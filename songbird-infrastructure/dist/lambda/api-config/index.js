"use strict";
/**
 * Config API Lambda
 *
 * Manages device configuration via Notehub environment variables:
 * - GET /devices/{serial_number}/config - Get current config
 * - PUT /devices/{serial_number}/config - Update config
 * - PUT /fleets/{fleet_uid}/config - Update fleet-wide config
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_secrets_manager_1 = require("@aws-sdk/client-secrets-manager");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const secretsClient = new client_secrets_manager_1.SecretsManagerClient({});
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
const NOTEHUB_PROJECT_UID = process.env.NOTEHUB_PROJECT_UID;
const NOTEHUB_SECRET_ARN = process.env.NOTEHUB_SECRET_ARN;
const DEVICE_ALIASES_TABLE = process.env.DEVICE_ALIASES_TABLE || 'songbird-device-aliases';
/**
 * Resolve serial number to device_uid using the aliases table
 */
async function resolveDeviceUid(serialNumber) {
    const result = await docClient.send(new lib_dynamodb_1.GetCommand({
        TableName: DEVICE_ALIASES_TABLE,
        Key: { serial_number: serialNumber },
    }));
    return result.Item?.device_uid || null;
}
// Cache the token to avoid fetching on every request
let cachedToken = null;
async function getNotehubToken() {
    if (cachedToken) {
        return cachedToken;
    }
    const command = new client_secrets_manager_1.GetSecretValueCommand({ SecretId: NOTEHUB_SECRET_ARN });
    const response = await secretsClient.send(command);
    if (!response.SecretString) {
        throw new Error('Notehub API token not found in secret');
    }
    const secret = JSON.parse(response.SecretString);
    cachedToken = secret.token;
    if (!cachedToken) {
        throw new Error('Token field not found in secret');
    }
    return cachedToken;
}
// Valid configuration keys and their types
const CONFIG_SCHEMA = {
    mode: { type: 'string', values: ['demo', 'transit', 'storage', 'sleep'] },
    gps_interval_min: { type: 'number', min: 1, max: 1440 },
    sync_interval_min: { type: 'number', min: 1, max: 1440 },
    heartbeat_hours: { type: 'number', min: 1, max: 168 },
    temp_alert_high_c: { type: 'number', min: -40, max: 85 },
    temp_alert_low_c: { type: 'number', min: -40, max: 85 },
    humidity_alert_high: { type: 'number', min: 0, max: 100 },
    humidity_alert_low: { type: 'number', min: 0, max: 100 },
    pressure_alert_delta: { type: 'number', min: 1, max: 100 },
    voltage_alert_low: { type: 'number', min: 3.0, max: 4.2 },
    motion_sensitivity: { type: 'string', values: ['low', 'medium', 'high'] },
    motion_wake_enabled: { type: 'boolean' },
    audio_enabled: { type: 'boolean' },
    audio_volume: { type: 'number', min: 0, max: 100 },
    audio_alerts_only: { type: 'boolean' },
    cmd_wake_enabled: { type: 'boolean' },
    cmd_ack_enabled: { type: 'boolean' },
    locate_duration_sec: { type: 'number', min: 5, max: 300 },
    led_enabled: { type: 'boolean' },
    debug_mode: { type: 'boolean' },
};
const handler = async (event) => {
    console.log('Request:', JSON.stringify(event));
    const corsHeaders = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type,Authorization',
        'Access-Control-Allow-Methods': 'GET,PUT,OPTIONS',
    };
    try {
        // HTTP API v2 uses requestContext.http.method, REST API v1 uses httpMethod
        const method = event.requestContext?.http?.method || event.httpMethod;
        if (method === 'OPTIONS') {
            return { statusCode: 200, headers: corsHeaders, body: '' };
        }
        const serialNumber = event.pathParameters?.serial_number;
        const fleetUid = event.pathParameters?.fleet_uid;
        if ((method === 'GET' || method === 'PUT') && serialNumber) {
            // Resolve serial number to device_uid
            const deviceUid = await resolveDeviceUid(serialNumber);
            if (!deviceUid) {
                return {
                    statusCode: 404,
                    headers: corsHeaders,
                    body: JSON.stringify({ error: 'Device not found for serial number' }),
                };
            }
            if (method === 'GET') {
                return await getDeviceConfig(deviceUid, serialNumber, corsHeaders);
            }
            else {
                return await updateDeviceConfig(deviceUid, serialNumber, event.body, corsHeaders);
            }
        }
        if (method === 'PUT' && fleetUid) {
            return await updateFleetConfig(fleetUid, event.body, corsHeaders);
        }
        return {
            statusCode: 400,
            headers: corsHeaders,
            body: JSON.stringify({ error: 'Invalid request' }),
        };
    }
    catch (error) {
        console.error('Error:', error);
        return {
            statusCode: 500,
            headers: corsHeaders,
            body: JSON.stringify({ error: 'Internal server error' }),
        };
    }
};
exports.handler = handler;
async function getDeviceConfig(deviceUid, serialNumber, headers) {
    try {
        // Get environment variables from Notehub
        const notehubToken = await getNotehubToken();
        const response = await fetch(`https://api.notefile.net/v1/projects/${NOTEHUB_PROJECT_UID}/devices/${deviceUid}/environment_variables`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${notehubToken}`,
            },
        });
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Notehub API error:', errorText);
            return {
                statusCode: response.status === 404 ? 404 : 502,
                headers,
                body: JSON.stringify({ error: 'Failed to fetch config from Notehub' }),
            };
        }
        const data = await response.json();
        const rawConfig = data.environment_variables || {};
        const parsedConfig = parseConfigValues(rawConfig);
        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({
                serial_number: serialNumber,
                device_uid: deviceUid,
                config: parsedConfig,
                schema: CONFIG_SCHEMA,
            }),
        };
    }
    catch (error) {
        console.error('Error fetching config:', error);
        return {
            statusCode: 502,
            headers,
            body: JSON.stringify({ error: 'Failed to communicate with Notehub' }),
        };
    }
}
async function updateDeviceConfig(deviceUid, serialNumber, body, headers) {
    if (!body) {
        return {
            statusCode: 400,
            headers,
            body: JSON.stringify({ error: 'Request body required' }),
        };
    }
    const updates = JSON.parse(body);
    // Validate configuration values
    const validationErrors = validateConfig(updates);
    if (validationErrors.length > 0) {
        return {
            statusCode: 400,
            headers,
            body: JSON.stringify({ error: 'Invalid configuration', errors: validationErrors }),
        };
    }
    try {
        // Update environment variables in Notehub
        const notehubToken = await getNotehubToken();
        const response = await fetch(`https://api.notefile.net/v1/projects/${NOTEHUB_PROJECT_UID}/devices/${deviceUid}/environment_variables`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${notehubToken}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ environment_variables: stringifyValues(updates) }),
        });
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Notehub API error:', errorText);
            return {
                statusCode: 502,
                headers,
                body: JSON.stringify({ error: 'Failed to update config in Notehub' }),
            };
        }
        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({
                serial_number: serialNumber,
                device_uid: deviceUid,
                config: updates,
                message: 'Configuration updated. Changes will take effect on next device sync.',
            }),
        };
    }
    catch (error) {
        console.error('Error updating config:', error);
        return {
            statusCode: 502,
            headers,
            body: JSON.stringify({ error: 'Failed to communicate with Notehub' }),
        };
    }
}
async function updateFleetConfig(fleetUid, body, headers) {
    if (!body) {
        return {
            statusCode: 400,
            headers,
            body: JSON.stringify({ error: 'Request body required' }),
        };
    }
    const updates = JSON.parse(body);
    // Validate configuration values
    const validationErrors = validateConfig(updates);
    if (validationErrors.length > 0) {
        return {
            statusCode: 400,
            headers,
            body: JSON.stringify({ error: 'Invalid configuration', errors: validationErrors }),
        };
    }
    try {
        // Update fleet environment variables in Notehub
        const notehubToken = await getNotehubToken();
        const response = await fetch(`https://api.notefile.net/v1/projects/${NOTEHUB_PROJECT_UID}/fleets/${fleetUid}/environment_variables`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${notehubToken}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ environment_variables: stringifyValues(updates) }),
        });
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Notehub API error:', errorText);
            return {
                statusCode: 502,
                headers,
                body: JSON.stringify({ error: 'Failed to update fleet config in Notehub' }),
            };
        }
        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({
                fleet_uid: fleetUid,
                config: updates,
                message: 'Fleet configuration updated. Changes will take effect on next device sync.',
            }),
        };
    }
    catch (error) {
        console.error('Error updating fleet config:', error);
        return {
            statusCode: 502,
            headers,
            body: JSON.stringify({ error: 'Failed to communicate with Notehub' }),
        };
    }
}
function validateConfig(config) {
    const errors = [];
    for (const [key, value] of Object.entries(config)) {
        const schema = CONFIG_SCHEMA[key];
        // Skip unknown keys - they will be filtered out in stringifyValues
        if (!schema) {
            continue;
        }
        if (schema.type === 'number') {
            const numValue = typeof value === 'string' ? parseFloat(value) : value;
            if (isNaN(numValue)) {
                errors.push(`${key} must be a number`);
            }
            else {
                if (schema.min !== undefined && numValue < schema.min) {
                    errors.push(`${key} must be >= ${schema.min}`);
                }
                if (schema.max !== undefined && numValue > schema.max) {
                    errors.push(`${key} must be <= ${schema.max}`);
                }
            }
        }
        if (schema.type === 'string' && schema.values) {
            if (!schema.values.includes(value)) {
                errors.push(`${key} must be one of: ${schema.values.join(', ')}`);
            }
        }
        if (schema.type === 'boolean') {
            const boolValue = typeof value === 'string' ? value === 'true' : value;
            if (typeof boolValue !== 'boolean') {
                errors.push(`${key} must be a boolean`);
            }
        }
    }
    return errors;
}
function stringifyValues(config) {
    const result = {};
    for (const [key, value] of Object.entries(config)) {
        // Only include keys that are in our schema
        if (CONFIG_SCHEMA[key]) {
            result[key] = String(value);
        }
    }
    return result;
}
function parseConfigValues(config) {
    const result = {};
    for (const [key, value] of Object.entries(config)) {
        const schema = CONFIG_SCHEMA[key];
        if (!schema) {
            // Keep unknown keys as-is
            result[key] = value;
            continue;
        }
        // Parse based on expected type
        if (schema.type === 'boolean') {
            result[key] = value === 'true';
        }
        else if (schema.type === 'number') {
            const numValue = parseFloat(value);
            result[key] = isNaN(numValue) ? value : numValue;
        }
        else {
            result[key] = value;
        }
    }
    return result;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvYXBpLWNvbmZpZy9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7R0FPRzs7O0FBR0gsNEVBQThGO0FBQzlGLDhEQUEwRDtBQUMxRCx3REFBMkU7QUFFM0UsTUFBTSxhQUFhLEdBQUcsSUFBSSw2Q0FBb0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUNuRCxNQUFNLFlBQVksR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDNUMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBRTVELE1BQU0sbUJBQW1CLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBb0IsQ0FBQztBQUM3RCxNQUFNLGtCQUFrQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQW1CLENBQUM7QUFDM0QsTUFBTSxvQkFBb0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixJQUFJLHlCQUF5QixDQUFDO0FBRTNGOztHQUVHO0FBQ0gsS0FBSyxVQUFVLGdCQUFnQixDQUFDLFlBQW9CO0lBQ2xELE1BQU0sTUFBTSxHQUFHLE1BQU0sU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLHlCQUFVLENBQUM7UUFDakQsU0FBUyxFQUFFLG9CQUFvQjtRQUMvQixHQUFHLEVBQUUsRUFBRSxhQUFhLEVBQUUsWUFBWSxFQUFFO0tBQ3JDLENBQUMsQ0FBQyxDQUFDO0lBRUosT0FBTyxNQUFNLENBQUMsSUFBSSxFQUFFLFVBQVUsSUFBSSxJQUFJLENBQUM7QUFDekMsQ0FBQztBQUVELHFEQUFxRDtBQUNyRCxJQUFJLFdBQVcsR0FBa0IsSUFBSSxDQUFDO0FBRXRDLEtBQUssVUFBVSxlQUFlO0lBQzVCLElBQUksV0FBVyxFQUFFLENBQUM7UUFDaEIsT0FBTyxXQUFXLENBQUM7SUFDckIsQ0FBQztJQUVELE1B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LEtBQUssS0FBSyxNQUFNLENBQUM7UUFDakMsQ0FBQzthQUFNLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxRQUFRLEVBQUUsQ0FBQztZQUNwQyxNQUFNLFFBQVEsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbkMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUM7UUFDbkQsQ0FBQzthQUFNLENBQUM7WUFDTixNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDO1FBQ3RCLENBQUM7SUFDSCxDQUFDO0lBRUQsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29uZmlnIEFQSSBMYW1iZGFcbiAqXG4gKiBNYW5hZ2VzIGRldmljZSBjb25maWd1cmF0aW9uIHZpYSBOb3RlaHViIGVudmlyb25tZW50IHZhcmlhYmxlczpcbiAqIC0gR0VUIC9kZXZpY2VzL3tzZXJpYWxfbnVtYmVyfS9jb25maWcgLSBHZXQgY3VycmVudCBjb25maWdcbiAqIC0gUFVUIC9kZXZpY2VzL3tzZXJpYWxfbnVtYmVyfS9jb25maWcgLSBVcGRhdGUgY29uZmlnXG4gKiAtIFBVVCAvZmxlZXRzL3tmbGVldF91aWR9L2NvbmZpZyAtIFVwZGF0ZSBmbGVldC13aWRlIGNvbmZpZ1xuICovXG5cbmltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBBUElHYXRld2F5UHJveHlSZXN1bHQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IFNlY3JldHNNYW5hZ2VyQ2xpZW50LCBHZXRTZWNyZXRWYWx1ZUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtc2VjcmV0cy1tYW5hZ2VyJztcbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIEdldENvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuXG5jb25zdCBzZWNyZXRzQ2xpZW50ID0gbmV3IFNlY3JldHNNYW5hZ2VyQ2xpZW50KHt9KTtcbmNvbnN0IGR5bmFtb0NsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XG5jb25zdCBkb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oZHluYW1vQ2xpZW50KTtcblxuY29uc3QgTk9URUhVQl9QUk9KRUNUX1VJRCA9IHByb2Nlc3MuZW52Lk5PVEVIVUJfUFJPSkVDVF9VSUQhO1xuY29uc3QgTk9URUhVQl9TRUNSRVRfQVJOID0gcHJvY2Vzcy5lbnYuTk9URUhVQl9TRUNSRVRfQVJOITtcbmNvbnN0IERFVklDRV9BTElBU0VTX1RBQkxFID0gcHJvY2Vzcy5lbnYuREVWSUNFX0FMSUFTRVNfVEFCTEUgfHwgJ3NvbmdiaXJkLWRldmljZS1hbGlhc2VzJztcblxuLyoqXG4gKiBSZXNvbHZlIHNlcmlhbCBudW1iZXIgdG8gZGV2aWNlX3VpZCB1c2luZyB0aGUgYWxpYXNlcyB0YWJsZVxuICovXG5hc3luYyBmdW5jdGlvbiByZXNvbHZlRGV2aWNlVWlkKHNlcmlhbE51bWJlcjogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmcgfCBudWxsPiB7XG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBHZXRDb21tYW5kKHtcbiAgICBUYWJsZU5hbWU6IERFVklDRV9BTElBU0VTX1RBQkxFLFxuICAgIEtleTogeyBzZXJpYWxfbnVtYmVyOiBzZXJpYWxOdW1iZXIgfSxcbiAgfSkpO1xuXG4gIHJldHVybiByZXN1bHQuSXRlbT8uZGV2aWNlX3VpZCB8fCBudWxsO1xufVxuXG4vLyBDYWNoZSB0aGUgdG9rZW4gdG8gYXZvaWQgZmV0Y2hpbmcgb24gZXZlcnkgcmVxdWVzdFxubGV0IGNhY2hlZFRva2VuOiBzdHJpbmcgfCBudWxsID0gbnVsbDtcblxuYXN5bmMgZnVuY3Rpb24gZ2V0Tm90ZWh1YlRva2VuKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gIGlmIChjYWNoZWRUb2tlbikge1xuICAgIHJldHVybiBjYWNoZWRUb2tlbjtcbiAgfVxuXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0U2VjcmV0VmFsdWVDb21tYW5kKHsgU2VjcmV0SWQ6IE5PVEVIVUJfU0VDUkVUX0FSTiB9KTtcbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBzZWNyZXRzQ2xpZW50LnNlbmQoY29tbWFuZCk7XG5cbiAgaWYgKCFyZXNwb25zZS5TZWNyZXRTdHJpbmcpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdGVodWIgQVBJIHRva2VuIG5vdCBmb3VuZCBpbiBzZWNyZXQnKTtcbiAgfVxuXG4gIGNvbnN0IHNlY3JldCA9IEpTT04ucGFyc2UocmVzcG9uc2UuU2VjcmV0U3RyaW5nKTtcbiAgY2FjaGVkVG9rZW4gPSBzZWNyZXQudG9rZW47XG5cbiAgaWYgKCFjYWNoZWRUb2tlbikge1xuICAgIHRocm93IG5ldyBFcnJvcignVG9rZW4gZmllbGQgbm90IGZvdW5kIGluIHNlY3JldCcpO1xuICB9XG5cbiAgcmV0dXJuIGNhY2hlZFRva2VuO1xufVxuXG4vLyBWYWxpZCBjb25maWd1cmF0aW9uIGtleXMgYW5kIHRoZWlyIHR5cGVzXG5jb25zdCBDT05GSUdfU0NIRU1BOiBSZWNvcmQ8c3RyaW5nLCB7IHR5cGU6IHN0cmluZzsgbWluPzogbnVtYmVyOyBtYXg/OiBudW1iZXI7IHZhbHVlcz86IHN0cmluZ1tdIH0+ID0ge1xuICBtb2RlOiB7IHR5cGU6ICdzdHJpbmcnLCB2YWx1ZXM6IFsnZGVtbycsICd0cmFuc2l0JywgJ3N0b3JhZ2UnLCAnc2xlZXAnXSB9LFxuICBncHNfaW50ZXJ2YWxfbWluOiB7IHR5cGU6ICdudW1iZXInLCBtaW46IDEsIG1heDogMTQ0MCB9LFxuICBzeW5jX2ludGVydmFsX21pbjogeyB0eXBlOiAnbnVtYmVyJywgbWluOiAxLCBtYXg6IDE0NDAgfSxcbiAgaGVhcnRiZWF0X2hvdXJzOiB7IHR5cGU6ICdudW1iZXInLCBtaW46IDEsIG1heDogMTY4IH0sXG4gIHRlbXBfYWxlcnRfaGlnaF9jOiB7IHR5cGU6ICdudW1iZXInLCBtaW46IC00MCwgbWF4OiA4NSB9LFxuICB0ZW1wX2FsZXJ0X2xvd19jOiB7IHR5cGU6ICdudW1iZXInLCBtaW46IC00MCwgbWF4OiA4NSB9LFxuICBodW1pZGl0eV9hbGVydF9oaWdoOiB7IHR5cGU6ICdudW1iZXInLCBtaW46IDAsIG1heDogMTAwIH0sXG4gIGh1bWlkaXR5X2FsZXJ0X2xvdzogeyB0eXBlOiAnbnVtYmVyJywgbWluOiAwLCBtYXg6IDEwMCB9LFxuICBwcmVzc3VyZV9hbGVydF9kZWx0YTogeyB0eXBlOiAnbnVtYmVyJywgbWluOiAxLCBtYXg6IDEwMCB9LFxuICB2b2x0YWdlX2FsZXJ0X2xvdzogeyB0eXBlOiAnbnVtYmVyJywgbWluOiAzLjAsIG1heDogNC4yIH0sXG4gIG1vdGlvbl9zZW5zaXRpdml0eTogeyB0eXBlOiAnc3RyaW5nJywgdmFsdWVzOiBbJ2xvdycsICdtZWRpdW0nLCAnaGlnaCddIH0sXG4gIG1vdGlvbl93YWtlX2VuYWJsZWQ6IHsgdHlwZTogJ2Jvb2xlYW4nIH0sXG4gIGF1ZGlvX2VuYWJsZWQ6IHsgdHlwZTogJ2Jvb2xlYW4nIH0sXG4gIGF1ZGlvX3ZvbHVtZTogeyB0eXBlOiAnbnVtYmVyJywgbWluOiAwLCBtYXg6IDEwMCB9LFxuICBhdWRpb19hbGVydHNfb25seTogeyB0eXBlOiAnYm9vbGVhbicgfSxcbiAgY21kX3dha2VfZW5hYmxlZDogeyB0eXBlOiAnYm9vbGVhbicgfSxcbiAgY21kX2Fja19lbmFibGVkOiB7IHR5cGU6ICdib29sZWFuJyB9LFxuICBsb2NhdGVfZHVyYXRpb25fc2VjOiB7IHR5cGU6ICdudW1iZXInLCBtaW46IDUsIG1heDogMzAwIH0sXG4gIGxlZF9lbmFibGVkOiB7IHR5cGU6ICdib29sZWFuJyB9LFxuICBkZWJ1Z19tb2RlOiB7IHR5cGU6ICdib29sZWFuJyB9LFxufTtcblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50KTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0+IHtcbiAgY29uc29sZS5sb2coJ1JlcXVlc3Q6JywgSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTtcblxuICBjb25zdCBjb3JzSGVhZGVycyA9IHtcbiAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogJ0NvbnRlbnQtVHlwZSxBdXRob3JpemF0aW9uJyxcbiAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctTWV0aG9kcyc6ICdHRVQsUFVULE9QVElPTlMnLFxuICB9O1xuXG4gIHRyeSB7XG4gICAgLy8gSFRUUCBBUEkgdjIgdXNlcyByZXF1ZXN0Q29udGV4dC5odHRwLm1ldGhvZCwgUkVTVCBBUEkgdjEgdXNlcyBodHRwTWV0aG9kXG4gICAgY29uc3QgbWV0aG9kID0gKGV2ZW50LnJlcXVlc3RDb250ZXh0IGFzIGFueSk/Lmh0dHA/Lm1ldGhvZCB8fCBldmVudC5odHRwTWV0aG9kO1xuXG4gICAgaWYgKG1ldGhvZCA9PT0gJ09QVElPTlMnKSB7XG4gICAgICByZXR1cm4geyBzdGF0dXNDb2RlOiAyMDAsIGhlYWRlcnM6IGNvcnNIZWFkZXJzLCBib2R5OiAnJyB9O1xuICAgIH1cblxuICAgIGNvbnN0IHNlcmlhbE51bWJlciA9IGV2ZW50LnBhdGhQYXJhbWV0ZXJzPy5zZXJpYWxfbnVtYmVyO1xuICAgIGNvbnN0IGZsZWV0VWlkID0gZXZlbnQucGF0aFBhcmFtZXRlcnM/LmZsZWV0X3VpZDtcblxuICAgIGlmICgobWV0aG9kID09PSAnR0VUJyB8fCBtZXRob2QgPT09ICdQVVQnKSAmJiBzZXJpYWxOdW1iZXIpIHtcbiAgICAgIC8vIFJlc29sdmUgc2VyaWFsIG51bWJlciB0byBkZXZpY2VfdWlkXG4gICAgICBjb25zdCBkZXZpY2VVaWQgPSBhd2FpdCByZXNvbHZlRGV2aWNlVWlkKHNlcmlhbE51bWJlcik7XG4gICAgICBpZiAoIWRldmljZVVpZCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHN0YXR1c0NvZGU6IDQwNCxcbiAgICAgICAgICBoZWFkZXJzOiBjb3JzSGVhZGVycyxcbiAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnRGV2aWNlIG5vdCBmb3VuZCBmb3Igc2VyaWFsIG51bWJlcicgfSksXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGlmIChtZXRob2QgPT09ICdHRVQnKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCBnZXREZXZpY2VDb25maWcoZGV2aWNlVWlkLCBzZXJpYWxOdW1iZXIsIGNvcnNIZWFkZXJzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBhd2FpdCB1cGRhdGVEZXZpY2VDb25maWcoZGV2aWNlVWlkLCBzZXJpYWxOdW1iZXIsIGV2ZW50LmJvZHksIGNvcnNIZWFkZXJzKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAobWV0aG9kID09PSAnUFVUJyAmJiBmbGVldFVpZCkge1xuICAgICAgcmV0dXJuIGF3YWl0IHVwZGF0ZUZsZWV0Q29uZmlnKGZsZWV0VWlkLCBldmVudC5ib2R5LCBjb3JzSGVhZGVycyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgIGhlYWRlcnM6IGNvcnNIZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0ludmFsaWQgcmVxdWVzdCcgfSksXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICAgIGhlYWRlcnM6IGNvcnNIZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicgfSksXG4gICAgfTtcbiAgfVxufTtcblxuYXN5bmMgZnVuY3Rpb24gZ2V0RGV2aWNlQ29uZmlnKFxuICBkZXZpY2VVaWQ6IHN0cmluZyxcbiAgc2VyaWFsTnVtYmVyOiBzdHJpbmcsXG4gIGhlYWRlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XG4gIHRyeSB7XG4gICAgLy8gR2V0IGVudmlyb25tZW50IHZhcmlhYmxlcyBmcm9tIE5vdGVodWJcbiAgICBjb25zdCBub3RlaHViVG9rZW4gPSBhd2FpdCBnZXROb3RlaHViVG9rZW4oKTtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKFxuICAgICAgYGh0dHBzOi8vYXBpLm5vdGVmaWxlLm5ldC92MS9wcm9qZWN0cy8ke05PVEVIVUJfUFJPSkVDVF9VSUR9L2RldmljZXMvJHtkZXZpY2VVaWR9L2Vudmlyb25tZW50X3ZhcmlhYmxlc2AsXG4gICAgICB7XG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHtub3RlaHViVG9rZW59YCxcbiAgICAgICAgfSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgY29uc3QgZXJyb3JUZXh0ID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpO1xuICAgICAgY29uc29sZS5lcnJvcignTm90ZWh1YiBBUEkgZXJyb3I6JywgZXJyb3JUZXh0KTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogcmVzcG9uc2Uuc3RhdHVzID09PSA0MDQgPyA0MDQgOiA1MDIsXG4gICAgICAgIGhlYWRlcnMsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdGYWlsZWQgdG8gZmV0Y2ggY29uZmlnIGZyb20gTm90ZWh1YicgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXNwb25zZS5qc29uKCkgYXMgeyBlbnZpcm9ubWVudF92YXJpYWJsZXM/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+IH07XG4gICAgY29uc3QgcmF3Q29uZmlnID0gZGF0YS5lbnZpcm9ubWVudF92YXJpYWJsZXMgfHwge307XG4gICAgY29uc3QgcGFyc2VkQ29uZmlnID0gcGFyc2VDb25maWdWYWx1ZXMocmF3Q29uZmlnKTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBzZXJpYWxfbnVtYmVyOiBzZXJpYWxOdW1iZXIsXG4gICAgICAgIGRldmljZV91aWQ6IGRldmljZVVpZCxcbiAgICAgICAgY29uZmlnOiBwYXJzZWRDb25maWcsXG4gICAgICAgIHNjaGVtYTogQ09ORklHX1NDSEVNQSxcbiAgICAgIH0pLFxuICAgIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgZmV0Y2hpbmcgY29uZmlnOicsIGVycm9yKTtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNTAyLFxuICAgICAgaGVhZGVycyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdGYWlsZWQgdG8gY29tbXVuaWNhdGUgd2l0aCBOb3RlaHViJyB9KSxcbiAgICB9O1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZURldmljZUNvbmZpZyhcbiAgZGV2aWNlVWlkOiBzdHJpbmcsXG4gIHNlcmlhbE51bWJlcjogc3RyaW5nLFxuICBib2R5OiBzdHJpbmcgfCBudWxsLFxuICBoZWFkZXJzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+XG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4ge1xuICBpZiAoIWJvZHkpIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgaGVhZGVycyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdSZXF1ZXN0IGJvZHkgcmVxdWlyZWQnIH0pLFxuICAgIH07XG4gIH1cblxuICBjb25zdCB1cGRhdGVzID0gSlNPTi5wYXJzZShib2R5KTtcblxuICAvLyBWYWxpZGF0ZSBjb25maWd1cmF0aW9uIHZhbHVlc1xuICBjb25zdCB2YWxpZGF0aW9uRXJyb3JzID0gdmFsaWRhdGVDb25maWcodXBkYXRlcyk7XG4gIGlmICh2YWxpZGF0aW9uRXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgaGVhZGVycyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdJbnZhbGlkIGNvbmZpZ3VyYXRpb24nLCBlcnJvcnM6IHZhbGlkYXRpb25FcnJvcnMgfSksXG4gICAgfTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgLy8gVXBkYXRlIGVudmlyb25tZW50IHZhcmlhYmxlcyBpbiBOb3RlaHViXG4gICAgY29uc3Qgbm90ZWh1YlRva2VuID0gYXdhaXQgZ2V0Tm90ZWh1YlRva2VuKCk7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChcbiAgICAgIGBodHRwczovL2FwaS5ub3RlZmlsZS5uZXQvdjEvcHJvamVjdHMvJHtOT1RFSFVCX1BST0pFQ1RfVUlEfS9kZXZpY2VzLyR7ZGV2aWNlVWlkfS9lbnZpcm9ubWVudF92YXJpYWJsZXNgLFxuICAgICAge1xuICAgICAgICBtZXRob2Q6ICdQVVQnLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7bm90ZWh1YlRva2VufWAsXG4gICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgfSxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlbnZpcm9ubWVudF92YXJpYWJsZXM6IHN0cmluZ2lmeVZhbHVlcyh1cGRhdGVzKSB9KSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgY29uc3QgZXJyb3JUZXh0ID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpO1xuICAgICAgY29uc29sZS5lcnJvcignTm90ZWh1YiBBUEkgZXJyb3I6JywgZXJyb3JUZXh0KTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNTAyLFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnRmFpbGVkIHRvIHVwZGF0ZSBjb25maWcgaW4gTm90ZWh1YicgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBzZXJpYWxfbnVtYmVyOiBzZXJpYWxOdW1iZXIsXG4gICAgICAgIGRldmljZV91aWQ6IGRldmljZVVpZCxcbiAgICAgICAgY29uZmlnOiB1cGRhdGVzLFxuICAgICAgICBtZXNzYWdlOiAnQ29uZmlndXJhdGlvbiB1cGRhdGVkLiBDaGFuZ2VzIHdpbGwgdGFrZSBlZmZlY3Qgb24gbmV4dCBkZXZpY2Ugc3luYy4nLFxuICAgICAgfSksXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciB1cGRhdGluZyBjb25maWc6JywgZXJyb3IpO1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA1MDIsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0ZhaWxlZCB0byBjb21tdW5pY2F0ZSB3aXRoIE5vdGVodWInIH0pLFxuICAgIH07XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gdXBkYXRlRmxlZXRDb25maWcoXG4gIGZsZWV0VWlkOiBzdHJpbmcsXG4gIGJvZHk6IHN0cmluZyB8IG51bGwsXG4gIGhlYWRlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XG4gIGlmICghYm9keSkge1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA0MDAsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ1JlcXVlc3QgYm9keSByZXF1aXJlZCcgfSksXG4gICAgfTtcbiAgfVxuXG4gIGNvbnN0IHVwZGF0ZXMgPSBKU09OLnBhcnNlKGJvZHkpO1xuXG4gIC8vIFZhbGlkYXRlIGNvbmZpZ3VyYXRpb24gdmFsdWVzXG4gIGNvbnN0IHZhbGlkYXRpb25FcnJvcnMgPSB2YWxpZGF0ZUNvbmZpZyh1cGRhdGVzKTtcbiAgaWYgKHZhbGlkYXRpb25FcnJvcnMubGVuZ3RoID4gMCkge1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA0MDAsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0ludmFsaWQgY29uZmlndXJhdGlvbicsIGVycm9yczogdmFsaWRhdGlvbkVycm9ycyB9KSxcbiAgICB9O1xuICB9XG5cbiAgdHJ5IHtcbiAgICAvLyBVcGRhdGUgZmxlZXQgZW52aXJvbm1lbnQgdmFyaWFibGVzIGluIE5vdGVodWJcbiAgICBjb25zdCBub3RlaHViVG9rZW4gPSBhd2FpdCBnZXROb3RlaHViVG9rZW4oKTtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKFxuICAgICAgYGh0dHBzOi8vYXBpLm5vdGVmaWxlLm5ldC92MS9wcm9qZWN0cy8ke05PVEVIVUJfUFJPSkVDVF9VSUR9L2ZsZWV0cy8ke2ZsZWV0VWlkfS9lbnZpcm9ubWVudF92YXJpYWJsZXNgLFxuICAgICAge1xuICAgICAgICBtZXRob2Q6ICdQVVQnLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7bm90ZWh1YlRva2VufWAsXG4gICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgfSxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlbnZpcm9ubWVudF92YXJpYWJsZXM6IHN0cmluZ2lmeVZhbHVlcyh1cGRhdGVzKSB9KSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgY29uc3QgZXJyb3JUZXh0ID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpO1xuICAgICAgY29uc29sZS5lcnJvcignTm90ZWh1YiBBUEkgZXJyb3I6JywgZXJyb3JUZXh0KTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNTAyLFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnRmFpbGVkIHRvIHVwZGF0ZSBmbGVldCBjb25maWcgaW4gTm90ZWh1YicgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBmbGVldF91aWQ6IGZsZWV0VWlkLFxuICAgICAgICBjb25maWc6IHVwZGF0ZXMsXG4gICAgICAgIG1lc3NhZ2U6ICdGbGVldCBjb25maWd1cmF0aW9uIHVwZGF0ZWQuIENoYW5nZXMgd2lsbCB0YWtlIGVmZmVjdCBvbiBuZXh0IGRldmljZSBzeW5jLicsXG4gICAgICB9KSxcbiAgICB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHVwZGF0aW5nIGZsZWV0IGNvbmZpZzonLCBlcnJvcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDUwMixcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnRmFpbGVkIHRvIGNvbW11bmljYXRlIHdpdGggTm90ZWh1YicgfSksXG4gICAgfTtcbiAgfVxufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZUNvbmZpZyhjb25maWc6IFJlY29yZDxzdHJpbmcsIGFueT4pOiBzdHJpbmdbXSB7XG4gIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcblxuICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhjb25maWcpKSB7XG4gICAgY29uc3Qgc2NoZW1hID0gQ09ORklHX1NDSEVNQVtrZXldO1xuXG4gICAgLy8gU2tpcCB1bmtub3duIGtleXMgLSB0aGV5IHdpbGwgYmUgZmlsdGVyZWQgb3V0IGluIHN0cmluZ2lmeVZhbHVlc1xuICAgIGlmICghc2NoZW1hKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBpZiAoc2NoZW1hLnR5cGUgPT09ICdudW1iZXInKSB7XG4gICAgICBjb25zdCBudW1WYWx1ZSA9IHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgPyBwYXJzZUZsb2F0KHZhbHVlKSA6IHZhbHVlO1xuICAgICAgaWYgKGlzTmFOKG51bVZhbHVlKSkge1xuICAgICAgICBlcnJvcnMucHVzaChgJHtrZXl9IG11c3QgYmUgYSBudW1iZXJgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChzY2hlbWEubWluICE9PSB1bmRlZmluZWQgJiYgbnVtVmFsdWUgPCBzY2hlbWEubWluKSB7XG4gICAgICAgICAgZXJyb3JzLnB1c2goYCR7a2V5fSBtdXN0IGJlID49ICR7c2NoZW1hLm1pbn1gKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc2NoZW1hLm1heCAhPT0gdW5kZWZpbmVkICYmIG51bVZhbHVlID4gc2NoZW1hLm1heCkge1xuICAgICAgICAgIGVycm9ycy5wdXNoKGAke2tleX0gbXVzdCBiZSA8PSAke3NjaGVtYS5tYXh9YCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoc2NoZW1hLnR5cGUgPT09ICdzdHJpbmcnICYmIHNjaGVtYS52YWx1ZXMpIHtcbiAgICAgIGlmICghc2NoZW1hLnZhbHVlcy5pbmNsdWRlcyh2YWx1ZSkpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goYCR7a2V5fSBtdXN0IGJlIG9uZSBvZjogJHtzY2hlbWEudmFsdWVzLmpvaW4oJywgJyl9YCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHNjaGVtYS50eXBlID09PSAnYm9vbGVhbicpIHtcbiAgICAgIGNvbnN0IGJvb2xWYWx1ZSA9IHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgPyB2YWx1ZSA9PT0gJ3RydWUnIDogdmFsdWU7XG4gICAgICBpZiAodHlwZW9mIGJvb2xWYWx1ZSAhPT0gJ2Jvb2xlYW4nKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKGAke2tleX0gbXVzdCBiZSBhIGJvb2xlYW5gKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gZXJyb3JzO1xufVxuXG5mdW5jdGlvbiBzdHJpbmdpZnlWYWx1ZXMoY29uZmlnOiBSZWNvcmQ8c3RyaW5nLCBhbnk+KTogUmVjb3JkPHN0cmluZywgc3RyaW5nPiB7XG4gIGNvbnN0IHJlc3VsdDogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuXG4gIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGNvbmZpZykpIHtcbiAgICAvLyBPbmx5IGluY2x1ZGUga2V5cyB0aGF0IGFyZSBpbiBvdXIgc2NoZW1hXG4gICAgaWYgKENPTkZJR19TQ0hFTUFba2V5XSkge1xuICAgICAgcmVzdWx0W2tleV0gPSBTdHJpbmcodmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmZ1bmN0aW9uIHBhcnNlQ29uZmlnVmFsdWVzKGNvbmZpZzogUmVjb3JkPHN0cmluZywgc3RyaW5nPik6IFJlY29yZDxzdHJpbmcsIGFueT4ge1xuICBjb25zdCByZXN1bHQ6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcblxuICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhjb25maWcpKSB7XG4gICAgY29uc3Qgc2NoZW1hID0gQ09ORklHX1NDSEVNQVtrZXldO1xuXG4gICAgaWYgKCFzY2hlbWEpIHtcbiAgICAgIC8vIEtlZXAgdW5rbm93biBrZXlzIGFzLWlzXG4gICAgICByZXN1bHRba2V5XSA9IHZhbHVlO1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgLy8gUGFyc2UgYmFzZWQgb24gZXhwZWN0ZWQgdHlwZVxuICAgIGlmIChzY2hlbWEudHlwZSA9PT0gJ2Jvb2xlYW4nKSB7XG4gICAgICByZXN1bHRba2V5XSA9IHZhbHVlID09PSAndHJ1ZSc7XG4gICAgfSBlbHNlIGlmIChzY2hlbWEudHlwZSA9PT0gJ251bWJlcicpIHtcbiAgICAgIGNvbnN0IG51bVZhbHVlID0gcGFyc2VGbG9hdCh2YWx1ZSk7XG4gICAgICByZXN1bHRba2V5XSA9IGlzTmFOKG51bVZhbHVlKSA/IHZhbHVlIDogbnVtVmFsdWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlc3VsdFtrZXldID0gdmFsdWU7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn1cbiJdfQ==