"use strict";
/**
 * Alerts API Lambda
 *
 * Handles alert operations:
 * - GET /alerts - List all alerts (with optional filters)
 * - GET /alerts/{alert_id} - Get single alert
 * - POST /alerts/{alert_id}/acknowledge - Acknowledge an alert
 * - POST /alerts/acknowledge-all - Bulk acknowledge alerts
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient);
const ALERTS_TABLE = process.env.ALERTS_TABLE;
const DEVICE_ALIASES_TABLE = process.env.DEVICE_ALIASES_TABLE || 'songbird-device-aliases';
/**
 * Get all device_uids associated with a serial number
 */
async function getAllDeviceUidsForSerial(serialNumber) {
    const result = await docClient.send(new lib_dynamodb_1.GetCommand({
        TableName: DEVICE_ALIASES_TABLE,
        Key: { serial_number: serialNumber },
    }));
    if (!result.Item) {
        return [];
    }
    // Return current device_uid plus any historical ones
    const deviceUids = [result.Item.device_uid];
    if (result.Item.previous_device_uids && Array.isArray(result.Item.previous_device_uids)) {
        deviceUids.push(...result.Item.previous_device_uids);
    }
    return deviceUids;
}
const handler = async (event) => {
    console.log('Request:', JSON.stringify(event));
    const corsHeaders = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type,Authorization',
        'Access-Control-Allow-Methods': 'GET,POST,OPTIONS',
    };
    try {
        const method = event.requestContext?.http?.method || event.httpMethod;
        const alertId = event.pathParameters?.alert_id;
        const path = event.rawPath || event.path || '';
        if (method === 'OPTIONS') {
            return { statusCode: 200, headers: corsHeaders, body: '' };
        }
        // POST /alerts/acknowledge-all
        if (method === 'POST' && path.endsWith('/acknowledge-all')) {
            return await bulkAcknowledgeAlerts(event, corsHeaders);
        }
        // POST /alerts/{alert_id}/acknowledge
        if (method === 'POST' && alertId && path.endsWith('/acknowledge')) {
            return await acknowledgeAlert(alertId, event, corsHeaders);
        }
        // GET /alerts/{alert_id}
        if (method === 'GET' && alertId) {
            return await getAlert(alertId, corsHeaders);
        }
        // GET /alerts
        if (method === 'GET' && !alertId) {
            return await listAlerts(event, corsHeaders);
        }
        return {
            statusCode: 405,
            headers: corsHeaders,
            body: JSON.stringify({ error: 'Method not allowed' }),
        };
    }
    catch (error) {
        console.error('Error:', error);
        return {
            statusCode: 500,
            headers: corsHeaders,
            body: JSON.stringify({ error: 'Internal server error' }),
        };
    }
};
exports.handler = handler;
async function listAlerts(event, headers) {
    const queryParams = event.queryStringParameters || {};
    const serialNumber = queryParams.serial_number || queryParams.device_uid; // Support both for backwards compat
    const acknowledged = queryParams.acknowledged;
    const limit = parseInt(queryParams.limit || '100');
    let items = [];
    if (serialNumber) {
        // Resolve serial number to device_uid(s)
        const deviceUids = await getAllDeviceUidsForSerial(serialNumber);
        if (deviceUids.length === 0) {
            // No device found for this serial number
            return {
                statusCode: 200,
                headers,
                body: JSON.stringify({
                    alerts: [],
                    count: 0,
                    active_count: 0,
                }),
            };
        }
        // Query alerts for all device_uids and merge
        const allResults = await Promise.all(deviceUids.map(async (deviceUid) => {
            const command = new lib_dynamodb_1.QueryCommand({
                TableName: ALERTS_TABLE,
                IndexName: 'device-index',
                KeyConditionExpression: 'device_uid = :device_uid',
                ExpressionAttributeValues: { ':device_uid': deviceUid },
                ScanIndexForward: false,
                Limit: limit,
            });
            const result = await docClient.send(command);
            return result.Items || [];
        }));
        // Merge and sort by created_at descending
        items = allResults.flat().sort((a, b) => (b.created_at || 0) - (a.created_at || 0));
        items = items.slice(0, limit);
    }
    else if (acknowledged === 'false') {
        // Query only unacknowledged alerts
        const command = new lib_dynamodb_1.QueryCommand({
            TableName: ALERTS_TABLE,
            IndexName: 'status-index',
            KeyConditionExpression: 'acknowledged = :ack',
            ExpressionAttributeValues: { ':ack': 'false' },
            ScanIndexForward: false,
            Limit: limit,
        });
        const result = await docClient.send(command);
        items = result.Items || [];
    }
    else {
        // Scan all alerts
        const command = new lib_dynamodb_1.ScanCommand({
            TableName: ALERTS_TABLE,
            Limit: limit,
        });
        const result = await docClient.send(command);
        items = result.Items || [];
        // Sort by created_at descending
        items.sort((a, b) => (b.created_at || 0) - (a.created_at || 0));
    }
    // Calculate stats
    const activeCount = items.filter(a => a.acknowledged === 'false').length;
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
            alerts: items,
            count: items.length,
            active_count: activeCount,
        }),
    };
}
async function getAlert(alertId, headers) {
    const command = new lib_dynamodb_1.GetCommand({
        TableName: ALERTS_TABLE,
        Key: { alert_id: alertId },
    });
    const result = await docClient.send(command);
    if (!result.Item) {
        return {
            statusCode: 404,
            headers,
            body: JSON.stringify({ error: 'Alert not found' }),
        };
    }
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify(result.Item),
    };
}
async function acknowledgeAlert(alertId, event, headers) {
    const now = Date.now();
    // Parse body for optional acknowledgment details
    let acknowledgedBy = 'system';
    if (event.body) {
        try {
            const body = JSON.parse(event.body);
            acknowledgedBy = body.acknowledged_by || 'system';
        }
        catch {
            // Ignore parse errors
        }
    }
    const command = new lib_dynamodb_1.UpdateCommand({
        TableName: ALERTS_TABLE,
        Key: { alert_id: alertId },
        UpdateExpression: 'SET acknowledged = :ack, acknowledged_at = :ack_at, acknowledged_by = :ack_by',
        ExpressionAttributeValues: {
            ':ack': 'true',
            ':ack_at': now,
            ':ack_by': acknowledgedBy,
        },
        ReturnValues: 'ALL_NEW',
    });
    const result = await docClient.send(command);
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify(result.Attributes),
    };
}
async function bulkAcknowledgeAlerts(event, headers) {
    const now = Date.now();
    // Parse body for alert IDs and acknowledgment details
    let alertIds = [];
    let acknowledgedBy = 'system';
    if (event.body) {
        try {
            const body = JSON.parse(event.body);
            alertIds = body.alert_ids || [];
            acknowledgedBy = body.acknowledged_by || 'system';
        }
        catch {
            return {
                statusCode: 400,
                headers,
                body: JSON.stringify({ error: 'Invalid request body' }),
            };
        }
    }
    if (!alertIds.length) {
        return {
            statusCode: 400,
            headers,
            body: JSON.stringify({ error: 'alert_ids array is required' }),
        };
    }
    // Update each alert individually (DynamoDB doesn't support batch updates)
    const results = await Promise.allSettled(alertIds.map(async (alertId) => {
        const command = new lib_dynamodb_1.UpdateCommand({
            TableName: ALERTS_TABLE,
            Key: { alert_id: alertId },
            UpdateExpression: 'SET acknowledged = :ack, acknowledged_at = :ack_at, acknowledged_by = :ack_by',
            ConditionExpression: 'acknowledged = :not_ack',
            ExpressionAttributeValues: {
                ':ack': 'true',
                ':ack_at': now,
                ':ack_by': acknowledgedBy,
                ':not_ack': 'false',
            },
            ReturnValues: 'ALL_NEW',
        });
        return docClient.send(command);
    }));
    const acknowledged = results.filter(r => r.status === 'fulfilled').length;
    const failed = results.filter(r => r.status === 'rejected').length;
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
            acknowledged,
            failed,
            total: alertIds.length,
        }),
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvYXBpLWFsZXJ0cy9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7O0dBUUc7OztBQUVILDhEQUEwRDtBQUMxRCx3REFPK0I7QUFHL0IsTUFBTSxTQUFTLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3pDLE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUV6RCxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQWEsQ0FBQztBQUMvQyxNQUFNLG9CQUFvQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLElBQUkseUJBQXlCLENBQUM7QUFFM0Y7O0dBRUc7QUFDSCxLQUFLLFVBQVUseUJBQXlCLENBQUMsWUFBb0I7SUFDM0QsTUFBTSxNQUFNLEdBQUcsTUFBTSxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUkseUJBQVUsQ0FBQztRQUNqRCxTQUFTLEVBQUUsb0JBQW9CO1FBQy9CLEdBQUcsRUFBRSxFQUFFLGFBQWEsRUFBRSxZQUFZLEVBQUU7S0FDckMsQ0FBQyxDQUFDLENBQUM7SUFFSixJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2pCLE9BQU8sRUFBRSxDQUFDO0lBQ1osQ0FBQztJQUVELHFEQUFxRDtJQUNyRCxNQUFNLFVBQVUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDNUMsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLG9CQUFvQixJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLENBQUM7UUFDeEYsVUFBVSxDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FB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Q3pCLFVBQVUsRUFBRSxPQUFPO2FBQ3BCO1lBQ0QsWUFBWSxFQUFFLFNBQVM7U0FDeEIsQ0FBQyxDQUFDO1FBRUgsT0FBTyxTQUFTLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ2pDLENBQUMsQ0FBQyxDQUNILENBQUM7SUFFRixNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sS0FBSyxXQUFXLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDMUUsTUFBTSxNQUFNLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLEtBQUssVUFBVSxDQUFDLENBQUMsTUFBTSxDQUFDO0lBRW5FLE9BQU87UUFDTCxVQUFVLEVBQUUsR0FBRztRQUNmLE9BQU87UUFDUCxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQztZQUNuQixZQUFZO1lBQ1osTUFBTTtZQUNOLEtBQUssRUFBRSxRQUFRLENBQUMsTUFBTTtTQUN2QixDQUFDO0tBQ0gsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEFsZXJ0cyBBUEkgTGFtYmRhXG4gKlxuICogSGFuZGxlcyBhbGVydCBvcGVyYXRpb25zOlxuICogLSBHRVQgL2FsZXJ0cyAtIExpc3QgYWxsIGFsZXJ0cyAod2l0aCBvcHRpb25hbCBmaWx0ZXJzKVxuICogLSBHRVQgL2FsZXJ0cy97YWxlcnRfaWR9IC0gR2V0IHNpbmdsZSBhbGVydFxuICogLSBQT1NUIC9hbGVydHMve2FsZXJ0X2lkfS9hY2tub3dsZWRnZSAtIEFja25vd2xlZGdlIGFuIGFsZXJ0XG4gKiAtIFBPU1QgL2FsZXJ0cy9hY2tub3dsZWRnZS1hbGwgLSBCdWxrIGFja25vd2xlZGdlIGFsZXJ0c1xuICovXG5cbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7XG4gIER5bmFtb0RCRG9jdW1lbnRDbGllbnQsXG4gIFNjYW5Db21tYW5kLFxuICBRdWVyeUNvbW1hbmQsXG4gIEdldENvbW1hbmQsXG4gIFVwZGF0ZUNvbW1hbmQsXG4gIEJhdGNoV3JpdGVDb21tYW5kLFxufSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuXG5jb25zdCBkZGJDbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGRkYkNsaWVudCk7XG5cbmNvbnN0IEFMRVJUU19UQUJMRSA9IHByb2Nlc3MuZW52LkFMRVJUU19UQUJMRSE7XG5jb25zdCBERVZJQ0VfQUxJQVNFU19UQUJMRSA9IHByb2Nlc3MuZW52LkRFVklDRV9BTElBU0VTX1RBQkxFIHx8ICdzb25nYmlyZC1kZXZpY2UtYWxpYXNlcyc7XG5cbi8qKlxuICogR2V0IGFsbCBkZXZpY2VfdWlkcyBhc3NvY2lhdGVkIHdpdGggYSBzZXJpYWwgbnVtYmVyXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGdldEFsbERldmljZVVpZHNGb3JTZXJpYWwoc2VyaWFsTnVtYmVyOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBHZXRDb21tYW5kKHtcbiAgICBUYWJsZU5hbWU6IERFVklDRV9BTElBU0VTX1RBQkxFLFxuICAgIEtleTogeyBzZXJpYWxfbnVtYmVyOiBzZXJpYWxOdW1iZXIgfSxcbiAgfSkpO1xuXG4gIGlmICghcmVzdWx0Lkl0ZW0pIHtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICAvLyBSZXR1cm4gY3VycmVudCBkZXZpY2VfdWlkIHBsdXMgYW55IGhpc3RvcmljYWwgb25lc1xuICBjb25zdCBkZXZpY2VVaWRzID0gW3Jlc3VsdC5JdGVtLmRldmljZV91aWRdO1xuICBpZiAocmVzdWx0Lkl0ZW0ucHJldmlvdXNfZGV2aWNlX3VpZHMgJiYgQXJyYXkuaXNBcnJheShyZXN1bHQuSXRlbS5wcmV2aW91c19kZXZpY2VfdWlkcykpIHtcbiAgICBkZXZpY2VVaWRzLnB1c2goLi4ucmVzdWx0Lkl0ZW0ucHJldmlvdXNfZGV2aWNlX3VpZHMpO1xuICB9XG4gIHJldHVybiBkZXZpY2VVaWRzO1xufVxuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQpOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4gPT4ge1xuICBjb25zb2xlLmxvZygnUmVxdWVzdDonLCBKU09OLnN0cmluZ2lmeShldmVudCkpO1xuXG4gIGNvbnN0IGNvcnNIZWFkZXJzID0ge1xuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLEF1dGhvcml6YXRpb24nLFxuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzJzogJ0dFVCxQT1NULE9QVElPTlMnLFxuICB9O1xuXG4gIHRyeSB7XG4gICAgY29uc3QgbWV0aG9kID0gKGV2ZW50LnJlcXVlc3RDb250ZXh0IGFzIGFueSk/Lmh0dHA/Lm1ldGhvZCB8fCBldmVudC5odHRwTWV0aG9kO1xuICAgIGNvbnN0IGFsZXJ0SWQgPSBldmVudC5wYXRoUGFyYW1ldGVycz8uYWxlcnRfaWQ7XG4gICAgY29uc3QgcGF0aCA9IChldmVudCBhcyBhbnkpLnJhd1BhdGggfHwgZXZlbnQucGF0aCB8fCAnJztcblxuICAgIGlmIChtZXRob2QgPT09ICdPUFRJT05TJykge1xuICAgICAgcmV0dXJuIHsgc3RhdHVzQ29kZTogMjAwLCBoZWFkZXJzOiBjb3JzSGVhZGVycywgYm9keTogJycgfTtcbiAgICB9XG5cbiAgICAvLyBQT1NUIC9hbGVydHMvYWNrbm93bGVkZ2UtYWxsXG4gICAgaWYgKG1ldGhvZCA9PT0gJ1BPU1QnICYmIHBhdGguZW5kc1dpdGgoJy9hY2tub3dsZWRnZS1hbGwnKSkge1xuICAgICAgcmV0dXJuIGF3YWl0IGJ1bGtBY2tub3dsZWRnZUFsZXJ0cyhldmVudCwgY29yc0hlYWRlcnMpO1xuICAgIH1cblxuICAgIC8vIFBPU1QgL2FsZXJ0cy97YWxlcnRfaWR9L2Fja25vd2xlZGdlXG4gICAgaWYgKG1ldGhvZCA9PT0gJ1BPU1QnICYmIGFsZXJ0SWQgJiYgcGF0aC5lbmRzV2l0aCgnL2Fja25vd2xlZGdlJykpIHtcbiAgICAgIHJldHVybiBhd2FpdCBhY2tub3dsZWRnZUFsZXJ0KGFsZXJ0SWQsIGV2ZW50LCBjb3JzSGVhZGVycyk7XG4gICAgfVxuXG4gICAgLy8gR0VUIC9hbGVydHMve2FsZXJ0X2lkfVxuICAgIGlmIChtZXRob2QgPT09ICdHRVQnICYmIGFsZXJ0SWQpIHtcbiAgICAgIHJldHVybiBhd2FpdCBnZXRBbGVydChhbGVydElkLCBjb3JzSGVhZGVycyk7XG4gICAgfVxuXG4gICAgLy8gR0VUIC9hbGVydHNcbiAgICBpZiAobWV0aG9kID09PSAnR0VUJyAmJiAhYWxlcnRJZCkge1xuICAgICAgcmV0dXJuIGF3YWl0IGxpc3RBbGVydHMoZXZlbnQsIGNvcnNIZWFkZXJzKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNDA1LFxuICAgICAgaGVhZGVyczogY29yc0hlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnTWV0aG9kIG5vdCBhbGxvd2VkJyB9KSxcbiAgICB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yOicsIGVycm9yKTtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNTAwLFxuICAgICAgaGVhZGVyczogY29yc0hlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyB9KSxcbiAgICB9O1xuICB9XG59O1xuXG5hc3luYyBmdW5jdGlvbiBsaXN0QWxlcnRzKFxuICBldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQsXG4gIGhlYWRlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XG4gIGNvbnN0IHF1ZXJ5UGFyYW1zID0gZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzIHx8IHt9O1xuICBjb25zdCBzZXJpYWxOdW1iZXIgPSBxdWVyeVBhcmFtcy5zZXJpYWxfbnVtYmVyIHx8IHF1ZXJ5UGFyYW1zLmRldmljZV91aWQ7IC8vIFN1cHBvcnQgYm90aCBmb3IgYmFja3dhcmRzIGNvbXBhdFxuICBjb25zdCBhY2tub3dsZWRnZWQgPSBxdWVyeVBhcmFtcy5hY2tub3dsZWRnZWQ7XG4gIGNvbnN0IGxpbWl0ID0gcGFyc2VJbnQocXVlcnlQYXJhbXMubGltaXQgfHwgJzEwMCcpO1xuXG4gIGxldCBpdGVtczogYW55W10gPSBbXTtcblxuICBpZiAoc2VyaWFsTnVtYmVyKSB7XG4gICAgLy8gUmVzb2x2ZSBzZXJpYWwgbnVtYmVyIHRvIGRldmljZV91aWQocylcbiAgICBjb25zdCBkZXZpY2VVaWRzID0gYXdhaXQgZ2V0QWxsRGV2aWNlVWlkc0ZvclNlcmlhbChzZXJpYWxOdW1iZXIpO1xuXG4gICAgaWYgKGRldmljZVVpZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAvLyBObyBkZXZpY2UgZm91bmQgZm9yIHRoaXMgc2VyaWFsIG51bWJlclxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgYWxlcnRzOiBbXSxcbiAgICAgICAgICBjb3VudDogMCxcbiAgICAgICAgICBhY3RpdmVfY291bnQ6IDAsXG4gICAgICAgIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBRdWVyeSBhbGVydHMgZm9yIGFsbCBkZXZpY2VfdWlkcyBhbmQgbWVyZ2VcbiAgICBjb25zdCBhbGxSZXN1bHRzID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICBkZXZpY2VVaWRzLm1hcChhc3luYyAoZGV2aWNlVWlkKSA9PiB7XG4gICAgICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgICAgICBUYWJsZU5hbWU6IEFMRVJUU19UQUJMRSxcbiAgICAgICAgICBJbmRleE5hbWU6ICdkZXZpY2UtaW5kZXgnLFxuICAgICAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdkZXZpY2VfdWlkID0gOmRldmljZV91aWQnLFxuICAgICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHsgJzpkZXZpY2VfdWlkJzogZGV2aWNlVWlkIH0sXG4gICAgICAgICAgU2NhbkluZGV4Rm9yd2FyZDogZmFsc2UsXG4gICAgICAgICAgTGltaXQ6IGxpbWl0LFxuICAgICAgICB9KTtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgICAgIHJldHVybiByZXN1bHQuSXRlbXMgfHwgW107XG4gICAgICB9KVxuICAgICk7XG5cbiAgICAvLyBNZXJnZSBhbmQgc29ydCBieSBjcmVhdGVkX2F0IGRlc2NlbmRpbmdcbiAgICBpdGVtcyA9IGFsbFJlc3VsdHMuZmxhdCgpLnNvcnQoKGEsIGIpID0+IChiLmNyZWF0ZWRfYXQgfHwgMCkgLSAoYS5jcmVhdGVkX2F0IHx8IDApKTtcbiAgICBpdGVtcyA9IGl0ZW1zLnNsaWNlKDAsIGxpbWl0KTtcbiAgfSBlbHNlIGlmIChhY2tub3dsZWRnZWQgPT09ICdmYWxzZScpIHtcbiAgICAvLyBRdWVyeSBvbmx5IHVuYWNrbm93bGVkZ2VkIGFsZXJ0c1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogQUxFUlRTX1RBQkxFLFxuICAgICAgSW5kZXhOYW1lOiAnc3RhdHVzLWluZGV4JyxcbiAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdhY2tub3dsZWRnZWQgPSA6YWNrJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHsgJzphY2snOiAnZmFsc2UnIH0sXG4gICAgICBTY2FuSW5kZXhGb3J3YXJkOiBmYWxzZSxcbiAgICAgIExpbWl0OiBsaW1pdCxcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIGl0ZW1zID0gcmVzdWx0Lkl0ZW1zIHx8IFtdO1xuICB9IGVsc2Uge1xuICAgIC8vIFNjYW4gYWxsIGFsZXJ0c1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgU2NhbkNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBBTEVSVFNfVEFCTEUsXG4gICAgICBMaW1pdDogbGltaXQsXG4gICAgfSk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICBpdGVtcyA9IHJlc3VsdC5JdGVtcyB8fCBbXTtcblxuICAgIC8vIFNvcnQgYnkgY3JlYXRlZF9hdCBkZXNjZW5kaW5nXG4gICAgaXRlbXMuc29ydCgoYSwgYikgPT4gKGIuY3JlYXRlZF9hdCB8fCAwKSAtIChhLmNyZWF0ZWRfYXQgfHwgMCkpO1xuICB9XG5cbiAgLy8gQ2FsY3VsYXRlIHN0YXRzXG4gIGNvbnN0IGFjdGl2ZUNvdW50ID0gaXRlbXMuZmlsdGVyKGEgPT4gYS5hY2tub3dsZWRnZWQgPT09ICdmYWxzZScpLmxlbmd0aDtcblxuICByZXR1cm4ge1xuICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICBoZWFkZXJzLFxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIGFsZXJ0czogaXRlbXMsXG4gICAgICBjb3VudDogaXRlbXMubGVuZ3RoLFxuICAgICAgYWN0aXZlX2NvdW50OiBhY3RpdmVDb3VudCxcbiAgICB9KSxcbiAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0QWxlcnQoXG4gIGFsZXJ0SWQ6IHN0cmluZyxcbiAgaGVhZGVyczogUmVjb3JkPHN0cmluZywgc3RyaW5nPlxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+IHtcbiAgY29uc3QgY29tbWFuZCA9IG5ldyBHZXRDb21tYW5kKHtcbiAgICBUYWJsZU5hbWU6IEFMRVJUU19UQUJMRSxcbiAgICBLZXk6IHsgYWxlcnRfaWQ6IGFsZXJ0SWQgfSxcbiAgfSk7XG5cbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG5cbiAgaWYgKCFyZXN1bHQuSXRlbSkge1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA0MDQsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0FsZXJ0IG5vdCBmb3VuZCcgfSksXG4gICAgfTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgc3RhdHVzQ29kZTogMjAwLFxuICAgIGhlYWRlcnMsXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkocmVzdWx0Lkl0ZW0pLFxuICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBhY2tub3dsZWRnZUFsZXJ0KFxuICBhbGVydElkOiBzdHJpbmcsXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCxcbiAgaGVhZGVyczogUmVjb3JkPHN0cmluZywgc3RyaW5nPlxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+IHtcbiAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcblxuICAvLyBQYXJzZSBib2R5IGZvciBvcHRpb25hbCBhY2tub3dsZWRnbWVudCBkZXRhaWxzXG4gIGxldCBhY2tub3dsZWRnZWRCeSA9ICdzeXN0ZW0nO1xuICBpZiAoZXZlbnQuYm9keSkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBib2R5ID0gSlNPTi5wYXJzZShldmVudC5ib2R5KTtcbiAgICAgIGFja25vd2xlZGdlZEJ5ID0gYm9keS5hY2tub3dsZWRnZWRfYnkgfHwgJ3N5c3RlbSc7XG4gICAgfSBjYXRjaCB7XG4gICAgICAvLyBJZ25vcmUgcGFyc2UgZXJyb3JzXG4gICAgfVxuICB9XG5cbiAgY29uc3QgY29tbWFuZCA9IG5ldyBVcGRhdGVDb21tYW5kKHtcbiAgICBUYWJsZU5hbWU6IEFMRVJUU19UQUJMRSxcbiAgICBLZXk6IHsgYWxlcnRfaWQ6IGFsZXJ0SWQgfSxcbiAgICBVcGRhdGVFeHByZXNzaW9uOiAnU0VUIGFja25vd2xlZGdlZCA9IDphY2ssIGFja25vd2xlZGdlZF9hdCA9IDphY2tfYXQsIGFja25vd2xlZGdlZF9ieSA9IDphY2tfYnknLFxuICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICc6YWNrJzogJ3RydWUnLFxuICAgICAgJzphY2tfYXQnOiBub3csXG4gICAgICAnOmFja19ieSc6IGFja25vd2xlZGdlZEJ5LFxuICAgIH0sXG4gICAgUmV0dXJuVmFsdWVzOiAnQUxMX05FVycsXG4gIH0pO1xuXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuXG4gIHJldHVybiB7XG4gICAgc3RhdHVzQ29kZTogMjAwLFxuICAgIGhlYWRlcnMsXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkocmVzdWx0LkF0dHJpYnV0ZXMpLFxuICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBidWxrQWNrbm93bGVkZ2VBbGVydHMoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCxcbiAgaGVhZGVyczogUmVjb3JkPHN0cmluZywgc3RyaW5nPlxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+IHtcbiAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcblxuICAvLyBQYXJzZSBib2R5IGZvciBhbGVydCBJRHMgYW5kIGFja25vd2xlZGdtZW50IGRldGFpbHNcbiAgbGV0IGFsZXJ0SWRzOiBzdHJpbmdbXSA9IFtdO1xuICBsZXQgYWNrbm93bGVkZ2VkQnkgPSAnc3lzdGVtJztcblxuICBpZiAoZXZlbnQuYm9keSkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBib2R5ID0gSlNPTi5wYXJzZShldmVudC5ib2R5KTtcbiAgICAgIGFsZXJ0SWRzID0gYm9keS5hbGVydF9pZHMgfHwgW107XG4gICAgICBhY2tub3dsZWRnZWRCeSA9IGJvZHkuYWNrbm93bGVkZ2VkX2J5IHx8ICdzeXN0ZW0nO1xuICAgIH0gY2F0Y2gge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnSW52YWxpZCByZXF1ZXN0IGJvZHknIH0pLFxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICBpZiAoIWFsZXJ0SWRzLmxlbmd0aCkge1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA0MDAsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ2FsZXJ0X2lkcyBhcnJheSBpcyByZXF1aXJlZCcgfSksXG4gICAgfTtcbiAgfVxuXG4gIC8vIFVwZGF0ZSBlYWNoIGFsZXJ0IGluZGl2aWR1YWxseSAoRHluYW1vREIgZG9lc24ndCBzdXBwb3J0IGJhdGNoIHVwZGF0ZXMpXG4gIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQoXG4gICAgYWxlcnRJZHMubWFwKGFzeW5jIChhbGVydElkKSA9PiB7XG4gICAgICBjb25zdCBjb21tYW5kID0gbmV3IFVwZGF0ZUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IEFMRVJUU19UQUJMRSxcbiAgICAgICAgS2V5OiB7IGFsZXJ0X2lkOiBhbGVydElkIH0sXG4gICAgICAgIFVwZGF0ZUV4cHJlc3Npb246ICdTRVQgYWNrbm93bGVkZ2VkID0gOmFjaywgYWNrbm93bGVkZ2VkX2F0ID0gOmFja19hdCwgYWNrbm93bGVkZ2VkX2J5ID0gOmFja19ieScsXG4gICAgICAgIENvbmRpdGlvbkV4cHJlc3Npb246ICdhY2tub3dsZWRnZWQgPSA6bm90X2FjaycsXG4gICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgICAnOmFjayc6ICd0cnVlJyxcbiAgICAgICAgICAnOmFja19hdCc6IG5vdyxcbiAgICAgICAgICAnOmFja19ieSc6IGFja25vd2xlZGdlZEJ5LFxuICAgICAgICAgICc6bm90X2Fjayc6ICdmYWxzZScsXG4gICAgICAgIH0sXG4gICAgICAgIFJldHVyblZhbHVlczogJ0FMTF9ORVcnLFxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICB9KVxuICApO1xuXG4gIGNvbnN0IGFja25vd2xlZGdlZCA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gci5zdGF0dXMgPT09ICdmdWxmaWxsZWQnKS5sZW5ndGg7XG4gIGNvbnN0IGZhaWxlZCA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gci5zdGF0dXMgPT09ICdyZWplY3RlZCcpLmxlbmd0aDtcblxuICByZXR1cm4ge1xuICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICBoZWFkZXJzLFxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIGFja25vd2xlZGdlZCxcbiAgICAgIGZhaWxlZCxcbiAgICAgIHRvdGFsOiBhbGVydElkcy5sZW5ndGgsXG4gICAgfSksXG4gIH07XG59XG4iXX0=