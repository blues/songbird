"use strict";
/**
 * Alerts API Lambda
 *
 * Handles alert operations:
 * - GET /alerts - List all alerts (with optional filters)
 * - GET /alerts/{alert_id} - Get single alert
 * - POST /alerts/{alert_id}/acknowledge - Acknowledge an alert
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient);
const ALERTS_TABLE = process.env.ALERTS_TABLE;
const handler = async (event) => {
    console.log('Request:', JSON.stringify(event));
    const corsHeaders = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type,Authorization',
        'Access-Control-Allow-Methods': 'GET,POST,OPTIONS',
    };
    try {
        const method = event.requestContext?.http?.method || event.httpMethod;
        const alertId = event.pathParameters?.alert_id;
        const path = event.rawPath || event.path || '';
        if (method === 'OPTIONS') {
            return { statusCode: 200, headers: corsHeaders, body: '' };
        }
        // POST /alerts/{alert_id}/acknowledge
        if (method === 'POST' && alertId && path.endsWith('/acknowledge')) {
            return await acknowledgeAlert(alertId, event, corsHeaders);
        }
        // GET /alerts/{alert_id}
        if (method === 'GET' && alertId) {
            return await getAlert(alertId, corsHeaders);
        }
        // GET /alerts
        if (method === 'GET' && !alertId) {
            return await listAlerts(event, corsHeaders);
        }
        return {
            statusCode: 405,
            headers: corsHeaders,
            body: JSON.stringify({ error: 'Method not allowed' }),
        };
    }
    catch (error) {
        console.error('Error:', error);
        return {
            statusCode: 500,
            headers: corsHeaders,
            body: JSON.stringify({ error: 'Internal server error' }),
        };
    }
};
exports.handler = handler;
async function listAlerts(event, headers) {
    const queryParams = event.queryStringParameters || {};
    const deviceUid = queryParams.device_uid;
    const acknowledged = queryParams.acknowledged;
    const limit = parseInt(queryParams.limit || '100');
    let items = [];
    if (deviceUid) {
        // Query alerts for a specific device
        const command = new lib_dynamodb_1.QueryCommand({
            TableName: ALERTS_TABLE,
            IndexName: 'device-index',
            KeyConditionExpression: 'device_uid = :device_uid',
            ExpressionAttributeValues: { ':device_uid': deviceUid },
            ScanIndexForward: false, // Most recent first
            Limit: limit,
        });
        const result = await docClient.send(command);
        items = result.Items || [];
    }
    else if (acknowledged === 'false') {
        // Query only unacknowledged alerts
        const command = new lib_dynamodb_1.QueryCommand({
            TableName: ALERTS_TABLE,
            IndexName: 'status-index',
            KeyConditionExpression: 'acknowledged = :ack',
            ExpressionAttributeValues: { ':ack': 'false' },
            ScanIndexForward: false,
            Limit: limit,
        });
        const result = await docClient.send(command);
        items = result.Items || [];
    }
    else {
        // Scan all alerts
        const command = new lib_dynamodb_1.ScanCommand({
            TableName: ALERTS_TABLE,
            Limit: limit,
        });
        const result = await docClient.send(command);
        items = result.Items || [];
        // Sort by created_at descending
        items.sort((a, b) => (b.created_at || 0) - (a.created_at || 0));
    }
    // Calculate stats
    const activeCount = items.filter(a => a.acknowledged === 'false').length;
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
            alerts: items,
            count: items.length,
            active_count: activeCount,
        }),
    };
}
async function getAlert(alertId, headers) {
    const command = new lib_dynamodb_1.GetCommand({
        TableName: ALERTS_TABLE,
        Key: { alert_id: alertId },
    });
    const result = await docClient.send(command);
    if (!result.Item) {
        return {
            statusCode: 404,
            headers,
            body: JSON.stringify({ error: 'Alert not found' }),
        };
    }
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify(result.Item),
    };
}
async function acknowledgeAlert(alertId, event, headers) {
    const now = Date.now();
    // Parse body for optional acknowledgment details
    let acknowledgedBy = 'system';
    if (event.body) {
        try {
            const body = JSON.parse(event.body);
            acknowledgedBy = body.acknowledged_by || 'system';
        }
        catch {
            // Ignore parse errors
        }
    }
    const command = new lib_dynamodb_1.UpdateCommand({
        TableName: ALERTS_TABLE,
        Key: { alert_id: alertId },
        UpdateExpression: 'SET acknowledged = :ack, acknowledged_at = :ack_at, acknowledged_by = :ack_by',
        ExpressionAttributeValues: {
            ':ack': 'true',
            ':ack_at': now,
            ':ack_by': acknowledgedBy,
        },
        ReturnValues: 'ALL_NEW',
    });
    const result = await docClient.send(command);
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify(result.Attributes),
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvYXBpLWFsZXJ0cy9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7R0FPRzs7O0FBRUgsOERBQTBEO0FBQzFELHdEQU0rQjtBQUcvQixNQUFNLFNBQVMsR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDekMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBRXpELE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBYSxDQUFDO0FBRXhDLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFBRSxLQUEyQixFQUFrQyxFQUFFO0lBQzNGLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUUvQyxNQUFNLFdBQVcsR0FBRztRQUNsQiw2QkFBNkIsRUFBRSxHQUFHO1FBQ2xDLDhCQUE4QixFQUFFLDRCQUE0QjtRQUM1RCw4QkFBOEIsRUFBRSxrQkFBa0I7S0FDbkQsQ0FBQztJQUVGLElBQUksQ0FBQztRQUNILE1BQU0sTUFBTSxHQUFJLEtBQUssQ0FBQyxjQUFzQixFQUFFLElBQUksRUFBRSxNQUFNLElBQUksS0FBSyxDQUFDLFVBQVUsQ0FBQztRQUMvRSxNQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMsY0FBYyxFQUFFLFFBQVEsQ0FBQztRQUMvQyxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLElBQUksRUFBRSxDQUFDO1FBRS9DLElBQUksTUFBTSxLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQ3pCLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxDQUFDO1FBQzdELENBQUM7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QUUsU0FBUztLQUN4QixDQUFDLENBQUM7SUFFSCxNQUFNLE1BQU0sR0FBRyxNQUFNLFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFN0MsT0FBTztRQUNMLFVBQVUsRUFBRSxHQUFHO1FBQ2YsT0FBTztRQUNQLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUM7S0FDeEMsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEFsZXJ0cyBBUEkgTGFtYmRhXG4gKlxuICogSGFuZGxlcyBhbGVydCBvcGVyYXRpb25zOlxuICogLSBHRVQgL2FsZXJ0cyAtIExpc3QgYWxsIGFsZXJ0cyAod2l0aCBvcHRpb25hbCBmaWx0ZXJzKVxuICogLSBHRVQgL2FsZXJ0cy97YWxlcnRfaWR9IC0gR2V0IHNpbmdsZSBhbGVydFxuICogLSBQT1NUIC9hbGVydHMve2FsZXJ0X2lkfS9hY2tub3dsZWRnZSAtIEFja25vd2xlZGdlIGFuIGFsZXJ0XG4gKi9cblxuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHtcbiAgRHluYW1vREJEb2N1bWVudENsaWVudCxcbiAgU2NhbkNvbW1hbmQsXG4gIFF1ZXJ5Q29tbWFuZCxcbiAgR2V0Q29tbWFuZCxcbiAgVXBkYXRlQ29tbWFuZCxcbn0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcbmltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBBUElHYXRld2F5UHJveHlSZXN1bHQgfSBmcm9tICdhd3MtbGFtYmRhJztcblxuY29uc3QgZGRiQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkZGJDbGllbnQpO1xuXG5jb25zdCBBTEVSVFNfVEFCTEUgPSBwcm9jZXNzLmVudi5BTEVSVFNfVEFCTEUhO1xuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQpOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4gPT4ge1xuICBjb25zb2xlLmxvZygnUmVxdWVzdDonLCBKU09OLnN0cmluZ2lmeShldmVudCkpO1xuXG4gIGNvbnN0IGNvcnNIZWFkZXJzID0ge1xuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLEF1dGhvcml6YXRpb24nLFxuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzJzogJ0dFVCxQT1NULE9QVElPTlMnLFxuICB9O1xuXG4gIHRyeSB7XG4gICAgY29uc3QgbWV0aG9kID0gKGV2ZW50LnJlcXVlc3RDb250ZXh0IGFzIGFueSk/Lmh0dHA/Lm1ldGhvZCB8fCBldmVudC5odHRwTWV0aG9kO1xuICAgIGNvbnN0IGFsZXJ0SWQgPSBldmVudC5wYXRoUGFyYW1ldGVycz8uYWxlcnRfaWQ7XG4gICAgY29uc3QgcGF0aCA9IGV2ZW50LnJhd1BhdGggfHwgZXZlbnQucGF0aCB8fCAnJztcblxuICAgIGlmIChtZXRob2QgPT09ICdPUFRJT05TJykge1xuICAgICAgcmV0dXJuIHsgc3RhdHVzQ29kZTogMjAwLCBoZWFkZXJzOiBjb3JzSGVhZGVycywgYm9keTogJycgfTtcbiAgICB9XG5cbiAgICAvLyBQT1NUIC9hbGVydHMve2FsZXJ0X2lkfS9hY2tub3dsZWRnZVxuICAgIGlmIChtZXRob2QgPT09ICdQT1NUJyAmJiBhbGVydElkICYmIHBhdGguZW5kc1dpdGgoJy9hY2tub3dsZWRnZScpKSB7XG4gICAgICByZXR1cm4gYXdhaXQgYWNrbm93bGVkZ2VBbGVydChhbGVydElkLCBldmVudCwgY29yc0hlYWRlcnMpO1xuICAgIH1cblxuICAgIC8vIEdFVCAvYWxlcnRzL3thbGVydF9pZH1cbiAgICBpZiAobWV0aG9kID09PSAnR0VUJyAmJiBhbGVydElkKSB7XG4gICAgICByZXR1cm4gYXdhaXQgZ2V0QWxlcnQoYWxlcnRJZCwgY29yc0hlYWRlcnMpO1xuICAgIH1cblxuICAgIC8vIEdFVCAvYWxlcnRzXG4gICAgaWYgKG1ldGhvZCA9PT0gJ0dFVCcgJiYgIWFsZXJ0SWQpIHtcbiAgICAgIHJldHVybiBhd2FpdCBsaXN0QWxlcnRzKGV2ZW50LCBjb3JzSGVhZGVycyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDQwNSxcbiAgICAgIGhlYWRlcnM6IGNvcnNIZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ01ldGhvZCBub3QgYWxsb3dlZCcgfSksXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICAgIGhlYWRlcnM6IGNvcnNIZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicgfSksXG4gICAgfTtcbiAgfVxufTtcblxuYXN5bmMgZnVuY3Rpb24gbGlzdEFsZXJ0cyhcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50LFxuICBoZWFkZXJzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+XG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4ge1xuICBjb25zdCBxdWVyeVBhcmFtcyA9IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycyB8fCB7fTtcbiAgY29uc3QgZGV2aWNlVWlkID0gcXVlcnlQYXJhbXMuZGV2aWNlX3VpZDtcbiAgY29uc3QgYWNrbm93bGVkZ2VkID0gcXVlcnlQYXJhbXMuYWNrbm93bGVkZ2VkO1xuICBjb25zdCBsaW1pdCA9IHBhcnNlSW50KHF1ZXJ5UGFyYW1zLmxpbWl0IHx8ICcxMDAnKTtcblxuICBsZXQgaXRlbXM6IGFueVtdID0gW107XG5cbiAgaWYgKGRldmljZVVpZCkge1xuICAgIC8vIFF1ZXJ5IGFsZXJ0cyBmb3IgYSBzcGVjaWZpYyBkZXZpY2VcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IEFMRVJUU19UQUJMRSxcbiAgICAgIEluZGV4TmFtZTogJ2RldmljZS1pbmRleCcsXG4gICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnZGV2aWNlX3VpZCA9IDpkZXZpY2VfdWlkJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHsgJzpkZXZpY2VfdWlkJzogZGV2aWNlVWlkIH0sXG4gICAgICBTY2FuSW5kZXhGb3J3YXJkOiBmYWxzZSwgLy8gTW9zdCByZWNlbnQgZmlyc3RcbiAgICAgIExpbWl0OiBsaW1pdCxcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIGl0ZW1zID0gcmVzdWx0Lkl0ZW1zIHx8IFtdO1xuICB9IGVsc2UgaWYgKGFja25vd2xlZGdlZCA9PT0gJ2ZhbHNlJykge1xuICAgIC8vIFF1ZXJ5IG9ubHkgdW5hY2tub3dsZWRnZWQgYWxlcnRzXG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBBTEVSVFNfVEFCTEUsXG4gICAgICBJbmRleE5hbWU6ICdzdGF0dXMtaW5kZXgnLFxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJ2Fja25vd2xlZGdlZCA9IDphY2snLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogeyAnOmFjayc6ICdmYWxzZScgfSxcbiAgICAgIFNjYW5JbmRleEZvcndhcmQ6IGZhbHNlLFxuICAgICAgTGltaXQ6IGxpbWl0LFxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgaXRlbXMgPSByZXN1bHQuSXRlbXMgfHwgW107XG4gIH0gZWxzZSB7XG4gICAgLy8gU2NhbiBhbGwgYWxlcnRzXG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBTY2FuQ29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IEFMRVJUU19UQUJMRSxcbiAgICAgIExpbWl0OiBsaW1pdCxcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIGl0ZW1zID0gcmVzdWx0Lkl0ZW1zIHx8IFtdO1xuXG4gICAgLy8gU29ydCBieSBjcmVhdGVkX2F0IGRlc2NlbmRpbmdcbiAgICBpdGVtcy5zb3J0KChhLCBiKSA9PiAoYi5jcmVhdGVkX2F0IHx8IDApIC0gKGEuY3JlYXRlZF9hdCB8fCAwKSk7XG4gIH1cblxuICAvLyBDYWxjdWxhdGUgc3RhdHNcbiAgY29uc3QgYWN0aXZlQ291bnQgPSBpdGVtcy5maWx0ZXIoYSA9PiBhLmFja25vd2xlZGdlZCA9PT0gJ2ZhbHNlJykubGVuZ3RoO1xuXG4gIHJldHVybiB7XG4gICAgc3RhdHVzQ29kZTogMjAwLFxuICAgIGhlYWRlcnMsXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgYWxlcnRzOiBpdGVtcyxcbiAgICAgIGNvdW50OiBpdGVtcy5sZW5ndGgsXG4gICAgICBhY3RpdmVfY291bnQ6IGFjdGl2ZUNvdW50LFxuICAgIH0pLFxuICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRBbGVydChcbiAgYWxlcnRJZDogc3RyaW5nLFxuICBoZWFkZXJzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+XG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4ge1xuICBjb25zdCBjb21tYW5kID0gbmV3IEdldENvbW1hbmQoe1xuICAgIFRhYmxlTmFtZTogQUxFUlRTX1RBQkxFLFxuICAgIEtleTogeyBhbGVydF9pZDogYWxlcnRJZCB9LFxuICB9KTtcblxuICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcblxuICBpZiAoIXJlc3VsdC5JdGVtKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDQwNCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnQWxlcnQgbm90IGZvdW5kJyB9KSxcbiAgICB9O1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgaGVhZGVycyxcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeShyZXN1bHQuSXRlbSksXG4gIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGFja25vd2xlZGdlQWxlcnQoXG4gIGFsZXJ0SWQ6IHN0cmluZyxcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50LFxuICBoZWFkZXJzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+XG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4ge1xuICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuXG4gIC8vIFBhcnNlIGJvZHkgZm9yIG9wdGlvbmFsIGFja25vd2xlZGdtZW50IGRldGFpbHNcbiAgbGV0IGFja25vd2xlZGdlZEJ5ID0gJ3N5c3RlbSc7XG4gIGlmIChldmVudC5ib2R5KSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGJvZHkgPSBKU09OLnBhcnNlKGV2ZW50LmJvZHkpO1xuICAgICAgYWNrbm93bGVkZ2VkQnkgPSBib2R5LmFja25vd2xlZGdlZF9ieSB8fCAnc3lzdGVtJztcbiAgICB9IGNhdGNoIHtcbiAgICAgIC8vIElnbm9yZSBwYXJzZSBlcnJvcnNcbiAgICB9XG4gIH1cblxuICBjb25zdCBjb21tYW5kID0gbmV3IFVwZGF0ZUNvbW1hbmQoe1xuICAgIFRhYmxlTmFtZTogQUxFUlRTX1RBQkxFLFxuICAgIEtleTogeyBhbGVydF9pZDogYWxlcnRJZCB9LFxuICAgIFVwZGF0ZUV4cHJlc3Npb246ICdTRVQgYWNrbm93bGVkZ2VkID0gOmFjaywgYWNrbm93bGVkZ2VkX2F0ID0gOmFja19hdCwgYWNrbm93bGVkZ2VkX2J5ID0gOmFja19ieScsXG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgJzphY2snOiAndHJ1ZScsXG4gICAgICAnOmFja19hdCc6IG5vdyxcbiAgICAgICc6YWNrX2J5JzogYWNrbm93bGVkZ2VkQnksXG4gICAgfSxcbiAgICBSZXR1cm5WYWx1ZXM6ICdBTExfTkVXJyxcbiAgfSk7XG5cbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG5cbiAgcmV0dXJuIHtcbiAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgaGVhZGVycyxcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeShyZXN1bHQuQXR0cmlidXRlcyksXG4gIH07XG59XG4iXX0=