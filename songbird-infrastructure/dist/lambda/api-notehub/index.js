"use strict";
/**
 * API Notehub Lambda
 *
 * Fetches Notehub project status and route information.
 * Available to all authenticated users.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_secrets_manager_1 = require("@aws-sdk/client-secrets-manager");
const secretsClient = new client_secrets_manager_1.SecretsManagerClient({});
const NOTEHUB_PROJECT_UID = process.env.NOTEHUB_PROJECT_UID || '';
const NOTEHUB_SECRET_ARN = process.env.NOTEHUB_SECRET_ARN || '';
const headers = {
    'Content-Type': 'application/json',
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type,Authorization',
    'Access-Control-Allow-Methods': 'GET,OPTIONS',
};
// Cache the token to avoid fetching on every request
let cachedToken = null;
async function getNotehubToken() {
    if (cachedToken) {
        return cachedToken;
    }
    const command = new client_secrets_manager_1.GetSecretValueCommand({ SecretId: NOTEHUB_SECRET_ARN });
    const response = await secretsClient.send(command);
    if (!response.SecretString) {
        throw new Error('Notehub API token not found in secret');
    }
    const secret = JSON.parse(response.SecretString);
    cachedToken = secret.token;
    if (!cachedToken) {
        throw new Error('Token field not found in secret');
    }
    return cachedToken;
}
async function fetchNotehubApi(path) {
    const token = await getNotehubToken();
    const response = await fetch(`https://api.notefile.net${path}`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
        },
    });
    if (!response.ok) {
        throw new Error(`Notehub API error: ${response.status} ${response.statusText}`);
    }
    return response.json();
}
async function getProjectInfo() {
    return fetchNotehubApi(`/v1/projects/${NOTEHUB_PROJECT_UID}`);
}
async function getRoutes() {
    // Notehub returns routes as a direct array, not wrapped in { routes: [...] }
    const routes = await fetchNotehubApi(`/v1/projects/${NOTEHUB_PROJECT_UID}/routes`);
    console.log('Notehub routes response:', JSON.stringify(routes, null, 2));
    return routes || [];
}
async function getFleets() {
    const result = await fetchNotehubApi(`/v1/projects/${NOTEHUB_PROJECT_UID}/fleets`);
    return result.fleets || [];
}
async function getDeviceCount() {
    const result = await fetchNotehubApi(`/v1/projects/${NOTEHUB_PROJECT_UID}/devices?pageSize=1`);
    // The API doesn't return total count directly, so we'll use a summary endpoint or estimate
    // For now, let's fetch all devices (up to a reasonable limit)
    const fullResult = await fetchNotehubApi(`/v1/projects/${NOTEHUB_PROJECT_UID}/devices?pageSize=500`);
    return fullResult.devices?.length || 0;
}
async function handler(event) {
    console.log('Event:', JSON.stringify(event, null, 2));
    const method = event.requestContext.http.method;
    const path = event.rawPath;
    // Handle OPTIONS for CORS
    if (method === 'OPTIONS') {
        return { statusCode: 200, headers, body: '' };
    }
    try {
        // GET /v1/notehub/status - Get full Notehub connection status
        if (method === 'GET' && path === '/v1/notehub/status') {
            // Fetch all data in parallel
            const [project, routes, fleets, deviceCount] = await Promise.all([
                getProjectInfo(),
                getRoutes(),
                getFleets(),
                getDeviceCount(),
            ]);
            // Determine overall health
            const activeRoutes = routes.filter(r => !r.disabled);
            console.log('Routes:', routes.length, 'Active routes:', activeRoutes.length);
            console.log('Route details:', routes.map(r => ({ name: r.label, disabled: r.disabled })));
            const health = activeRoutes.length > 0 ? 'healthy' : 'warning';
            return {
                statusCode: 200,
                headers,
                body: JSON.stringify({
                    project: {
                        uid: project.uid,
                        name: project.label,
                        created: project.created,
                    },
                    routes: routes.map(r => ({
                        uid: r.uid,
                        name: r.label,
                        type: r.type,
                        url: r.url,
                        enabled: !r.disabled,
                        modified: r.modified,
                    })),
                    fleets: fleets.map(f => ({
                        uid: f.uid,
                        name: f.label,
                        created: f.created,
                    })),
                    device_count: deviceCount,
                    health,
                    last_checked: new Date().toISOString(),
                }),
            };
        }
        // GET /v1/notehub/fleets - Get available fleets
        if (method === 'GET' && path === '/v1/notehub/fleets') {
            const fleets = await getFleets();
            return {
                statusCode: 200,
                headers,
                body: JSON.stringify({
                    fleets: fleets.map(f => ({
                        uid: f.uid,
                        name: f.label,
                        created: f.created,
                    })),
                }),
            };
        }
        return {
            statusCode: 404,
            headers,
            body: JSON.stringify({ error: 'Not found' }),
        };
    }
    catch (error) {
        console.error('Error:', error);
        const errorMessage = error instanceof Error ? error.message : 'Internal server error';
        // Return degraded status if we can't connect
        if (path === '/v1/notehub/status') {
            return {
                statusCode: 200,
                headers,
                body: JSON.stringify({
                    project: {
                        uid: NOTEHUB_PROJECT_UID,
                        name: 'Unknown',
                    },
                    routes: [],
                    fleets: [],
                    device_count: 0,
                    health: 'error',
                    error: errorMessage,
                    last_checked: new Date().toISOString(),
                }),
            };
        }
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: errorMessage }),
        };
    }
}
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvYXBpLW5vdGVodWIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7OztHQUtHOzs7QUFFSCw0RUFBOEY7QUFHOUYsTUFBTSxhQUFhLEdBQUcsSUFBSSw2Q0FBb0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUVuRCxNQUFNLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLElBQUksRUFBRSxDQUFDO0FBQ2xFLE1BQU0sa0JBQWtCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsSUFBSSxFQUFFLENBQUM7QUFFaEUsTUFBTSxPQUFPLEdBQUc7SUFDZCxjQUFjLEVBQUUsa0JBQWtCO0lBQ2xDLDZCQUE2QixFQUFFLEdBQUc7SUFDbEMsOEJBQThCLEVBQUUsNEJBQTRCO0lBQzVELDhCQUE4QixFQUFFLGFBQWE7Q0FDOUMsQ0FBQztBQUVGLHFEQUFxRDtBQUNyRCxJQUFJLFdBQVcsR0FBa0IsSUFBSSxDQUFDO0FBRXRDLEtBQUssVUFBVSxlQUFlO0lBQzVCLElBQUksV0FBVyxFQUFFLENBQUM7UUFDaEIsT0FBTyxXQUFXLENBQUM7SUFDckIsQ0FBQztJQUVELE1BQU0sT0FBTyxHQUFHLElBQUksOENBQXFCLENBQUMsRUFBRSxRQUFRLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQyxDQUFDO0lBQzVFLE1BQU0sUUFBUSxHQUFHLE1BQU0sYUFBYSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUVuRCxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQzNCLE1BQU0sSUFBSSxLQUFLLENBQUMsdUNBQXVDLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBRUQsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDakQsV0FBVyxHQUFHLE1BQU0sQ0FB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QUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQy9CLE1BQU0sWUFBWSxHQUFHLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLHVCQUF1QixDQUFDO1FBRXRGLDZDQUE2QztRQUM3QyxJQUFJLElBQUksS0FBSyxvQkFBb0IsRUFBRSxDQUFDO1lBQ2xDLE9BQU87Z0JBQ0wsVUFBVSxFQUFFLEdBQUc7Z0JBQ2YsT0FBTztnQkFDUCxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQztvQkFDbkIsT0FBTyxFQUFFO3dCQUNQLEdBQUcsRUFBRSxtQkFBbUI7d0JBQ3hCLElBQUksRUFBRSxTQUFTO3FCQUNoQjtvQkFDRCxNQUFNLEVBQUUsRUFBRTtvQkFDVixNQUFNLEVBQUUsRUFBRTtvQkFDVixZQUFZLEVBQUUsQ0FBQztvQkFDZixNQUFNLEVBQUUsT0FBTztvQkFDZixLQUFLLEVBQUUsWUFBWTtvQkFDbkIsWUFBWSxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO2lCQUN2QyxDQUFDO2FBQ0gsQ0FBQztRQUNKLENBQUM7UUFFRCxPQUFPO1lBQ0wsVUFBVSxFQUFFLEdBQUc7WUFDZixPQUFPO1lBQ1AsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLEVBQUUsWUFBWSxFQUFFLENBQUM7U0FDOUMsQ0FBQztJQUNKLENBQUM7QUFDSCxDQUFDO0FBN0dELDBCQTZHQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQVBJIE5vdGVodWIgTGFtYmRhXG4gKlxuICogRmV0Y2hlcyBOb3RlaHViIHByb2plY3Qgc3RhdHVzIGFuZCByb3V0ZSBpbmZvcm1hdGlvbi5cbiAqIEF2YWlsYWJsZSB0byBhbGwgYXV0aGVudGljYXRlZCB1c2Vycy5cbiAqL1xuXG5pbXBvcnQgeyBTZWNyZXRzTWFuYWdlckNsaWVudCwgR2V0U2VjcmV0VmFsdWVDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXNlY3JldHMtbWFuYWdlcic7XG5pbXBvcnQgdHlwZSB7IEFQSUdhdGV3YXlQcm94eUV2ZW50VjIsIEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyIH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5cbmNvbnN0IHNlY3JldHNDbGllbnQgPSBuZXcgU2VjcmV0c01hbmFnZXJDbGllbnQoe30pO1xuXG5jb25zdCBOT1RFSFVCX1BST0pFQ1RfVUlEID0gcHJvY2Vzcy5lbnYuTk9URUhVQl9QUk9KRUNUX1VJRCB8fCAnJztcbmNvbnN0IE5PVEVIVUJfU0VDUkVUX0FSTiA9IHByb2Nlc3MuZW52Lk5PVEVIVUJfU0VDUkVUX0FSTiB8fCAnJztcblxuY29uc3QgaGVhZGVycyA9IHtcbiAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLEF1dGhvcml6YXRpb24nLFxuICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctTWV0aG9kcyc6ICdHRVQsT1BUSU9OUycsXG59O1xuXG4vLyBDYWNoZSB0aGUgdG9rZW4gdG8gYXZvaWQgZmV0Y2hpbmcgb24gZXZlcnkgcmVxdWVzdFxubGV0IGNhY2hlZFRva2VuOiBzdHJpbmcgfCBudWxsID0gbnVsbDtcblxuYXN5bmMgZnVuY3Rpb24gZ2V0Tm90ZWh1YlRva2VuKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gIGlmIChjYWNoZWRUb2tlbikge1xuICAgIHJldHVybiBjYWNoZWRUb2tlbjtcbiAgfVxuXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0U2VjcmV0VmFsdWVDb21tYW5kKHsgU2VjcmV0SWQ6IE5PVEVIVUJfU0VDUkVUX0FSTiB9KTtcbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBzZWNyZXRzQ2xpZW50LnNlbmQoY29tbWFuZCk7XG5cbiAgaWYgKCFyZXNwb25zZS5TZWNyZXRTdHJpbmcpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdGVodWIgQVBJIHRva2VuIG5vdCBmb3VuZCBpbiBzZWNyZXQnKTtcbiAgfVxuXG4gIGNvbnN0IHNlY3JldCA9IEpTT04ucGFyc2UocmVzcG9uc2UuU2VjcmV0U3RyaW5nKTtcbiAgY2FjaGVkVG9rZW4gPSBzZWNyZXQudG9rZW47XG5cbiAgaWYgKCFjYWNoZWRUb2tlbikge1xuICAgIHRocm93IG5ldyBFcnJvcignVG9rZW4gZmllbGQgbm90IGZvdW5kIGluIHNlY3JldCcpO1xuICB9XG5cbiAgcmV0dXJuIGNhY2hlZFRva2VuO1xufVxuXG5pbnRlcmZhY2UgTm90ZWh1YlByb2plY3Qge1xuICB1aWQ6IHN0cmluZztcbiAgbGFiZWw6IHN0cmluZztcbiAgY3JlYXRlZDogc3RyaW5nO1xuICByb2xlOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBOb3RlaHViUm91dGUge1xuICB1aWQ6IHN0cmluZztcbiAgbGFiZWw6IHN0cmluZztcbiAgdHlwZTogc3RyaW5nO1xuICB1cmw/OiBzdHJpbmc7XG4gIG1vZGlmaWVkOiBzdHJpbmc7XG4gIGRpc2FibGVkOiBib29sZWFuO1xufVxuXG5pbnRlcmZhY2UgTm90ZWh1YkZsZWV0IHtcbiAgdWlkOiBzdHJpbmc7XG4gIGxhYmVsOiBzdHJpbmc7XG4gIGNyZWF0ZWQ6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIE5vdGVodWJTdGF0cyB7XG4gIGRldmljZV9jb3VudDogbnVtYmVyO1xuICBmbGVldHM6IE5vdGVodWJGbGVldFtdO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmZXRjaE5vdGVodWJBcGk8VD4ocGF0aDogc3RyaW5nKTogUHJvbWlzZTxUPiB7XG4gIGNvbnN0IHRva2VuID0gYXdhaXQgZ2V0Tm90ZWh1YlRva2VuKCk7XG5cbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgaHR0cHM6Ly9hcGkubm90ZWZpbGUubmV0JHtwYXRofWAsIHtcbiAgICBtZXRob2Q6ICdHRVQnLFxuICAgIGhlYWRlcnM6IHtcbiAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke3Rva2VufWAsXG4gICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgIH0sXG4gIH0pO1xuXG4gIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYE5vdGVodWIgQVBJIGVycm9yOiAke3Jlc3BvbnNlLnN0YXR1c30gJHtyZXNwb25zZS5zdGF0dXNUZXh0fWApO1xuICB9XG5cbiAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0UHJvamVjdEluZm8oKTogUHJvbWlzZTxOb3RlaHViUHJvamVjdD4ge1xuICByZXR1cm4gZmV0Y2hOb3RlaHViQXBpPE5vdGVodWJQcm9qZWN0PihgL3YxL3Byb2plY3RzLyR7Tk9URUhVQl9QUk9KRUNUX1VJRH1gKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0Um91dGVzKCk6IFByb21pc2U8Tm90ZWh1YlJvdXRlW10+IHtcbiAgLy8gTm90ZWh1YiByZXR1cm5zIHJvdXRlcyBhcyBhIGRpcmVjdCBhcnJheSwgbm90IHdyYXBwZWQgaW4geyByb3V0ZXM6IFsuLi5dIH1cbiAgY29uc3Qgcm91dGVzID0gYXdhaXQgZmV0Y2hOb3RlaHViQXBpPE5vdGVodWJSb3V0ZVtdPihgL3YxL3Byb2plY3RzLyR7Tk9URUhVQl9QUk9KRUNUX1VJRH0vcm91dGVzYCk7XG4gIGNvbnNvbGUubG9nKCdOb3RlaHViIHJvdXRlcyByZXNwb25zZTonLCBKU09OLnN0cmluZ2lmeShyb3V0ZXMsIG51bGwsIDIpKTtcbiAgcmV0dXJuIHJvdXRlcyB8fCBbXTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0RmxlZXRzKCk6IFByb21pc2U8Tm90ZWh1YkZsZWV0W10+IHtcbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZmV0Y2hOb3RlaHViQXBpPHsgZmxlZXRzOiBOb3RlaHViRmxlZXRbXSB9PihgL3YxL3Byb2plY3RzLyR7Tk9URUhVQl9QUk9KRUNUX1VJRH0vZmxlZXRzYCk7XG4gIHJldHVybiByZXN1bHQuZmxlZXRzIHx8IFtdO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXREZXZpY2VDb3VudCgpOiBQcm9taXNlPG51bWJlcj4ge1xuICBjb25zdCByZXN1bHQgPSBhd2FpdCBmZXRjaE5vdGVodWJBcGk8eyBkZXZpY2VzOiB1bmtub3duW107IGhhc19tb3JlPzogYm9vbGVhbiB9PihgL3YxL3Byb2plY3RzLyR7Tk9URUhVQl9QUk9KRUNUX1VJRH0vZGV2aWNlcz9wYWdlU2l6ZT0xYCk7XG4gIC8vIFRoZSBBUEkgZG9lc24ndCByZXR1cm4gdG90YWwgY291bnQgZGlyZWN0bHksIHNvIHdlJ2xsIHVzZSBhIHN1bW1hcnkgZW5kcG9pbnQgb3IgZXN0aW1hdGVcbiAgLy8gRm9yIG5vdywgbGV0J3MgZmV0Y2ggYWxsIGRldmljZXMgKHVwIHRvIGEgcmVhc29uYWJsZSBsaW1pdClcbiAgY29uc3QgZnVsbFJlc3VsdCA9IGF3YWl0IGZldGNoTm90ZWh1YkFwaTx7IGRldmljZXM6IHVua25vd25bXSB9PihgL3YxL3Byb2plY3RzLyR7Tk9URUhVQl9QUk9KRUNUX1VJRH0vZGV2aWNlcz9wYWdlU2l6ZT01MDBgKTtcbiAgcmV0dXJuIGZ1bGxSZXN1bHQuZGV2aWNlcz8ubGVuZ3RoIHx8IDA7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYW5kbGVyKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHRWMj4ge1xuICBjb25zb2xlLmxvZygnRXZlbnQ6JywgSlNPTi5zdHJpbmdpZnkoZXZlbnQsIG51bGwsIDIpKTtcblxuICBjb25zdCBtZXRob2QgPSBldmVudC5yZXF1ZXN0Q29udGV4dC5odHRwLm1ldGhvZDtcbiAgY29uc3QgcGF0aCA9IGV2ZW50LnJhd1BhdGg7XG5cbiAgLy8gSGFuZGxlIE9QVElPTlMgZm9yIENPUlNcbiAgaWYgKG1ldGhvZCA9PT0gJ09QVElPTlMnKSB7XG4gICAgcmV0dXJuIHsgc3RhdHVzQ29kZTogMjAwLCBoZWFkZXJzLCBib2R5OiAnJyB9O1xuICB9XG5cbiAgdHJ5IHtcbiAgICAvLyBHRVQgL3YxL25vdGVodWIvc3RhdHVzIC0gR2V0IGZ1bGwgTm90ZWh1YiBjb25uZWN0aW9uIHN0YXR1c1xuICAgIGlmIChtZXRob2QgPT09ICdHRVQnICYmIHBhdGggPT09ICcvdjEvbm90ZWh1Yi9zdGF0dXMnKSB7XG4gICAgICAvLyBGZXRjaCBhbGwgZGF0YSBpbiBwYXJhbGxlbFxuICAgICAgY29uc3QgW3Byb2plY3QsIHJvdXRlcywgZmxlZXRzLCBkZXZpY2VDb3VudF0gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgIGdldFByb2plY3RJbmZvKCksXG4gICAgICAgIGdldFJvdXRlcygpLFxuICAgICAgICBnZXRGbGVldHMoKSxcbiAgICAgICAgZ2V0RGV2aWNlQ291bnQoKSxcbiAgICAgIF0pO1xuXG4gICAgICAvLyBEZXRlcm1pbmUgb3ZlcmFsbCBoZWFsdGhcbiAgICAgIGNvbnN0IGFjdGl2ZVJvdXRlcyA9IHJvdXRlcy5maWx0ZXIociA9PiAhci5kaXNhYmxlZCk7XG4gICAgICBjb25zb2xlLmxvZygnUm91dGVzOicsIHJvdXRlcy5sZW5ndGgsICdBY3RpdmUgcm91dGVzOicsIGFjdGl2ZVJvdXRlcy5sZW5ndGgpO1xuICAgICAgY29uc29sZS5sb2coJ1JvdXRlIGRldGFpbHM6Jywgcm91dGVzLm1hcChyID0+ICh7IG5hbWU6IHIubGFiZWwsIGRpc2FibGVkOiByLmRpc2FibGVkIH0pKSk7XG4gICAgICBjb25zdCBoZWFsdGggPSBhY3RpdmVSb3V0ZXMubGVuZ3RoID4gMCA/ICdoZWFsdGh5JyA6ICd3YXJuaW5nJztcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgcHJvamVjdDoge1xuICAgICAgICAgICAgdWlkOiBwcm9qZWN0LnVpZCxcbiAgICAgICAgICAgIG5hbWU6IHByb2plY3QubGFiZWwsXG4gICAgICAgICAgICBjcmVhdGVkOiBwcm9qZWN0LmNyZWF0ZWQsXG4gICAgICAgICAgfSxcbiAgICAgICAgICByb3V0ZXM6IHJvdXRlcy5tYXAociA9PiAoe1xuICAgICAgICAgICAgdWlkOiByLnVpZCxcbiAgICAgICAgICAgIG5hbWU6IHIubGFiZWwsXG4gICAgICAgICAgICB0eXBlOiByLnR5cGUsXG4gICAgICAgICAgICB1cmw6IHIudXJsLFxuICAgICAgICAgICAgZW5hYmxlZDogIXIuZGlzYWJsZWQsXG4gICAgICAgICAgICBtb2RpZmllZDogci5tb2RpZmllZCxcbiAgICAgICAgICB9KSksXG4gICAgICAgICAgZmxlZXRzOiBmbGVldHMubWFwKGYgPT4gKHtcbiAgICAgICAgICAgIHVpZDogZi51aWQsXG4gICAgICAgICAgICBuYW1lOiBmLmxhYmVsLFxuICAgICAgICAgICAgY3JlYXRlZDogZi5jcmVhdGVkLFxuICAgICAgICAgIH0pKSxcbiAgICAgICAgICBkZXZpY2VfY291bnQ6IGRldmljZUNvdW50LFxuICAgICAgICAgIGhlYWx0aCxcbiAgICAgICAgICBsYXN0X2NoZWNrZWQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIEdFVCAvdjEvbm90ZWh1Yi9mbGVldHMgLSBHZXQgYXZhaWxhYmxlIGZsZWV0c1xuICAgIGlmIChtZXRob2QgPT09ICdHRVQnICYmIHBhdGggPT09ICcvdjEvbm90ZWh1Yi9mbGVldHMnKSB7XG4gICAgICBjb25zdCBmbGVldHMgPSBhd2FpdCBnZXRGbGVldHMoKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgZmxlZXRzOiBmbGVldHMubWFwKGYgPT4gKHtcbiAgICAgICAgICAgIHVpZDogZi51aWQsXG4gICAgICAgICAgICBuYW1lOiBmLmxhYmVsLFxuICAgICAgICAgICAgY3JlYXRlZDogZi5jcmVhdGVkLFxuICAgICAgICAgIH0pKSxcbiAgICAgICAgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA0MDQsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ05vdCBmb3VuZCcgfSksXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvcjonLCBlcnJvcik7XG4gICAgY29uc3QgZXJyb3JNZXNzYWdlID0gZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJztcblxuICAgIC8vIFJldHVybiBkZWdyYWRlZCBzdGF0dXMgaWYgd2UgY2FuJ3QgY29ubmVjdFxuICAgIGlmIChwYXRoID09PSAnL3YxL25vdGVodWIvc3RhdHVzJykge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgcHJvamVjdDoge1xuICAgICAgICAgICAgdWlkOiBOT1RFSFVCX1BST0pFQ1RfVUlELFxuICAgICAgICAgICAgbmFtZTogJ1Vua25vd24nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgcm91dGVzOiBbXSxcbiAgICAgICAgICBmbGVldHM6IFtdLFxuICAgICAgICAgIGRldmljZV9jb3VudDogMCxcbiAgICAgICAgICBoZWFsdGg6ICdlcnJvcicsXG4gICAgICAgICAgZXJyb3I6IGVycm9yTWVzc2FnZSxcbiAgICAgICAgICBsYXN0X2NoZWNrZWQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA1MDAsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogZXJyb3JNZXNzYWdlIH0pLFxuICAgIH07XG4gIH1cbn1cbiJdfQ==