"use strict";
/**
 * API Notehub Lambda
 *
 * Fetches Notehub project status and route information.
 * Available to all authenticated users.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_secrets_manager_1 = require("@aws-sdk/client-secrets-manager");
const secretsClient = new client_secrets_manager_1.SecretsManagerClient({});
const NOTEHUB_PROJECT_UID = process.env.NOTEHUB_PROJECT_UID || '';
const NOTEHUB_SECRET_ARN = process.env.NOTEHUB_SECRET_ARN || '';
const headers = {
    'Content-Type': 'application/json',
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type,Authorization',
    'Access-Control-Allow-Methods': 'GET,OPTIONS',
};
// Cache the token to avoid fetching on every request
let cachedToken = null;
async function getNotehubToken() {
    if (cachedToken) {
        return cachedToken;
    }
    const command = new client_secrets_manager_1.GetSecretValueCommand({ SecretId: NOTEHUB_SECRET_ARN });
    const response = await secretsClient.send(command);
    if (!response.SecretString) {
        throw new Error('Notehub API token not found in secret');
    }
    const secret = JSON.parse(response.SecretString);
    cachedToken = secret.token;
    if (!cachedToken) {
        throw new Error('Token field not found in secret');
    }
    return cachedToken;
}
async function fetchNotehubApi(path) {
    const token = await getNotehubToken();
    const response = await fetch(`https://api.notefile.net${path}`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
        },
    });
    if (!response.ok) {
        throw new Error(`Notehub API error: ${response.status} ${response.statusText}`);
    }
    return response.json();
}
async function getProjectInfo() {
    return fetchNotehubApi(`/v1/projects/${NOTEHUB_PROJECT_UID}`);
}
async function getRoutes() {
    // Notehub returns routes as a direct array, not wrapped in { routes: [...] }
    const routes = await fetchNotehubApi(`/v1/projects/${NOTEHUB_PROJECT_UID}/routes`);
    console.log('Notehub routes response:', JSON.stringify(routes, null, 2));
    return routes || [];
}
async function getFleets() {
    const result = await fetchNotehubApi(`/v1/projects/${NOTEHUB_PROJECT_UID}/fleets`);
    return result.fleets || [];
}
async function getDeviceCount() {
    const result = await fetchNotehubApi(`/v1/projects/${NOTEHUB_PROJECT_UID}/devices?pageSize=1`);
    // The API doesn't return total count directly, so we'll use a summary endpoint or estimate
    // For now, let's fetch all devices (up to a reasonable limit)
    const fullResult = await fetchNotehubApi(`/v1/projects/${NOTEHUB_PROJECT_UID}/devices?pageSize=500`);
    return fullResult.devices?.length || 0;
}
async function handler(event) {
    console.log('Event:', JSON.stringify(event, null, 2));
    const method = event.requestContext.http.method;
    const path = event.rawPath;
    // Handle OPTIONS for CORS
    if (method === 'OPTIONS') {
        return { statusCode: 200, headers, body: '' };
    }
    try {
        // GET /v1/notehub/status - Get full Notehub connection status
        if (method === 'GET' && path === '/v1/notehub/status') {
            // Fetch all data in parallel
            const [project, routes, fleets, deviceCount] = await Promise.all([
                getProjectInfo(),
                getRoutes(),
                getFleets(),
                getDeviceCount(),
            ]);
            // Determine overall health
            const activeRoutes = routes.filter(r => !r.disabled);
            console.log('Routes:', routes.length, 'Active routes:', activeRoutes.length);
            console.log('Route details:', routes.map(r => ({ name: r.label, disabled: r.disabled })));
            const health = activeRoutes.length > 0 ? 'healthy' : 'warning';
            return {
                statusCode: 200,
                headers,
                body: JSON.stringify({
                    project: {
                        uid: project.uid,
                        name: project.label,
                        created: project.created,
                    },
                    routes: routes.map(r => ({
                        uid: r.uid,
                        name: r.label,
                        type: r.type,
                        url: r.url,
                        enabled: !r.disabled,
                        modified: r.modified,
                    })),
                    fleets: fleets.map(f => ({
                        uid: f.uid,
                        name: f.label,
                        created: f.created,
                    })),
                    device_count: deviceCount,
                    health,
                    last_checked: new Date().toISOString(),
                }),
            };
        }
        // GET /v1/notehub/fleets - Get available fleets
        if (method === 'GET' && path === '/v1/notehub/fleets') {
            const fleets = await getFleets();
            return {
                statusCode: 200,
                headers,
                body: JSON.stringify({
                    fleets: fleets.map(f => ({
                        uid: f.uid,
                        name: f.label,
                        created: f.created,
                    })),
                }),
            };
        }
        return {
            statusCode: 404,
            headers,
            body: JSON.stringify({ error: 'Not found' }),
        };
    }
    catch (error) {
        console.error('Error:', error);
        const errorMessage = error instanceof Error ? error.message : 'Internal server error';
        // Return degraded status if we can't connect
        if (path === '/v1/notehub/status') {
            return {
                statusCode: 200,
                headers,
                body: JSON.stringify({
                    project: {
                        uid: NOTEHUB_PROJECT_UID,
                        name: 'Unknown',
                    },
                    routes: [],
                    fleets: [],
                    device_count: 0,
                    health: 'error',
                    error: errorMessage,
                    last_checked: new Date().toISOString(),
                }),
            };
        }
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: errorMessage }),
        };
    }
}
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvYXBpLW5vdGVodWIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7OztHQUtHOzs7QUFFSCw0RUFBOEY7QUFHOUYsTUFBTSxhQUFhLEdBQUcsSUFBSSw2Q0FBb0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUVuRCxNQUFNLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLElBQUksRUFBRSxDQUFDO0FBQ2xFLE1BQU0sa0JBQWtCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsSUFBSSxFQUFFLENBQUM7QUFFaEUsTUFBTSxPQUFPLEdBQUc7SUFDZCxjQUFjLEVBQUUsa0JBQWtCO0lBQ2xDLDZCQUE2QixFQUFFLEdBQUc7SUFDbEMsOEJBQThCLEVBQUUsNEJBQTRCO0lBQzVELDhCQUE4QixFQUFFLGFBQWE7Q0FDOUMsQ0FBQztBQUVGLHFEQUFxRDtBQUNyRCxJQUFJLFdBQVcsR0FBa0IsSUFBSSxDQUFDO0FBRXRDLEtBQUssVUFBVSxlQUFlO0lBQzVCLElBQUksV0FBVyxFQUFFLENBQUM7UUFDaEIsT0FBTyxXQUFXLENBQUM7SUFDckIsQ0FBQztJQUVELE1BQU0sT0FBTyxHQUFHLElBQUksOENBQXFCLENBQUMsRUFBRSxRQUFRLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQyxDQUFDO0lBQzVFLE1BQU0sUUFBUSxHQUFHLE1BQU0sYUFBYSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUVuRCxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQzNCLE1BQU0sSUFBSSxLQUFLLENBQUMsdUNBQXVDLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBRUQsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDakQsV0FBVyxHQUFHLE1BQU0sQ0FB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Q0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUMvQixNQUFNLFlBQVksR0FBRyxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyx1QkFBdUIsQ0FBQztRQUV0Riw2Q0FBNkM7UUFDN0MsSUFBSSxJQUFJLEtBQUssb0JBQW9CLEVBQUUsQ0FBQztZQUNsQyxPQUFPO2dCQUNMLFVBQVUsRUFBRSxHQUFHO2dCQUNmLE9BQU87Z0JBQ1AsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7b0JBQ25CLE9BQU8sRUFBRTt3QkFDUCxHQUFHLEVBQUUsbUJBQW1CO3dCQUN4QixJQUFJLEVBQUUsU0FBUztxQkFDaEI7b0JBQ0QsTUFBTSxFQUFFLEVBQUU7b0JBQ1YsTUFBTSxFQUFFLEVBQUU7b0JBQ1YsWUFBWSxFQUFFLENBQUM7b0JBQ2YsTUFBTSxFQUFFLE9BQU87b0JBQ2YsS0FBSyxFQUFFLFlBQVk7b0JBQ25CLFlBQVksRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtpQkFDdkMsQ0FBQzthQUNILENBQUM7UUFDSixDQUFDO1FBRUQsT0FBTztZQUNMLFVBQVUsRUFBRSxHQUFHO1lBQ2YsT0FBTztZQUNQLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBRSxDQUFDO1NBQzlDLENBQUM7SUFDSixDQUFDO0FBQ0gsQ0FBQztBQTdHRCwwQkE2R0MiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEFQSSBOb3RlaHViIExhbWJkYVxuICpcbiAqIEZldGNoZXMgTm90ZWh1YiBwcm9qZWN0IHN0YXR1cyBhbmQgcm91dGUgaW5mb3JtYXRpb24uXG4gKiBBdmFpbGFibGUgdG8gYWxsIGF1dGhlbnRpY2F0ZWQgdXNlcnMuXG4gKi9cblxuaW1wb3J0IHsgU2VjcmV0c01hbmFnZXJDbGllbnQsIEdldFNlY3JldFZhbHVlQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zZWNyZXRzLW1hbmFnZXInO1xuaW1wb3J0IHR5cGUgeyBBUElHYXRld2F5UHJveHlFdmVudFYyLCBBUElHYXRld2F5UHJveHlSZXN1bHRWMiB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuXG5jb25zdCBzZWNyZXRzQ2xpZW50ID0gbmV3IFNlY3JldHNNYW5hZ2VyQ2xpZW50KHt9KTtcblxuY29uc3QgTk9URUhVQl9QUk9KRUNUX1VJRCA9IHByb2Nlc3MuZW52Lk5PVEVIVUJfUFJPSkVDVF9VSUQgfHwgJyc7XG5jb25zdCBOT1RFSFVCX1NFQ1JFVF9BUk4gPSBwcm9jZXNzLmVudi5OT1RFSFVCX1NFQ1JFVF9BUk4gfHwgJyc7XG5cbmNvbnN0IGhlYWRlcnMgPSB7XG4gICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXG4gICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogJ0NvbnRlbnQtVHlwZSxBdXRob3JpemF0aW9uJyxcbiAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU1ldGhvZHMnOiAnR0VULE9QVElPTlMnLFxufTtcblxuLy8gQ2FjaGUgdGhlIHRva2VuIHRvIGF2b2lkIGZldGNoaW5nIG9uIGV2ZXJ5IHJlcXVlc3RcbmxldCBjYWNoZWRUb2tlbjogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG5cbmFzeW5jIGZ1bmN0aW9uIGdldE5vdGVodWJUb2tlbigpOiBQcm9taXNlPHN0cmluZz4ge1xuICBpZiAoY2FjaGVkVG9rZW4pIHtcbiAgICByZXR1cm4gY2FjaGVkVG9rZW47XG4gIH1cblxuICBjb25zdCBjb21tYW5kID0gbmV3IEdldFNlY3JldFZhbHVlQ29tbWFuZCh7IFNlY3JldElkOiBOT1RFSFVCX1NFQ1JFVF9BUk4gfSk7XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgc2VjcmV0c0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuXG4gIGlmICghcmVzcG9uc2UuU2VjcmV0U3RyaW5nKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdOb3RlaHViIEFQSSB0b2tlbiBub3QgZm91bmQgaW4gc2VjcmV0Jyk7XG4gIH1cblxuICBjb25zdCBzZWNyZXQgPSBKU09OLnBhcnNlKHJlc3BvbnNlLlNlY3JldFN0cmluZyk7XG4gIGNhY2hlZFRva2VuID0gc2VjcmV0LnRva2VuO1xuXG4gIGlmICghY2FjaGVkVG9rZW4pIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1Rva2VuIGZpZWxkIG5vdCBmb3VuZCBpbiBzZWNyZXQnKTtcbiAgfVxuXG4gIHJldHVybiBjYWNoZWRUb2tlbjtcbn1cblxuaW50ZXJmYWNlIE5vdGVodWJQcm9qZWN0IHtcbiAgdWlkOiBzdHJpbmc7XG4gIGxhYmVsOiBzdHJpbmc7XG4gIGNyZWF0ZWQ6IHN0cmluZztcbiAgcm9sZTogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgTm90ZWh1YlJvdXRlIHtcbiAgdWlkOiBzdHJpbmc7XG4gIGxhYmVsOiBzdHJpbmc7XG4gIHR5cGU6IHN0cmluZztcbiAgdXJsPzogc3RyaW5nO1xuICBtb2RpZmllZDogc3RyaW5nO1xuICBkaXNhYmxlZDogYm9vbGVhbjtcbn1cblxuaW50ZXJmYWNlIE5vdGVodWJGbGVldCB7XG4gIHVpZDogc3RyaW5nO1xuICBsYWJlbDogc3RyaW5nO1xuICBjcmVhdGVkOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBOb3RlaHViU3RhdHMge1xuICBkZXZpY2VfY291bnQ6IG51bWJlcjtcbiAgZmxlZXRzOiBOb3RlaHViRmxlZXRbXTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZmV0Y2hOb3RlaHViQXBpPFQ+KHBhdGg6IHN0cmluZyk6IFByb21pc2U8VD4ge1xuICBjb25zdCB0b2tlbiA9IGF3YWl0IGdldE5vdGVodWJUb2tlbigpO1xuXG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYGh0dHBzOi8vYXBpLm5vdGVmaWxlLm5ldCR7cGF0aH1gLCB7XG4gICAgbWV0aG9kOiAnR0VUJyxcbiAgICBoZWFkZXJzOiB7XG4gICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHt0b2tlbn1gLFxuICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICB9LFxuICB9KTtcblxuICBpZiAoIXJlc3BvbnNlLm9rKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBOb3RlaHViIEFQSSBlcnJvcjogJHtyZXNwb25zZS5zdGF0dXN9ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTtcbiAgfVxuXG4gIHJldHVybiByZXNwb25zZS5qc29uKCkgYXMgUHJvbWlzZTxUPjtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0UHJvamVjdEluZm8oKTogUHJvbWlzZTxOb3RlaHViUHJvamVjdD4ge1xuICByZXR1cm4gZmV0Y2hOb3RlaHViQXBpPE5vdGVodWJQcm9qZWN0PihgL3YxL3Byb2plY3RzLyR7Tk9URUhVQl9QUk9KRUNUX1VJRH1gKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0Um91dGVzKCk6IFByb21pc2U8Tm90ZWh1YlJvdXRlW10+IHtcbiAgLy8gTm90ZWh1YiByZXR1cm5zIHJvdXRlcyBhcyBhIGRpcmVjdCBhcnJheSwgbm90IHdyYXBwZWQgaW4geyByb3V0ZXM6IFsuLi5dIH1cbiAgY29uc3Qgcm91dGVzID0gYXdhaXQgZmV0Y2hOb3RlaHViQXBpPE5vdGVodWJSb3V0ZVtdPihgL3YxL3Byb2plY3RzLyR7Tk9URUhVQl9QUk9KRUNUX1VJRH0vcm91dGVzYCk7XG4gIGNvbnNvbGUubG9nKCdOb3RlaHViIHJvdXRlcyByZXNwb25zZTonLCBKU09OLnN0cmluZ2lmeShyb3V0ZXMsIG51bGwsIDIpKTtcbiAgcmV0dXJuIHJvdXRlcyB8fCBbXTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0RmxlZXRzKCk6IFByb21pc2U8Tm90ZWh1YkZsZWV0W10+IHtcbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZmV0Y2hOb3RlaHViQXBpPHsgZmxlZXRzOiBOb3RlaHViRmxlZXRbXSB9PihgL3YxL3Byb2plY3RzLyR7Tk9URUhVQl9QUk9KRUNUX1VJRH0vZmxlZXRzYCk7XG4gIHJldHVybiByZXN1bHQuZmxlZXRzIHx8IFtdO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXREZXZpY2VDb3VudCgpOiBQcm9taXNlPG51bWJlcj4ge1xuICBjb25zdCByZXN1bHQgPSBhd2FpdCBmZXRjaE5vdGVodWJBcGk8eyBkZXZpY2VzOiB1bmtub3duW107IGhhc19tb3JlPzogYm9vbGVhbiB9PihgL3YxL3Byb2plY3RzLyR7Tk9URUhVQl9QUk9KRUNUX1VJRH0vZGV2aWNlcz9wYWdlU2l6ZT0xYCk7XG4gIC8vIFRoZSBBUEkgZG9lc24ndCByZXR1cm4gdG90YWwgY291bnQgZGlyZWN0bHksIHNvIHdlJ2xsIHVzZSBhIHN1bW1hcnkgZW5kcG9pbnQgb3IgZXN0aW1hdGVcbiAgLy8gRm9yIG5vdywgbGV0J3MgZmV0Y2ggYWxsIGRldmljZXMgKHVwIHRvIGEgcmVhc29uYWJsZSBsaW1pdClcbiAgY29uc3QgZnVsbFJlc3VsdCA9IGF3YWl0IGZldGNoTm90ZWh1YkFwaTx7IGRldmljZXM6IHVua25vd25bXSB9PihgL3YxL3Byb2plY3RzLyR7Tk9URUhVQl9QUk9KRUNUX1VJRH0vZGV2aWNlcz9wYWdlU2l6ZT01MDBgKTtcbiAgcmV0dXJuIGZ1bGxSZXN1bHQuZGV2aWNlcz8ubGVuZ3RoIHx8IDA7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYW5kbGVyKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHRWMj4ge1xuICBjb25zb2xlLmxvZygnRXZlbnQ6JywgSlNPTi5zdHJpbmdpZnkoZXZlbnQsIG51bGwsIDIpKTtcblxuICBjb25zdCBtZXRob2QgPSBldmVudC5yZXF1ZXN0Q29udGV4dC5odHRwLm1ldGhvZDtcbiAgY29uc3QgcGF0aCA9IGV2ZW50LnJhd1BhdGg7XG5cbiAgLy8gSGFuZGxlIE9QVElPTlMgZm9yIENPUlNcbiAgaWYgKG1ldGhvZCA9PT0gJ09QVElPTlMnKSB7XG4gICAgcmV0dXJuIHsgc3RhdHVzQ29kZTogMjAwLCBoZWFkZXJzLCBib2R5OiAnJyB9O1xuICB9XG5cbiAgdHJ5IHtcbiAgICAvLyBHRVQgL3YxL25vdGVodWIvc3RhdHVzIC0gR2V0IGZ1bGwgTm90ZWh1YiBjb25uZWN0aW9uIHN0YXR1c1xuICAgIGlmIChtZXRob2QgPT09ICdHRVQnICYmIHBhdGggPT09ICcvdjEvbm90ZWh1Yi9zdGF0dXMnKSB7XG4gICAgICAvLyBGZXRjaCBhbGwgZGF0YSBpbiBwYXJhbGxlbFxuICAgICAgY29uc3QgW3Byb2plY3QsIHJvdXRlcywgZmxlZXRzLCBkZXZpY2VDb3VudF0gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICAgIGdldFByb2plY3RJbmZvKCksXG4gICAgICAgIGdldFJvdXRlcygpLFxuICAgICAgICBnZXRGbGVldHMoKSxcbiAgICAgICAgZ2V0RGV2aWNlQ291bnQoKSxcbiAgICAgIF0pO1xuXG4gICAgICAvLyBEZXRlcm1pbmUgb3ZlcmFsbCBoZWFsdGhcbiAgICAgIGNvbnN0IGFjdGl2ZVJvdXRlcyA9IHJvdXRlcy5maWx0ZXIociA9PiAhci5kaXNhYmxlZCk7XG4gICAgICBjb25zb2xlLmxvZygnUm91dGVzOicsIHJvdXRlcy5sZW5ndGgsICdBY3RpdmUgcm91dGVzOicsIGFjdGl2ZVJvdXRlcy5sZW5ndGgpO1xuICAgICAgY29uc29sZS5sb2coJ1JvdXRlIGRldGFpbHM6Jywgcm91dGVzLm1hcChyID0+ICh7IG5hbWU6IHIubGFiZWwsIGRpc2FibGVkOiByLmRpc2FibGVkIH0pKSk7XG4gICAgICBjb25zdCBoZWFsdGggPSBhY3RpdmVSb3V0ZXMubGVuZ3RoID4gMCA/ICdoZWFsdGh5JyA6ICd3YXJuaW5nJztcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgcHJvamVjdDoge1xuICAgICAgICAgICAgdWlkOiBwcm9qZWN0LnVpZCxcbiAgICAgICAgICAgIG5hbWU6IHByb2plY3QubGFiZWwsXG4gICAgICAgICAgICBjcmVhdGVkOiBwcm9qZWN0LmNyZWF0ZWQsXG4gICAgICAgICAgfSxcbiAgICAgICAgICByb3V0ZXM6IHJvdXRlcy5tYXAociA9PiAoe1xuICAgICAgICAgICAgdWlkOiByLnVpZCxcbiAgICAgICAgICAgIG5hbWU6IHIubGFiZWwsXG4gICAgICAgICAgICB0eXBlOiByLnR5cGUsXG4gICAgICAgICAgICB1cmw6IHIudXJsLFxuICAgICAgICAgICAgZW5hYmxlZDogIXIuZGlzYWJsZWQsXG4gICAgICAgICAgICBtb2RpZmllZDogci5tb2RpZmllZCxcbiAgICAgICAgICB9KSksXG4gICAgICAgICAgZmxlZXRzOiBmbGVldHMubWFwKGYgPT4gKHtcbiAgICAgICAgICAgIHVpZDogZi51aWQsXG4gICAgICAgICAgICBuYW1lOiBmLmxhYmVsLFxuICAgICAgICAgICAgY3JlYXRlZDogZi5jcmVhdGVkLFxuICAgICAgICAgIH0pKSxcbiAgICAgICAgICBkZXZpY2VfY291bnQ6IGRldmljZUNvdW50LFxuICAgICAgICAgIGhlYWx0aCxcbiAgICAgICAgICBsYXN0X2NoZWNrZWQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIEdFVCAvdjEvbm90ZWh1Yi9mbGVldHMgLSBHZXQgYXZhaWxhYmxlIGZsZWV0c1xuICAgIGlmIChtZXRob2QgPT09ICdHRVQnICYmIHBhdGggPT09ICcvdjEvbm90ZWh1Yi9mbGVldHMnKSB7XG4gICAgICBjb25zdCBmbGVldHMgPSBhd2FpdCBnZXRGbGVldHMoKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgZmxlZXRzOiBmbGVldHMubWFwKGYgPT4gKHtcbiAgICAgICAgICAgIHVpZDogZi51aWQsXG4gICAgICAgICAgICBuYW1lOiBmLmxhYmVsLFxuICAgICAgICAgICAgY3JlYXRlZDogZi5jcmVhdGVkLFxuICAgICAgICAgIH0pKSxcbiAgICAgICAgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA0MDQsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ05vdCBmb3VuZCcgfSksXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvcjonLCBlcnJvcik7XG4gICAgY29uc3QgZXJyb3JNZXNzYWdlID0gZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJztcblxuICAgIC8vIFJldHVybiBkZWdyYWRlZCBzdGF0dXMgaWYgd2UgY2FuJ3QgY29ubmVjdFxuICAgIGlmIChwYXRoID09PSAnL3YxL25vdGVodWIvc3RhdHVzJykge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgcHJvamVjdDoge1xuICAgICAgICAgICAgdWlkOiBOT1RFSFVCX1BST0pFQ1RfVUlELFxuICAgICAgICAgICAgbmFtZTogJ1Vua25vd24nLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgcm91dGVzOiBbXSxcbiAgICAgICAgICBmbGVldHM6IFtdLFxuICAgICAgICAgIGRldmljZV9jb3VudDogMCxcbiAgICAgICAgICBoZWFsdGg6ICdlcnJvcicsXG4gICAgICAgICAgZXJyb3I6IGVycm9yTWVzc2FnZSxcbiAgICAgICAgICBsYXN0X2NoZWNrZWQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA1MDAsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogZXJyb3JNZXNzYWdlIH0pLFxuICAgIH07XG4gIH1cbn1cbiJdfQ==