"use strict";
/**
 * Re-run Query Lambda
 *
 * Re-executes a stored SQL query from chat history to regenerate visualization data.
 * Used when loading historical conversations to render charts/maps.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_rds_data_1 = require("@aws-sdk/client-rds-data");
const rds = new client_rds_data_1.RDSDataClient({});
const CLUSTER_ARN = process.env.CLUSTER_ARN;
const SECRET_ARN = process.env.SECRET_ARN;
const DATABASE_NAME = process.env.DATABASE_NAME;
function validateSQL(sql) {
    const lowerSQL = sql.toLowerCase();
    // Only allow SELECT statements
    if (!lowerSQL.trim().startsWith('select') && !lowerSQL.trim().startsWith('with')) {
        throw new Error('Only SELECT queries are allowed');
    }
    // Block dangerous keywords
    const dangerousKeywords = [
        'insert', 'update', 'delete', 'drop', 'truncate', 'alter',
        'create', 'grant', 'revoke', 'exec', 'execute'
    ];
    for (const keyword of dangerousKeywords) {
        if (lowerSQL.includes(keyword)) {
            throw new Error(`Keyword '${keyword}' is not allowed`);
        }
    }
    // Must include device filter
    if (!sql.includes(':deviceFilter')) {
        throw new Error('Query must include device filter (:deviceFilter)');
    }
}
async function executeQuery(sql, deviceSerialNumbers) {
    // Replace device filter placeholder
    const deviceList = deviceSerialNumbers.map(sn => `'${sn.replace(/'/g, "''")}'`).join(', ');
    const finalSQL = sql.replace(':deviceFilter', deviceList);
    console.log('Re-executing SQL:', finalSQL);
    const response = await rds.send(new client_rds_data_1.ExecuteStatementCommand({
        resourceArn: CLUSTER_ARN,
        secretArn: SECRET_ARN,
        database: DATABASE_NAME,
        sql: finalSQL,
        includeResultMetadata: true,
    }));
    if (!response.records) {
        return [];
    }
    // Convert RDS Data API format to JSON
    const columnMetadata = response.columnMetadata || [];
    const records = response.records.map(record => {
        const row = {};
        record.forEach((field, index) => {
            const columnName = columnMetadata[index]?.name || `column_${index}`;
            let value = null;
            if (field.stringValue !== undefined) {
                value = field.stringValue;
            }
            else if (field.longValue !== undefined) {
                value = field.longValue;
            }
            else if (field.doubleValue !== undefined) {
                value = field.doubleValue;
            }
            else if (field.booleanValue !== undefined) {
                value = field.booleanValue;
            }
            else if (field.isNull) {
                value = null;
            }
            row[columnName] = value;
        });
        return row;
    });
    return records;
}
const handler = async (event) => {
    try {
        const request = JSON.parse(event.body || '{}');
        if (!request.sql || !request.userEmail) {
            return {
                statusCode: 400,
                headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*',
                },
                body: JSON.stringify({ error: 'Missing required fields (sql, userEmail)' }),
            };
        }
        // Validate SQL before execution
        validateSQL(request.sql);
        // Get all device serial numbers (user has access to all in this implementation)
        const devicesResult = await rds.send(new client_rds_data_1.ExecuteStatementCommand({
            resourceArn: CLUSTER_ARN,
            secretArn: SECRET_ARN,
            database: DATABASE_NAME,
            sql: 'SELECT DISTINCT serial_number FROM analytics.devices',
        }));
        let deviceSerialNumbers = (devicesResult.records || [])
            .map(record => record[0]?.stringValue)
            .filter((sn) => !!sn);
        // Fallback: check telemetry table if devices table is empty
        if (deviceSerialNumbers.length === 0) {
            const telemetryResult = await rds.send(new client_rds_data_1.ExecuteStatementCommand({
                resourceArn: CLUSTER_ARN,
                secretArn: SECRET_ARN,
                database: DATABASE_NAME,
                sql: 'SELECT DISTINCT serial_number FROM analytics.telemetry LIMIT 100',
            }));
            deviceSerialNumbers = (telemetryResult.records || [])
                .map(record => record[0]?.stringValue)
                .filter((sn) => !!sn);
        }
        // Execute the stored query
        const data = await executeQuery(request.sql, deviceSerialNumbers);
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify({ data }),
        };
    }
    catch (error) {
        console.error('Rerun query error:', error);
        return {
            statusCode: 500,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*',
            },
            body: JSON.stringify({
                error: error.message || 'Internal server error',
            }),
        };
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVydW4tcXVlcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvYW5hbHl0aWNzL3JlcnVuLXF1ZXJ5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7R0FLRzs7O0FBR0gsOERBQWtGO0FBRWxGLE1BQU0sR0FBRyxHQUFHLElBQUksK0JBQWEsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUVsQyxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVksQ0FBQztBQUM3QyxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVcsQ0FBQztBQUMzQyxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWMsQ0FBQztBQU9qRCxTQUFTLFdBQVcsQ0FBQyxHQUFXO0lBQzlCLE1BQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUVuQywrQkFBK0I7SUFDL0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7UUFDakYsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO0lBQ3JELENBQUM7SUFFRCwyQkFBMkI7SUFDM0IsTUFBTSxpQkFBaUIsR0FBRztRQUN4QixRQUFRLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE9BQU87UUFDekQsUUFBUSxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLFNBQVM7S0FDL0MsQ0FBQztJQUVGLEtBQUssTUFBTSxPQUFPLElBQUksaUJBQWlCLEVBQUUsQ0FBQztRQUN4QyxJQUFJLFFBQVEsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUMvQixNQUFNLElBQUksS0FBSyxDQUFDLFlBQVksT0FBTyxrQkFBa0IsQ0FBQyxDQUFDO1FBQ3pELENBQUM7SUFDSCxDQUFDO0lBRUQsNkJBQTZCO0lBQzdCLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLGVBQWUsQ0FBQyxFQUFFLENBQUM7UUFDbkMsTUFBTSxJQUFJLEtBQUssQ0FBQyxrREFBa0QsQ0FBQyxDQUFDO0lBQ3RFLENBQUM7QUFDSCxDQUFDO0FBRUQsS0FBSyxVQUFVLFlBQVksQ0FBQyxHQUFXLEVBQUUsbUJBQTZCO0lBQ3BFLG9DQUFvQztJQUNwQyxNQUFNLFVBQVUsR0FBRyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDM0YsTUFBTSxRQUFRLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxlQUFlLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFFMUQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUUzQyxNQUFNLFFBQVEsR0FBRyxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSx5Q0FBdUIsQ0FBQztRQUMxRCxXQUFXLEVBQUUsV0FBVztRQUN4QixTQUFTLEVBQUUsVUFBVTtRQUNyQixRQUFRLEVBQUUsYUFBYTtRQUN2QixHQUFHLEVBQUUsUUFBUTtRQUNiLHFCQUFxQixFQUFFLElBQUk7S0FDNUIsQ0FBQyxDQUFDLENBQUM7SUFFSixJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ3RCLE9BQU8sRUFBRSxDQUFDO0lBQ1osQ0FBQztJQUVELHNDQUFzQztJQUN0QyxNQUFNLGNBQWMsR0FBRyxRQUFRLENBQUMsY0FBYyxJQUFJLEVBQUUsQ0FBQztJQUNyRCxNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRTtRQUM1QyxNQUFNLEdBQUcsR0FBUSxFQUFFLENBQUM7UUFDcEIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRTtZQUM5QixNQUFNLFVBQVUsR0FBRyxjQUFjLENBQUMsS0FBSyxDQUFDLEVBQUUsSUFBSSxJQUFJLFVBQVUsS0FBSyxFQUFFLENBQUM7WUFDcEUsSUFBSSxLQUFLLEdBQVEsSUFBSSxDQUFDO1lBQ3RCLElBQUksS0FBSyxDQUFDLFdBQVcsS0FBSyxTQUFTLEVBQUUsQ0FBQztnQkFDcEMsS0FBSyxHQUFHLEtBQUssQ0FBQyxXQUFXLENBQUM7WUFDNUIsQ0FBQztpQkFBTSxJQUFJLEtBQUssQ0FBQyxTQUFTLEtBQUssU0FBUyxFQUFFLENBQUM7Z0JBQ3pDLEtBQUssR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDO1lBQzFCLENBQUM7aUJBQU0sSUFBSSxLQUFLLENBQUMsV0FBVyxLQUFLLFNBQVMsRUFBRSxDQUFDO2dCQUMzQyxLQUFLLEdBQUcsS0FBSyxDQUFDLFdBQVcsQ0FBQztZQUM1QixDQUFDO2lCQUFNLElBQUksS0FBSyxDQUFDLFlBQVksS0FBSyxTQUFTLEVBQUUsQ0FBQztnQkFDNUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxZQUFZLENBQUM7WUFDN0IsQ0FBQztpQkFBTSxJQUFJLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDeEIsS0FBSyxHQUFHLElBQUksQ0FBQztZQUNmLENBQUM7WUFDRCxHQUFHLENBQUMsVUFBVSxDQUFDLEdBQUcsS0FBSyxDQUFDO1FBQzFCLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxHQUFHLENBQUM7SUFDYixDQUFDLENBQUMsQ0FBQztJQUVILE9BQU8sT0FBTyxDQUFDO0FBQ2pCLENBQUM7QUFFTSxNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQUUsS0FBMkIsRUFBa0MsRUFBRTtJQUMzRixJQUFJLENBQUM7UUFDSCxNQUFNLE9BQU8sR0FBaUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxDQUFDO1FBRTdELElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ3ZDLE9BQU87Z0JBQ0wsVUFBVSxFQUFFLEdBQUc7Z0JBQ2YsT0FBTyxFQUFFO29CQUNQLGNBQWMsRUFBRSxrQkFBa0I7b0JBQ2xDLDZCQUE2QixFQUFFLEdBQUc7aUJBQ25DO2dCQUNELElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsS0FBSyxFQUFFLDBDQUEwQyxFQUFFLENBQUM7YUFDNUUsQ0FBQztRQUNKLENBQUM7UUFFRCxnQ0FBZ0M7UUFDaEMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUV6QixnRkFBZ0Y7UUFDaEYsTUFBTSxhQUFhLEdBQUcsTUFBTSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUkseUNBQXVCLENBQUM7WUFDL0QsV0FBVyxFQUFFLFdBQVc7WUFDeEIsU0FBUyxFQUFFLFVBQVU7WUFDckIsUUFBUSxFQUFFLGFBQWE7WUFDdkIsR0FBRyxFQUFFLHNEQUFzRDtTQUM1RCxDQUFDLENBQUMsQ0FBQztRQUVKLElBQUksbUJBQW1CLEdBQUcsQ0FBQyxhQUFhLENBQUMsT0FBTyxJQUFJLEVBQUUsQ0FBQzthQUNwRCxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsV0FBVyxDQUFDO2FBQ3JDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsRUFBZ0IsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUV0Qyw0REFBNEQ7UUFDNUQsSUFBSSxtQkFBbUIsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDckMsTUFBTSxlQUFlLEdBQUcsTUFBTSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUkseUNBQXVCLENBQUM7Z0JBQ2pFLFdBQVcsRUFBRSxXQUFXO2dCQUN4QixTQUFTLEVBQUUsVUFBVTtnQkFDckIsUUFBUSxFQUFFLGFBQWE7Z0JBQ3ZCLEdBQUcsRUFBRSxrRUFBa0U7YUFDeEUsQ0FBQyxDQUFDLENBQUM7WUFFSixtQkFBbUIsR0FBRyxDQUFDLGVBQWUsQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDO2lCQUNsRCxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsV0FBVyxDQUFDO2lCQUNyQyxNQUFNLENBQUMsQ0FBQyxFQUFFLEVBQWdCLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDeEMsQ0FBQztRQUVELDJCQUEyQjtRQUMzQixNQUFNLElBQUksR0FBRyxNQUFNLFlBQVksQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLG1CQUFtQixDQUFDLENBQUM7UUFFbEUsT0FBTztZQUNMLFVBQVUsRUFBRSxHQUFHO1lBQ2YsT0FBTyxFQUFFO2dCQUNQLGNBQWMsRUFBRSxrQkFBa0I7Z0JBQ2xDLDZCQUE2QixFQUFFLEdBQUc7YUFDbkM7WUFDRCxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDO1NBQy9CLENBQUM7SUFFSixDQUFDO0lBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztRQUNwQixPQUFPLENBQUMsS0FBSyxDQUFDLG9CQUFvQixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzNDLE9BQU87WUFDTCxVQUFVLEVBQUUsR0FBRztZQUNmLE9BQU8sRUFBRTtnQkFDUCxjQUFjLEVBQUUsa0JBQWtCO2dCQUNsQyw2QkFBNkIsRUFBRSxHQUFHO2FBQ25DO1lBQ0QsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7Z0JBQ25CLEtBQUssRUFBRSxLQUFLLENBQUMsT0FBTyxJQUFJLHVCQUF1QjthQUNoRCxDQUFDO1NBQ0gsQ0FBQztJQUNKLENBQUM7QUFDSCxDQUFDLENBQUM7QUFyRVcsUUFBQSxPQUFPLFdBcUVsQiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogUmUtcnVuIFF1ZXJ5IExhbWJkYVxuICpcbiAqIFJlLWV4ZWN1dGVzIGEgc3RvcmVkIFNRTCBxdWVyeSBmcm9tIGNoYXQgaGlzdG9yeSB0byByZWdlbmVyYXRlIHZpc3VhbGl6YXRpb24gZGF0YS5cbiAqIFVzZWQgd2hlbiBsb2FkaW5nIGhpc3RvcmljYWwgY29udmVyc2F0aW9ucyB0byByZW5kZXIgY2hhcnRzL21hcHMuXG4gKi9cblxuaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgUkRTRGF0YUNsaWVudCwgRXhlY3V0ZVN0YXRlbWVudENvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtcmRzLWRhdGEnO1xuXG5jb25zdCByZHMgPSBuZXcgUkRTRGF0YUNsaWVudCh7fSk7XG5cbmNvbnN0IENMVVNURVJfQVJOID0gcHJvY2Vzcy5lbnYuQ0xVU1RFUl9BUk4hO1xuY29uc3QgU0VDUkVUX0FSTiA9IHByb2Nlc3MuZW52LlNFQ1JFVF9BUk4hO1xuY29uc3QgREFUQUJBU0VfTkFNRSA9IHByb2Nlc3MuZW52LkRBVEFCQVNFX05BTUUhO1xuXG5pbnRlcmZhY2UgUmVydW5SZXF1ZXN0IHtcbiAgc3FsOiBzdHJpbmc7XG4gIHVzZXJFbWFpbDogc3RyaW5nO1xufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZVNRTChzcWw6IHN0cmluZyk6IHZvaWQge1xuICBjb25zdCBsb3dlclNRTCA9IHNxbC50b0xvd2VyQ2FzZSgpO1xuXG4gIC8vIE9ubHkgYWxsb3cgU0VMRUNUIHN0YXRlbWVudHNcbiAgaWYgKCFsb3dlclNRTC50cmltKCkuc3RhcnRzV2l0aCgnc2VsZWN0JykgJiYgIWxvd2VyU1FMLnRyaW0oKS5zdGFydHNXaXRoKCd3aXRoJykpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ09ubHkgU0VMRUNUIHF1ZXJpZXMgYXJlIGFsbG93ZWQnKTtcbiAgfVxuXG4gIC8vIEJsb2NrIGRhbmdlcm91cyBrZXl3b3Jkc1xuICBjb25zdCBkYW5nZXJvdXNLZXl3b3JkcyA9IFtcbiAgICAnaW5zZXJ0JywgJ3VwZGF0ZScsICdkZWxldGUnLCAnZHJvcCcsICd0cnVuY2F0ZScsICdhbHRlcicsXG4gICAgJ2NyZWF0ZScsICdncmFudCcsICdyZXZva2UnLCAnZXhlYycsICdleGVjdXRlJ1xuICBdO1xuXG4gIGZvciAoY29uc3Qga2V5d29yZCBvZiBkYW5nZXJvdXNLZXl3b3Jkcykge1xuICAgIGlmIChsb3dlclNRTC5pbmNsdWRlcyhrZXl3b3JkKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBLZXl3b3JkICcke2tleXdvcmR9JyBpcyBub3QgYWxsb3dlZGApO1xuICAgIH1cbiAgfVxuXG4gIC8vIE11c3QgaW5jbHVkZSBkZXZpY2UgZmlsdGVyXG4gIGlmICghc3FsLmluY2x1ZGVzKCc6ZGV2aWNlRmlsdGVyJykpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1F1ZXJ5IG11c3QgaW5jbHVkZSBkZXZpY2UgZmlsdGVyICg6ZGV2aWNlRmlsdGVyKScpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGV4ZWN1dGVRdWVyeShzcWw6IHN0cmluZywgZGV2aWNlU2VyaWFsTnVtYmVyczogc3RyaW5nW10pOiBQcm9taXNlPGFueVtdPiB7XG4gIC8vIFJlcGxhY2UgZGV2aWNlIGZpbHRlciBwbGFjZWhvbGRlclxuICBjb25zdCBkZXZpY2VMaXN0ID0gZGV2aWNlU2VyaWFsTnVtYmVycy5tYXAoc24gPT4gYCcke3NuLnJlcGxhY2UoLycvZywgXCInJ1wiKX0nYCkuam9pbignLCAnKTtcbiAgY29uc3QgZmluYWxTUUwgPSBzcWwucmVwbGFjZSgnOmRldmljZUZpbHRlcicsIGRldmljZUxpc3QpO1xuXG4gIGNvbnNvbGUubG9nKCdSZS1leGVjdXRpbmcgU1FMOicsIGZpbmFsU1FMKTtcblxuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJkcy5zZW5kKG5ldyBFeGVjdXRlU3RhdGVtZW50Q29tbWFuZCh7XG4gICAgcmVzb3VyY2VBcm46IENMVVNURVJfQVJOLFxuICAgIHNlY3JldEFybjogU0VDUkVUX0FSTixcbiAgICBkYXRhYmFzZTogREFUQUJBU0VfTkFNRSxcbiAgICBzcWw6IGZpbmFsU1FMLFxuICAgIGluY2x1ZGVSZXN1bHRNZXRhZGF0YTogdHJ1ZSxcbiAgfSkpO1xuXG4gIGlmICghcmVzcG9uc2UucmVjb3Jkcykge1xuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIC8vIENvbnZlcnQgUkRTIERhdGEgQVBJIGZvcm1hdCB0byBKU09OXG4gIGNvbnN0IGNvbHVtbk1ldGFkYXRhID0gcmVzcG9uc2UuY29sdW1uTWV0YWRhdGEgfHwgW107XG4gIGNvbnN0IHJlY29yZHMgPSByZXNwb25zZS5yZWNvcmRzLm1hcChyZWNvcmQgPT4ge1xuICAgIGNvbnN0IHJvdzogYW55ID0ge307XG4gICAgcmVjb3JkLmZvckVhY2goKGZpZWxkLCBpbmRleCkgPT4ge1xuICAgICAgY29uc3QgY29sdW1uTmFtZSA9IGNvbHVtbk1ldGFkYXRhW2luZGV4XT8ubmFtZSB8fCBgY29sdW1uXyR7aW5kZXh9YDtcbiAgICAgIGxldCB2YWx1ZTogYW55ID0gbnVsbDtcbiAgICAgIGlmIChmaWVsZC5zdHJpbmdWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHZhbHVlID0gZmllbGQuc3RyaW5nVmFsdWU7XG4gICAgICB9IGVsc2UgaWYgKGZpZWxkLmxvbmdWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHZhbHVlID0gZmllbGQubG9uZ1ZhbHVlO1xuICAgICAgfSBlbHNlIGlmIChmaWVsZC5kb3VibGVWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHZhbHVlID0gZmllbGQuZG91YmxlVmFsdWU7XG4gICAgICB9IGVsc2UgaWYgKGZpZWxkLmJvb2xlYW5WYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHZhbHVlID0gZmllbGQuYm9vbGVhblZhbHVlO1xuICAgICAgfSBlbHNlIGlmIChmaWVsZC5pc051bGwpIHtcbiAgICAgICAgdmFsdWUgPSBudWxsO1xuICAgICAgfVxuICAgICAgcm93W2NvbHVtbk5hbWVdID0gdmFsdWU7XG4gICAgfSk7XG4gICAgcmV0dXJuIHJvdztcbiAgfSk7XG5cbiAgcmV0dXJuIHJlY29yZHM7XG59XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCk6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgcmVxdWVzdDogUmVydW5SZXF1ZXN0ID0gSlNPTi5wYXJzZShldmVudC5ib2R5IHx8ICd7fScpO1xuXG4gICAgaWYgKCFyZXF1ZXN0LnNxbCB8fCAhcmVxdWVzdC51c2VyRW1haWwpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgICAgICAgfSxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ01pc3NpbmcgcmVxdWlyZWQgZmllbGRzIChzcWwsIHVzZXJFbWFpbCknIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSBTUUwgYmVmb3JlIGV4ZWN1dGlvblxuICAgIHZhbGlkYXRlU1FMKHJlcXVlc3Quc3FsKTtcblxuICAgIC8vIEdldCBhbGwgZGV2aWNlIHNlcmlhbCBudW1iZXJzICh1c2VyIGhhcyBhY2Nlc3MgdG8gYWxsIGluIHRoaXMgaW1wbGVtZW50YXRpb24pXG4gICAgY29uc3QgZGV2aWNlc1Jlc3VsdCA9IGF3YWl0IHJkcy5zZW5kKG5ldyBFeGVjdXRlU3RhdGVtZW50Q29tbWFuZCh7XG4gICAgICByZXNvdXJjZUFybjogQ0xVU1RFUl9BUk4sXG4gICAgICBzZWNyZXRBcm46IFNFQ1JFVF9BUk4sXG4gICAgICBkYXRhYmFzZTogREFUQUJBU0VfTkFNRSxcbiAgICAgIHNxbDogJ1NFTEVDVCBESVNUSU5DVCBzZXJpYWxfbnVtYmVyIEZST00gYW5hbHl0aWNzLmRldmljZXMnLFxuICAgIH0pKTtcblxuICAgIGxldCBkZXZpY2VTZXJpYWxOdW1iZXJzID0gKGRldmljZXNSZXN1bHQucmVjb3JkcyB8fCBbXSlcbiAgICAgIC5tYXAocmVjb3JkID0+IHJlY29yZFswXT8uc3RyaW5nVmFsdWUpXG4gICAgICAuZmlsdGVyKChzbik6IHNuIGlzIHN0cmluZyA9PiAhIXNuKTtcblxuICAgIC8vIEZhbGxiYWNrOiBjaGVjayB0ZWxlbWV0cnkgdGFibGUgaWYgZGV2aWNlcyB0YWJsZSBpcyBlbXB0eVxuICAgIGlmIChkZXZpY2VTZXJpYWxOdW1iZXJzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgY29uc3QgdGVsZW1ldHJ5UmVzdWx0ID0gYXdhaXQgcmRzLnNlbmQobmV3IEV4ZWN1dGVTdGF0ZW1lbnRDb21tYW5kKHtcbiAgICAgICAgcmVzb3VyY2VBcm46IENMVVNURVJfQVJOLFxuICAgICAgICBzZWNyZXRBcm46IFNFQ1JFVF9BUk4sXG4gICAgICAgIGRhdGFiYXNlOiBEQVRBQkFTRV9OQU1FLFxuICAgICAgICBzcWw6ICdTRUxFQ1QgRElTVElOQ1Qgc2VyaWFsX251bWJlciBGUk9NIGFuYWx5dGljcy50ZWxlbWV0cnkgTElNSVQgMTAwJyxcbiAgICAgIH0pKTtcblxuICAgICAgZGV2aWNlU2VyaWFsTnVtYmVycyA9ICh0ZWxlbWV0cnlSZXN1bHQucmVjb3JkcyB8fCBbXSlcbiAgICAgICAgLm1hcChyZWNvcmQgPT4gcmVjb3JkWzBdPy5zdHJpbmdWYWx1ZSlcbiAgICAgICAgLmZpbHRlcigoc24pOiBzbiBpcyBzdHJpbmcgPT4gISFzbik7XG4gICAgfVxuXG4gICAgLy8gRXhlY3V0ZSB0aGUgc3RvcmVkIHF1ZXJ5XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IGV4ZWN1dGVRdWVyeShyZXF1ZXN0LnNxbCwgZGV2aWNlU2VyaWFsTnVtYmVycyk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICAgICAgfSxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZGF0YSB9KSxcbiAgICB9O1xuXG4gIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICBjb25zb2xlLmVycm9yKCdSZXJ1biBxdWVyeSBlcnJvcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgICAgIH0sXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGVycm9yOiBlcnJvci5tZXNzYWdlIHx8ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InLFxuICAgICAgfSksXG4gICAgfTtcbiAgfVxufTtcbiJdfQ==