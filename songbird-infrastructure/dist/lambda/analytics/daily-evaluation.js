"use strict";
/**
 * Daily Evaluation Lambda
 *
 * Runs automated evaluations on the last 24 hours of analytics chat queries.
 * Generates a quality report and optionally sends it via SNS.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_sns_1 = require("@aws-sdk/client-sns");
const client_bedrock_runtime_1 = require("@aws-sdk/client-bedrock-runtime");
const evaluators_1 = require("./evaluators");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const ddb = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient);
const sns = new client_sns_1.SNSClient({});
const bedrock = new client_bedrock_runtime_1.BedrockRuntimeClient({ region: 'us-east-1' });
const CHAT_HISTORY_TABLE = process.env.CHAT_HISTORY_TABLE;
const REPORT_SNS_TOPIC = process.env.REPORT_SNS_TOPIC; // Optional
// Use the same model as chat-query for evaluations (Haiku not enabled in this account)
const EVAL_MODEL_ID = process.env.EVAL_MODEL_ID || 'us.anthropic.claude-3-5-sonnet-20241022-v2:0';
const handler = async (_event) => {
    console.log('Starting daily evaluation...');
    const yesterday = Date.now() - (24 * 60 * 60 * 1000);
    // Scan chat history for last 24h
    // Using Scan + filter since there's no timestamp-based GSI
    const queries = [];
    let lastEvaluatedKey;
    do {
        const result = await ddb.send(new lib_dynamodb_1.ScanCommand({
            TableName: CHAT_HISTORY_TABLE,
            FilterExpression: '#ts > :yesterday',
            ExpressionAttributeNames: { '#ts': 'timestamp' },
            ExpressionAttributeValues: { ':yesterday': yesterday },
            ExclusiveStartKey: lastEvaluatedKey,
        }));
        if (result.Items) {
            queries.push(...result.Items);
        }
        lastEvaluatedKey = result.LastEvaluatedKey;
    } while (lastEvaluatedKey);
    console.log(`Evaluating ${queries.length} queries from last 24h`);
    if (queries.length === 0) {
        console.log('No queries to evaluate. Skipping report.');
        return;
    }
    // Run code-based evaluations
    let syntaxValid = 0;
    let executionSuccess = 0;
    const complexityDistribution = { simple: 0, medium: 0, complex: 0 };
    const errorCounts = {};
    for (const query of queries) {
        if (!query.sql)
            continue;
        // Evaluate SQL syntax
        const syntaxResult = (0, evaluators_1.evaluateSQLSyntax)(query.sql);
        if (syntaxResult.score === 1.0) {
            syntaxValid++;
        }
        else {
            const errors = syntaxResult.metadata?.errors || [];
            for (const error of errors) {
                errorCounts[error] = (errorCounts[error] || 0) + 1;
            }
        }
        // Evaluate execution success
        const executionError = query.execution_error || null;
        const execResult = (0, evaluators_1.evaluateSQLExecution)(executionError, query.row_count || 0);
        if (execResult.score === 1.0) {
            executionSuccess++;
        }
        // Analyze complexity
        const complexityResult = (0, evaluators_1.analyzeQueryComplexity)(query.sql);
        const category = complexityResult.label;
        complexityDistribution[category]++;
    }
    // Run LLM-based evaluations on a sample (to control cost)
    // Evaluate up to 20 queries per run with Haiku (~$0.001 per evaluation)
    const llmSampleSize = Math.min(queries.length, 20);
    const llmSample = queries
        .filter(q => q.sql && q.question && q.insights)
        .slice(0, llmSampleSize);
    let totalRelevanceScore = 0;
    let totalHallucinationScore = 0;
    let llmEvaluatedCount = 0;
    for (let i = 0; i < llmSample.length; i++) {
        const query = llmSample[i];
        try {
            const [relevanceResult, hallucinationResult] = await Promise.all([
                (0, evaluators_1.evaluateInsightRelevance)(bedrock, EVAL_MODEL_ID, query.question, query.sql, query.insights),
                (0, evaluators_1.evaluateSQLHallucination)(bedrock, EVAL_MODEL_ID, query.question, query.sql),
            ]);
            // Only count non-error results in averages
            if (relevanceResult.label !== 'error' && hallucinationResult.label !== 'error') {
                totalRelevanceScore += relevanceResult.score;
                totalHallucinationScore += hallucinationResult.score;
                llmEvaluatedCount++;
                console.log(`LLM eval [${i + 1}/${llmSample.length}]: relevance=${relevanceResult.score.toFixed(2)} (${relevanceResult.label}), hallucination=${hallucinationResult.score.toFixed(2)} (${hallucinationResult.label})`);
            }
            else {
                const relErr = relevanceResult.label === 'error' ? relevanceResult.explanation : null;
                const halErr = hallucinationResult.label === 'error' ? hallucinationResult.explanation : null;
                console.warn(`LLM eval [${i + 1}/${llmSample.length}] error: relevance=${relErr}, hallucination=${halErr}`);
            }
        }
        catch (error) {
            console.error(`LLM evaluation failed for query [${i + 1}]: ${query.question}`, error);
        }
    }
    const avgInsightRelevance = llmEvaluatedCount > 0 ? totalRelevanceScore / llmEvaluatedCount : 0;
    const avgHallucinationScore = llmEvaluatedCount > 0 ? totalHallucinationScore / llmEvaluatedCount : 0;
    // Generate report
    const report = {
        date: new Date().toISOString().split('T')[0],
        totalQueries: queries.length,
        syntaxValidRate: queries.length > 0 ? syntaxValid / queries.length : 0,
        executionSuccessRate: queries.length > 0 ? executionSuccess / queries.length : 0,
        avgInsightRelevance,
        avgHallucinationScore,
        llmEvaluatedCount,
        complexityDistribution,
        topErrors: Object.entries(errorCounts)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 10)
            .map(([error, count]) => ({ error, count })),
    };
    console.log('Evaluation Report:', JSON.stringify(report, null, 2));
    // Emit single-line structured metrics for CloudWatch metric filters
    console.log(JSON.stringify({
        metric: 'EvaluationReport',
        totalQueries: report.totalQueries,
        syntaxValidRate: report.syntaxValidRate,
        executionSuccessRate: report.executionSuccessRate,
        avgInsightRelevance: report.avgInsightRelevance,
        avgHallucinationScore: report.avgHallucinationScore,
        llmEvaluatedCount: report.llmEvaluatedCount,
        simpleQueries: report.complexityDistribution.simple,
        mediumQueries: report.complexityDistribution.medium,
        complexQueries: report.complexityDistribution.complex,
    }));
    // Send to SNS (optional)
    if (REPORT_SNS_TOPIC) {
        await sns.send(new client_sns_1.PublishCommand({
            TopicArn: REPORT_SNS_TOPIC,
            Subject: `Analytics Evaluation Report - ${report.date}`,
            Message: formatReport(report),
        }));
        console.log('Report sent to SNS topic');
    }
    console.log('Daily evaluation complete');
};
exports.handler = handler;
function formatReport(report) {
    const lines = [
        `Analytics Evaluation Report - ${report.date}`,
        '============================================',
        '',
        `Total Queries: ${report.totalQueries}`,
        '',
        'Code-Based Metrics:',
        `- SQL Syntax Valid: ${(report.syntaxValidRate * 100).toFixed(1)}%`,
        `- Execution Success: ${(report.executionSuccessRate * 100).toFixed(1)}%`,
        '',
        `LLM-Based Metrics (${report.llmEvaluatedCount} queries sampled):`,
        `- Avg Insight Relevance: ${(report.avgInsightRelevance * 100).toFixed(1)}% (0-100%)`,
        `- Avg Hallucination Score: ${(report.avgHallucinationScore * 100).toFixed(1)}% (higher = less hallucination)`,
        '',
        'Complexity Distribution:',
        `- Simple: ${report.complexityDistribution.simple} (${((report.complexityDistribution.simple / report.totalQueries) * 100).toFixed(1)}%)`,
        `- Medium: ${report.complexityDistribution.medium} (${((report.complexityDistribution.medium / report.totalQueries) * 100).toFixed(1)}%)`,
        `- Complex: ${report.complexityDistribution.complex} (${((report.complexityDistribution.complex / report.totalQueries) * 100).toFixed(1)}%)`,
        '',
        'Top Errors:',
        ...report.topErrors.map((e, i) => `${i + 1}. ${e.error}: ${e.count} occurrences`),
        '',
        'View detailed traces at: https://phoenix.songbird.live',
    ];
    return lines.join('\n');
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGFpbHktZXZhbHVhdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xhbWJkYS9hbmFseXRpY3MvZGFpbHktZXZhbHVhdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7O0dBS0c7OztBQUdILDhEQUEwRDtBQUMxRCx3REFBNEU7QUFDNUUsb0RBQWdFO0FBQ2hFLDRFQUF1RTtBQUN2RSw2Q0FNc0I7QUFFdEIsTUFBTSxTQUFTLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3pDLE1BQU0sR0FBRyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUNuRCxNQUFNLEdBQUcsR0FBRyxJQUFJLHNCQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDOUIsTUFBTSxPQUFPLEdBQUcsSUFBSSw2Q0FBb0IsQ0FBQyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO0FBRWxFLE1BQU0sa0JBQWtCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBbUIsQ0FBQztBQUMzRCxNQUFNLGdCQUFnQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxXQUFXO0FBQ2xFLHVGQUF1RjtBQUN2RixNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsSUFBSSw4Q0FBOEMsQ0FBQztBQWtCM0YsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUFFLE1BQXNCLEVBQWlCLEVBQUU7SUFDckUsT0FBTyxDQUFDLEdBQUcsQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO0lBRTVDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO0lBRXJELGlDQUFpQztJQUNqQywyREFBMkQ7SUFDM0QsTUFBTSxPQUFPLEdBQTBCLEVBQUUsQ0FBQztJ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QUFDO1FBQ2pGLEVBQUU7UUFDRix3REFBd0Q7S0FDekQsQ0FBQztJQUVGLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUMxQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBEYWlseSBFdmFsdWF0aW9uIExhbWJkYVxuICpcbiAqIFJ1bnMgYXV0b21hdGVkIGV2YWx1YXRpb25zIG9uIHRoZSBsYXN0IDI0IGhvdXJzIG9mIGFuYWx5dGljcyBjaGF0IHF1ZXJpZXMuXG4gKiBHZW5lcmF0ZXMgYSBxdWFsaXR5IHJlcG9ydCBhbmQgb3B0aW9uYWxseSBzZW5kcyBpdCB2aWEgU05TLlxuICovXG5cbmltcG9ydCB7IFNjaGVkdWxlZEV2ZW50IH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQgeyBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LCBTY2FuQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBTTlNDbGllbnQsIFB1Ymxpc2hDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXNucyc7XG5pbXBvcnQgeyBCZWRyb2NrUnVudGltZUNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1iZWRyb2NrLXJ1bnRpbWUnO1xuaW1wb3J0IHtcbiAgZXZhbHVhdGVTUUxTeW50YXgsXG4gIGV2YWx1YXRlU1FMRXhlY3V0aW9uLFxuICBhbmFseXplUXVlcnlDb21wbGV4aXR5LFxuICBldmFsdWF0ZUluc2lnaHRSZWxldmFuY2UsXG4gIGV2YWx1YXRlU1FMSGFsbHVjaW5hdGlvbixcbn0gZnJvbSAnLi9ldmFsdWF0b3JzJztcblxuY29uc3QgZGRiQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRkYiA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkZGJDbGllbnQpO1xuY29uc3Qgc25zID0gbmV3IFNOU0NsaWVudCh7fSk7XG5jb25zdCBiZWRyb2NrID0gbmV3IEJlZHJvY2tSdW50aW1lQ2xpZW50KHsgcmVnaW9uOiAndXMtZWFzdC0xJyB9KTtcblxuY29uc3QgQ0hBVF9ISVNUT1JZX1RBQkxFID0gcHJvY2Vzcy5lbnYuQ0hBVF9ISVNUT1JZX1RBQkxFITtcbmNvbnN0IFJFUE9SVF9TTlNfVE9QSUMgPSBwcm9jZXNzLmVudi5SRVBPUlRfU05TX1RPUElDOyAvLyBPcHRpb25hbFxuLy8gVXNlIHRoZSBzYW1lIG1vZGVsIGFzIGNoYXQtcXVlcnkgZm9yIGV2YWx1YXRpb25zIChIYWlrdSBub3QgZW5hYmxlZCBpbiB0aGlzIGFjY291bnQpXG5jb25zdCBFVkFMX01PREVMX0lEID0gcHJvY2Vzcy5lbnYuRVZBTF9NT0RFTF9JRCB8fCAndXMuYW50aHJvcGljLmNsYXVkZS0zLTUtc29ubmV0LTIwMjQxMDIyLXYyOjAnO1xuXG5pbnRlcmZhY2UgRXZhbHVhdGlvblJlcG9ydCB7XG4gIGRhdGU6IHN0cmluZztcbiAgdG90YWxRdWVyaWVzOiBudW1iZXI7XG4gIHN5bnRheFZhbGlkUmF0ZTogbnVtYmVyO1xuICBleGVjdXRpb25TdWNjZXNzUmF0ZTogbnVtYmVyO1xuICBhdmdJbnNpZ2h0UmVsZXZhbmNlOiBudW1iZXI7XG4gIGF2Z0hhbGx1Y2luYXRpb25TY29yZTogbnVtYmVyO1xuICBsbG1FdmFsdWF0ZWRDb3VudDogbnVtYmVyO1xuICBjb21wbGV4aXR5RGlzdHJpYnV0aW9uOiB7XG4gICAgc2ltcGxlOiBudW1iZXI7XG4gICAgbWVkaXVtOiBudW1iZXI7XG4gICAgY29tcGxleDogbnVtYmVyO1xuICB9O1xuICB0b3BFcnJvcnM6IEFycmF5PHsgZXJyb3I6IHN0cmluZzsgY291bnQ6IG51bWJlciB9Pjtcbn1cblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoX2V2ZW50OiBTY2hlZHVsZWRFdmVudCk6IFByb21pc2U8dm9pZD4gPT4ge1xuICBjb25zb2xlLmxvZygnU3RhcnRpbmcgZGFpbHkgZXZhbHVhdGlvbi4uLicpO1xuXG4gIGNvbnN0IHllc3RlcmRheSA9IERhdGUubm93KCkgLSAoMjQgKiA2MCAqIDYwICogMTAwMCk7XG5cbiAgLy8gU2NhbiBjaGF0IGhpc3RvcnkgZm9yIGxhc3QgMjRoXG4gIC8vIFVzaW5nIFNjYW4gKyBmaWx0ZXIgc2luY2UgdGhlcmUncyBubyB0aW1lc3RhbXAtYmFzZWQgR1NJXG4gIGNvbnN0IHF1ZXJpZXM6IFJlY29yZDxzdHJpbmcsIGFueT5bXSA9IFtdO1xuICBsZXQgbGFzdEV2YWx1YXRlZEtleTogUmVjb3JkPHN0cmluZywgYW55PiB8IHVuZGVmaW5lZDtcblxuICBkbyB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZGRiLnNlbmQobmV3IFNjYW5Db21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogQ0hBVF9ISVNUT1JZX1RBQkxFLFxuICAgICAgRmlsdGVyRXhwcmVzc2lvbjogJyN0cyA+IDp5ZXN0ZXJkYXknLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiB7ICcjdHMnOiAndGltZXN0YW1wJyB9LFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogeyAnOnllc3RlcmRheSc6IHllc3RlcmRheSB9LFxuICAgICAgRXhjbHVzaXZlU3RhcnRLZXk6IGxhc3RFdmFsdWF0ZWRLZXksXG4gICAgfSkpO1xuXG4gICAgaWYgKHJlc3VsdC5JdGVtcykge1xuICAgICAgcXVlcmllcy5wdXNoKC4uLnJlc3VsdC5JdGVtcyk7XG4gICAgfVxuICAgIGxhc3RFdmFsdWF0ZWRLZXkgPSByZXN1bHQuTGFzdEV2YWx1YXRlZEtleTtcbiAgfSB3aGlsZSAobGFzdEV2YWx1YXRlZEtleSk7XG5cbiAgY29uc29sZS5sb2coYEV2YWx1YXRpbmcgJHtxdWVyaWVzLmxlbmd0aH0gcXVlcmllcyBmcm9tIGxhc3QgMjRoYCk7XG5cbiAgaWYgKHF1ZXJpZXMubGVuZ3RoID09PSAwKSB7XG4gICAgY29uc29sZS5sb2coJ05vIHF1ZXJpZXMgdG8gZXZhbHVhdGUuIFNraXBwaW5nIHJlcG9ydC4nKTtcbiAgICByZXR1cm47XG4gIH1cblxuICAvLyBSdW4gY29kZS1iYXNlZCBldmFsdWF0aW9uc1xuICBsZXQgc3ludGF4VmFsaWQgPSAwO1xuICBsZXQgZXhlY3V0aW9uU3VjY2VzcyA9IDA7XG4gIGNvbnN0IGNvbXBsZXhpdHlEaXN0cmlidXRpb24gPSB7IHNpbXBsZTogMCwgbWVkaXVtOiAwLCBjb21wbGV4OiAwIH07XG4gIGNvbnN0IGVycm9yQ291bnRzOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+ID0ge307XG5cbiAgZm9yIChjb25zdCBxdWVyeSBvZiBxdWVyaWVzKSB7XG4gICAgaWYgKCFxdWVyeS5zcWwpIGNvbnRpbnVlO1xuXG4gICAgLy8gRXZhbHVhdGUgU1FMIHN5bnRheFxuICAgIGNvbnN0IHN5bnRheFJlc3VsdCA9IGV2YWx1YXRlU1FMU3ludGF4KHF1ZXJ5LnNxbCk7XG4gICAgaWYgKHN5bnRheFJlc3VsdC5zY29yZSA9PT0gMS4wKSB7XG4gICAgICBzeW50YXhWYWxpZCsrO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBlcnJvcnMgPSAoc3ludGF4UmVzdWx0Lm1ldGFkYXRhPy5lcnJvcnMgYXMgc3RyaW5nW10pIHx8IFtdO1xuICAgICAgZm9yIChjb25zdCBlcnJvciBvZiBlcnJvcnMpIHtcbiAgICAgICAgZXJyb3JDb3VudHNbZXJyb3JdID0gKGVycm9yQ291bnRzW2Vycm9yXSB8fCAwKSArIDE7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gRXZhbHVhdGUgZXhlY3V0aW9uIHN1Y2Nlc3NcbiAgICBjb25zdCBleGVjdXRpb25FcnJvciA9IHF1ZXJ5LmV4ZWN1dGlvbl9lcnJvciB8fCBudWxsO1xuICAgIGNvbnN0IGV4ZWNSZXN1bHQgPSBldmFsdWF0ZVNRTEV4ZWN1dGlvbihleGVjdXRpb25FcnJvciwgcXVlcnkucm93X2NvdW50IHx8IDApO1xuICAgIGlmIChleGVjUmVzdWx0LnNjb3JlID09PSAxLjApIHtcbiAgICAgIGV4ZWN1dGlvblN1Y2Nlc3MrKztcbiAgICB9XG5cbiAgICAvLyBBbmFseXplIGNvbXBsZXhpdHlcbiAgICBjb25zdCBjb21wbGV4aXR5UmVzdWx0ID0gYW5hbHl6ZVF1ZXJ5Q29tcGxleGl0eShxdWVyeS5zcWwpO1xuICAgIGNvbnN0IGNhdGVnb3J5ID0gY29tcGxleGl0eVJlc3VsdC5sYWJlbCBhcyAnc2ltcGxlJyB8ICdtZWRpdW0nIHwgJ2NvbXBsZXgnO1xuICAgIGNvbXBsZXhpdHlEaXN0cmlidXRpb25bY2F0ZWdvcnldKys7XG4gIH1cblxuICAvLyBSdW4gTExNLWJhc2VkIGV2YWx1YXRpb25zIG9uIGEgc2FtcGxlICh0byBjb250cm9sIGNvc3QpXG4gIC8vIEV2YWx1YXRlIHVwIHRvIDIwIHF1ZXJpZXMgcGVyIHJ1biB3aXRoIEhhaWt1ICh+JDAuMDAxIHBlciBldmFsdWF0aW9uKVxuICBjb25zdCBsbG1TYW1wbGVTaXplID0gTWF0aC5taW4ocXVlcmllcy5sZW5ndGgsIDIwKTtcbiAgY29uc3QgbGxtU2FtcGxlID0gcXVlcmllc1xuICAgIC5maWx0ZXIocSA9PiBxLnNxbCAmJiBxLnF1ZXN0aW9uICYmIHEuaW5zaWdodHMpXG4gICAgLnNsaWNlKDAsIGxsbVNhbXBsZVNpemUpO1xuXG4gIGxldCB0b3RhbFJlbGV2YW5jZVNjb3JlID0gMDtcbiAgbGV0IHRvdGFsSGFsbHVjaW5hdGlvblNjb3JlID0gMDtcbiAgbGV0IGxsbUV2YWx1YXRlZENvdW50ID0gMDtcblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGxsbVNhbXBsZS5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IHF1ZXJ5ID0gbGxtU2FtcGxlW2ldO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBbcmVsZXZhbmNlUmVzdWx0LCBoYWxsdWNpbmF0aW9uUmVzdWx0XSA9IGF3YWl0IFByb21pc2UuYWxsKFtcbiAgICAgICAgZXZhbHVhdGVJbnNpZ2h0UmVsZXZhbmNlKGJlZHJvY2ssIEVWQUxfTU9ERUxfSUQsIHF1ZXJ5LnF1ZXN0aW9uLCBxdWVyeS5zcWwsIHF1ZXJ5Lmluc2lnaHRzKSxcbiAgICAgICAgZXZhbHVhdGVTUUxIYWxsdWNpbmF0aW9uKGJlZHJvY2ssIEVWQUxfTU9ERUxfSUQsIHF1ZXJ5LnF1ZXN0aW9uLCBxdWVyeS5zcWwpLFxuICAgICAgXSk7XG5cbiAgICAgIC8vIE9ubHkgY291bnQgbm9uLWVycm9yIHJlc3VsdHMgaW4gYXZlcmFnZXNcbiAgICAgIGlmIChyZWxldmFuY2VSZXN1bHQubGFiZWwgIT09ICdlcnJvcicgJiYgaGFsbHVjaW5hdGlvblJlc3VsdC5sYWJlbCAhPT0gJ2Vycm9yJykge1xuICAgICAgICB0b3RhbFJlbGV2YW5jZVNjb3JlICs9IHJlbGV2YW5jZVJlc3VsdC5zY29yZTtcbiAgICAgICAgdG90YWxIYWxsdWNpbmF0aW9uU2NvcmUgKz0gaGFsbHVjaW5hdGlvblJlc3VsdC5zY29yZTtcbiAgICAgICAgbGxtRXZhbHVhdGVkQ291bnQrKztcbiAgICAgICAgY29uc29sZS5sb2coYExMTSBldmFsIFske2kgKyAxfS8ke2xsbVNhbXBsZS5sZW5ndGh9XTogcmVsZXZhbmNlPSR7cmVsZXZhbmNlUmVzdWx0LnNjb3JlLnRvRml4ZWQoMil9ICgke3JlbGV2YW5jZVJlc3VsdC5sYWJlbH0pLCBoYWxsdWNpbmF0aW9uPSR7aGFsbHVjaW5hdGlvblJlc3VsdC5zY29yZS50b0ZpeGVkKDIpfSAoJHtoYWxsdWNpbmF0aW9uUmVzdWx0LmxhYmVsfSlgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHJlbEVyciA9IHJlbGV2YW5jZVJlc3VsdC5sYWJlbCA9PT0gJ2Vycm9yJyA/IHJlbGV2YW5jZVJlc3VsdC5leHBsYW5hdGlvbiA6IG51bGw7XG4gICAgICAgIGNvbnN0IGhhbEVyciA9IGhhbGx1Y2luYXRpb25SZXN1bHQubGFiZWwgPT09ICdlcnJvcicgPyBoYWxsdWNpbmF0aW9uUmVzdWx0LmV4cGxhbmF0aW9uIDogbnVsbDtcbiAgICAgICAgY29uc29sZS53YXJuKGBMTE0gZXZhbCBbJHtpICsgMX0vJHtsbG1TYW1wbGUubGVuZ3RofV0gZXJyb3I6IHJlbGV2YW5jZT0ke3JlbEVycn0sIGhhbGx1Y2luYXRpb249JHtoYWxFcnJ9YCk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYExMTSBldmFsdWF0aW9uIGZhaWxlZCBmb3IgcXVlcnkgWyR7aSArIDF9XTogJHtxdWVyeS5xdWVzdGlvbn1gLCBlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgYXZnSW5zaWdodFJlbGV2YW5jZSA9IGxsbUV2YWx1YXRlZENvdW50ID4gMCA/IHRvdGFsUmVsZXZhbmNlU2NvcmUgLyBsbG1FdmFsdWF0ZWRDb3VudCA6IDA7XG4gIGNvbnN0IGF2Z0hhbGx1Y2luYXRpb25TY29yZSA9IGxsbUV2YWx1YXRlZENvdW50ID4gMCA/IHRvdGFsSGFsbHVjaW5hdGlvblNjb3JlIC8gbGxtRXZhbHVhdGVkQ291bnQgOiAwO1xuXG4gIC8vIEdlbmVyYXRlIHJlcG9ydFxuICBjb25zdCByZXBvcnQ6IEV2YWx1YXRpb25SZXBvcnQgPSB7XG4gICAgZGF0ZTogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnNwbGl0KCdUJylbMF0sXG4gICAgdG90YWxRdWVyaWVzOiBxdWVyaWVzLmxlbmd0aCxcbiAgICBzeW50YXhWYWxpZFJhdGU6IHF1ZXJpZXMubGVuZ3RoID4gMCA/IHN5bnRheFZhbGlkIC8gcXVlcmllcy5sZW5ndGggOiAwLFxuICAgIGV4ZWN1dGlvblN1Y2Nlc3NSYXRlOiBxdWVyaWVzLmxlbmd0aCA+IDAgPyBleGVjdXRpb25TdWNjZXNzIC8gcXVlcmllcy5sZW5ndGggOiAwLFxuICAgIGF2Z0luc2lnaHRSZWxldmFuY2UsXG4gICAgYXZnSGFsbHVjaW5hdGlvblNjb3JlLFxuICAgIGxsbUV2YWx1YXRlZENvdW50LFxuICAgIGNvbXBsZXhpdHlEaXN0cmlidXRpb24sXG4gICAgdG9wRXJyb3JzOiBPYmplY3QuZW50cmllcyhlcnJvckNvdW50cylcbiAgICAgIC5zb3J0KChbLCBhXSwgWywgYl0pID0+IGIgLSBhKVxuICAgICAgLnNsaWNlKDAsIDEwKVxuICAgICAgLm1hcCgoW2Vycm9yLCBjb3VudF0pID0+ICh7IGVycm9yLCBjb3VudCB9KSksXG4gIH07XG5cbiAgY29uc29sZS5sb2coJ0V2YWx1YXRpb24gUmVwb3J0OicsIEpTT04uc3RyaW5naWZ5KHJlcG9ydCwgbnVsbCwgMikpO1xuXG4gIC8vIEVtaXQgc2luZ2xlLWxpbmUgc3RydWN0dXJlZCBtZXRyaWNzIGZvciBDbG91ZFdhdGNoIG1ldHJpYyBmaWx0ZXJzXG4gIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHtcbiAgICBtZXRyaWM6ICdFdmFsdWF0aW9uUmVwb3J0JyxcbiAgICB0b3RhbFF1ZXJpZXM6IHJlcG9ydC50b3RhbFF1ZXJpZXMsXG4gICAgc3ludGF4VmFsaWRSYXRlOiByZXBvcnQuc3ludGF4VmFsaWRSYXRlLFxuICAgIGV4ZWN1dGlvblN1Y2Nlc3NSYXRlOiByZXBvcnQuZXhlY3V0aW9uU3VjY2Vzc1JhdGUsXG4gICAgYXZnSW5zaWdodFJlbGV2YW5jZTogcmVwb3J0LmF2Z0luc2lnaHRSZWxldmFuY2UsXG4gICAgYXZnSGFsbHVjaW5hdGlvblNjb3JlOiByZXBvcnQuYXZnSGFsbHVjaW5hdGlvblNjb3JlLFxuICAgIGxsbUV2YWx1YXRlZENvdW50OiByZXBvcnQubGxtRXZhbHVhdGVkQ291bnQsXG4gICAgc2ltcGxlUXVlcmllczogcmVwb3J0LmNvbXBsZXhpdHlEaXN0cmlidXRpb24uc2ltcGxlLFxuICAgIG1lZGl1bVF1ZXJpZXM6IHJlcG9ydC5jb21wbGV4aXR5RGlzdHJpYnV0aW9uLm1lZGl1bSxcbiAgICBjb21wbGV4UXVlcmllczogcmVwb3J0LmNvbXBsZXhpdHlEaXN0cmlidXRpb24uY29tcGxleCxcbiAgfSkpO1xuXG4gIC8vIFNlbmQgdG8gU05TIChvcHRpb25hbClcbiAgaWYgKFJFUE9SVF9TTlNfVE9QSUMpIHtcbiAgICBhd2FpdCBzbnMuc2VuZChuZXcgUHVibGlzaENvbW1hbmQoe1xuICAgICAgVG9waWNBcm46IFJFUE9SVF9TTlNfVE9QSUMsXG4gICAgICBTdWJqZWN0OiBgQW5hbHl0aWNzIEV2YWx1YXRpb24gUmVwb3J0IC0gJHtyZXBvcnQuZGF0ZX1gLFxuICAgICAgTWVzc2FnZTogZm9ybWF0UmVwb3J0KHJlcG9ydCksXG4gICAgfSkpO1xuICAgIGNvbnNvbGUubG9nKCdSZXBvcnQgc2VudCB0byBTTlMgdG9waWMnKTtcbiAgfVxuXG4gIGNvbnNvbGUubG9nKCdEYWlseSBldmFsdWF0aW9uIGNvbXBsZXRlJyk7XG59O1xuXG5mdW5jdGlvbiBmb3JtYXRSZXBvcnQocmVwb3J0OiBFdmFsdWF0aW9uUmVwb3J0KTogc3RyaW5nIHtcbiAgY29uc3QgbGluZXMgPSBbXG4gICAgYEFuYWx5dGljcyBFdmFsdWF0aW9uIFJlcG9ydCAtICR7cmVwb3J0LmRhdGV9YCxcbiAgICAnPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0nLFxuICAgICcnLFxuICAgIGBUb3RhbCBRdWVyaWVzOiAke3JlcG9ydC50b3RhbFF1ZXJpZXN9YCxcbiAgICAnJyxcbiAgICAnQ29kZS1CYXNlZCBNZXRyaWNzOicsXG4gICAgYC0gU1FMIFN5bnRheCBWYWxpZDogJHsocmVwb3J0LnN5bnRheFZhbGlkUmF0ZSAqIDEwMCkudG9GaXhlZCgxKX0lYCxcbiAgICBgLSBFeGVjdXRpb24gU3VjY2VzczogJHsocmVwb3J0LmV4ZWN1dGlvblN1Y2Nlc3NSYXRlICogMTAwKS50b0ZpeGVkKDEpfSVgLFxuICAgICcnLFxuICAgIGBMTE0tQmFzZWQgTWV0cmljcyAoJHtyZXBvcnQubGxtRXZhbHVhdGVkQ291bnR9IHF1ZXJpZXMgc2FtcGxlZCk6YCxcbiAgICBgLSBBdmcgSW5zaWdodCBSZWxldmFuY2U6ICR7KHJlcG9ydC5hdmdJbnNpZ2h0UmVsZXZhbmNlICogMTAwKS50b0ZpeGVkKDEpfSUgKDAtMTAwJSlgLFxuICAgIGAtIEF2ZyBIYWxsdWNpbmF0aW9uIFNjb3JlOiAkeyhyZXBvcnQuYXZnSGFsbHVjaW5hdGlvblNjb3JlICogMTAwKS50b0ZpeGVkKDEpfSUgKGhpZ2hlciA9IGxlc3MgaGFsbHVjaW5hdGlvbilgLFxuICAgICcnLFxuICAgICdDb21wbGV4aXR5IERpc3RyaWJ1dGlvbjonLFxuICAgIGAtIFNpbXBsZTogJHtyZXBvcnQuY29tcGxleGl0eURpc3RyaWJ1dGlvbi5zaW1wbGV9ICgkeygocmVwb3J0LmNvbXBsZXhpdHlEaXN0cmlidXRpb24uc2ltcGxlIC8gcmVwb3J0LnRvdGFsUXVlcmllcykgKiAxMDApLnRvRml4ZWQoMSl9JSlgLFxuICAgIGAtIE1lZGl1bTogJHtyZXBvcnQuY29tcGxleGl0eURpc3RyaWJ1dGlvbi5tZWRpdW19ICgkeygocmVwb3J0LmNvbXBsZXhpdHlEaXN0cmlidXRpb24ubWVkaXVtIC8gcmVwb3J0LnRvdGFsUXVlcmllcykgKiAxMDApLnRvRml4ZWQoMSl9JSlgLFxuICAgIGAtIENvbXBsZXg6ICR7cmVwb3J0LmNvbXBsZXhpdHlEaXN0cmlidXRpb24uY29tcGxleH0gKCR7KChyZXBvcnQuY29tcGxleGl0eURpc3RyaWJ1dGlvbi5jb21wbGV4IC8gcmVwb3J0LnRvdGFsUXVlcmllcykgKiAxMDApLnRvRml4ZWQoMSl9JSlgLFxuICAgICcnLFxuICAgICdUb3AgRXJyb3JzOicsXG4gICAgLi4ucmVwb3J0LnRvcEVycm9ycy5tYXAoKGUsIGkpID0+IGAke2kgKyAxfS4gJHtlLmVycm9yfTogJHtlLmNvdW50fSBvY2N1cnJlbmNlc2ApLFxuICAgICcnLFxuICAgICdWaWV3IGRldGFpbGVkIHRyYWNlcyBhdDogaHR0cHM6Ly9waG9lbml4LnNvbmdiaXJkLmxpdmUnLFxuICBdO1xuXG4gIHJldHVybiBsaW5lcy5qb2luKCdcXG4nKTtcbn1cbiJdfQ==