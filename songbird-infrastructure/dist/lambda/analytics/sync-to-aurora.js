"use strict";
/**
 * DynamoDB â†’ Aurora Real-Time Sync
 *
 * Processes DynamoDB Stream events and syncs data to Aurora analytics database.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_rds_data_1 = require("@aws-sdk/client-rds-data");
const util_dynamodb_1 = require("@aws-sdk/util-dynamodb");
const rds = new client_rds_data_1.RDSDataClient({});
const CLUSTER_ARN = process.env.CLUSTER_ARN;
const SECRET_ARN = process.env.SECRET_ARN;
const DATABASE_NAME = process.env.DATABASE_NAME;
const TABLE_CONFIGS = {
    'songbird-devices': {
        table: 'analytics.devices',
        primaryKey: ['serial_number'],
        columnMapping: {
            serial_number: 'serial_number',
            device_uid: 'device_uid',
            name: 'name',
            fleet_name: 'fleet_name',
            fleet_uid: 'fleet_uid',
            product_uid: 'product_uid',
            last_seen: 'last_seen',
            last_location_lat: 'last_location_lat',
            last_location_lon: 'last_location_lon',
            status: 'status',
            voltage: 'voltage',
            temperature: 'temperature',
            created_at: 'created_at',
            updated_at: 'updated_at',
        },
    },
    'songbird-telemetry': {
        table: 'analytics.telemetry',
        primaryKey: ['serial_number', 'time'],
        columnMapping: {
            device_uid: 'device_uid',
            serial_number: 'serial_number',
            timestamp: 'time',
            temperature: 'temperature',
            humidity: 'humidity',
            pressure: 'pressure',
            voltage: 'voltage',
            event_type: 'event_type',
        },
    },
    'songbird-locations': {
        table: 'analytics.locations',
        primaryKey: ['serial_number', 'time'],
        columnMapping: {
            device_uid: 'device_uid',
            serial_number: 'serial_number',
            timestamp: 'time',
            latitude: 'lat',
            longitude: 'lon',
            source: 'source',
            journey_id: 'journey_id',
        },
    },
    'songbird-alerts': {
        table: 'analytics.alerts',
        primaryKey: ['alert_id'],
        columnMapping: {
            alert_id: 'alert_id',
            device_uid: 'device_uid',
            serial_number: 'serial_number',
            alert_type: 'alert_type',
            severity: 'severity',
            message: 'message',
            acknowledged: 'acknowledged',
            created_at: 'created_at',
            acknowledged_at: 'acknowledged_at',
            acknowledged_by: 'acknowledged_by',
        },
    },
    'songbird-journeys': {
        table: 'analytics.journeys',
        primaryKey: ['serial_number', 'journey_id'],
        columnMapping: {
            device_uid: 'device_uid',
            serial_number: 'serial_number',
            journey_id: 'journey_id',
            start_time: 'start_time',
            end_time: 'end_time',
            status: 'status',
            total_distance: 'distance_km',
        },
    },
};
function getTableName(sourceArn) {
    const match = sourceArn.match(/table\/([\w-]+)\//);
    return match ? match[1] : '';
}
function buildUpsertSQL(config, item) {
    const columns = [];
    const values = [];
    for (const [sourceCol, targetCol] of Object.entries(config.columnMapping)) {
        if (item[sourceCol] !== undefined) {
            columns.push(targetCol);
            let value = item[sourceCol];
            // Handle timestamps - convert to PostgreSQL timestamp if numeric
            // DynamoDB stores timestamps in milliseconds, TO_TIMESTAMP expects seconds
            if (targetCol === 'time' && typeof value === 'number') {
                const seconds = value > 9999999999 ? value / 1000 : value;
                values.push(`TO_TIMESTAMP(${seconds})`);
            }
            // Handle booleans
            else if (typeof value === 'boolean') {
                values.push(value ? 'TRUE' : 'FALSE');
            }
            // Handle strings
            else if (typeof value === 'string') {
                values.push(`'${value.replace(/'/g, "''")}'`);
            }
            // Handle numbers
            else if (typeof value === 'number') {
                values.push(String(value));
            }
            // Handle nulls
            else if (value === null) {
                values.push('NULL');
            }
        }
    }
    if (columns.length === 0) {
        return '';
    }
    const updateClauses = columns
        .filter(col => !config.primaryKey.includes(col))
        .map(col => `${col} = EXCLUDED.${col}`)
        .join(', ');
    const sql = `
    INSERT INTO ${config.table} (${columns.join(', ')})
    VALUES (${values.join(', ')})
    ${updateClauses ? `ON CONFLICT (${config.primaryKey.join(', ')}) DO UPDATE SET ${updateClauses}` : ''}
  `;
    return sql;
}
function buildDeleteSQL(config, keys) {
    const whereClauses = config.primaryKey.map(key => {
        const value = keys[key];
        if (typeof value === 'string') {
            return `${key} = '${value.replace(/'/g, "''")}'`;
        }
        else if (typeof value === 'number') {
            return `${key} = ${value}`;
        }
        return '';
    }).filter(c => c);
    return `DELETE FROM ${config.table} WHERE ${whereClauses.join(' AND ')}`;
}
const handler = async (event) => {
    try {
        if (!event.Records || event.Records.length === 0) {
            console.log('No records to process');
            return;
        }
        const tableName = getTableName(event.Records[0].eventSourceARN);
        const config = TABLE_CONFIGS[tableName];
        if (!config) {
            console.log(`No config found for table: ${tableName}`);
            return;
        }
        console.log(`Processing ${event.Records.length} records from ${tableName}`);
        const statements = [];
        for (const record of event.Records) {
            try {
                if (record.eventName === 'INSERT' || record.eventName === 'MODIFY') {
                    const newImage = (0, util_dynamodb_1.unmarshall)(record.dynamodb.NewImage);
                    const sql = buildUpsertSQL(config, newImage);
                    if (sql) {
                        statements.push(sql);
                    }
                }
                else if (record.eventName === 'REMOVE') {
                    const oldImage = (0, util_dynamodb_1.unmarshall)(record.dynamodb.OldImage);
                    const sql = buildDeleteSQL(config, oldImage);
                    if (sql) {
                        statements.push(sql);
                    }
                }
            }
            catch (error) {
                console.error('Error processing record:', error);
                console.error('Record:', JSON.stringify(record, null, 2));
            }
        }
        // Execute statements
        for (const sql of statements) {
            try {
                await rds.send(new client_rds_data_1.ExecuteStatementCommand({
                    resourceArn: CLUSTER_ARN,
                    secretArn: SECRET_ARN,
                    database: DATABASE_NAME,
                    sql,
                }));
            }
            catch (error) {
                console.error('SQL execution error:', error);
                console.error('SQL:', sql);
            }
        }
        console.log(`Successfully synced ${statements.length} records to Aurora`);
    }
    catch (error) {
        console.error('Sync error:', error);
        throw error;
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3luYy10by1hdXJvcmEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvYW5hbHl0aWNzL3N5bmMtdG8tYXVyb3JhLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHOzs7QUFHSCw4REFBZ0g7QUFDaEgsMERBQW9EO0FBRXBELE1BQU0sR0FBRyxHQUFHLElBQUksK0JBQWEsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUVsQyxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVksQ0FBQztBQUM3QyxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVcsQ0FBQztBQUMzQyxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWMsQ0FBQztBQVFqRCxNQUFNLGFBQWEsR0FBbUM7SUFDcEQsa0JBQWtCLEVBQUU7UUFDbEIsS0FBSyxFQUFFLG1CQUFtQjtRQUMxQixVQUFVLEVBQUUsQ0FBQyxlQUFlLENBQUM7UUFDN0IsYUFBYSxFQUFFO1lBQ2IsYUFBYSxFQUFFLGVBQWU7WUFDOUIsVUFBVSxFQUFFLFlBQVk7WUFDeEIsSUFBSSxFQUFFLE1BQU07WUFDWixVQUFVLEVBQUUsWUFBWTtZQUN4QixTQUFTLEVBQUUsV0FBVztZQUN0QixXQUFXLEVBQUUsYUFBYTtZQUMxQixTQUFTLEVBQUUsV0FBVztZQUN0QixpQkFBaUIsRUFBRSxtQkFBbUI7WUFDdEMsaUJBQWlCLEVBQUUsbUJBQW1CO1lBQ3RDLE1BQU0sRUFBRSxRQUFRO1lBQ2hCLE9BQU8sRUFBRSxTQUFTO1lBQ2xCLFdBQVcsRUFBRSxhQUFhO1lBQzFCLFVBQVUsRUFBRSxZQUFZO1lBQ3hCLFVBQVUsRUFBRSxZQUFZO1NBQ3pCO0tBQ0Y7SUFDRCxvQkFBb0IsRUFBRTtRQUNwQixLQUFLLEVBQUUscUJBQXFCO1FBQzVCLFVBQVUsRUFBRSxDQUFDLGVBQWUsRUFBRSxNQUFNLENBQUM7UUFDckMsYUFBYSxFQUFF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IOKGkiBBdXJvcmEgUmVhbC1UaW1lIFN5bmNcbiAqXG4gKiBQcm9jZXNzZXMgRHluYW1vREIgU3RyZWFtIGV2ZW50cyBhbmQgc3luY3MgZGF0YSB0byBBdXJvcmEgYW5hbHl0aWNzIGRhdGFiYXNlLlxuICovXG5cbmltcG9ydCB7IER5bmFtb0RCU3RyZWFtRXZlbnQsIER5bmFtb0RCUmVjb3JkIH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBSRFNEYXRhQ2xpZW50LCBFeGVjdXRlU3RhdGVtZW50Q29tbWFuZCwgQmF0Y2hFeGVjdXRlU3RhdGVtZW50Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1yZHMtZGF0YSc7XG5pbXBvcnQgeyB1bm1hcnNoYWxsIH0gZnJvbSAnQGF3cy1zZGsvdXRpbC1keW5hbW9kYic7XG5cbmNvbnN0IHJkcyA9IG5ldyBSRFNEYXRhQ2xpZW50KHt9KTtcblxuY29uc3QgQ0xVU1RFUl9BUk4gPSBwcm9jZXNzLmVudi5DTFVTVEVSX0FSTiE7XG5jb25zdCBTRUNSRVRfQVJOID0gcHJvY2Vzcy5lbnYuU0VDUkVUX0FSTiE7XG5jb25zdCBEQVRBQkFTRV9OQU1FID0gcHJvY2Vzcy5lbnYuREFUQUJBU0VfTkFNRSE7XG5cbmludGVyZmFjZSBUYWJsZUNvbmZpZyB7XG4gIHRhYmxlOiBzdHJpbmc7XG4gIHByaW1hcnlLZXk6IHN0cmluZ1tdO1xuICBjb2x1bW5NYXBwaW5nOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9O1xufVxuXG5jb25zdCBUQUJMRV9DT05GSUdTOiB7IFtrZXk6IHN0cmluZ106IFRhYmxlQ29uZmlnIH0gPSB7XG4gICdzb25nYmlyZC1kZXZpY2VzJzoge1xuICAgIHRhYmxlOiAnYW5hbHl0aWNzLmRldmljZXMnLFxuICAgIHByaW1hcnlLZXk6IFsnc2VyaWFsX251bWJlciddLFxuICAgIGNvbHVtbk1hcHBpbmc6IHtcbiAgICAgIHNlcmlhbF9udW1iZXI6ICdzZXJpYWxfbnVtYmVyJyxcbiAgICAgIGRldmljZV91aWQ6ICdkZXZpY2VfdWlkJyxcbiAgICAgIG5hbWU6ICduYW1lJyxcbiAgICAgIGZsZWV0X25hbWU6ICdmbGVldF9uYW1lJyxcbiAgICAgIGZsZWV0X3VpZDogJ2ZsZWV0X3VpZCcsXG4gICAgICBwcm9kdWN0X3VpZDogJ3Byb2R1Y3RfdWlkJyxcbiAgICAgIGxhc3Rfc2VlbjogJ2xhc3Rfc2VlbicsXG4gICAgICBsYXN0X2xvY2F0aW9uX2xhdDogJ2xhc3RfbG9jYXRpb25fbGF0JyxcbiAgICAgIGxhc3RfbG9jYXRpb25fbG9uOiAnbGFzdF9sb2NhdGlvbl9sb24nLFxuICAgICAgc3RhdHVzOiAnc3RhdHVzJyxcbiAgICAgIHZvbHRhZ2U6ICd2b2x0YWdlJyxcbiAgICAgIHRlbXBlcmF0dXJlOiAndGVtcGVyYXR1cmUnLFxuICAgICAgY3JlYXRlZF9hdDogJ2NyZWF0ZWRfYXQnLFxuICAgICAgdXBkYXRlZF9hdDogJ3VwZGF0ZWRfYXQnLFxuICAgIH0sXG4gIH0sXG4gICdzb25nYmlyZC10ZWxlbWV0cnknOiB7XG4gICAgdGFibGU6ICdhbmFseXRpY3MudGVsZW1ldHJ5JyxcbiAgICBwcmltYXJ5S2V5OiBbJ3NlcmlhbF9udW1iZXInLCAndGltZSddLFxuICAgIGNvbHVtbk1hcHBpbmc6IHtcbiAgICAgIGRldmljZV91aWQ6ICdkZXZpY2VfdWlkJyxcbiAgICAgIHNlcmlhbF9udW1iZXI6ICdzZXJpYWxfbnVtYmVyJyxcbiAgICAgIHRpbWVzdGFtcDogJ3RpbWUnLFxuICAgICAgdGVtcGVyYXR1cmU6ICd0ZW1wZXJhdHVyZScsXG4gICAgICBodW1pZGl0eTogJ2h1bWlkaXR5JyxcbiAgICAgIHByZXNzdXJlOiAncHJlc3N1cmUnLFxuICAgICAgdm9sdGFnZTogJ3ZvbHRhZ2UnLFxuICAgICAgZXZlbnRfdHlwZTogJ2V2ZW50X3R5cGUnLFxuICAgIH0sXG4gIH0sXG4gICdzb25nYmlyZC1sb2NhdGlvbnMnOiB7XG4gICAgdGFibGU6ICdhbmFseXRpY3MubG9jYXRpb25zJyxcbiAgICBwcmltYXJ5S2V5OiBbJ3NlcmlhbF9udW1iZXInLCAndGltZSddLFxuICAgIGNvbHVtbk1hcHBpbmc6IHtcbiAgICAgIGRldmljZV91aWQ6ICdkZXZpY2VfdWlkJyxcbiAgICAgIHNlcmlhbF9udW1iZXI6ICdzZXJpYWxfbnVtYmVyJyxcbiAgICAgIHRpbWVzdGFtcDogJ3RpbWUnLFxuICAgICAgbGF0aXR1ZGU6ICdsYXQnLFxuICAgICAgbG9uZ2l0dWRlOiAnbG9uJyxcbiAgICAgIHNvdXJjZTogJ3NvdXJjZScsXG4gICAgICBqb3VybmV5X2lkOiAnam91cm5leV9pZCcsXG4gICAgfSxcbiAgfSxcbiAgJ3NvbmdiaXJkLWFsZXJ0cyc6IHtcbiAgICB0YWJsZTogJ2FuYWx5dGljcy5hbGVydHMnLFxuICAgIHByaW1hcnlLZXk6IFsnYWxlcnRfaWQnXSxcbiAgICBjb2x1bW5NYXBwaW5nOiB7XG4gICAgICBhbGVydF9pZDogJ2FsZXJ0X2lkJyxcbiAgICAgIGRldmljZV91aWQ6ICdkZXZpY2VfdWlkJyxcbiAgICAgIHNlcmlhbF9udW1iZXI6ICdzZXJpYWxfbnVtYmVyJyxcbiAgICAgIGFsZXJ0X3R5cGU6ICdhbGVydF90eXBlJyxcbiAgICAgIHNldmVyaXR5OiAnc2V2ZXJpdHknLFxuICAgICAgbWVzc2FnZTogJ21lc3NhZ2UnLFxuICAgICAgYWNrbm93bGVkZ2VkOiAnYWNrbm93bGVkZ2VkJyxcbiAgICAgIGNyZWF0ZWRfYXQ6ICdjcmVhdGVkX2F0JyxcbiAgICAgIGFja25vd2xlZGdlZF9hdDogJ2Fja25vd2xlZGdlZF9hdCcsXG4gICAgICBhY2tub3dsZWRnZWRfYnk6ICdhY2tub3dsZWRnZWRfYnknLFxuICAgIH0sXG4gIH0sXG4gICdzb25nYmlyZC1qb3VybmV5cyc6IHtcbiAgICB0YWJsZTogJ2FuYWx5dGljcy5qb3VybmV5cycsXG4gICAgcHJpbWFyeUtleTogWydzZXJpYWxfbnVtYmVyJywgJ2pvdXJuZXlfaWQnXSxcbiAgICBjb2x1bW5NYXBwaW5nOiB7XG4gICAgICBkZXZpY2VfdWlkOiAnZGV2aWNlX3VpZCcsXG4gICAgICBzZXJpYWxfbnVtYmVyOiAnc2VyaWFsX251bWJlcicsXG4gICAgICBqb3VybmV5X2lkOiAnam91cm5leV9pZCcsXG4gICAgICBzdGFydF90aW1lOiAnc3RhcnRfdGltZScsXG4gICAgICBlbmRfdGltZTogJ2VuZF90aW1lJyxcbiAgICAgIHN0YXR1czogJ3N0YXR1cycsXG4gICAgICB0b3RhbF9kaXN0YW5jZTogJ2Rpc3RhbmNlX2ttJyxcbiAgICB9LFxuICB9LFxufTtcblxuZnVuY3Rpb24gZ2V0VGFibGVOYW1lKHNvdXJjZUFybjogc3RyaW5nKTogc3RyaW5nIHtcbiAgY29uc3QgbWF0Y2ggPSBzb3VyY2VBcm4ubWF0Y2goL3RhYmxlXFwvKFtcXHctXSspXFwvLyk7XG4gIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7XG59XG5cbmZ1bmN0aW9uIGJ1aWxkVXBzZXJ0U1FMKGNvbmZpZzogVGFibGVDb25maWcsIGl0ZW06IGFueSk6IHN0cmluZyB7XG4gIGNvbnN0IGNvbHVtbnM6IHN0cmluZ1tdID0gW107XG4gIGNvbnN0IHZhbHVlczogc3RyaW5nW10gPSBbXTtcblxuICBmb3IgKGNvbnN0IFtzb3VyY2VDb2wsIHRhcmdldENvbF0gb2YgT2JqZWN0LmVudHJpZXMoY29uZmlnLmNvbHVtbk1hcHBpbmcpKSB7XG4gICAgaWYgKGl0ZW1bc291cmNlQ29sXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBjb2x1bW5zLnB1c2godGFyZ2V0Q29sKTtcblxuICAgICAgbGV0IHZhbHVlID0gaXRlbVtzb3VyY2VDb2xdO1xuXG4gICAgICAvLyBIYW5kbGUgdGltZXN0YW1wcyAtIGNvbnZlcnQgdG8gUG9zdGdyZVNRTCB0aW1lc3RhbXAgaWYgbnVtZXJpY1xuICAgICAgLy8gRHluYW1vREIgc3RvcmVzIHRpbWVzdGFtcHMgaW4gbWlsbGlzZWNvbmRzLCBUT19USU1FU1RBTVAgZXhwZWN0cyBzZWNvbmRzXG4gICAgICBpZiAodGFyZ2V0Q29sID09PSAndGltZScgJiYgdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykge1xuICAgICAgICBjb25zdCBzZWNvbmRzID0gdmFsdWUgPiA5OTk5OTk5OTk5ID8gdmFsdWUgLyAxMDAwIDogdmFsdWU7XG4gICAgICAgIHZhbHVlcy5wdXNoKGBUT19USU1FU1RBTVAoJHtzZWNvbmRzfSlgKTtcbiAgICAgIH1cbiAgICAgIC8vIEhhbmRsZSBib29sZWFuc1xuICAgICAgZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbicpIHtcbiAgICAgICAgdmFsdWVzLnB1c2godmFsdWUgPyAnVFJVRScgOiAnRkFMU0UnKTtcbiAgICAgIH1cbiAgICAgIC8vIEhhbmRsZSBzdHJpbmdzXG4gICAgICBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHZhbHVlcy5wdXNoKGAnJHt2YWx1ZS5yZXBsYWNlKC8nL2csIFwiJydcIil9J2ApO1xuICAgICAgfVxuICAgICAgLy8gSGFuZGxlIG51bWJlcnNcbiAgICAgIGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgdmFsdWVzLnB1c2goU3RyaW5nKHZhbHVlKSk7XG4gICAgICB9XG4gICAgICAvLyBIYW5kbGUgbnVsbHNcbiAgICAgIGVsc2UgaWYgKHZhbHVlID09PSBudWxsKSB7XG4gICAgICAgIHZhbHVlcy5wdXNoKCdOVUxMJyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKGNvbHVtbnMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuICcnO1xuICB9XG5cbiAgY29uc3QgdXBkYXRlQ2xhdXNlcyA9IGNvbHVtbnNcbiAgICAuZmlsdGVyKGNvbCA9PiAhY29uZmlnLnByaW1hcnlLZXkuaW5jbHVkZXMoY29sKSlcbiAgICAubWFwKGNvbCA9PiBgJHtjb2x9ID0gRVhDTFVERUQuJHtjb2x9YClcbiAgICAuam9pbignLCAnKTtcblxuICBjb25zdCBzcWwgPSBgXG4gICAgSU5TRVJUIElOVE8gJHtjb25maWcudGFibGV9ICgke2NvbHVtbnMuam9pbignLCAnKX0pXG4gICAgVkFMVUVTICgke3ZhbHVlcy5qb2luKCcsICcpfSlcbiAgICAke3VwZGF0ZUNsYXVzZXMgPyBgT04gQ09ORkxJQ1QgKCR7Y29uZmlnLnByaW1hcnlLZXkuam9pbignLCAnKX0pIERPIFVQREFURSBTRVQgJHt1cGRhdGVDbGF1c2VzfWAgOiAnJ31cbiAgYDtcblxuICByZXR1cm4gc3FsO1xufVxuXG5mdW5jdGlvbiBidWlsZERlbGV0ZVNRTChjb25maWc6IFRhYmxlQ29uZmlnLCBrZXlzOiBhbnkpOiBzdHJpbmcge1xuICBjb25zdCB3aGVyZUNsYXVzZXMgPSBjb25maWcucHJpbWFyeUtleS5tYXAoa2V5ID0+IHtcbiAgICBjb25zdCB2YWx1ZSA9IGtleXNba2V5XTtcbiAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgcmV0dXJuIGAke2tleX0gPSAnJHt2YWx1ZS5yZXBsYWNlKC8nL2csIFwiJydcIil9J2A7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSB7XG4gICAgICByZXR1cm4gYCR7a2V5fSA9ICR7dmFsdWV9YDtcbiAgICB9XG4gICAgcmV0dXJuICcnO1xuICB9KS5maWx0ZXIoYyA9PiBjKTtcblxuICByZXR1cm4gYERFTEVURSBGUk9NICR7Y29uZmlnLnRhYmxlfSBXSEVSRSAke3doZXJlQ2xhdXNlcy5qb2luKCcgQU5EICcpfWA7XG59XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBEeW5hbW9EQlN0cmVhbUV2ZW50KTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gIHRyeSB7XG4gICAgaWYgKCFldmVudC5SZWNvcmRzIHx8IGV2ZW50LlJlY29yZHMubGVuZ3RoID09PSAwKSB7XG4gICAgICBjb25zb2xlLmxvZygnTm8gcmVjb3JkcyB0byBwcm9jZXNzJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgdGFibGVOYW1lID0gZ2V0VGFibGVOYW1lKGV2ZW50LlJlY29yZHNbMF0uZXZlbnRTb3VyY2VBUk4hKTtcbiAgICBjb25zdCBjb25maWcgPSBUQUJMRV9DT05GSUdTW3RhYmxlTmFtZV07XG5cbiAgICBpZiAoIWNvbmZpZykge1xuICAgICAgY29uc29sZS5sb2coYE5vIGNvbmZpZyBmb3VuZCBmb3IgdGFibGU6ICR7dGFibGVOYW1lfWApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKGBQcm9jZXNzaW5nICR7ZXZlbnQuUmVjb3Jkcy5sZW5ndGh9IHJlY29yZHMgZnJvbSAke3RhYmxlTmFtZX1gKTtcblxuICAgIGNvbnN0IHN0YXRlbWVudHM6IHN0cmluZ1tdID0gW107XG5cbiAgICBmb3IgKGNvbnN0IHJlY29yZCBvZiBldmVudC5SZWNvcmRzKSB7XG4gICAgICB0cnkge1xuICAgICAgICBpZiAocmVjb3JkLmV2ZW50TmFtZSA9PT0gJ0lOU0VSVCcgfHwgcmVjb3JkLmV2ZW50TmFtZSA9PT0gJ01PRElGWScpIHtcbiAgICAgICAgICBjb25zdCBuZXdJbWFnZSA9IHVubWFyc2hhbGwocmVjb3JkLmR5bmFtb2RiIS5OZXdJbWFnZSBhcyBhbnkpO1xuICAgICAgICAgIGNvbnN0IHNxbCA9IGJ1aWxkVXBzZXJ0U1FMKGNvbmZpZywgbmV3SW1hZ2UpO1xuICAgICAgICAgIGlmIChzcWwpIHtcbiAgICAgICAgICAgIHN0YXRlbWVudHMucHVzaChzcWwpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChyZWNvcmQuZXZlbnROYW1lID09PSAnUkVNT1ZFJykge1xuICAgICAgICAgIGNvbnN0IG9sZEltYWdlID0gdW5tYXJzaGFsbChyZWNvcmQuZHluYW1vZGIhLk9sZEltYWdlIGFzIGFueSk7XG4gICAgICAgICAgY29uc3Qgc3FsID0gYnVpbGREZWxldGVTUUwoY29uZmlnLCBvbGRJbWFnZSk7XG4gICAgICAgICAgaWYgKHNxbCkge1xuICAgICAgICAgICAgc3RhdGVtZW50cy5wdXNoKHNxbCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHByb2Nlc3NpbmcgcmVjb3JkOicsIGVycm9yKTtcbiAgICAgICAgY29uc29sZS5lcnJvcignUmVjb3JkOicsIEpTT04uc3RyaW5naWZ5KHJlY29yZCwgbnVsbCwgMikpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEV4ZWN1dGUgc3RhdGVtZW50c1xuICAgIGZvciAoY29uc3Qgc3FsIG9mIHN0YXRlbWVudHMpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHJkcy5zZW5kKG5ldyBFeGVjdXRlU3RhdGVtZW50Q29tbWFuZCh7XG4gICAgICAgICAgcmVzb3VyY2VBcm46IENMVVNURVJfQVJOLFxuICAgICAgICAgIHNlY3JldEFybjogU0VDUkVUX0FSTixcbiAgICAgICAgICBkYXRhYmFzZTogREFUQUJBU0VfTkFNRSxcbiAgICAgICAgICBzcWwsXG4gICAgICAgIH0pKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignU1FMIGV4ZWN1dGlvbiBlcnJvcjonLCBlcnJvcik7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ1NRTDonLCBzcWwpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKGBTdWNjZXNzZnVsbHkgc3luY2VkICR7c3RhdGVtZW50cy5sZW5ndGh9IHJlY29yZHMgdG8gQXVyb3JhYCk7XG5cbiAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgIGNvbnNvbGUuZXJyb3IoJ1N5bmMgZXJyb3I6JywgZXJyb3IpO1xuICAgIHRocm93IGVycm9yO1xuICB9XG59O1xuIl19