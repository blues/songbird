"use strict";
/**
 * Activity Feed API Lambda
 *
 * Returns a unified activity feed combining:
 * - Alerts (from alerts table)
 * - Health events (from telemetry table)
 * - Location updates (from telemetry table)
 * - Device status changes (derived from device last_seen)
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient);
const TELEMETRY_TABLE = process.env.TELEMETRY_TABLE;
const ALERTS_TABLE = process.env.ALERTS_TABLE;
const DEVICES_TABLE = process.env.DEVICES_TABLE;
const handler = async (event) => {
    console.log('Request:', JSON.stringify(event));
    const corsHeaders = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type,Authorization',
        'Access-Control-Allow-Methods': 'GET,OPTIONS',
    };
    try {
        const method = event.requestContext?.http?.method || event.httpMethod;
        if (method === 'OPTIONS') {
            return { statusCode: 200, headers: corsHeaders, body: '' };
        }
        const queryParams = event.queryStringParameters || {};
        const hours = parseInt(queryParams.hours || '24');
        const limit = parseInt(queryParams.limit || '50');
        // Fetch activities from all sources in parallel
        const [alerts, healthEvents, locationEvents, devices] = await Promise.all([
            getRecentAlerts(hours, limit),
            getRecentHealthEvents(hours, limit),
            getRecentLocationEvents(hours, limit),
            getDevices(),
        ]);
        console.log(`Found ${alerts.length} alerts, ${healthEvents.length} health events, ${locationEvents.length} location events`);
        // Create device name lookup
        const deviceNames = {};
        for (const device of devices) {
            deviceNames[device.device_uid] = device.name || device.serial_number || device.device_uid;
        }
        // Transform alerts to activity items
        const alertActivities = alerts.map((alert) => ({
            id: `alert-${alert.alert_id}`,
            type: 'alert',
            device_uid: alert.device_uid,
            device_name: deviceNames[alert.device_uid],
            message: formatAlertMessage(alert),
            timestamp: new Date(alert.created_at).toISOString(),
            data: {
                alert_type: alert.type,
                value: alert.value,
                threshold: alert.threshold,
                acknowledged: alert.acknowledged,
            },
        }));
        // Transform health events to activity items
        const healthActivities = healthEvents.map((event) => ({
            id: `health-${event.device_uid}-${event.timestamp}`,
            type: 'health',
            device_uid: event.device_uid,
            device_name: deviceNames[event.device_uid],
            message: formatHealthMessage(event),
            timestamp: new Date(event.timestamp).toISOString(),
            data: {
                method: event.method,
                voltage: event.voltage,
            },
        }));
        // Transform location events to activity items
        const locationActivities = locationEvents.map((event) => ({
            id: `location-${event.device_uid}-${event.timestamp}`,
            type: 'location',
            device_uid: event.device_uid,
            device_name: deviceNames[event.device_uid],
            message: formatLocationMessage(event, deviceNames[event.device_uid]),
            timestamp: new Date(event.timestamp).toISOString(),
            data: {
                lat: event.latitude,
                lon: event.longitude,
                source: event.location_source,
            },
        }));
        // Merge all activities and sort by timestamp (newest first)
        const allActivities = [...alertActivities, ...healthActivities, ...locationActivities]
            .sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime())
            .slice(0, limit);
        return {
            statusCode: 200,
            headers: corsHeaders,
            body: JSON.stringify({
                hours,
                count: allActivities.length,
                activities: allActivities,
            }),
        };
    }
    catch (error) {
        console.error('Error:', error);
        return {
            statusCode: 500,
            headers: corsHeaders,
            body: JSON.stringify({ error: 'Internal server error' }),
        };
    }
};
exports.handler = handler;
async function getRecentAlerts(hours, limit) {
    const cutoffTime = Date.now() - hours * 60 * 60 * 1000;
    const allItems = [];
    let lastEvaluatedKey;
    // Paginate through all results
    do {
        const command = new lib_dynamodb_1.ScanCommand({
            TableName: ALERTS_TABLE,
            FilterExpression: 'created_at > :cutoff',
            ExpressionAttributeValues: {
                ':cutoff': cutoffTime,
            },
            ExclusiveStartKey: lastEvaluatedKey,
        });
        const result = await docClient.send(command);
        allItems.push(...(result.Items || []));
        lastEvaluatedKey = result.LastEvaluatedKey;
        // Stop early if we have enough items
        if (allItems.length >= limit * 2)
            break;
    } while (lastEvaluatedKey);
    return allItems.slice(0, limit * 2);
}
async function getRecentHealthEvents(hours, limit) {
    const cutoffTime = Date.now() - hours * 60 * 60 * 1000;
    const allItems = [];
    let lastEvaluatedKey;
    // Paginate through all results
    do {
        const command = new lib_dynamodb_1.ScanCommand({
            TableName: TELEMETRY_TABLE,
            FilterExpression: '#ts > :cutoff AND data_type = :data_type',
            ExpressionAttributeNames: {
                '#ts': 'timestamp',
            },
            ExpressionAttributeValues: {
                ':cutoff': cutoffTime,
                ':data_type': 'health',
            },
            ExclusiveStartKey: lastEvaluatedKey,
        });
        const result = await docClient.send(command);
        allItems.push(...(result.Items || []));
        lastEvaluatedKey = result.LastEvaluatedKey;
        // Stop early if we have enough items
        if (allItems.length >= limit * 2)
            break;
    } while (lastEvaluatedKey);
    return allItems.slice(0, limit * 2);
}
async function getRecentLocationEvents(hours, limit) {
    const cutoffTime = Date.now() - hours * 60 * 60 * 1000;
    const allItems = [];
    let lastEvaluatedKey;
    // Paginate through all results - DynamoDB Scan returns max 1MB per call
    do {
        const command = new lib_dynamodb_1.ScanCommand({
            TableName: TELEMETRY_TABLE,
            FilterExpression: '#ts > :cutoff AND event_type = :event_type',
            ExpressionAttributeNames: {
                '#ts': 'timestamp',
            },
            ExpressionAttributeValues: {
                ':cutoff': cutoffTime,
                ':event_type': '_geolocate.qo',
            },
            ExclusiveStartKey: lastEvaluatedKey,
        });
        const result = await docClient.send(command);
        allItems.push(...(result.Items || []));
        lastEvaluatedKey = result.LastEvaluatedKey;
        // Stop early if we have enough items
        if (allItems.length >= limit * 2)
            break;
    } while (lastEvaluatedKey);
    return allItems.slice(0, limit * 2);
}
async function getDevices() {
    const command = new lib_dynamodb_1.ScanCommand({
        TableName: DEVICES_TABLE,
        ProjectionExpression: 'device_uid, #name, serial_number',
        ExpressionAttributeNames: {
            '#name': 'name',
        },
    });
    const result = await docClient.send(command);
    return result.Items || [];
}
function formatAlertMessage(alert) {
    const alertLabels = {
        temp_high: 'High temperature alert',
        temp_low: 'Low temperature alert',
        humidity_high: 'High humidity alert',
        humidity_low: 'Low humidity alert',
        pressure_change: 'Pressure change alert',
        low_battery: 'Low battery alert',
        motion: 'Motion detected',
    };
    const label = alertLabels[alert.type] || alert.type;
    if (alert.value !== undefined) {
        return `${label}: ${alert.value.toFixed(1)}`;
    }
    return label;
}
function formatHealthMessage(event) {
    const methodLabels = {
        dfu: 'Firmware update',
        boot: 'Device booted',
        reboot: 'Device rebooted',
        reset: 'Device reset',
        usb: 'USB connected',
        battery: 'Battery status update',
        sync: 'Sync completed',
        connected: 'Connected to network',
        disconnected: 'Disconnected from network',
    };
    const label = methodLabels[event.method] || event.method || 'Health event';
    if (event.text) {
        return `${label}: ${event.text}`;
    }
    return label;
}
function formatLocationMessage(event, deviceName) {
    const name = deviceName || event.device_uid;
    const sourceLabels = {
        gps: 'GPS location',
        triangulation: 'Triangulated location',
        cell: 'Cell tower location',
        tower: 'Cell tower location',
        wifi: 'Wi-Fi location',
    };
    const sourceLabel = sourceLabels[event.location_source] || 'Location update';
    return `${sourceLabel} received`;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvYXBpLWFjdGl2aXR5L2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7R0FRRzs7O0FBRUgsOERBQTBEO0FBQzFELHdEQUEwRjtBQUcxRixNQUFNLFNBQVMsR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDekMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBRXpELE1BQU0sZUFBZSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZ0IsQ0FBQztBQUNyRCxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQWEsQ0FBQztBQUMvQyxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWMsQ0FBQztBQVkxQyxNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQUUsS0FBMkIsRUFBa0MsRUFBRTtJQUMzRixPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFFL0MsTUFBTSxXQUFXLEdBQUc7UUFDbEIsNkJBQTZCLEVBQUUsR0FBRztRQUNsQyw4QkFBOEIsRUFBRSw0QkFBNEI7UUFDNUQsOEJBQThCLEVBQUUsYUFBYTtLQUM5QyxDQUFDO0lBRUYsSUFBSSxDQUFDO1FBQ0gsTUFBTSxNQUFNLEdBQUksS0FBSyxDQUFDLGNBQXNCLEVBQUUsSUFBSSxFQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsVUFBVSxDQUFDO1FBRS9FLElBQUksTUFBTSxLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQ3pCLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxDQUFDO1FBQzdELENBQUM7UUFFRCxNQUFNLFdBQVcsR0FB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QUM7SUFDM0UsSUFBSSxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDZixPQUFPLEdBQUcsS0FBSyxLQUFLLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNuQyxDQUFDO0lBQ0QsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDO0FBRUQsU0FBUyxxQkFBcUIsQ0FBQyxLQUFVLEVBQUUsVUFBbUI7SUFDNUQsTUFBTSxJQUFJLEdBQUcsVUFBVSxJQUFJLEtBQUssQ0FBQyxVQUFVLENBQUM7SUFDNUMsTUFBTSxZQUFZLEdBQTJCO1FBQzNDLEdBQUcsRUFBRSxjQUFjO1FBQ25CLGFBQWEsRUFBRSx1QkFBdUI7UUFDdEMsSUFBSSxFQUFFLHFCQUFxQjtRQUMzQixLQUFLLEVBQUUscUJBQXFCO1FBQzVCLElBQUksRUFBRSxnQkFBZ0I7S0FDdkIsQ0FBQztJQUVGLE1BQU0sV0FBVyxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLElBQUksaUJBQWlCLENBQUM7SUFDN0UsT0FBTyxHQUFHLFdBQVcsV0FBVyxDQUFDO0FBQ25DLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEFjdGl2aXR5IEZlZWQgQVBJIExhbWJkYVxuICpcbiAqIFJldHVybnMgYSB1bmlmaWVkIGFjdGl2aXR5IGZlZWQgY29tYmluaW5nOlxuICogLSBBbGVydHMgKGZyb20gYWxlcnRzIHRhYmxlKVxuICogLSBIZWFsdGggZXZlbnRzIChmcm9tIHRlbGVtZXRyeSB0YWJsZSlcbiAqIC0gTG9jYXRpb24gdXBkYXRlcyAoZnJvbSB0ZWxlbWV0cnkgdGFibGUpXG4gKiAtIERldmljZSBzdGF0dXMgY2hhbmdlcyAoZGVyaXZlZCBmcm9tIGRldmljZSBsYXN0X3NlZW4pXG4gKi9cblxuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgUXVlcnlDb21tYW5kLCBTY2FuQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCwgQVBJR2F0ZXdheVByb3h5UmVzdWx0IH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5cbmNvbnN0IGRkYkNsaWVudCA9IG5ldyBEeW5hbW9EQkNsaWVudCh7fSk7XG5jb25zdCBkb2NDbGllbnQgPSBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LmZyb20oZGRiQ2xpZW50KTtcblxuY29uc3QgVEVMRU1FVFJZX1RBQkxFID0gcHJvY2Vzcy5lbnYuVEVMRU1FVFJZX1RBQkxFITtcbmNvbnN0IEFMRVJUU19UQUJMRSA9IHByb2Nlc3MuZW52LkFMRVJUU19UQUJMRSE7XG5jb25zdCBERVZJQ0VTX1RBQkxFID0gcHJvY2Vzcy5lbnYuREVWSUNFU19UQUJMRSE7XG5cbmludGVyZmFjZSBBY3Rpdml0eUl0ZW0ge1xuICBpZDogc3RyaW5nO1xuICB0eXBlOiAnYWxlcnQnIHwgJ2hlYWx0aCcgfCAnbG9jYXRpb24nIHwgJ3N0YXR1cyc7XG4gIGRldmljZV91aWQ6IHN0cmluZztcbiAgZGV2aWNlX25hbWU/OiBzdHJpbmc7XG4gIG1lc3NhZ2U6IHN0cmluZztcbiAgdGltZXN0YW1wOiBzdHJpbmc7XG4gIGRhdGE/OiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPjtcbn1cblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50KTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0+IHtcbiAgY29uc29sZS5sb2coJ1JlcXVlc3Q6JywgSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTtcblxuICBjb25zdCBjb3JzSGVhZGVycyA9IHtcbiAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogJ0NvbnRlbnQtVHlwZSxBdXRob3JpemF0aW9uJyxcbiAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctTWV0aG9kcyc6ICdHRVQsT1BUSU9OUycsXG4gIH07XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBtZXRob2QgPSAoZXZlbnQucmVxdWVzdENvbnRleHQgYXMgYW55KT8uaHR0cD8ubWV0aG9kIHx8IGV2ZW50Lmh0dHBNZXRob2Q7XG5cbiAgICBpZiAobWV0aG9kID09PSAnT1BUSU9OUycpIHtcbiAgICAgIHJldHVybiB7IHN0YXR1c0NvZGU6IDIwMCwgaGVhZGVyczogY29yc0hlYWRlcnMsIGJvZHk6ICcnIH07XG4gICAgfVxuXG4gICAgY29uc3QgcXVlcnlQYXJhbXMgPSBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnMgfHwge307XG4gICAgY29uc3QgaG91cnMgPSBwYXJzZUludChxdWVyeVBhcmFtcy5ob3VycyB8fCAnMjQnKTtcbiAgICBjb25zdCBsaW1pdCA9IHBhcnNlSW50KHF1ZXJ5UGFyYW1zLmxpbWl0IHx8ICc1MCcpO1xuXG4gICAgLy8gRmV0Y2ggYWN0aXZpdGllcyBmcm9tIGFsbCBzb3VyY2VzIGluIHBhcmFsbGVsXG4gICAgY29uc3QgW2FsZXJ0cywgaGVhbHRoRXZlbnRzLCBsb2NhdGlvbkV2ZW50cywgZGV2aWNlc10gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICBnZXRSZWNlbnRBbGVydHMoaG91cnMsIGxpbWl0KSxcbiAgICAgIGdldFJlY2VudEhlYWx0aEV2ZW50cyhob3VycywgbGltaXQpLFxuICAgICAgZ2V0UmVjZW50TG9jYXRpb25FdmVudHMoaG91cnMsIGxpbWl0KSxcbiAgICAgIGdldERldmljZXMoKSxcbiAgICBdKTtcblxuICAgIGNvbnNvbGUubG9nKGBGb3VuZCAke2FsZXJ0cy5sZW5ndGh9IGFsZXJ0cywgJHtoZWFsdGhFdmVudHMubGVuZ3RofSBoZWFsdGggZXZlbnRzLCAke2xvY2F0aW9uRXZlbnRzLmxlbmd0aH0gbG9jYXRpb24gZXZlbnRzYCk7XG5cbiAgICAvLyBDcmVhdGUgZGV2aWNlIG5hbWUgbG9va3VwXG4gICAgY29uc3QgZGV2aWNlTmFtZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcbiAgICBmb3IgKGNvbnN0IGRldmljZSBvZiBkZXZpY2VzKSB7XG4gICAgICBkZXZpY2VOYW1lc1tkZXZpY2UuZGV2aWNlX3VpZF0gPSBkZXZpY2UubmFtZSB8fCBkZXZpY2Uuc2VyaWFsX251bWJlciB8fCBkZXZpY2UuZGV2aWNlX3VpZDtcbiAgICB9XG5cbiAgICAvLyBUcmFuc2Zvcm0gYWxlcnRzIHRvIGFjdGl2aXR5IGl0ZW1zXG4gICAgY29uc3QgYWxlcnRBY3Rpdml0aWVzOiBBY3Rpdml0eUl0ZW1bXSA9IGFsZXJ0cy5tYXAoKGFsZXJ0KSA9PiAoe1xuICAgICAgaWQ6IGBhbGVydC0ke2FsZXJ0LmFsZXJ0X2lkfWAsXG4gICAgICB0eXBlOiAnYWxlcnQnLFxuICAgICAgZGV2aWNlX3VpZDogYWxlcnQuZGV2aWNlX3VpZCxcbiAgICAgIGRldmljZV9uYW1lOiBkZXZpY2VOYW1lc1thbGVydC5kZXZpY2VfdWlkXSxcbiAgICAgIG1lc3NhZ2U6IGZvcm1hdEFsZXJ0TWVzc2FnZShhbGVydCksXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKGFsZXJ0LmNyZWF0ZWRfYXQpLnRvSVNPU3RyaW5nKCksXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGFsZXJ0X3R5cGU6IGFsZXJ0LnR5cGUsXG4gICAgICAgIHZhbHVlOiBhbGVydC52YWx1ZSxcbiAgICAgICAgdGhyZXNob2xkOiBhbGVydC50aHJlc2hvbGQsXG4gICAgICAgIGFja25vd2xlZGdlZDogYWxlcnQuYWNrbm93bGVkZ2VkLFxuICAgICAgfSxcbiAgICB9KSk7XG5cbiAgICAvLyBUcmFuc2Zvcm0gaGVhbHRoIGV2ZW50cyB0byBhY3Rpdml0eSBpdGVtc1xuICAgIGNvbnN0IGhlYWx0aEFjdGl2aXRpZXM6IEFjdGl2aXR5SXRlbVtdID0gaGVhbHRoRXZlbnRzLm1hcCgoZXZlbnQpID0+ICh7XG4gICAgICBpZDogYGhlYWx0aC0ke2V2ZW50LmRldmljZV91aWR9LSR7ZXZlbnQudGltZXN0YW1wfWAsXG4gICAgICB0eXBlOiAnaGVhbHRoJyxcbiAgICAgIGRldmljZV91aWQ6IGV2ZW50LmRldmljZV91aWQsXG4gICAgICBkZXZpY2VfbmFtZTogZGV2aWNlTmFtZXNbZXZlbnQuZGV2aWNlX3VpZF0sXG4gICAgICBtZXNzYWdlOiBmb3JtYXRIZWFsdGhNZXNzYWdlKGV2ZW50KSxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoZXZlbnQudGltZXN0YW1wKS50b0lTT1N0cmluZygpLFxuICAgICAgZGF0YToge1xuICAgICAgICBtZXRob2Q6IGV2ZW50Lm1ldGhvZCxcbiAgICAgICAgdm9sdGFnZTogZXZlbnQudm9sdGFnZSxcbiAgICAgIH0sXG4gICAgfSkpO1xuXG4gICAgLy8gVHJhbnNmb3JtIGxvY2F0aW9uIGV2ZW50cyB0byBhY3Rpdml0eSBpdGVtc1xuICAgIGNvbnN0IGxvY2F0aW9uQWN0aXZpdGllczogQWN0aXZpdHlJdGVtW10gPSBsb2NhdGlvbkV2ZW50cy5tYXAoKGV2ZW50KSA9PiAoe1xuICAgICAgaWQ6IGBsb2NhdGlvbi0ke2V2ZW50LmRldmljZV91aWR9LSR7ZXZlbnQudGltZXN0YW1wfWAsXG4gICAgICB0eXBlOiAnbG9jYXRpb24nLFxuICAgICAgZGV2aWNlX3VpZDogZXZlbnQuZGV2aWNlX3VpZCxcbiAgICAgIGRldmljZV9uYW1lOiBkZXZpY2VOYW1lc1tldmVudC5kZXZpY2VfdWlkXSxcbiAgICAgIG1lc3NhZ2U6IGZvcm1hdExvY2F0aW9uTWVzc2FnZShldmVudCwgZGV2aWNlTmFtZXNbZXZlbnQuZGV2aWNlX3VpZF0pLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZShldmVudC50aW1lc3RhbXApLnRvSVNPU3RyaW5nKCksXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGxhdDogZXZlbnQubGF0aXR1ZGUsXG4gICAgICAgIGxvbjogZXZlbnQubG9uZ2l0dWRlLFxuICAgICAgICBzb3VyY2U6IGV2ZW50LmxvY2F0aW9uX3NvdXJjZSxcbiAgICAgIH0sXG4gICAgfSkpO1xuXG4gICAgLy8gTWVyZ2UgYWxsIGFjdGl2aXRpZXMgYW5kIHNvcnQgYnkgdGltZXN0YW1wIChuZXdlc3QgZmlyc3QpXG4gICAgY29uc3QgYWxsQWN0aXZpdGllcyA9IFsuLi5hbGVydEFjdGl2aXRpZXMsIC4uLmhlYWx0aEFjdGl2aXRpZXMsIC4uLmxvY2F0aW9uQWN0aXZpdGllc11cbiAgICAgIC5zb3J0KChhLCBiKSA9PiBuZXcgRGF0ZShiLnRpbWVzdGFtcCkuZ2V0VGltZSgpIC0gbmV3IERhdGUoYS50aW1lc3RhbXApLmdldFRpbWUoKSlcbiAgICAgIC5zbGljZSgwLCBsaW1pdCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgaGVhZGVyczogY29yc0hlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGhvdXJzLFxuICAgICAgICBjb3VudDogYWxsQWN0aXZpdGllcy5sZW5ndGgsXG4gICAgICAgIGFjdGl2aXRpZXM6IGFsbEFjdGl2aXRpZXMsXG4gICAgICB9KSxcbiAgICB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yOicsIGVycm9yKTtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNTAwLFxuICAgICAgaGVhZGVyczogY29yc0hlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyB9KSxcbiAgICB9O1xuICB9XG59O1xuXG5hc3luYyBmdW5jdGlvbiBnZXRSZWNlbnRBbGVydHMoaG91cnM6IG51bWJlciwgbGltaXQ6IG51bWJlcik6IFByb21pc2U8YW55W10+IHtcbiAgY29uc3QgY3V0b2ZmVGltZSA9IERhdGUubm93KCkgLSBob3VycyAqIDYwICogNjAgKiAxMDAwO1xuICBjb25zdCBhbGxJdGVtczogYW55W10gPSBbXTtcbiAgbGV0IGxhc3RFdmFsdWF0ZWRLZXk6IFJlY29yZDxzdHJpbmcsIGFueT4gfCB1bmRlZmluZWQ7XG5cbiAgLy8gUGFnaW5hdGUgdGhyb3VnaCBhbGwgcmVzdWx0c1xuICBkbyB7XG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBTY2FuQ29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IEFMRVJUU19UQUJMRSxcbiAgICAgIEZpbHRlckV4cHJlc3Npb246ICdjcmVhdGVkX2F0ID4gOmN1dG9mZicsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICc6Y3V0b2ZmJzogY3V0b2ZmVGltZSxcbiAgICAgIH0sXG4gICAgICBFeGNsdXNpdmVTdGFydEtleTogbGFzdEV2YWx1YXRlZEtleSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIGFsbEl0ZW1zLnB1c2goLi4uKHJlc3VsdC5JdGVtcyB8fCBbXSkpO1xuICAgIGxhc3RFdmFsdWF0ZWRLZXkgPSByZXN1bHQuTGFzdEV2YWx1YXRlZEtleTtcblxuICAgIC8vIFN0b3AgZWFybHkgaWYgd2UgaGF2ZSBlbm91Z2ggaXRlbXNcbiAgICBpZiAoYWxsSXRlbXMubGVuZ3RoID49IGxpbWl0ICogMikgYnJlYWs7XG4gIH0gd2hpbGUgKGxhc3RFdmFsdWF0ZWRLZXkpO1xuXG4gIHJldHVybiBhbGxJdGVtcy5zbGljZSgwLCBsaW1pdCAqIDIpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRSZWNlbnRIZWFsdGhFdmVudHMoaG91cnM6IG51bWJlciwgbGltaXQ6IG51bWJlcik6IFByb21pc2U8YW55W10+IHtcbiAgY29uc3QgY3V0b2ZmVGltZSA9IERhdGUubm93KCkgLSBob3VycyAqIDYwICogNjAgKiAxMDAwO1xuICBjb25zdCBhbGxJdGVtczogYW55W10gPSBbXTtcbiAgbGV0IGxhc3RFdmFsdWF0ZWRLZXk6IFJlY29yZDxzdHJpbmcsIGFueT4gfCB1bmRlZmluZWQ7XG5cbiAgLy8gUGFnaW5hdGUgdGhyb3VnaCBhbGwgcmVzdWx0c1xuICBkbyB7XG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBTY2FuQ29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IFRFTEVNRVRSWV9UQUJMRSxcbiAgICAgIEZpbHRlckV4cHJlc3Npb246ICcjdHMgPiA6Y3V0b2ZmIEFORCBkYXRhX3R5cGUgPSA6ZGF0YV90eXBlJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAnI3RzJzogJ3RpbWVzdGFtcCcsXG4gICAgICB9LFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAnOmN1dG9mZic6IGN1dG9mZlRpbWUsXG4gICAgICAgICc6ZGF0YV90eXBlJzogJ2hlYWx0aCcsXG4gICAgICB9LFxuICAgICAgRXhjbHVzaXZlU3RhcnRLZXk6IGxhc3RFdmFsdWF0ZWRLZXksXG4gICAgfSk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICBhbGxJdGVtcy5wdXNoKC4uLihyZXN1bHQuSXRlbXMgfHwgW10pKTtcbiAgICBsYXN0RXZhbHVhdGVkS2V5ID0gcmVzdWx0Lkxhc3RFdmFsdWF0ZWRLZXk7XG5cbiAgICAvLyBTdG9wIGVhcmx5IGlmIHdlIGhhdmUgZW5vdWdoIGl0ZW1zXG4gICAgaWYgKGFsbEl0ZW1zLmxlbmd0aCA+PSBsaW1pdCAqIDIpIGJyZWFrO1xuICB9IHdoaWxlIChsYXN0RXZhbHVhdGVkS2V5KTtcblxuICByZXR1cm4gYWxsSXRlbXMuc2xpY2UoMCwgbGltaXQgKiAyKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0UmVjZW50TG9jYXRpb25FdmVudHMoaG91cnM6IG51bWJlciwgbGltaXQ6IG51bWJlcik6IFByb21pc2U8YW55W10+IHtcbiAgY29uc3QgY3V0b2ZmVGltZSA9IERhdGUubm93KCkgLSBob3VycyAqIDYwICogNjAgKiAxMDAwO1xuICBjb25zdCBhbGxJdGVtczogYW55W10gPSBbXTtcbiAgbGV0IGxhc3RFdmFsdWF0ZWRLZXk6IFJlY29yZDxzdHJpbmcsIGFueT4gfCB1bmRlZmluZWQ7XG5cbiAgLy8gUGFnaW5hdGUgdGhyb3VnaCBhbGwgcmVzdWx0cyAtIER5bmFtb0RCIFNjYW4gcmV0dXJucyBtYXggMU1CIHBlciBjYWxsXG4gIGRvIHtcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IFNjYW5Db21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogVEVMRU1FVFJZX1RBQkxFLFxuICAgICAgRmlsdGVyRXhwcmVzc2lvbjogJyN0cyA+IDpjdXRvZmYgQU5EIGV2ZW50X3R5cGUgPSA6ZXZlbnRfdHlwZScsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcbiAgICAgICAgJyN0cyc6ICd0aW1lc3RhbXAnLFxuICAgICAgfSxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgJzpjdXRvZmYnOiBjdXRvZmZUaW1lLFxuICAgICAgICAnOmV2ZW50X3R5cGUnOiAnX2dlb2xvY2F0ZS5xbycsXG4gICAgICB9LFxuICAgICAgRXhjbHVzaXZlU3RhcnRLZXk6IGxhc3RFdmFsdWF0ZWRLZXksXG4gICAgfSk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICBhbGxJdGVtcy5wdXNoKC4uLihyZXN1bHQuSXRlbXMgfHwgW10pKTtcbiAgICBsYXN0RXZhbHVhdGVkS2V5ID0gcmVzdWx0Lkxhc3RFdmFsdWF0ZWRLZXk7XG5cbiAgICAvLyBTdG9wIGVhcmx5IGlmIHdlIGhhdmUgZW5vdWdoIGl0ZW1zXG4gICAgaWYgKGFsbEl0ZW1zLmxlbmd0aCA+PSBsaW1pdCAqIDIpIGJyZWFrO1xuICB9IHdoaWxlIChsYXN0RXZhbHVhdGVkS2V5KTtcblxuICByZXR1cm4gYWxsSXRlbXMuc2xpY2UoMCwgbGltaXQgKiAyKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0RGV2aWNlcygpOiBQcm9taXNlPGFueVtdPiB7XG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgU2NhbkNvbW1hbmQoe1xuICAgIFRhYmxlTmFtZTogREVWSUNFU19UQUJMRSxcbiAgICBQcm9qZWN0aW9uRXhwcmVzc2lvbjogJ2RldmljZV91aWQsICNuYW1lLCBzZXJpYWxfbnVtYmVyJyxcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHtcbiAgICAgICcjbmFtZSc6ICduYW1lJyxcbiAgICB9LFxuICB9KTtcblxuICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgcmV0dXJuIHJlc3VsdC5JdGVtcyB8fCBbXTtcbn1cblxuZnVuY3Rpb24gZm9ybWF0QWxlcnRNZXNzYWdlKGFsZXJ0OiBhbnkpOiBzdHJpbmcge1xuICBjb25zdCBhbGVydExhYmVsczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHtcbiAgICB0ZW1wX2hpZ2g6ICdIaWdoIHRlbXBlcmF0dXJlIGFsZXJ0JyxcbiAgICB0ZW1wX2xvdzogJ0xvdyB0ZW1wZXJhdHVyZSBhbGVydCcsXG4gICAgaHVtaWRpdHlfaGlnaDogJ0hpZ2ggaHVtaWRpdHkgYWxlcnQnLFxuICAgIGh1bWlkaXR5X2xvdzogJ0xvdyBodW1pZGl0eSBhbGVydCcsXG4gICAgcHJlc3N1cmVfY2hhbmdlOiAnUHJlc3N1cmUgY2hhbmdlIGFsZXJ0JyxcbiAgICBsb3dfYmF0dGVyeTogJ0xvdyBiYXR0ZXJ5IGFsZXJ0JyxcbiAgICBtb3Rpb246ICdNb3Rpb24gZGV0ZWN0ZWQnLFxuICB9O1xuXG4gIGNvbnN0IGxhYmVsID0gYWxlcnRMYWJlbHNbYWxlcnQudHlwZV0gfHwgYWxlcnQudHlwZTtcbiAgaWYgKGFsZXJ0LnZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4gYCR7bGFiZWx9OiAke2FsZXJ0LnZhbHVlLnRvRml4ZWQoMSl9YDtcbiAgfVxuICByZXR1cm4gbGFiZWw7XG59XG5cbmZ1bmN0aW9uIGZvcm1hdEhlYWx0aE1lc3NhZ2UoZXZlbnQ6IGFueSk6IHN0cmluZyB7XG4gIGNvbnN0IG1ldGhvZExhYmVsczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHtcbiAgICBkZnU6ICdGaXJtd2FyZSB1cGRhdGUnLFxuICAgIGJvb3Q6ICdEZXZpY2UgYm9vdGVkJyxcbiAgICByZWJvb3Q6ICdEZXZpY2UgcmVib290ZWQnLFxuICAgIHJlc2V0OiAnRGV2aWNlIHJlc2V0JyxcbiAgICB1c2I6ICdVU0IgY29ubmVjdGVkJyxcbiAgICBiYXR0ZXJ5OiAnQmF0dGVyeSBzdGF0dXMgdXBkYXRlJyxcbiAgICBzeW5jOiAnU3luYyBjb21wbGV0ZWQnLFxuICAgIGNvbm5lY3RlZDogJ0Nvbm5lY3RlZCB0byBuZXR3b3JrJyxcbiAgICBkaXNjb25uZWN0ZWQ6ICdEaXNjb25uZWN0ZWQgZnJvbSBuZXR3b3JrJyxcbiAgfTtcblxuICBjb25zdCBsYWJlbCA9IG1ldGhvZExhYmVsc1tldmVudC5tZXRob2RdIHx8IGV2ZW50Lm1ldGhvZCB8fCAnSGVhbHRoIGV2ZW50JztcbiAgaWYgKGV2ZW50LnRleHQpIHtcbiAgICByZXR1cm4gYCR7bGFiZWx9OiAke2V2ZW50LnRleHR9YDtcbiAgfVxuICByZXR1cm4gbGFiZWw7XG59XG5cbmZ1bmN0aW9uIGZvcm1hdExvY2F0aW9uTWVzc2FnZShldmVudDogYW55LCBkZXZpY2VOYW1lPzogc3RyaW5nKTogc3RyaW5nIHtcbiAgY29uc3QgbmFtZSA9IGRldmljZU5hbWUgfHwgZXZlbnQuZGV2aWNlX3VpZDtcbiAgY29uc3Qgc291cmNlTGFiZWxzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge1xuICAgIGdwczogJ0dQUyBsb2NhdGlvbicsXG4gICAgdHJpYW5ndWxhdGlvbjogJ1RyaWFuZ3VsYXRlZCBsb2NhdGlvbicsXG4gICAgY2VsbDogJ0NlbGwgdG93ZXIgbG9jYXRpb24nLFxuICAgIHRvd2VyOiAnQ2VsbCB0b3dlciBsb2NhdGlvbicsXG4gICAgd2lmaTogJ1dpLUZpIGxvY2F0aW9uJyxcbiAgfTtcblxuICBjb25zdCBzb3VyY2VMYWJlbCA9IHNvdXJjZUxhYmVsc1tldmVudC5sb2NhdGlvbl9zb3VyY2VdIHx8ICdMb2NhdGlvbiB1cGRhdGUnO1xuICByZXR1cm4gYCR7c291cmNlTGFiZWx9IHJlY2VpdmVkYDtcbn1cbiJdfQ==