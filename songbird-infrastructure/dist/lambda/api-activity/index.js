"use strict";
/**
 * Activity Feed API Lambda
 *
 * Returns a unified activity feed combining:
 * - Alerts (from alerts table)
 * - Health events (from telemetry table)
 * - Commands (from commands table)
 * - Journey start/end events (from journeys table)
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient);
const TELEMETRY_TABLE = process.env.TELEMETRY_TABLE;
const ALERTS_TABLE = process.env.ALERTS_TABLE;
const DEVICES_TABLE = process.env.DEVICES_TABLE;
const COMMANDS_TABLE = process.env.COMMANDS_TABLE;
const JOURNEYS_TABLE = process.env.JOURNEYS_TABLE;
const handler = async (event) => {
    console.log('Request:', JSON.stringify(event));
    const corsHeaders = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type,Authorization',
        'Access-Control-Allow-Methods': 'GET,OPTIONS',
    };
    try {
        const method = event.requestContext?.http?.method || event.httpMethod;
        if (method === 'OPTIONS') {
            return { statusCode: 200, headers: corsHeaders, body: '' };
        }
        const queryParams = event.queryStringParameters || {};
        const hours = parseInt(queryParams.hours || '24');
        const limit = parseInt(queryParams.limit || '50');
        // Fetch activities from all sources in parallel
        const [alerts, healthEvents, commands, journeys, devices] = await Promise.all([
            getRecentAlerts(hours, limit),
            getRecentHealthEvents(hours, limit),
            getRecentCommands(hours, limit),
            getRecentJourneys(hours, limit),
            getDevices(),
        ]);
        // Create device name lookup
        const deviceNames = {};
        for (const device of devices) {
            deviceNames[device.device_uid] = device.name || device.serial_number || device.device_uid;
        }
        // Transform alerts to activity items
        const alertActivities = alerts.map((alert) => ({
            id: `alert-${alert.alert_id}`,
            type: 'alert',
            device_uid: alert.device_uid,
            device_name: deviceNames[alert.device_uid],
            message: formatAlertMessage(alert),
            timestamp: new Date(alert.created_at).toISOString(),
            data: {
                alert_type: alert.type,
                value: alert.value,
                threshold: alert.threshold,
                acknowledged: alert.acknowledged,
            },
        }));
        // Transform health events to activity items
        const healthActivities = healthEvents.map((event) => ({
            id: `health-${event.device_uid}-${event.timestamp}`,
            type: 'health',
            device_uid: event.device_uid,
            device_name: deviceNames[event.device_uid],
            message: formatHealthMessage(event),
            timestamp: new Date(event.timestamp).toISOString(),
            data: {
                method: event.method,
                voltage: event.voltage,
            },
        }));
        // Transform commands to activity items
        const commandActivities = commands.map((cmd) => ({
            id: `command-${cmd.command_id}`,
            type: 'command',
            device_uid: cmd.device_uid,
            device_name: deviceNames[cmd.device_uid],
            message: formatCommandMessage(cmd),
            timestamp: new Date(cmd.created_at).toISOString(),
            data: {
                cmd: cmd.cmd,
                status: cmd.status,
                ack_status: cmd.ack_status,
            },
        }));
        // Transform journeys to activity items (start and end events)
        const journeyActivities = [];
        for (const journey of journeys) {
            // Journey start event
            journeyActivities.push({
                id: `journey-start-${journey.device_uid}-${journey.journey_id}`,
                type: 'journey',
                device_uid: journey.device_uid,
                device_name: deviceNames[journey.device_uid],
                message: 'Journey started',
                timestamp: new Date(journey.start_time).toISOString(),
                data: {
                    journey_id: journey.journey_id,
                    event: 'start',
                },
            });
            // Journey end event (only if completed)
            if (journey.status === 'completed' && journey.end_time) {
                journeyActivities.push({
                    id: `journey-end-${journey.device_uid}-${journey.journey_id}`,
                    type: 'journey',
                    device_uid: journey.device_uid,
                    device_name: deviceNames[journey.device_uid],
                    message: formatJourneyEndMessage(journey),
                    timestamp: new Date(journey.end_time).toISOString(),
                    data: {
                        journey_id: journey.journey_id,
                        event: 'end',
                        point_count: journey.point_count,
                        total_distance: journey.total_distance,
                    },
                });
            }
        }
        // Merge all activities and sort by timestamp (newest first)
        const allActivities = [...alertActivities, ...healthActivities, ...commandActivities, ...journeyActivities]
            .sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime())
            .slice(0, limit);
        return {
            statusCode: 200,
            headers: corsHeaders,
            body: JSON.stringify({
                hours,
                count: allActivities.length,
                activities: allActivities,
            }),
        };
    }
    catch (error) {
        console.error('Error:', error);
        return {
            statusCode: 500,
            headers: corsHeaders,
            body: JSON.stringify({ error: 'Internal server error' }),
        };
    }
};
exports.handler = handler;
async function getRecentAlerts(hours, limit) {
    const cutoffTime = Date.now() - hours * 60 * 60 * 1000;
    const allItems = [];
    let lastEvaluatedKey;
    // Paginate through all results
    do {
        const command = new lib_dynamodb_1.ScanCommand({
            TableName: ALERTS_TABLE,
            FilterExpression: 'created_at > :cutoff',
            ExpressionAttributeValues: {
                ':cutoff': cutoffTime,
            },
            ExclusiveStartKey: lastEvaluatedKey,
        });
        const result = await docClient.send(command);
        allItems.push(...(result.Items || []));
        lastEvaluatedKey = result.LastEvaluatedKey;
        // Stop early if we have enough items
        if (allItems.length >= limit * 2)
            break;
    } while (lastEvaluatedKey);
    return allItems.slice(0, limit * 2);
}
async function getRecentHealthEvents(hours, limit) {
    const cutoffTime = Date.now() - hours * 60 * 60 * 1000;
    const allItems = [];
    let lastEvaluatedKey;
    // Paginate through all results
    do {
        const command = new lib_dynamodb_1.ScanCommand({
            TableName: TELEMETRY_TABLE,
            FilterExpression: '#ts > :cutoff AND data_type = :data_type',
            ExpressionAttributeNames: {
                '#ts': 'timestamp',
            },
            ExpressionAttributeValues: {
                ':cutoff': cutoffTime,
                ':data_type': 'health',
            },
            ExclusiveStartKey: lastEvaluatedKey,
        });
        const result = await docClient.send(command);
        allItems.push(...(result.Items || []));
        lastEvaluatedKey = result.LastEvaluatedKey;
        // Stop early if we have enough items
        if (allItems.length >= limit * 2)
            break;
    } while (lastEvaluatedKey);
    return allItems.slice(0, limit * 2);
}
async function getRecentCommands(hours, limit) {
    const cutoffTime = Date.now() - hours * 60 * 60 * 1000;
    const allItems = [];
    let lastEvaluatedKey;
    do {
        const command = new lib_dynamodb_1.ScanCommand({
            TableName: COMMANDS_TABLE,
            FilterExpression: 'created_at > :cutoff',
            ExpressionAttributeValues: {
                ':cutoff': cutoffTime,
            },
            ExclusiveStartKey: lastEvaluatedKey,
        });
        const result = await docClient.send(command);
        allItems.push(...(result.Items || []));
        lastEvaluatedKey = result.LastEvaluatedKey;
        if (allItems.length >= limit * 2)
            break;
    } while (lastEvaluatedKey);
    return allItems.slice(0, limit * 2);
}
async function getRecentJourneys(hours, limit) {
    const cutoffTime = Date.now() - hours * 60 * 60 * 1000;
    const allItems = [];
    let lastEvaluatedKey;
    do {
        const command = new lib_dynamodb_1.ScanCommand({
            TableName: JOURNEYS_TABLE,
            FilterExpression: 'start_time > :cutoff',
            ExpressionAttributeValues: {
                ':cutoff': cutoffTime,
            },
            ExclusiveStartKey: lastEvaluatedKey,
        });
        const result = await docClient.send(command);
        allItems.push(...(result.Items || []));
        lastEvaluatedKey = result.LastEvaluatedKey;
        if (allItems.length >= limit * 2)
            break;
    } while (lastEvaluatedKey);
    return allItems.slice(0, limit * 2);
}
async function getDevices() {
    const command = new lib_dynamodb_1.ScanCommand({
        TableName: DEVICES_TABLE,
        ProjectionExpression: 'device_uid, #name, serial_number',
        ExpressionAttributeNames: {
            '#name': 'name',
        },
    });
    const result = await docClient.send(command);
    return result.Items || [];
}
function formatAlertMessage(alert) {
    const alertLabels = {
        temp_high: 'High temperature alert',
        temp_low: 'Low temperature alert',
        humidity_high: 'High humidity alert',
        humidity_low: 'Low humidity alert',
        pressure_change: 'Pressure change alert',
        low_battery: 'Low battery alert',
        motion: 'Motion detected',
    };
    const label = alertLabels[alert.type] || alert.type;
    if (alert.value !== undefined) {
        return `${label}: ${alert.value.toFixed(1)}`;
    }
    return label;
}
function formatHealthMessage(event) {
    const methodLabels = {
        dfu: 'Firmware update',
        boot: 'Device booted',
        reboot: 'Device rebooted',
        reset: 'Device reset',
        usb: 'USB connected',
        battery: 'Battery status update',
        sync: 'Sync completed',
        connected: 'Connected to network',
        disconnected: 'Disconnected from network',
    };
    const label = methodLabels[event.method] || event.method || 'Health event';
    if (event.text) {
        return `${label}: ${event.text}`;
    }
    return label;
}
function formatCommandMessage(cmd) {
    const cmdLabels = {
        ping: 'Ping command',
        locate: 'Locate command',
        play_melody: 'Play melody command',
        test_audio: 'Test audio command',
        set_volume: 'Set volume command',
    };
    const label = cmdLabels[cmd.cmd] || cmd.cmd || 'Command';
    const statusLabels = {
        queued: 'queued',
        sent: 'sent',
        ok: 'acknowledged',
        error: 'failed',
        ignored: 'ignored',
    };
    const status = statusLabels[cmd.ack_status || cmd.status] || cmd.status;
    return `${label} ${status}`;
}
function formatJourneyEndMessage(journey) {
    const distance = journey.total_distance || 0;
    const points = journey.point_count || 0;
    // Format distance in km or m
    let distanceStr;
    if (distance >= 1000) {
        distanceStr = `${(distance / 1000).toFixed(1)} km`;
    }
    else {
        distanceStr = `${Math.round(distance)} m`;
    }
    return `Journey ended: ${distanceStr}, ${points} points`;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvYXBpLWFjdGl2aXR5L2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7R0FRRzs7O0FBRUgsOERBQTBEO0FBQzFELHdEQUE0RTtBQUc1RSxNQUFNLFNBQVMsR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDekMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBRXpELE1BQU0sZUFBZSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZ0IsQ0FBQztBQUNyRCxNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQWEsQ0FBQztBQUMvQyxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWMsQ0FBQztBQUNqRCxNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWUsQ0FBQztBQUNuRCxNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWUsQ0FBQztBQVk1QyxNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQUUsS0FBMkIsRUFBa0MsRUFBRTtJQUMzRixPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFFL0MsTUFBTSxXQUFXLEdBQUc7UUFDbEIsNkJBQTZCLEVBQUUsR0FBRztRQUNsQyw4QkFBOEIsRUFBRSw0QkFBNEI7UUFDNUQsOEJBQThCLEVBQUUsYUFBYTtLQUM5QyxDQUFDO0lBRUYsSUFBSSxDQUFDO1FBQ0gsTUFBTSxNQUFNLEdBQUksS0FBSyxDQUFDLGNBQXNCLEVBQUUsSUFBSSxFQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsVUFBVSxDQUFDO1FBRS9FLElBQUksTUFBTSxLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQ3pCLE9B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LFdBQVcsS0FBSyxNQUFNLFNBQVMsQ0FBQztBQUMzRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBBY3Rpdml0eSBGZWVkIEFQSSBMYW1iZGFcbiAqXG4gKiBSZXR1cm5zIGEgdW5pZmllZCBhY3Rpdml0eSBmZWVkIGNvbWJpbmluZzpcbiAqIC0gQWxlcnRzIChmcm9tIGFsZXJ0cyB0YWJsZSlcbiAqIC0gSGVhbHRoIGV2ZW50cyAoZnJvbSB0ZWxlbWV0cnkgdGFibGUpXG4gKiAtIENvbW1hbmRzIChmcm9tIGNvbW1hbmRzIHRhYmxlKVxuICogLSBKb3VybmV5IHN0YXJ0L2VuZCBldmVudHMgKGZyb20gam91cm5leXMgdGFibGUpXG4gKi9cblxuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgU2NhbkNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuXG5jb25zdCBkZGJDbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGRkYkNsaWVudCk7XG5cbmNvbnN0IFRFTEVNRVRSWV9UQUJMRSA9IHByb2Nlc3MuZW52LlRFTEVNRVRSWV9UQUJMRSE7XG5jb25zdCBBTEVSVFNfVEFCTEUgPSBwcm9jZXNzLmVudi5BTEVSVFNfVEFCTEUhO1xuY29uc3QgREVWSUNFU19UQUJMRSA9IHByb2Nlc3MuZW52LkRFVklDRVNfVEFCTEUhO1xuY29uc3QgQ09NTUFORFNfVEFCTEUgPSBwcm9jZXNzLmVudi5DT01NQU5EU19UQUJMRSE7XG5jb25zdCBKT1VSTkVZU19UQUJMRSA9IHByb2Nlc3MuZW52LkpPVVJORVlTX1RBQkxFITtcblxuaW50ZXJmYWNlIEFjdGl2aXR5SXRlbSB7XG4gIGlkOiBzdHJpbmc7XG4gIHR5cGU6ICdhbGVydCcgfCAnaGVhbHRoJyB8ICdjb21tYW5kJyB8ICdqb3VybmV5JztcbiAgZGV2aWNlX3VpZDogc3RyaW5nO1xuICBkZXZpY2VfbmFtZT86IHN0cmluZztcbiAgbWVzc2FnZTogc3RyaW5nO1xuICB0aW1lc3RhbXA6IHN0cmluZztcbiAgZGF0YT86IFJlY29yZDxzdHJpbmcsIHVua25vd24+O1xufVxuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQpOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4gPT4ge1xuICBjb25zb2xlLmxvZygnUmVxdWVzdDonLCBKU09OLnN0cmluZ2lmeShldmVudCkpO1xuXG4gIGNvbnN0IGNvcnNIZWFkZXJzID0ge1xuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLEF1dGhvcml6YXRpb24nLFxuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzJzogJ0dFVCxPUFRJT05TJyxcbiAgfTtcblxuICB0cnkge1xuICAgIGNvbnN0IG1ldGhvZCA9IChldmVudC5yZXF1ZXN0Q29udGV4dCBhcyBhbnkpPy5odHRwPy5tZXRob2QgfHwgZXZlbnQuaHR0cE1ldGhvZDtcblxuICAgIGlmIChtZXRob2QgPT09ICdPUFRJT05TJykge1xuICAgICAgcmV0dXJuIHsgc3RhdHVzQ29kZTogMjAwLCBoZWFkZXJzOiBjb3JzSGVhZGVycywgYm9keTogJycgfTtcbiAgICB9XG5cbiAgICBjb25zdCBxdWVyeVBhcmFtcyA9IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycyB8fCB7fTtcbiAgICBjb25zdCBob3VycyA9IHBhcnNlSW50KHF1ZXJ5UGFyYW1zLmhvdXJzIHx8ICcyNCcpO1xuICAgIGNvbnN0IGxpbWl0ID0gcGFyc2VJbnQocXVlcnlQYXJhbXMubGltaXQgfHwgJzUwJyk7XG5cbiAgICAvLyBGZXRjaCBhY3Rpdml0aWVzIGZyb20gYWxsIHNvdXJjZXMgaW4gcGFyYWxsZWxcbiAgICBjb25zdCBbYWxlcnRzLCBoZWFsdGhFdmVudHMsIGNvbW1hbmRzLCBqb3VybmV5cywgZGV2aWNlc10gPSBhd2FpdCBQcm9taXNlLmFsbChbXG4gICAgICBnZXRSZWNlbnRBbGVydHMoaG91cnMsIGxpbWl0KSxcbiAgICAgIGdldFJlY2VudEhlYWx0aEV2ZW50cyhob3VycywgbGltaXQpLFxuICAgICAgZ2V0UmVjZW50Q29tbWFuZHMoaG91cnMsIGxpbWl0KSxcbiAgICAgIGdldFJlY2VudEpvdXJuZXlzKGhvdXJzLCBsaW1pdCksXG4gICAgICBnZXREZXZpY2VzKCksXG4gICAgXSk7XG5cbiAgICAvLyBDcmVhdGUgZGV2aWNlIG5hbWUgbG9va3VwXG4gICAgY29uc3QgZGV2aWNlTmFtZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcbiAgICBmb3IgKGNvbnN0IGRldmljZSBvZiBkZXZpY2VzKSB7XG4gICAgICBkZXZpY2VOYW1lc1tkZXZpY2UuZGV2aWNlX3VpZF0gPSBkZXZpY2UubmFtZSB8fCBkZXZpY2Uuc2VyaWFsX251bWJlciB8fCBkZXZpY2UuZGV2aWNlX3VpZDtcbiAgICB9XG5cbiAgICAvLyBUcmFuc2Zvcm0gYWxlcnRzIHRvIGFjdGl2aXR5IGl0ZW1zXG4gICAgY29uc3QgYWxlcnRBY3Rpdml0aWVzOiBBY3Rpdml0eUl0ZW1bXSA9IGFsZXJ0cy5tYXAoKGFsZXJ0KSA9PiAoe1xuICAgICAgaWQ6IGBhbGVydC0ke2FsZXJ0LmFsZXJ0X2lkfWAsXG4gICAgICB0eXBlOiAnYWxlcnQnLFxuICAgICAgZGV2aWNlX3VpZDogYWxlcnQuZGV2aWNlX3VpZCxcbiAgICAgIGRldmljZV9uYW1lOiBkZXZpY2VOYW1lc1thbGVydC5kZXZpY2VfdWlkXSxcbiAgICAgIG1lc3NhZ2U6IGZvcm1hdEFsZXJ0TWVzc2FnZShhbGVydCksXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKGFsZXJ0LmNyZWF0ZWRfYXQpLnRvSVNPU3RyaW5nKCksXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGFsZXJ0X3R5cGU6IGFsZXJ0LnR5cGUsXG4gICAgICAgIHZhbHVlOiBhbGVydC52YWx1ZSxcbiAgICAgICAgdGhyZXNob2xkOiBhbGVydC50aHJlc2hvbGQsXG4gICAgICAgIGFja25vd2xlZGdlZDogYWxlcnQuYWNrbm93bGVkZ2VkLFxuICAgICAgfSxcbiAgICB9KSk7XG5cbiAgICAvLyBUcmFuc2Zvcm0gaGVhbHRoIGV2ZW50cyB0byBhY3Rpdml0eSBpdGVtc1xuICAgIGNvbnN0IGhlYWx0aEFjdGl2aXRpZXM6IEFjdGl2aXR5SXRlbVtdID0gaGVhbHRoRXZlbnRzLm1hcCgoZXZlbnQpID0+ICh7XG4gICAgICBpZDogYGhlYWx0aC0ke2V2ZW50LmRldmljZV91aWR9LSR7ZXZlbnQudGltZXN0YW1wfWAsXG4gICAgICB0eXBlOiAnaGVhbHRoJyxcbiAgICAgIGRldmljZV91aWQ6IGV2ZW50LmRldmljZV91aWQsXG4gICAgICBkZXZpY2VfbmFtZTogZGV2aWNlTmFtZXNbZXZlbnQuZGV2aWNlX3VpZF0sXG4gICAgICBtZXNzYWdlOiBmb3JtYXRIZWFsdGhNZXNzYWdlKGV2ZW50KSxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoZXZlbnQudGltZXN0YW1wKS50b0lTT1N0cmluZygpLFxuICAgICAgZGF0YToge1xuICAgICAgICBtZXRob2Q6IGV2ZW50Lm1ldGhvZCxcbiAgICAgICAgdm9sdGFnZTogZXZlbnQudm9sdGFnZSxcbiAgICAgIH0sXG4gICAgfSkpO1xuXG4gICAgLy8gVHJhbnNmb3JtIGNvbW1hbmRzIHRvIGFjdGl2aXR5IGl0ZW1zXG4gICAgY29uc3QgY29tbWFuZEFjdGl2aXRpZXM6IEFjdGl2aXR5SXRlbVtdID0gY29tbWFuZHMubWFwKChjbWQpID0+ICh7XG4gICAgICBpZDogYGNvbW1hbmQtJHtjbWQuY29tbWFuZF9pZH1gLFxuICAgICAgdHlwZTogJ2NvbW1hbmQnLFxuICAgICAgZGV2aWNlX3VpZDogY21kLmRldmljZV91aWQsXG4gICAgICBkZXZpY2VfbmFtZTogZGV2aWNlTmFtZXNbY21kLmRldmljZV91aWRdLFxuICAgICAgbWVzc2FnZTogZm9ybWF0Q29tbWFuZE1lc3NhZ2UoY21kKSxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoY21kLmNyZWF0ZWRfYXQpLnRvSVNPU3RyaW5nKCksXG4gICAgICBkYXRhOiB7XG4gICAgICAgIGNtZDogY21kLmNtZCxcbiAgICAgICAgc3RhdHVzOiBjbWQuc3RhdHVzLFxuICAgICAgICBhY2tfc3RhdHVzOiBjbWQuYWNrX3N0YXR1cyxcbiAgICAgIH0sXG4gICAgfSkpO1xuXG4gICAgLy8gVHJhbnNmb3JtIGpvdXJuZXlzIHRvIGFjdGl2aXR5IGl0ZW1zIChzdGFydCBhbmQgZW5kIGV2ZW50cylcbiAgICBjb25zdCBqb3VybmV5QWN0aXZpdGllczogQWN0aXZpdHlJdGVtW10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IGpvdXJuZXkgb2Ygam91cm5leXMpIHtcbiAgICAgIC8vIEpvdXJuZXkgc3RhcnQgZXZlbnRcbiAgICAgIGpvdXJuZXlBY3Rpdml0aWVzLnB1c2goe1xuICAgICAgICBpZDogYGpvdXJuZXktc3RhcnQtJHtqb3VybmV5LmRldmljZV91aWR9LSR7am91cm5leS5qb3VybmV5X2lkfWAsXG4gICAgICAgIHR5cGU6ICdqb3VybmV5JyxcbiAgICAgICAgZGV2aWNlX3VpZDogam91cm5leS5kZXZpY2VfdWlkLFxuICAgICAgICBkZXZpY2VfbmFtZTogZGV2aWNlTmFtZXNbam91cm5leS5kZXZpY2VfdWlkXSxcbiAgICAgICAgbWVzc2FnZTogJ0pvdXJuZXkgc3RhcnRlZCcsXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoam91cm5leS5zdGFydF90aW1lKS50b0lTT1N0cmluZygpLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgam91cm5leV9pZDogam91cm5leS5qb3VybmV5X2lkLFxuICAgICAgICAgIGV2ZW50OiAnc3RhcnQnLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIEpvdXJuZXkgZW5kIGV2ZW50IChvbmx5IGlmIGNvbXBsZXRlZClcbiAgICAgIGlmIChqb3VybmV5LnN0YXR1cyA9PT0gJ2NvbXBsZXRlZCcgJiYgam91cm5leS5lbmRfdGltZSkge1xuICAgICAgICBqb3VybmV5QWN0aXZpdGllcy5wdXNoKHtcbiAgICAgICAgICBpZDogYGpvdXJuZXktZW5kLSR7am91cm5leS5kZXZpY2VfdWlkfS0ke2pvdXJuZXkuam91cm5leV9pZH1gLFxuICAgICAgICAgIHR5cGU6ICdqb3VybmV5JyxcbiAgICAgICAgICBkZXZpY2VfdWlkOiBqb3VybmV5LmRldmljZV91aWQsXG4gICAgICAgICAgZGV2aWNlX25hbWU6IGRldmljZU5hbWVzW2pvdXJuZXkuZGV2aWNlX3VpZF0sXG4gICAgICAgICAgbWVzc2FnZTogZm9ybWF0Sm91cm5leUVuZE1lc3NhZ2Uoam91cm5leSksXG4gICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZShqb3VybmV5LmVuZF90aW1lKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIGpvdXJuZXlfaWQ6IGpvdXJuZXkuam91cm5leV9pZCxcbiAgICAgICAgICAgIGV2ZW50OiAnZW5kJyxcbiAgICAgICAgICAgIHBvaW50X2NvdW50OiBqb3VybmV5LnBvaW50X2NvdW50LFxuICAgICAgICAgICAgdG90YWxfZGlzdGFuY2U6IGpvdXJuZXkudG90YWxfZGlzdGFuY2UsXG4gICAgICAgICAgfSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gTWVyZ2UgYWxsIGFjdGl2aXRpZXMgYW5kIHNvcnQgYnkgdGltZXN0YW1wIChuZXdlc3QgZmlyc3QpXG4gICAgY29uc3QgYWxsQWN0aXZpdGllcyA9IFsuLi5hbGVydEFjdGl2aXRpZXMsIC4uLmhlYWx0aEFjdGl2aXRpZXMsIC4uLmNvbW1hbmRBY3Rpdml0aWVzLCAuLi5qb3VybmV5QWN0aXZpdGllc11cbiAgICAgIC5zb3J0KChhLCBiKSA9PiBuZXcgRGF0ZShiLnRpbWVzdGFtcCkuZ2V0VGltZSgpIC0gbmV3IERhdGUoYS50aW1lc3RhbXApLmdldFRpbWUoKSlcbiAgICAgIC5zbGljZSgwLCBsaW1pdCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgaGVhZGVyczogY29yc0hlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGhvdXJzLFxuICAgICAgICBjb3VudDogYWxsQWN0aXZpdGllcy5sZW5ndGgsXG4gICAgICAgIGFjdGl2aXRpZXM6IGFsbEFjdGl2aXRpZXMsXG4gICAgICB9KSxcbiAgICB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yOicsIGVycm9yKTtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNTAwLFxuICAgICAgaGVhZGVyczogY29yc0hlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyB9KSxcbiAgICB9O1xuICB9XG59O1xuXG5hc3luYyBmdW5jdGlvbiBnZXRSZWNlbnRBbGVydHMoaG91cnM6IG51bWJlciwgbGltaXQ6IG51bWJlcik6IFByb21pc2U8YW55W10+IHtcbiAgY29uc3QgY3V0b2ZmVGltZSA9IERhdGUubm93KCkgLSBob3VycyAqIDYwICogNjAgKiAxMDAwO1xuICBjb25zdCBhbGxJdGVtczogYW55W10gPSBbXTtcbiAgbGV0IGxhc3RFdmFsdWF0ZWRLZXk6IFJlY29yZDxzdHJpbmcsIGFueT4gfCB1bmRlZmluZWQ7XG5cbiAgLy8gUGFnaW5hdGUgdGhyb3VnaCBhbGwgcmVzdWx0c1xuICBkbyB7XG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBTY2FuQ29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IEFMRVJUU19UQUJMRSxcbiAgICAgIEZpbHRlckV4cHJlc3Npb246ICdjcmVhdGVkX2F0ID4gOmN1dG9mZicsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICc6Y3V0b2ZmJzogY3V0b2ZmVGltZSxcbiAgICAgIH0sXG4gICAgICBFeGNsdXNpdmVTdGFydEtleTogbGFzdEV2YWx1YXRlZEtleSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIGFsbEl0ZW1zLnB1c2goLi4uKHJlc3VsdC5JdGVtcyB8fCBbXSkpO1xuICAgIGxhc3RFdmFsdWF0ZWRLZXkgPSByZXN1bHQuTGFzdEV2YWx1YXRlZEtleTtcblxuICAgIC8vIFN0b3AgZWFybHkgaWYgd2UgaGF2ZSBlbm91Z2ggaXRlbXNcbiAgICBpZiAoYWxsSXRlbXMubGVuZ3RoID49IGxpbWl0ICogMikgYnJlYWs7XG4gIH0gd2hpbGUgKGxhc3RFdmFsdWF0ZWRLZXkpO1xuXG4gIHJldHVybiBhbGxJdGVtcy5zbGljZSgwLCBsaW1pdCAqIDIpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRSZWNlbnRIZWFsdGhFdmVudHMoaG91cnM6IG51bWJlciwgbGltaXQ6IG51bWJlcik6IFByb21pc2U8YW55W10+IHtcbiAgY29uc3QgY3V0b2ZmVGltZSA9IERhdGUubm93KCkgLSBob3VycyAqIDYwICogNjAgKiAxMDAwO1xuICBjb25zdCBhbGxJdGVtczogYW55W10gPSBbXTtcbiAgbGV0IGxhc3RFdmFsdWF0ZWRLZXk6IFJlY29yZDxzdHJpbmcsIGFueT4gfCB1bmRlZmluZWQ7XG5cbiAgLy8gUGFnaW5hdGUgdGhyb3VnaCBhbGwgcmVzdWx0c1xuICBkbyB7XG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBTY2FuQ29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IFRFTEVNRVRSWV9UQUJMRSxcbiAgICAgIEZpbHRlckV4cHJlc3Npb246ICcjdHMgPiA6Y3V0b2ZmIEFORCBkYXRhX3R5cGUgPSA6ZGF0YV90eXBlJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgICAnI3RzJzogJ3RpbWVzdGFtcCcsXG4gICAgICB9LFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAnOmN1dG9mZic6IGN1dG9mZlRpbWUsXG4gICAgICAgICc6ZGF0YV90eXBlJzogJ2hlYWx0aCcsXG4gICAgICB9LFxuICAgICAgRXhjbHVzaXZlU3RhcnRLZXk6IGxhc3RFdmFsdWF0ZWRLZXksXG4gICAgfSk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICBhbGxJdGVtcy5wdXNoKC4uLihyZXN1bHQuSXRlbXMgfHwgW10pKTtcbiAgICBsYXN0RXZhbHVhdGVkS2V5ID0gcmVzdWx0Lkxhc3RFdmFsdWF0ZWRLZXk7XG5cbiAgICAvLyBTdG9wIGVhcmx5IGlmIHdlIGhhdmUgZW5vdWdoIGl0ZW1zXG4gICAgaWYgKGFsbEl0ZW1zLmxlbmd0aCA+PSBsaW1pdCAqIDIpIGJyZWFrO1xuICB9IHdoaWxlIChsYXN0RXZhbHVhdGVkS2V5KTtcblxuICByZXR1cm4gYWxsSXRlbXMuc2xpY2UoMCwgbGltaXQgKiAyKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0UmVjZW50Q29tbWFuZHMoaG91cnM6IG51bWJlciwgbGltaXQ6IG51bWJlcik6IFByb21pc2U8YW55W10+IHtcbiAgY29uc3QgY3V0b2ZmVGltZSA9IERhdGUubm93KCkgLSBob3VycyAqIDYwICogNjAgKiAxMDAwO1xuICBjb25zdCBhbGxJdGVtczogYW55W10gPSBbXTtcbiAgbGV0IGxhc3RFdmFsdWF0ZWRLZXk6IFJlY29yZDxzdHJpbmcsIGFueT4gfCB1bmRlZmluZWQ7XG5cbiAgZG8ge1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgU2NhbkNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBDT01NQU5EU19UQUJMRSxcbiAgICAgIEZpbHRlckV4cHJlc3Npb246ICdjcmVhdGVkX2F0ID4gOmN1dG9mZicsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICc6Y3V0b2ZmJzogY3V0b2ZmVGltZSxcbiAgICAgIH0sXG4gICAgICBFeGNsdXNpdmVTdGFydEtleTogbGFzdEV2YWx1YXRlZEtleSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIGFsbEl0ZW1zLnB1c2goLi4uKHJlc3VsdC5JdGVtcyB8fCBbXSkpO1xuICAgIGxhc3RFdmFsdWF0ZWRLZXkgPSByZXN1bHQuTGFzdEV2YWx1YXRlZEtleTtcblxuICAgIGlmIChhbGxJdGVtcy5sZW5ndGggPj0gbGltaXQgKiAyKSBicmVhaztcbiAgfSB3aGlsZSAobGFzdEV2YWx1YXRlZEtleSk7XG5cbiAgcmV0dXJuIGFsbEl0ZW1zLnNsaWNlKDAsIGxpbWl0ICogMik7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFJlY2VudEpvdXJuZXlzKGhvdXJzOiBudW1iZXIsIGxpbWl0OiBudW1iZXIpOiBQcm9taXNlPGFueVtdPiB7XG4gIGNvbnN0IGN1dG9mZlRpbWUgPSBEYXRlLm5vdygpIC0gaG91cnMgKiA2MCAqIDYwICogMTAwMDtcbiAgY29uc3QgYWxsSXRlbXM6IGFueVtdID0gW107XG4gIGxldCBsYXN0RXZhbHVhdGVkS2V5OiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHwgdW5kZWZpbmVkO1xuXG4gIGRvIHtcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IFNjYW5Db21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogSk9VUk5FWVNfVEFCTEUsXG4gICAgICBGaWx0ZXJFeHByZXNzaW9uOiAnc3RhcnRfdGltZSA+IDpjdXRvZmYnLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAnOmN1dG9mZic6IGN1dG9mZlRpbWUsXG4gICAgICB9LFxuICAgICAgRXhjbHVzaXZlU3RhcnRLZXk6IGxhc3RFdmFsdWF0ZWRLZXksXG4gICAgfSk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICBhbGxJdGVtcy5wdXNoKC4uLihyZXN1bHQuSXRlbXMgfHwgW10pKTtcbiAgICBsYXN0RXZhbHVhdGVkS2V5ID0gcmVzdWx0Lkxhc3RFdmFsdWF0ZWRLZXk7XG5cbiAgICBpZiAoYWxsSXRlbXMubGVuZ3RoID49IGxpbWl0ICogMikgYnJlYWs7XG4gIH0gd2hpbGUgKGxhc3RFdmFsdWF0ZWRLZXkpO1xuXG4gIHJldHVybiBhbGxJdGVtcy5zbGljZSgwLCBsaW1pdCAqIDIpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXREZXZpY2VzKCk6IFByb21pc2U8YW55W10+IHtcbiAgY29uc3QgY29tbWFuZCA9IG5ldyBTY2FuQ29tbWFuZCh7XG4gICAgVGFibGVOYW1lOiBERVZJQ0VTX1RBQkxFLFxuICAgIFByb2plY3Rpb25FeHByZXNzaW9uOiAnZGV2aWNlX3VpZCwgI25hbWUsIHNlcmlhbF9udW1iZXInLFxuICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczoge1xuICAgICAgJyNuYW1lJzogJ25hbWUnLFxuICAgIH0sXG4gIH0pO1xuXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICByZXR1cm4gcmVzdWx0Lkl0ZW1zIHx8IFtdO1xufVxuXG5mdW5jdGlvbiBmb3JtYXRBbGVydE1lc3NhZ2UoYWxlcnQ6IGFueSk6IHN0cmluZyB7XG4gIGNvbnN0IGFsZXJ0TGFiZWxzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge1xuICAgIHRlbXBfaGlnaDogJ0hpZ2ggdGVtcGVyYXR1cmUgYWxlcnQnLFxuICAgIHRlbXBfbG93OiAnTG93IHRlbXBlcmF0dXJlIGFsZXJ0JyxcbiAgICBodW1pZGl0eV9oaWdoOiAnSGlnaCBodW1pZGl0eSBhbGVydCcsXG4gICAgaHVtaWRpdHlfbG93OiAnTG93IGh1bWlkaXR5IGFsZXJ0JyxcbiAgICBwcmVzc3VyZV9jaGFuZ2U6ICdQcmVzc3VyZSBjaGFuZ2UgYWxlcnQnLFxuICAgIGxvd19iYXR0ZXJ5OiAnTG93IGJhdHRlcnkgYWxlcnQnLFxuICAgIG1vdGlvbjogJ01vdGlvbiBkZXRlY3RlZCcsXG4gIH07XG5cbiAgY29uc3QgbGFiZWwgPSBhbGVydExhYmVsc1thbGVydC50eXBlXSB8fCBhbGVydC50eXBlO1xuICBpZiAoYWxlcnQudmFsdWUgIT09IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiBgJHtsYWJlbH06ICR7YWxlcnQudmFsdWUudG9GaXhlZCgxKX1gO1xuICB9XG4gIHJldHVybiBsYWJlbDtcbn1cblxuZnVuY3Rpb24gZm9ybWF0SGVhbHRoTWVzc2FnZShldmVudDogYW55KTogc3RyaW5nIHtcbiAgY29uc3QgbWV0aG9kTGFiZWxzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge1xuICAgIGRmdTogJ0Zpcm13YXJlIHVwZGF0ZScsXG4gICAgYm9vdDogJ0RldmljZSBib290ZWQnLFxuICAgIHJlYm9vdDogJ0RldmljZSByZWJvb3RlZCcsXG4gICAgcmVzZXQ6ICdEZXZpY2UgcmVzZXQnLFxuICAgIHVzYjogJ1VTQiBjb25uZWN0ZWQnLFxuICAgIGJhdHRlcnk6ICdCYXR0ZXJ5IHN0YXR1cyB1cGRhdGUnLFxuICAgIHN5bmM6ICdTeW5jIGNvbXBsZXRlZCcsXG4gICAgY29ubmVjdGVkOiAnQ29ubmVjdGVkIHRvIG5ldHdvcmsnLFxuICAgIGRpc2Nvbm5lY3RlZDogJ0Rpc2Nvbm5lY3RlZCBmcm9tIG5ldHdvcmsnLFxuICB9O1xuXG4gIGNvbnN0IGxhYmVsID0gbWV0aG9kTGFiZWxzW2V2ZW50Lm1ldGhvZF0gfHwgZXZlbnQubWV0aG9kIHx8ICdIZWFsdGggZXZlbnQnO1xuICBpZiAoZXZlbnQudGV4dCkge1xuICAgIHJldHVybiBgJHtsYWJlbH06ICR7ZXZlbnQudGV4dH1gO1xuICB9XG4gIHJldHVybiBsYWJlbDtcbn1cblxuZnVuY3Rpb24gZm9ybWF0Q29tbWFuZE1lc3NhZ2UoY21kOiBhbnkpOiBzdHJpbmcge1xuICBjb25zdCBjbWRMYWJlbHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7XG4gICAgcGluZzogJ1BpbmcgY29tbWFuZCcsXG4gICAgbG9jYXRlOiAnTG9jYXRlIGNvbW1hbmQnLFxuICAgIHBsYXlfbWVsb2R5OiAnUGxheSBtZWxvZHkgY29tbWFuZCcsXG4gICAgdGVzdF9hdWRpbzogJ1Rlc3QgYXVkaW8gY29tbWFuZCcsXG4gICAgc2V0X3ZvbHVtZTogJ1NldCB2b2x1bWUgY29tbWFuZCcsXG4gIH07XG5cbiAgY29uc3QgbGFiZWwgPSBjbWRMYWJlbHNbY21kLmNtZF0gfHwgY21kLmNtZCB8fCAnQ29tbWFuZCc7XG4gIGNvbnN0IHN0YXR1c0xhYmVsczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHtcbiAgICBxdWV1ZWQ6ICdxdWV1ZWQnLFxuICAgIHNlbnQ6ICdzZW50JyxcbiAgICBvazogJ2Fja25vd2xlZGdlZCcsXG4gICAgZXJyb3I6ICdmYWlsZWQnLFxuICAgIGlnbm9yZWQ6ICdpZ25vcmVkJyxcbiAgfTtcblxuICBjb25zdCBzdGF0dXMgPSBzdGF0dXNMYWJlbHNbY21kLmFja19zdGF0dXMgfHwgY21kLnN0YXR1c10gfHwgY21kLnN0YXR1cztcbiAgcmV0dXJuIGAke2xhYmVsfSAke3N0YXR1c31gO1xufVxuXG5mdW5jdGlvbiBmb3JtYXRKb3VybmV5RW5kTWVzc2FnZShqb3VybmV5OiBhbnkpOiBzdHJpbmcge1xuICBjb25zdCBkaXN0YW5jZSA9IGpvdXJuZXkudG90YWxfZGlzdGFuY2UgfHwgMDtcbiAgY29uc3QgcG9pbnRzID0gam91cm5leS5wb2ludF9jb3VudCB8fCAwO1xuXG4gIC8vIEZvcm1hdCBkaXN0YW5jZSBpbiBrbSBvciBtXG4gIGxldCBkaXN0YW5jZVN0cjogc3RyaW5nO1xuICBpZiAoZGlzdGFuY2UgPj0gMTAwMCkge1xuICAgIGRpc3RhbmNlU3RyID0gYCR7KGRpc3RhbmNlIC8gMTAwMCkudG9GaXhlZCgxKX0ga21gO1xuICB9IGVsc2Uge1xuICAgIGRpc3RhbmNlU3RyID0gYCR7TWF0aC5yb3VuZChkaXN0YW5jZSl9IG1gO1xuICB9XG5cbiAgcmV0dXJuIGBKb3VybmV5IGVuZGVkOiAke2Rpc3RhbmNlU3RyfSwgJHtwb2ludHN9IHBvaW50c2A7XG59XG4iXX0=