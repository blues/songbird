"use strict";
/**
 * Public Device API Lambda
 *
 * Provides unauthenticated read-only access to device information.
 * All requests are audit logged.
 *
 * Endpoints:
 * - GET /public/devices/{serial_number} - Get device details (no auth required)
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const device_lookup_1 = require("../shared/device-lookup");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient);
const DEVICES_TABLE = process.env.DEVICES_TABLE;
const TELEMETRY_TABLE = process.env.TELEMETRY_TABLE;
const AUDIT_TABLE = process.env.AUDIT_TABLE;
const handler = async (event) => {
    console.log('Public device request:', JSON.stringify(event));
    const corsHeaders = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type',
        'Access-Control-Allow-Methods': 'GET,OPTIONS',
    };
    try {
        const method = event.requestContext?.http?.method || event.httpMethod;
        const serialNumber = event.pathParameters?.serial_number;
        if (method === 'OPTIONS') {
            return { statusCode: 200, headers: corsHeaders, body: '' };
        }
        if (method !== 'GET') {
            return {
                statusCode: 405,
                headers: corsHeaders,
                body: JSON.stringify({ error: 'Method not allowed' }),
            };
        }
        if (!serialNumber) {
            return {
                statusCode: 400,
                headers: corsHeaders,
                body: JSON.stringify({ error: 'Serial number required' }),
            };
        }
        // Get device data
        const result = await getPublicDevice(serialNumber, corsHeaders);
        // Audit log the access (fire and forget - don't block response)
        await logPublicAccess(event, serialNumber, result.statusCode === 200);
        return result;
    }
    catch (error) {
        console.error('Error:', error);
        return {
            statusCode: 500,
            headers: corsHeaders,
            body: JSON.stringify({ error: 'Internal server error' }),
        };
    }
};
exports.handler = handler;
async function getPublicDevice(serialNumber, headers) {
    // Resolve serial_number to device info
    const resolved = await (0, device_lookup_1.resolveDevice)(serialNumber);
    if (!resolved) {
        return {
            statusCode: 404,
            headers,
            body: JSON.stringify({ error: 'Device not found' }),
        };
    }
    // Get the device using the current device_uid
    const command = new lib_dynamodb_1.GetCommand({
        TableName: DEVICES_TABLE,
        Key: { device_uid: resolved.device_uid },
    });
    const result = await docClient.send(command);
    if (!result.Item) {
        return {
            statusCode: 404,
            headers,
            body: JSON.stringify({ error: 'Device not found' }),
        };
    }
    // Get recent telemetry for the device
    const telemetry = await getRecentTelemetry(resolved.device_uid);
    // Transform device data
    const device = transformDevice(result.Item);
    device.recent_telemetry = telemetry;
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify(device),
    };
}
async function getRecentTelemetry(deviceUid) {
    try {
        const oneDayAgo = Date.now() - 24 * 60 * 60 * 1000;
        const command = new lib_dynamodb_1.QueryCommand({
            TableName: TELEMETRY_TABLE,
            KeyConditionExpression: 'device_uid = :uid AND #ts >= :start',
            ExpressionAttributeNames: { '#ts': 'timestamp' },
            ExpressionAttributeValues: {
                ':uid': deviceUid,
                ':start': oneDayAgo,
            },
            ScanIndexForward: false, // Most recent first
            Limit: 100,
        });
        const result = await docClient.send(command);
        return (result.Items || []).map((item) => ({
            timestamp: new Date(item.timestamp).toISOString(),
            temperature: item.temp,
            humidity: item.humidity,
            pressure: item.pressure,
            voltage: item.voltage,
        }));
    }
    catch (error) {
        console.error('Error fetching telemetry:', error);
        return [];
    }
}
/**
 * Transform DynamoDB device record to public frontend format
 */
function transformDevice(item) {
    const device = {
        device_uid: item.device_uid,
        serial_number: item.serial_number,
        name: item.name,
        fleet: item.fleet,
        status: item.status,
        last_seen: item.last_seen ? new Date(item.last_seen).toISOString() : undefined,
        mode: item.current_mode,
        transit_locked: item.transit_locked || false,
        demo_locked: item.demo_locked || false,
        usb_powered: item.usb_powered || false,
    };
    // Flatten last_location
    if (item.last_location) {
        device.latitude = item.last_location.lat;
        device.longitude = item.last_location.lon;
        if (item.last_location.time) {
            const timeMs = item.last_location.time * 1000;
            device.location_time = new Date(timeMs).toISOString();
        }
        device.location_source = item.last_location.source;
        device.location_name = item.last_location.name;
    }
    // Flatten last_telemetry
    if (item.last_telemetry) {
        device.temperature = item.last_telemetry.temp;
        device.humidity = item.last_telemetry.humidity;
        device.pressure = item.last_telemetry.pressure;
        device.motion = item.last_telemetry.motion;
    }
    // Voltage from device record
    if (item.voltage !== undefined) {
        device.voltage = item.voltage;
    }
    // Firmware versions
    if (item.firmware_version) {
        device.firmware_version = item.firmware_version;
    }
    if (item.notecard_version) {
        device.notecard_version = item.notecard_version;
    }
    if (item.notecard_sku) {
        device.notecard_sku = item.notecard_sku;
    }
    return device;
}
/**
 * Log public device access for audit purposes
 */
async function logPublicAccess(event, serialNumber, success) {
    try {
        const sourceIp = event.requestContext?.identity?.sourceIp ||
            event.requestContext?.http?.sourceIp ||
            'unknown';
        const userAgent = event.headers?.['User-Agent'] ||
            event.headers?.['user-agent'] ||
            'unknown';
        const auditRecord = {
            audit_id: `public-device-${Date.now()}-${Math.random().toString(36).substring(7)}`,
            action: 'public_device_view',
            serial_number: serialNumber,
            timestamp: Date.now(),
            result: success ? 'success' : 'not_found',
            source_ip: sourceIp,
            user_agent: userAgent,
            ttl: Math.floor(Date.now() / 1000) + 90 * 24 * 60 * 60, // 90 day TTL
        };
        await docClient.send(new lib_dynamodb_1.PutCommand({
            TableName: AUDIT_TABLE,
            Item: auditRecord,
        }));
        console.log(`Audit: public_device_view - ${success ? 'success' : 'not_found'} for ${serialNumber} from ${sourceIp}`);
    }
    catch (error) {
        // Audit logging is non-critical, log but don't fail the request
        console.error('Failed to write audit log:', error);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvYXBpLXB1YmxpYy1kZXZpY2UvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7OztHQVFHOzs7QUFFSCw4REFBMEQ7QUFDMUQsd0RBSytCO0FBRS9CLDJEQUF3RDtBQUV4RCxNQUFNLFNBQVMsR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDekMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBRXpELE1BQU0sYUFBYSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYyxDQUFDO0FBQ2pELE1BQU0sZUFBZSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZ0IsQ0FBQztBQUNyRCxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVksQ0FBQztBQUV0QyxNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQUUsS0FBMkIsRUFBa0MsRUFBRTtJQUMzRixPQUFPLENBQUMsR0FBRyxDQUFDLHdCQUF3QixFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUU3RCxNQUFNLFdBQVcsR0FBRztRQUNsQiw2QkFBNkIsRUFBRSxHQUFHO1FBQ2xDLDhCQUE4QixFQUFFLGNBQWM7UUFDOUMsOEJBQThCLEVBQUUsYUFBYTtLQUM5QyxDQUFDO0lBRUYsSUFBSSxDQUFDO1FBQ0gsTUFBTSxNQUFNLEdBQUksS0FBSyxDQUFDLGNBQXNCLEVBQUUsSUFBSSxFQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsVUFBVSxDQUFDO1FBQy9FLE1BQU0sWUFBWSxHQUFHLEtBQUssQ0FBQyxjQUFjLEVBQUUsYUFBYSxDQUFDO1FBRXpELElBQUksTUFBTSxLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQ3pCLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLE9BQU8s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T0FBTyxDQUFDLEtBQUssQ0FBQyw0QkFBNEIsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNyRCxDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogUHVibGljIERldmljZSBBUEkgTGFtYmRhXG4gKlxuICogUHJvdmlkZXMgdW5hdXRoZW50aWNhdGVkIHJlYWQtb25seSBhY2Nlc3MgdG8gZGV2aWNlIGluZm9ybWF0aW9uLlxuICogQWxsIHJlcXVlc3RzIGFyZSBhdWRpdCBsb2dnZWQuXG4gKlxuICogRW5kcG9pbnRzOlxuICogLSBHRVQgL3B1YmxpYy9kZXZpY2VzL3tzZXJpYWxfbnVtYmVyfSAtIEdldCBkZXZpY2UgZGV0YWlscyAobm8gYXV0aCByZXF1aXJlZClcbiAqL1xuXG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQge1xuICBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LFxuICBHZXRDb21tYW5kLFxuICBQdXRDb21tYW5kLFxuICBRdWVyeUNvbW1hbmQsXG59IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCwgQVBJR2F0ZXdheVByb3h5UmVzdWx0IH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyByZXNvbHZlRGV2aWNlIH0gZnJvbSAnLi4vc2hhcmVkL2RldmljZS1sb29rdXAnO1xuXG5jb25zdCBkZGJDbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGRkYkNsaWVudCk7XG5cbmNvbnN0IERFVklDRVNfVEFCTEUgPSBwcm9jZXNzLmVudi5ERVZJQ0VTX1RBQkxFITtcbmNvbnN0IFRFTEVNRVRSWV9UQUJMRSA9IHByb2Nlc3MuZW52LlRFTEVNRVRSWV9UQUJMRSE7XG5jb25zdCBBVURJVF9UQUJMRSA9IHByb2Nlc3MuZW52LkFVRElUX1RBQkxFITtcblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50KTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0+IHtcbiAgY29uc29sZS5sb2coJ1B1YmxpYyBkZXZpY2UgcmVxdWVzdDonLCBKU09OLnN0cmluZ2lmeShldmVudCkpO1xuXG4gIGNvbnN0IGNvcnNIZWFkZXJzID0ge1xuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlJyxcbiAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctTWV0aG9kcyc6ICdHRVQsT1BUSU9OUycsXG4gIH07XG5cbiAgdHJ5IHtcbiAgICBjb25zdCBtZXRob2QgPSAoZXZlbnQucmVxdWVzdENvbnRleHQgYXMgYW55KT8uaHR0cD8ubWV0aG9kIHx8IGV2ZW50Lmh0dHBNZXRob2Q7XG4gICAgY29uc3Qgc2VyaWFsTnVtYmVyID0gZXZlbnQucGF0aFBhcmFtZXRlcnM/LnNlcmlhbF9udW1iZXI7XG5cbiAgICBpZiAobWV0aG9kID09PSAnT1BUSU9OUycpIHtcbiAgICAgIHJldHVybiB7IHN0YXR1c0NvZGU6IDIwMCwgaGVhZGVyczogY29yc0hlYWRlcnMsIGJvZHk6ICcnIH07XG4gICAgfVxuXG4gICAgaWYgKG1ldGhvZCAhPT0gJ0dFVCcpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDQwNSxcbiAgICAgICAgaGVhZGVyczogY29yc0hlYWRlcnMsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdNZXRob2Qgbm90IGFsbG93ZWQnIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoIXNlcmlhbE51bWJlcikge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgICBoZWFkZXJzOiBjb3JzSGVhZGVycyxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ1NlcmlhbCBudW1iZXIgcmVxdWlyZWQnIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBHZXQgZGV2aWNlIGRhdGFcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBnZXRQdWJsaWNEZXZpY2Uoc2VyaWFsTnVtYmVyLCBjb3JzSGVhZGVycyk7XG5cbiAgICAvLyBBdWRpdCBsb2cgdGhlIGFjY2VzcyAoZmlyZSBhbmQgZm9yZ2V0IC0gZG9uJ3QgYmxvY2sgcmVzcG9uc2UpXG4gICAgYXdhaXQgbG9nUHVibGljQWNjZXNzKGV2ZW50LCBzZXJpYWxOdW1iZXIsIHJlc3VsdC5zdGF0dXNDb2RlID09PSAyMDApO1xuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICAgIGhlYWRlcnM6IGNvcnNIZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicgfSksXG4gICAgfTtcbiAgfVxufTtcblxuYXN5bmMgZnVuY3Rpb24gZ2V0UHVibGljRGV2aWNlKFxuICBzZXJpYWxOdW1iZXI6IHN0cmluZyxcbiAgaGVhZGVyczogUmVjb3JkPHN0cmluZywgc3RyaW5nPlxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+IHtcbiAgLy8gUmVzb2x2ZSBzZXJpYWxfbnVtYmVyIHRvIGRldmljZSBpbmZvXG4gIGNvbnN0IHJlc29sdmVkID0gYXdhaXQgcmVzb2x2ZURldmljZShzZXJpYWxOdW1iZXIpO1xuXG4gIGlmICghcmVzb2x2ZWQpIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNDA0LFxuICAgICAgaGVhZGVycyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdEZXZpY2Ugbm90IGZvdW5kJyB9KSxcbiAgICB9O1xuICB9XG5cbiAgLy8gR2V0IHRoZSBkZXZpY2UgdXNpbmcgdGhlIGN1cnJlbnQgZGV2aWNlX3VpZFxuICBjb25zdCBjb21tYW5kID0gbmV3IEdldENvbW1hbmQoe1xuICAgIFRhYmxlTmFtZTogREVWSUNFU19UQUJMRSxcbiAgICBLZXk6IHsgZGV2aWNlX3VpZDogcmVzb2x2ZWQuZGV2aWNlX3VpZCB9LFxuICB9KTtcblxuICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcblxuICBpZiAoIXJlc3VsdC5JdGVtKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDQwNCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnRGV2aWNlIG5vdCBmb3VuZCcgfSksXG4gICAgfTtcbiAgfVxuXG4gIC8vIEdldCByZWNlbnQgdGVsZW1ldHJ5IGZvciB0aGUgZGV2aWNlXG4gIGNvbnN0IHRlbGVtZXRyeSA9IGF3YWl0IGdldFJlY2VudFRlbGVtZXRyeShyZXNvbHZlZC5kZXZpY2VfdWlkKTtcblxuICAvLyBUcmFuc2Zvcm0gZGV2aWNlIGRhdGFcbiAgY29uc3QgZGV2aWNlID0gdHJhbnNmb3JtRGV2aWNlKHJlc3VsdC5JdGVtKTtcbiAgZGV2aWNlLnJlY2VudF90ZWxlbWV0cnkgPSB0ZWxlbWV0cnk7XG5cbiAgcmV0dXJuIHtcbiAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgaGVhZGVycyxcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeShkZXZpY2UpLFxuICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRSZWNlbnRUZWxlbWV0cnkoZGV2aWNlVWlkOiBzdHJpbmcpOiBQcm9taXNlPGFueVtdPiB7XG4gIHRyeSB7XG4gICAgY29uc3Qgb25lRGF5QWdvID0gRGF0ZS5ub3coKSAtIDI0ICogNjAgKiA2MCAqIDEwMDA7XG5cbiAgICBjb25zdCBjb21tYW5kID0gbmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IFRFTEVNRVRSWV9UQUJMRSxcbiAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdkZXZpY2VfdWlkID0gOnVpZCBBTkQgI3RzID49IDpzdGFydCcsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHsgJyN0cyc6ICd0aW1lc3RhbXAnIH0sXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICc6dWlkJzogZGV2aWNlVWlkLFxuICAgICAgICAnOnN0YXJ0Jzogb25lRGF5QWdvLFxuICAgICAgfSxcbiAgICAgIFNjYW5JbmRleEZvcndhcmQ6IGZhbHNlLCAvLyBNb3N0IHJlY2VudCBmaXJzdFxuICAgICAgTGltaXQ6IDEwMCxcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIHJldHVybiAocmVzdWx0Lkl0ZW1zIHx8IFtdKS5tYXAoKGl0ZW06IGFueSkgPT4gKHtcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoaXRlbS50aW1lc3RhbXApLnRvSVNPU3RyaW5nKCksXG4gICAgICB0ZW1wZXJhdHVyZTogaXRlbS50ZW1wLFxuICAgICAgaHVtaWRpdHk6IGl0ZW0uaHVtaWRpdHksXG4gICAgICBwcmVzc3VyZTogaXRlbS5wcmVzc3VyZSxcbiAgICAgIHZvbHRhZ2U6IGl0ZW0udm9sdGFnZSxcbiAgICB9KSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgZmV0Y2hpbmcgdGVsZW1ldHJ5OicsIGVycm9yKTtcbiAgICByZXR1cm4gW107XG4gIH1cbn1cblxuLyoqXG4gKiBUcmFuc2Zvcm0gRHluYW1vREIgZGV2aWNlIHJlY29yZCB0byBwdWJsaWMgZnJvbnRlbmQgZm9ybWF0XG4gKi9cbmZ1bmN0aW9uIHRyYW5zZm9ybURldmljZShpdGVtOiBhbnkpOiBhbnkge1xuICBjb25zdCBkZXZpY2U6IGFueSA9IHtcbiAgICBkZXZpY2VfdWlkOiBpdGVtLmRldmljZV91aWQsXG4gICAgc2VyaWFsX251bWJlcjogaXRlbS5zZXJpYWxfbnVtYmVyLFxuICAgIG5hbWU6IGl0ZW0ubmFtZSxcbiAgICBmbGVldDogaXRlbS5mbGVldCxcbiAgICBzdGF0dXM6IGl0ZW0uc3RhdHVzLFxuICAgIGxhc3Rfc2VlbjogaXRlbS5sYXN0X3NlZW4gPyBuZXcgRGF0ZShpdGVtLmxhc3Rfc2VlbikudG9JU09TdHJpbmcoKSA6IHVuZGVmaW5lZCxcbiAgICBtb2RlOiBpdGVtLmN1cnJlbnRfbW9kZSxcbiAgICB0cmFuc2l0X2xvY2tlZDogaXRlbS50cmFuc2l0X2xvY2tlZCB8fCBmYWxzZSxcbiAgICBkZW1vX2xvY2tlZDogaXRlbS5kZW1vX2xvY2tlZCB8fCBmYWxzZSxcbiAgICB1c2JfcG93ZXJlZDogaXRlbS51c2JfcG93ZXJlZCB8fCBmYWxzZSxcbiAgfTtcblxuICAvLyBGbGF0dGVuIGxhc3RfbG9jYXRpb25cbiAgaWYgKGl0ZW0ubGFzdF9sb2NhdGlvbikge1xuICAgIGRldmljZS5sYXRpdHVkZSA9IGl0ZW0ubGFzdF9sb2NhdGlvbi5sYXQ7XG4gICAgZGV2aWNlLmxvbmdpdHVkZSA9IGl0ZW0ubGFzdF9sb2NhdGlvbi5sb247XG4gICAgaWYgKGl0ZW0ubGFzdF9sb2NhdGlvbi50aW1lKSB7XG4gICAgICBjb25zdCB0aW1lTXMgPSBpdGVtLmxhc3RfbG9jYXRpb24udGltZSAqIDEwMDA7XG4gICAgICBkZXZpY2UubG9jYXRpb25fdGltZSA9IG5ldyBEYXRlKHRpbWVNcykudG9JU09TdHJpbmcoKTtcbiAgICB9XG4gICAgZGV2aWNlLmxvY2F0aW9uX3NvdXJjZSA9IGl0ZW0ubGFzdF9sb2NhdGlvbi5zb3VyY2U7XG4gICAgZGV2aWNlLmxvY2F0aW9uX25hbWUgPSBpdGVtLmxhc3RfbG9jYXRpb24ubmFtZTtcbiAgfVxuXG4gIC8vIEZsYXR0ZW4gbGFzdF90ZWxlbWV0cnlcbiAgaWYgKGl0ZW0ubGFzdF90ZWxlbWV0cnkpIHtcbiAgICBkZXZpY2UudGVtcGVyYXR1cmUgPSBpdGVtLmxhc3RfdGVsZW1ldHJ5LnRlbXA7XG4gICAgZGV2aWNlLmh1bWlkaXR5ID0gaXRlbS5sYXN0X3RlbGVtZXRyeS5odW1pZGl0eTtcbiAgICBkZXZpY2UucHJlc3N1cmUgPSBpdGVtLmxhc3RfdGVsZW1ldHJ5LnByZXNzdXJlO1xuICAgIGRldmljZS5tb3Rpb24gPSBpdGVtLmxhc3RfdGVsZW1ldHJ5Lm1vdGlvbjtcbiAgfVxuXG4gIC8vIFZvbHRhZ2UgZnJvbSBkZXZpY2UgcmVjb3JkXG4gIGlmIChpdGVtLnZvbHRhZ2UgIT09IHVuZGVmaW5lZCkge1xuICAgIGRldmljZS52b2x0YWdlID0gaXRlbS52b2x0YWdlO1xuICB9XG5cbiAgLy8gRmlybXdhcmUgdmVyc2lvbnNcbiAgaWYgKGl0ZW0uZmlybXdhcmVfdmVyc2lvbikge1xuICAgIGRldmljZS5maXJtd2FyZV92ZXJzaW9uID0gaXRlbS5maXJtd2FyZV92ZXJzaW9uO1xuICB9XG4gIGlmIChpdGVtLm5vdGVjYXJkX3ZlcnNpb24pIHtcbiAgICBkZXZpY2Uubm90ZWNhcmRfdmVyc2lvbiA9IGl0ZW0ubm90ZWNhcmRfdmVyc2lvbjtcbiAgfVxuICBpZiAoaXRlbS5ub3RlY2FyZF9za3UpIHtcbiAgICBkZXZpY2Uubm90ZWNhcmRfc2t1ID0gaXRlbS5ub3RlY2FyZF9za3U7XG4gIH1cblxuICByZXR1cm4gZGV2aWNlO1xufVxuXG4vKipcbiAqIExvZyBwdWJsaWMgZGV2aWNlIGFjY2VzcyBmb3IgYXVkaXQgcHVycG9zZXNcbiAqL1xuYXN5bmMgZnVuY3Rpb24gbG9nUHVibGljQWNjZXNzKFxuICBldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQsXG4gIHNlcmlhbE51bWJlcjogc3RyaW5nLFxuICBzdWNjZXNzOiBib29sZWFuXG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBzb3VyY2VJcCA9IGV2ZW50LnJlcXVlc3RDb250ZXh0Py5pZGVudGl0eT8uc291cmNlSXAgfHxcbiAgICAgIChldmVudC5yZXF1ZXN0Q29udGV4dCBhcyBhbnkpPy5odHRwPy5zb3VyY2VJcCB8fFxuICAgICAgJ3Vua25vd24nO1xuICAgIGNvbnN0IHVzZXJBZ2VudCA9IGV2ZW50LmhlYWRlcnM/LlsnVXNlci1BZ2VudCddIHx8XG4gICAgICBldmVudC5oZWFkZXJzPy5bJ3VzZXItYWdlbnQnXSB8fFxuICAgICAgJ3Vua25vd24nO1xuXG4gICAgY29uc3QgYXVkaXRSZWNvcmQgPSB7XG4gICAgICBhdWRpdF9pZDogYHB1YmxpYy1kZXZpY2UtJHtEYXRlLm5vdygpfS0ke01hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cmluZyg3KX1gLFxuICAgICAgYWN0aW9uOiAncHVibGljX2RldmljZV92aWV3JyxcbiAgICAgIHNlcmlhbF9udW1iZXI6IHNlcmlhbE51bWJlcixcbiAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgIHJlc3VsdDogc3VjY2VzcyA/ICdzdWNjZXNzJyA6ICdub3RfZm91bmQnLFxuICAgICAgc291cmNlX2lwOiBzb3VyY2VJcCxcbiAgICAgIHVzZXJfYWdlbnQ6IHVzZXJBZ2VudCxcbiAgICAgIHR0bDogTWF0aC5mbG9vcihEYXRlLm5vdygpIC8gMTAwMCkgKyA5MCAqIDI0ICogNjAgKiA2MCwgLy8gOTAgZGF5IFRUTFxuICAgIH07XG5cbiAgICBhd2FpdCBkb2NDbGllbnQuc2VuZChuZXcgUHV0Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IEFVRElUX1RBQkxFLFxuICAgICAgSXRlbTogYXVkaXRSZWNvcmQsXG4gICAgfSkpO1xuXG4gICAgY29uc29sZS5sb2coYEF1ZGl0OiBwdWJsaWNfZGV2aWNlX3ZpZXcgLSAke3N1Y2Nlc3MgPyAnc3VjY2VzcycgOiAnbm90X2ZvdW5kJ30gZm9yICR7c2VyaWFsTnVtYmVyfSBmcm9tICR7c291cmNlSXB9YCk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgLy8gQXVkaXQgbG9nZ2luZyBpcyBub24tY3JpdGljYWwsIGxvZyBidXQgZG9uJ3QgZmFpbCB0aGUgcmVxdWVzdFxuICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byB3cml0ZSBhdWRpdCBsb2c6JywgZXJyb3IpO1xuICB9XG59XG4iXX0=