"use strict";
/**
 * Telemetry API Lambda
 *
 * Queries DynamoDB for device telemetry data:
 * - GET /devices/{serial_number}/telemetry - Get telemetry history
 * - GET /devices/{serial_number}/location - Get location history
 * - GET /devices/{serial_number}/power - Get Mojo power history
 * - GET /devices/{serial_number}/health - Get health event history
 *
 * Note: When a Notecard is swapped, historical data is merged from all device_uids
 * associated with the serial_number.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const device_lookup_1 = require("../shared/device-lookup");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient);
const TELEMETRY_TABLE = process.env.TELEMETRY_TABLE;
const handler = async (event) => {
    console.log('Request:', JSON.stringify(event));
    const corsHeaders = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type,Authorization',
        'Access-Control-Allow-Methods': 'GET,OPTIONS',
    };
    try {
        // HTTP API v2 uses requestContext.http.method, REST API v1 uses httpMethod
        const method = event.requestContext?.http?.method || event.httpMethod;
        const path = event.requestContext?.http?.path || event.path;
        if (method === 'OPTIONS') {
            return { statusCode: 200, headers: corsHeaders, body: '' };
        }
        const serialNumber = event.pathParameters?.serial_number;
        if (!serialNumber) {
            return {
                statusCode: 400,
                headers: corsHeaders,
                body: JSON.stringify({ error: 'serial_number required' }),
            };
        }
        // Resolve serial_number to all associated device_uids
        const resolved = await (0, device_lookup_1.resolveDevice)(serialNumber);
        if (!resolved) {
            return {
                statusCode: 404,
                headers: corsHeaders,
                body: JSON.stringify({ error: 'Device not found' }),
            };
        }
        const queryParams = event.queryStringParameters || {};
        // Parse time range
        const hours = parseInt(queryParams.hours || '24');
        const limit = parseInt(queryParams.limit || '1000');
        // All queries now use all_device_uids to get merged history
        if (path.endsWith('/location')) {
            return await getLocationHistory(resolved.serial_number, resolved.all_device_uids, hours, limit, corsHeaders);
        }
        if (path.endsWith('/power')) {
            return await getPowerHistory(resolved.serial_number, resolved.all_device_uids, hours, limit, corsHeaders);
        }
        if (path.endsWith('/health')) {
            return await getHealthHistory(resolved.serial_number, resolved.all_device_uids, hours, limit, corsHeaders);
        }
        return await getTelemetryHistory(resolved.serial_number, resolved.all_device_uids, hours, limit, corsHeaders);
    }
    catch (error) {
        console.error('Error:', error);
        return {
            statusCode: 500,
            headers: corsHeaders,
            body: JSON.stringify({ error: 'Internal server error' }),
        };
    }
};
exports.handler = handler;
/**
 * Query telemetry for multiple device_uids and merge results
 */
async function queryForAllDeviceUids(deviceUids, dataType, cutoffTime, limit) {
    const cutoffKey = `${dataType}#${cutoffTime}`;
    const endKey = `${dataType}#${Date.now() + 1000}`;
    const fetchAll = limit > 1000;
    // Query all device_uids in parallel
    const queryPromises = deviceUids.map(async (deviceUid) => {
        let items = [];
        let lastEvaluatedKey;
        do {
            const command = new lib_dynamodb_1.QueryCommand({
                TableName: TELEMETRY_TABLE,
                IndexName: 'event-type-index',
                KeyConditionExpression: 'device_uid = :device_uid AND event_type_timestamp BETWEEN :start AND :end',
                ExpressionAttributeValues: {
                    ':device_uid': deviceUid,
                    ':start': cutoffKey,
                    ':end': endKey,
                },
                ScanIndexForward: true,
                ...(fetchAll ? {} : { Limit: limit }),
                ...(lastEvaluatedKey ? { ExclusiveStartKey: lastEvaluatedKey } : {}),
            });
            const result = await docClient.send(command);
            items = items.concat(result.Items || []);
            lastEvaluatedKey = result.LastEvaluatedKey;
            if (!fetchAll || items.length >= limit)
                break;
        } while (lastEvaluatedKey);
        return items;
    });
    const allResults = await Promise.all(queryPromises);
    // Merge all results and sort by timestamp
    const merged = allResults.flat().sort((a, b) => a.timestamp - b.timestamp);
    // Apply limit and reverse for newest-first
    return merged.slice(-limit).reverse();
}
async function getTelemetryHistory(serialNumber, deviceUids, hours, limit, headers) {
    const cutoffTime = Date.now() - (hours * 60 * 60 * 1000);
    const items = await queryForAllDeviceUids(deviceUids, 'telemetry', cutoffTime, limit);
    // Transform to API response format
    // Note: voltage is no longer included in track.qo telemetry; battery info comes from power API
    const telemetry = items.map((item) => ({
        time: new Date(item.timestamp).toISOString(),
        temperature: item.temperature,
        humidity: item.humidity,
        pressure: item.pressure,
        motion: item.motion,
    }));
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
            serial_number: serialNumber,
            hours,
            count: telemetry.length,
            telemetry,
        }),
    };
}
async function getLocationHistory(serialNumber, deviceUids, hours, limit, headers) {
    const cutoffTime = Date.now() - (hours * 60 * 60 * 1000);
    const items = await queryForAllDeviceUids(deviceUids, 'telemetry', cutoffTime, limit);
    // Transform to API response format - filter to only items with location
    const locations = items
        .filter((item) => item.latitude !== undefined && item.longitude !== undefined)
        .map((item) => ({
        time: new Date(item.timestamp).toISOString(),
        lat: item.latitude,
        lon: item.longitude,
        source: item.location_source,
    }));
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
            serial_number: serialNumber,
            hours,
            count: locations.length,
            locations,
        }),
    };
}
async function getPowerHistory(serialNumber, deviceUids, hours, limit, headers) {
    const cutoffTime = Date.now() - (hours * 60 * 60 * 1000);
    const items = await queryForAllDeviceUids(deviceUids, 'power', cutoffTime, limit);
    // Transform to API response format
    const power = items.map((item) => ({
        time: new Date(item.timestamp).toISOString(),
        voltage: item.mojo_voltage,
        milliamp_hours: item.milliamp_hours,
    }));
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
            serial_number: serialNumber,
            hours,
            count: power.length,
            power,
        }),
    };
}
async function getHealthHistory(serialNumber, deviceUids, hours, limit, headers) {
    const cutoffTime = Date.now() - (hours * 60 * 60 * 1000);
    const items = await queryForAllDeviceUids(deviceUids, 'health', cutoffTime, limit);
    // Transform to API response format
    const health = items.map((item) => ({
        time: new Date(item.timestamp).toISOString(),
        method: item.method,
        text: item.text,
        voltage: item.voltage,
        voltage_mode: item.voltage_mode,
        milliamp_hours: item.milliamp_hours,
    }));
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
            serial_number: serialNumber,
            hours,
            count: health.length,
            health,
        }),
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvYXBpLXRlbGVtZXRyeS9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7O0dBV0c7OztBQUVILDhEQUEwRDtBQUMxRCx3REFBNkU7QUFFN0UsMkRBQXdEO0FBRXhELE1BQU0sU0FBUyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN6QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7QUFFekQsTUFBTSxlQUFlLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFnQixDQUFDO0FBRTlDLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFBRSxLQUEyQixFQUFrQyxFQUFFO0lBQzNGLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUUvQyxNQUFNLFdBQVcsR0FBRztRQUNsQiw2QkFBNkIsRUFBRSxHQUFHO1FBQ2xDLDhCQUE4QixFQUFFLDRCQUE0QjtRQUM1RCw4QkFBOEIsRUFBRSxhQUFhO0tBQzlDLENBQUM7SUFFRixJQUFJLENBQUM7UUFDSCwyRUFBMkU7UUFDM0UsTUFBTSxNQUFNLEdBQUksS0FBSyxDQUFDLGNBQXNCLEVBQUUsSUFBSSxFQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsVUFBVSxDQUFDO1FBQy9FLE1BQU0sSUFBSSxHQUFJLEtBQUssQ0FBQyxjQUFzQixFQUFFLElBQUksRUFBRSxJQUFJLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQztRQUVyRSxJQUFJLE1BQU0sS0FBSyxTQUFTLEVBQUUsQ0FBQztZQUN6QixPQUFPLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsQ0FBQztRQUM3RCxDQUFDO1FBRUQsTUFB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QyxDQUFDO0lBRW5GLG1DQUFtQztJQUNuQyxNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQ2xDLElBQUksRUFBRSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsV0FBVyxFQUFFO1FBQzVDLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTTtRQUNuQixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7UUFDZixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87UUFDckIsWUFBWSxFQUFFLElBQUksQ0FBQyxZQUFZO1FBQy9CLGNBQWMsRUFBRSxJQUFJLENBQUMsY0FBYztLQUNwQyxDQUFDLENBQUMsQ0FBQztJQUVKLE9BQU87UUFDTCxVQUFVLEVBQUUsR0FBRztRQUNmLE9BQU87UUFDUCxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQztZQUNuQixhQUFhLEVBQUUsWUFBWTtZQUMzQixLQUFLO1lBQ0wsS0FBSyxFQUFFLE1BQU0sQ0FBQyxNQUFNO1lBQ3BCLE1BQU07U0FDUCxDQUFDO0tBQ0gsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFRlbGVtZXRyeSBBUEkgTGFtYmRhXG4gKlxuICogUXVlcmllcyBEeW5hbW9EQiBmb3IgZGV2aWNlIHRlbGVtZXRyeSBkYXRhOlxuICogLSBHRVQgL2RldmljZXMve3NlcmlhbF9udW1iZXJ9L3RlbGVtZXRyeSAtIEdldCB0ZWxlbWV0cnkgaGlzdG9yeVxuICogLSBHRVQgL2RldmljZXMve3NlcmlhbF9udW1iZXJ9L2xvY2F0aW9uIC0gR2V0IGxvY2F0aW9uIGhpc3RvcnlcbiAqIC0gR0VUIC9kZXZpY2VzL3tzZXJpYWxfbnVtYmVyfS9wb3dlciAtIEdldCBNb2pvIHBvd2VyIGhpc3RvcnlcbiAqIC0gR0VUIC9kZXZpY2VzL3tzZXJpYWxfbnVtYmVyfS9oZWFsdGggLSBHZXQgaGVhbHRoIGV2ZW50IGhpc3RvcnlcbiAqXG4gKiBOb3RlOiBXaGVuIGEgTm90ZWNhcmQgaXMgc3dhcHBlZCwgaGlzdG9yaWNhbCBkYXRhIGlzIG1lcmdlZCBmcm9tIGFsbCBkZXZpY2VfdWlkc1xuICogYXNzb2NpYXRlZCB3aXRoIHRoZSBzZXJpYWxfbnVtYmVyLlxuICovXG5cbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIFF1ZXJ5Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCwgQVBJR2F0ZXdheVByb3h5UmVzdWx0IH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyByZXNvbHZlRGV2aWNlIH0gZnJvbSAnLi4vc2hhcmVkL2RldmljZS1sb29rdXAnO1xuXG5jb25zdCBkZGJDbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGRkYkNsaWVudCk7XG5cbmNvbnN0IFRFTEVNRVRSWV9UQUJMRSA9IHByb2Nlc3MuZW52LlRFTEVNRVRSWV9UQUJMRSE7XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCk6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiA9PiB7XG4gIGNvbnNvbGUubG9nKCdSZXF1ZXN0OicsIEpTT04uc3RyaW5naWZ5KGV2ZW50KSk7XG5cbiAgY29uc3QgY29yc0hlYWRlcnMgPSB7XG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVycyc6ICdDb250ZW50LVR5cGUsQXV0aG9yaXphdGlvbicsXG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU1ldGhvZHMnOiAnR0VULE9QVElPTlMnLFxuICB9O1xuXG4gIHRyeSB7XG4gICAgLy8gSFRUUCBBUEkgdjIgdXNlcyByZXF1ZXN0Q29udGV4dC5odHRwLm1ldGhvZCwgUkVTVCBBUEkgdjEgdXNlcyBodHRwTWV0aG9kXG4gICAgY29uc3QgbWV0aG9kID0gKGV2ZW50LnJlcXVlc3RDb250ZXh0IGFzIGFueSk/Lmh0dHA/Lm1ldGhvZCB8fCBldmVudC5odHRwTWV0aG9kO1xuICAgIGNvbnN0IHBhdGggPSAoZXZlbnQucmVxdWVzdENvbnRleHQgYXMgYW55KT8uaHR0cD8ucGF0aCB8fCBldmVudC5wYXRoO1xuXG4gICAgaWYgKG1ldGhvZCA9PT0gJ09QVElPTlMnKSB7XG4gICAgICByZXR1cm4geyBzdGF0dXNDb2RlOiAyMDAsIGhlYWRlcnM6IGNvcnNIZWFkZXJzLCBib2R5OiAnJyB9O1xuICAgIH1cblxuICAgIGNvbnN0IHNlcmlhbE51bWJlciA9IGV2ZW50LnBhdGhQYXJhbWV0ZXJzPy5zZXJpYWxfbnVtYmVyO1xuICAgIGlmICghc2VyaWFsTnVtYmVyKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXNDb2RlOiA0MDAsXG4gICAgICAgIGhlYWRlcnM6IGNvcnNIZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnc2VyaWFsX251bWJlciByZXF1aXJlZCcgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIFJlc29sdmUgc2VyaWFsX251bWJlciB0byBhbGwgYXNzb2NpYXRlZCBkZXZpY2VfdWlkc1xuICAgIGNvbnN0IHJlc29sdmVkID0gYXdhaXQgcmVzb2x2ZURldmljZShzZXJpYWxOdW1iZXIpO1xuICAgIGlmICghcmVzb2x2ZWQpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDQwNCxcbiAgICAgICAgaGVhZGVyczogY29yc0hlYWRlcnMsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdEZXZpY2Ugbm90IGZvdW5kJyB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3QgcXVlcnlQYXJhbXMgPSBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnMgfHwge307XG5cbiAgICAvLyBQYXJzZSB0aW1lIHJhbmdlXG4gICAgY29uc3QgaG91cnMgPSBwYXJzZUludChxdWVyeVBhcmFtcy5ob3VycyB8fCAnMjQnKTtcbiAgICBjb25zdCBsaW1pdCA9IHBhcnNlSW50KHF1ZXJ5UGFyYW1zLmxpbWl0IHx8ICcxMDAwJyk7XG5cbiAgICAvLyBBbGwgcXVlcmllcyBub3cgdXNlIGFsbF9kZXZpY2VfdWlkcyB0byBnZXQgbWVyZ2VkIGhpc3RvcnlcbiAgICBpZiAocGF0aC5lbmRzV2l0aCgnL2xvY2F0aW9uJykpIHtcbiAgICAgIHJldHVybiBhd2FpdCBnZXRMb2NhdGlvbkhpc3RvcnkocmVzb2x2ZWQuc2VyaWFsX251bWJlciwgcmVzb2x2ZWQuYWxsX2RldmljZV91aWRzLCBob3VycywgbGltaXQsIGNvcnNIZWFkZXJzKTtcbiAgICB9XG5cbiAgICBpZiAocGF0aC5lbmRzV2l0aCgnL3Bvd2VyJykpIHtcbiAgICAgIHJldHVybiBhd2FpdCBnZXRQb3dlckhpc3RvcnkocmVzb2x2ZWQuc2VyaWFsX251bWJlciwgcmVzb2x2ZWQuYWxsX2RldmljZV91aWRzLCBob3VycywgbGltaXQsIGNvcnNIZWFkZXJzKTtcbiAgICB9XG5cbiAgICBpZiAocGF0aC5lbmRzV2l0aCgnL2hlYWx0aCcpKSB7XG4gICAgICByZXR1cm4gYXdhaXQgZ2V0SGVhbHRoSGlzdG9yeShyZXNvbHZlZC5zZXJpYWxfbnVtYmVyLCByZXNvbHZlZC5hbGxfZGV2aWNlX3VpZHMsIGhvdXJzLCBsaW1pdCwgY29yc0hlYWRlcnMpO1xuICAgIH1cblxuICAgIHJldHVybiBhd2FpdCBnZXRUZWxlbWV0cnlIaXN0b3J5KHJlc29sdmVkLnNlcmlhbF9udW1iZXIsIHJlc29sdmVkLmFsbF9kZXZpY2VfdWlkcywgaG91cnMsIGxpbWl0LCBjb3JzSGVhZGVycyk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3I6JywgZXJyb3IpO1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA1MDAsXG4gICAgICBoZWFkZXJzOiBjb3JzSGVhZGVycyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InIH0pLFxuICAgIH07XG4gIH1cbn07XG5cbi8qKlxuICogUXVlcnkgdGVsZW1ldHJ5IGZvciBtdWx0aXBsZSBkZXZpY2VfdWlkcyBhbmQgbWVyZ2UgcmVzdWx0c1xuICovXG5hc3luYyBmdW5jdGlvbiBxdWVyeUZvckFsbERldmljZVVpZHMoXG4gIGRldmljZVVpZHM6IHN0cmluZ1tdLFxuICBkYXRhVHlwZTogc3RyaW5nLFxuICBjdXRvZmZUaW1lOiBudW1iZXIsXG4gIGxpbWl0OiBudW1iZXJcbik6IFByb21pc2U8UmVjb3JkPHN0cmluZywgYW55PltdPiB7XG4gIGNvbnN0IGN1dG9mZktleSA9IGAke2RhdGFUeXBlfSMke2N1dG9mZlRpbWV9YDtcbiAgY29uc3QgZW5kS2V5ID0gYCR7ZGF0YVR5cGV9IyR7RGF0ZS5ub3coKSArIDEwMDB9YDtcbiAgY29uc3QgZmV0Y2hBbGwgPSBsaW1pdCA+IDEwMDA7XG5cbiAgLy8gUXVlcnkgYWxsIGRldmljZV91aWRzIGluIHBhcmFsbGVsXG4gIGNvbnN0IHF1ZXJ5UHJvbWlzZXMgPSBkZXZpY2VVaWRzLm1hcChhc3luYyAoZGV2aWNlVWlkKSA9PiB7XG4gICAgbGV0IGl0ZW1zOiBSZWNvcmQ8c3RyaW5nLCBhbnk+W10gPSBbXTtcbiAgICBsZXQgbGFzdEV2YWx1YXRlZEtleTogUmVjb3JkPHN0cmluZywgYW55PiB8IHVuZGVmaW5lZDtcblxuICAgIGRvIHtcbiAgICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBURUxFTUVUUllfVEFCTEUsXG4gICAgICAgIEluZGV4TmFtZTogJ2V2ZW50LXR5cGUtaW5kZXgnLFxuICAgICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnZGV2aWNlX3VpZCA9IDpkZXZpY2VfdWlkIEFORCBldmVudF90eXBlX3RpbWVzdGFtcCBCRVRXRUVOIDpzdGFydCBBTkQgOmVuZCcsXG4gICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgICAnOmRldmljZV91aWQnOiBkZXZpY2VVaWQsXG4gICAgICAgICAgJzpzdGFydCc6IGN1dG9mZktleSxcbiAgICAgICAgICAnOmVuZCc6IGVuZEtleSxcbiAgICAgICAgfSxcbiAgICAgICAgU2NhbkluZGV4Rm9yd2FyZDogdHJ1ZSxcbiAgICAgICAgLi4uKGZldGNoQWxsID8ge30gOiB7IExpbWl0OiBsaW1pdCB9KSxcbiAgICAgICAgLi4uKGxhc3RFdmFsdWF0ZWRLZXkgPyB7IEV4Y2x1c2l2ZVN0YXJ0S2V5OiBsYXN0RXZhbHVhdGVkS2V5IH0gOiB7fSksXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgICBpdGVtcyA9IGl0ZW1zLmNvbmNhdChyZXN1bHQuSXRlbXMgfHwgW10pO1xuICAgICAgbGFzdEV2YWx1YXRlZEtleSA9IHJlc3VsdC5MYXN0RXZhbHVhdGVkS2V5O1xuXG4gICAgICBpZiAoIWZldGNoQWxsIHx8IGl0ZW1zLmxlbmd0aCA+PSBsaW1pdCkgYnJlYWs7XG4gICAgfSB3aGlsZSAobGFzdEV2YWx1YXRlZEtleSk7XG5cbiAgICByZXR1cm4gaXRlbXM7XG4gIH0pO1xuXG4gIGNvbnN0IGFsbFJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbChxdWVyeVByb21pc2VzKTtcblxuICAvLyBNZXJnZSBhbGwgcmVzdWx0cyBhbmQgc29ydCBieSB0aW1lc3RhbXBcbiAgY29uc3QgbWVyZ2VkID0gYWxsUmVzdWx0cy5mbGF0KCkuc29ydCgoYSwgYikgPT4gYS50aW1lc3RhbXAgLSBiLnRpbWVzdGFtcCk7XG5cbiAgLy8gQXBwbHkgbGltaXQgYW5kIHJldmVyc2UgZm9yIG5ld2VzdC1maXJzdFxuICByZXR1cm4gbWVyZ2VkLnNsaWNlKC1saW1pdCkucmV2ZXJzZSgpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRUZWxlbWV0cnlIaXN0b3J5KFxuICBzZXJpYWxOdW1iZXI6IHN0cmluZyxcbiAgZGV2aWNlVWlkczogc3RyaW5nW10sXG4gIGhvdXJzOiBudW1iZXIsXG4gIGxpbWl0OiBudW1iZXIsXG4gIGhlYWRlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XG4gIGNvbnN0IGN1dG9mZlRpbWUgPSBEYXRlLm5vdygpIC0gKGhvdXJzICogNjAgKiA2MCAqIDEwMDApO1xuXG4gIGNvbnN0IGl0ZW1zID0gYXdhaXQgcXVlcnlGb3JBbGxEZXZpY2VVaWRzKGRldmljZVVpZHMsICd0ZWxlbWV0cnknLCBjdXRvZmZUaW1lLCBsaW1pdCk7XG5cbiAgLy8gVHJhbnNmb3JtIHRvIEFQSSByZXNwb25zZSBmb3JtYXRcbiAgLy8gTm90ZTogdm9sdGFnZSBpcyBubyBsb25nZXIgaW5jbHVkZWQgaW4gdHJhY2sucW8gdGVsZW1ldHJ5OyBiYXR0ZXJ5IGluZm8gY29tZXMgZnJvbSBwb3dlciBBUElcbiAgY29uc3QgdGVsZW1ldHJ5ID0gaXRlbXMubWFwKChpdGVtKSA9PiAoe1xuICAgIHRpbWU6IG5ldyBEYXRlKGl0ZW0udGltZXN0YW1wKS50b0lTT1N0cmluZygpLFxuICAgIHRlbXBlcmF0dXJlOiBpdGVtLnRlbXBlcmF0dXJlLFxuICAgIGh1bWlkaXR5OiBpdGVtLmh1bWlkaXR5LFxuICAgIHByZXNzdXJlOiBpdGVtLnByZXNzdXJlLFxuICAgIG1vdGlvbjogaXRlbS5tb3Rpb24sXG4gIH0pKTtcblxuICByZXR1cm4ge1xuICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICBoZWFkZXJzLFxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIHNlcmlhbF9udW1iZXI6IHNlcmlhbE51bWJlcixcbiAgICAgIGhvdXJzLFxuICAgICAgY291bnQ6IHRlbGVtZXRyeS5sZW5ndGgsXG4gICAgICB0ZWxlbWV0cnksXG4gICAgfSksXG4gIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldExvY2F0aW9uSGlzdG9yeShcbiAgc2VyaWFsTnVtYmVyOiBzdHJpbmcsXG4gIGRldmljZVVpZHM6IHN0cmluZ1tdLFxuICBob3VyczogbnVtYmVyLFxuICBsaW1pdDogbnVtYmVyLFxuICBoZWFkZXJzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+XG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4ge1xuICBjb25zdCBjdXRvZmZUaW1lID0gRGF0ZS5ub3coKSAtIChob3VycyAqIDYwICogNjAgKiAxMDAwKTtcblxuICBjb25zdCBpdGVtcyA9IGF3YWl0IHF1ZXJ5Rm9yQWxsRGV2aWNlVWlkcyhkZXZpY2VVaWRzLCAndGVsZW1ldHJ5JywgY3V0b2ZmVGltZSwgbGltaXQpO1xuXG4gIC8vIFRyYW5zZm9ybSB0byBBUEkgcmVzcG9uc2UgZm9ybWF0IC0gZmlsdGVyIHRvIG9ubHkgaXRlbXMgd2l0aCBsb2NhdGlvblxuICBjb25zdCBsb2NhdGlvbnMgPSBpdGVtc1xuICAgIC5maWx0ZXIoKGl0ZW0pID0+IGl0ZW0ubGF0aXR1ZGUgIT09IHVuZGVmaW5lZCAmJiBpdGVtLmxvbmdpdHVkZSAhPT0gdW5kZWZpbmVkKVxuICAgIC5tYXAoKGl0ZW0pID0+ICh7XG4gICAgICB0aW1lOiBuZXcgRGF0ZShpdGVtLnRpbWVzdGFtcCkudG9JU09TdHJpbmcoKSxcbiAgICAgIGxhdDogaXRlbS5sYXRpdHVkZSxcbiAgICAgIGxvbjogaXRlbS5sb25naXR1ZGUsXG4gICAgICBzb3VyY2U6IGl0ZW0ubG9jYXRpb25fc291cmNlLFxuICAgIH0pKTtcblxuICByZXR1cm4ge1xuICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICBoZWFkZXJzLFxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIHNlcmlhbF9udW1iZXI6IHNlcmlhbE51bWJlcixcbiAgICAgIGhvdXJzLFxuICAgICAgY291bnQ6IGxvY2F0aW9ucy5sZW5ndGgsXG4gICAgICBsb2NhdGlvbnMsXG4gICAgfSksXG4gIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFBvd2VySGlzdG9yeShcbiAgc2VyaWFsTnVtYmVyOiBzdHJpbmcsXG4gIGRldmljZVVpZHM6IHN0cmluZ1tdLFxuICBob3VyczogbnVtYmVyLFxuICBsaW1pdDogbnVtYmVyLFxuICBoZWFkZXJzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+XG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4ge1xuICBjb25zdCBjdXRvZmZUaW1lID0gRGF0ZS5ub3coKSAtIChob3VycyAqIDYwICogNjAgKiAxMDAwKTtcblxuICBjb25zdCBpdGVtcyA9IGF3YWl0IHF1ZXJ5Rm9yQWxsRGV2aWNlVWlkcyhkZXZpY2VVaWRzLCAncG93ZXInLCBjdXRvZmZUaW1lLCBsaW1pdCk7XG5cbiAgLy8gVHJhbnNmb3JtIHRvIEFQSSByZXNwb25zZSBmb3JtYXRcbiAgY29uc3QgcG93ZXIgPSBpdGVtcy5tYXAoKGl0ZW0pID0+ICh7XG4gICAgdGltZTogbmV3IERhdGUoaXRlbS50aW1lc3RhbXApLnRvSVNPU3RyaW5nKCksXG4gICAgdm9sdGFnZTogaXRlbS5tb2pvX3ZvbHRhZ2UsXG4gICAgbWlsbGlhbXBfaG91cnM6IGl0ZW0ubWlsbGlhbXBfaG91cnMsXG4gIH0pKTtcblxuICByZXR1cm4ge1xuICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICBoZWFkZXJzLFxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIHNlcmlhbF9udW1iZXI6IHNlcmlhbE51bWJlcixcbiAgICAgIGhvdXJzLFxuICAgICAgY291bnQ6IHBvd2VyLmxlbmd0aCxcbiAgICAgIHBvd2VyLFxuICAgIH0pLFxuICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRIZWFsdGhIaXN0b3J5KFxuICBzZXJpYWxOdW1iZXI6IHN0cmluZyxcbiAgZGV2aWNlVWlkczogc3RyaW5nW10sXG4gIGhvdXJzOiBudW1iZXIsXG4gIGxpbWl0OiBudW1iZXIsXG4gIGhlYWRlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XG4gIGNvbnN0IGN1dG9mZlRpbWUgPSBEYXRlLm5vdygpIC0gKGhvdXJzICogNjAgKiA2MCAqIDEwMDApO1xuXG4gIGNvbnN0IGl0ZW1zID0gYXdhaXQgcXVlcnlGb3JBbGxEZXZpY2VVaWRzKGRldmljZVVpZHMsICdoZWFsdGgnLCBjdXRvZmZUaW1lLCBsaW1pdCk7XG5cbiAgLy8gVHJhbnNmb3JtIHRvIEFQSSByZXNwb25zZSBmb3JtYXRcbiAgY29uc3QgaGVhbHRoID0gaXRlbXMubWFwKChpdGVtKSA9PiAoe1xuICAgIHRpbWU6IG5ldyBEYXRlKGl0ZW0udGltZXN0YW1wKS50b0lTT1N0cmluZygpLFxuICAgIG1ldGhvZDogaXRlbS5tZXRob2QsXG4gICAgdGV4dDogaXRlbS50ZXh0LFxuICAgIHZvbHRhZ2U6IGl0ZW0udm9sdGFnZSxcbiAgICB2b2x0YWdlX21vZGU6IGl0ZW0udm9sdGFnZV9tb2RlLFxuICAgIG1pbGxpYW1wX2hvdXJzOiBpdGVtLm1pbGxpYW1wX2hvdXJzLFxuICB9KSk7XG5cbiAgcmV0dXJuIHtcbiAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgaGVhZGVycyxcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICBzZXJpYWxfbnVtYmVyOiBzZXJpYWxOdW1iZXIsXG4gICAgICBob3VycyxcbiAgICAgIGNvdW50OiBoZWFsdGgubGVuZ3RoLFxuICAgICAgaGVhbHRoLFxuICAgIH0pLFxuICB9O1xufVxuIl19