"use strict";
/**
 * API Settings Lambda
 *
 * Handles fleet defaults settings CRUD operations.
 * Admin-only endpoints are protected by checking JWT cognito:groups claim.
 *
 * Fleet defaults are saved to:
 * 1. DynamoDB (for dashboard UI)
 * 2. Notehub fleet environment variables (so devices receive the config)
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_secrets_manager_1 = require("@aws-sdk/client-secrets-manager");
const client = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(client);
const secretsClient = new client_secrets_manager_1.SecretsManagerClient({});
const SETTINGS_TABLE = process.env.SETTINGS_TABLE || 'songbird-settings';
const NOTEHUB_PROJECT_UID = process.env.NOTEHUB_PROJECT_UID;
const NOTEHUB_SECRET_ARN = process.env.NOTEHUB_SECRET_ARN;
// Cache the Notehub token
let cachedNotehubToken = null;
async function getNotehubToken() {
    if (!NOTEHUB_SECRET_ARN) {
        console.warn('NOTEHUB_SECRET_ARN not configured');
        return null;
    }
    if (cachedNotehubToken) {
        return cachedNotehubToken;
    }
    try {
        const command = new client_secrets_manager_1.GetSecretValueCommand({ SecretId: NOTEHUB_SECRET_ARN });
        const response = await secretsClient.send(command);
        if (!response.SecretString) {
            console.error('Notehub API token not found in secret');
            return null;
        }
        const secret = JSON.parse(response.SecretString);
        cachedNotehubToken = secret.token;
        return cachedNotehubToken;
    }
    catch (error) {
        console.error('Error fetching Notehub token:', error);
        return null;
    }
}
const headers = {
    'Content-Type': 'application/json',
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type,Authorization',
    'Access-Control-Allow-Methods': 'GET,PUT,OPTIONS',
};
// Validation schema for fleet defaults
const fleetDefaultsSchema = {
    mode: { type: 'string', values: ['demo', 'transit', 'storage', 'sleep'] },
    gps_interval_min: { type: 'number', min: 1, max: 1440 },
    sync_interval_min: { type: 'number', min: 1, max: 1440 },
    heartbeat_hours: { type: 'number', min: 1, max: 168 },
    temp_alert_high_c: { type: 'number', min: -40, max: 85 },
    temp_alert_low_c: { type: 'number', min: -40, max: 85 },
    humidity_alert_high: { type: 'number', min: 0, max: 100 },
    humidity_alert_low: { type: 'number', min: 0, max: 100 },
    voltage_alert_low: { type: 'number', min: 3.0, max: 4.2 },
    motion_sensitivity: { type: 'string', values: ['low', 'medium', 'high'] },
    audio_enabled: { type: 'boolean' },
    led_enabled: { type: 'boolean' },
};
function isAdmin(event) {
    try {
        const claims = event.requestContext?.authorizer?.jwt?.claims;
        if (!claims)
            return false;
        // cognito:groups is either a string or array depending on number of groups
        const groups = claims['cognito:groups'];
        if (Array.isArray(groups)) {
            return groups.includes('Admin');
        }
        if (typeof groups === 'string') {
            return groups === 'Admin' || groups.includes('Admin');
        }
        return false;
    }
    catch {
        return false;
    }
}
/**
 * Push fleet defaults to Notehub as fleet environment variables
 * This makes the config available to all devices in the fleet
 */
async function pushToNotehub(fleetUid, config) {
    if (!NOTEHUB_PROJECT_UID) {
        console.warn('NOTEHUB_PROJECT_UID not configured, skipping Notehub push');
        return { success: false, error: 'Notehub not configured' };
    }
    const token = await getNotehubToken();
    if (!token) {
        return { success: false, error: 'Could not get Notehub token' };
    }
    // Convert config values to strings for Notehub environment variables
    const envVars = {};
    for (const [key, value] of Object.entries(config)) {
        if (value !== undefined && value !== null) {
            envVars[key] = String(value);
        }
    }
    try {
        const response = await fetch(`https://api.notefile.net/v1/projects/${NOTEHUB_PROJECT_UID}/fleets/${fleetUid}/environment_variables`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ environment_variables: envVars }),
        });
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Notehub API error:', response.status, errorText);
            return { success: false, error: `Notehub API error: ${response.status}` };
        }
        console.log(`Successfully pushed fleet defaults to Notehub for fleet ${fleetUid}`);
        return { success: true };
    }
    catch (error) {
        console.error('Error pushing to Notehub:', error);
        return { success: false, error: String(error) };
    }
}
function validateFleetDefaults(config) {
    const errors = [];
    for (const [key, value] of Object.entries(config)) {
        const schema = fleetDefaultsSchema[key];
        if (!schema) {
            errors.push(`Unknown setting: ${key}`);
            continue;
        }
        if (schema.type === 'number') {
            if (typeof value !== 'number') {
                errors.push(`${key} must be a number`);
                continue;
            }
            if (schema.min !== undefined && value < schema.min) {
                errors.push(`${key} must be at least ${schema.min}`);
            }
            if (schema.max !== undefined && value > schema.max) {
                errors.push(`${key} must be at most ${schema.max}`);
            }
        }
        else if (schema.type === 'string') {
            if (typeof value !== 'string') {
                errors.push(`${key} must be a string`);
                continue;
            }
            if (schema.values && !schema.values.includes(value)) {
                errors.push(`${key} must be one of: ${schema.values.join(', ')}`);
            }
        }
        else if (schema.type === 'boolean') {
            if (typeof value !== 'boolean') {
                errors.push(`${key} must be a boolean`);
            }
        }
    }
    return { valid: errors.length === 0, errors };
}
async function handler(event) {
    console.log('Event:', JSON.stringify(event, null, 2));
    const method = event.requestContext.http.method;
    const path = event.rawPath;
    // Handle OPTIONS for CORS
    if (method === 'OPTIONS') {
        return { statusCode: 200, headers, body: '' };
    }
    try {
        // GET /v1/settings/fleet-defaults - List all fleet defaults (admin only)
        if (method === 'GET' && path === '/v1/settings/fleet-defaults') {
            if (!isAdmin(event)) {
                return {
                    statusCode: 403,
                    headers,
                    body: JSON.stringify({ error: 'Admin access required' }),
                };
            }
            const result = await docClient.send(new lib_dynamodb_1.QueryCommand({
                TableName: SETTINGS_TABLE,
                KeyConditionExpression: 'setting_type = :type',
                ExpressionAttributeValues: {
                    ':type': 'fleet_defaults',
                },
            }));
            const fleetDefaults = (result.Items || []).map((item) => ({
                fleet_uid: item.setting_id,
                ...(item.config || {}),
                updated_at: item.updated_at,
                updated_by: item.updated_by,
            }));
            return {
                statusCode: 200,
                headers,
                body: JSON.stringify({ fleet_defaults: fleetDefaults }),
            };
        }
        // GET /v1/settings/fleet-defaults/{fleet} - Get specific fleet defaults
        if (method === 'GET' && path.startsWith('/v1/settings/fleet-defaults/')) {
            const fleetUid = event.pathParameters?.fleet;
            if (!fleetUid) {
                return {
                    statusCode: 400,
                    headers,
                    body: JSON.stringify({ error: 'Fleet UID required' }),
                };
            }
            const result = await docClient.send(new lib_dynamodb_1.GetCommand({
                TableName: SETTINGS_TABLE,
                Key: {
                    setting_type: 'fleet_defaults',
                    setting_id: fleetUid,
                },
            }));
            if (!result.Item) {
                // Return empty defaults if none set
                return {
                    statusCode: 200,
                    headers,
                    body: JSON.stringify({
                        fleet_uid: fleetUid,
                        config: {},
                        schema: fleetDefaultsSchema,
                    }),
                };
            }
            return {
                statusCode: 200,
                headers,
                body: JSON.stringify({
                    fleet_uid: fleetUid,
                    config: result.Item.config || {},
                    schema: fleetDefaultsSchema,
                    updated_at: result.Item.updated_at,
                    updated_by: result.Item.updated_by,
                }),
            };
        }
        // PUT /v1/settings/fleet-defaults/{fleet} - Update fleet defaults (admin only)
        if (method === 'PUT' && path.startsWith('/v1/settings/fleet-defaults/')) {
            if (!isAdmin(event)) {
                return {
                    statusCode: 403,
                    headers,
                    body: JSON.stringify({ error: 'Admin access required' }),
                };
            }
            const fleetUid = event.pathParameters?.fleet;
            if (!fleetUid) {
                return {
                    statusCode: 400,
                    headers,
                    body: JSON.stringify({ error: 'Fleet UID required' }),
                };
            }
            let config;
            try {
                config = JSON.parse(event.body || '{}');
            }
            catch {
                return {
                    statusCode: 400,
                    headers,
                    body: JSON.stringify({ error: 'Invalid JSON body' }),
                };
            }
            // Validate config
            const validation = validateFleetDefaults(config);
            if (!validation.valid) {
                return {
                    statusCode: 400,
                    headers,
                    body: JSON.stringify({ error: 'Validation failed', details: validation.errors }),
                };
            }
            // Get user info from JWT claims
            const claims = event.requestContext?.authorizer?.jwt?.claims;
            const userEmail = claims?.email || claims?.sub || 'unknown';
            // Store settings in DynamoDB (for dashboard UI)
            await docClient.send(new lib_dynamodb_1.PutCommand({
                TableName: SETTINGS_TABLE,
                Item: {
                    setting_type: 'fleet_defaults',
                    setting_id: fleetUid,
                    config,
                    updated_at: Date.now(),
                    updated_by: userEmail,
                },
            }));
            // Push to Notehub as fleet environment variables (so devices receive the config)
            const notehubResult = await pushToNotehub(fleetUid, config);
            return {
                statusCode: 200,
                headers,
                body: JSON.stringify({
                    fleet_uid: fleetUid,
                    config,
                    updated_at: Date.now(),
                    updated_by: userEmail,
                    notehub_sync: notehubResult.success,
                    notehub_error: notehubResult.error,
                }),
            };
        }
        return {
            statusCode: 404,
            headers,
            body: JSON.stringify({ error: 'Not found' }),
        };
    }
    catch (error) {
        console.error('Error:', error);
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Internal server error' }),
        };
    }
}
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvYXBpLXNldHRpbmdzL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7O0dBU0c7OztBQUVILDhEQUEwRDtBQUMxRCx3REFBcUc7QUFDckcsNEVBQThGO0FBRzlGLE1BQU0sTUFBTSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN0QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDdEQsTUFBTSxhQUFhLEdBQUcsSUFBSSw2Q0FBb0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUVuRCxNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSxtQkFBbUIsQ0FBQztBQUN6RSxNQUFNLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUM7QUFDNUQsTUFBTSxrQkFBa0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDO0FBRTFELDBCQUEwQjtBQUMxQixJQUFJLGtCQUFrQixHQUFrQixJQUFJLENBQUM7QUFFN0MsS0FBSyxVQUFVLGVBQWU7SUFDNUIsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFDeEIsT0FBTyxDQUFDLElBQUksQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDO1FBQ2xELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELElBQUksa0JBQWtCLEVBQUUsQ0FBQztRQUN2QixPQUFPLGtCQUFrQixDQUFDO0lBQzVCLENBQUM7SUFFRCxJQUFJLENBQUM7UUFDSCxNQUFNLE9BQU8sR0FBRyxJQUFJLDhDQUFxQixDQUFDLEVBQUUsUUFBUSxFQUFFLGtCQUFrQixFQUFFLENBQUMsQ0FBQztRQUM1RSxNQUFNLFFBQVEsR0FBRyxNQUFNLGFBQWEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENB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TCxVQUFVLEVBQUUsR0FBRztZQUNmLE9BQU87WUFDUCxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLEtBQUssRUFBRSx1QkFBdUIsRUFBRSxDQUFDO1NBQ3pELENBQUM7SUFDSixDQUFDO0FBQ0gsQ0FBQztBQS9LRCwwQkErS0MiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEFQSSBTZXR0aW5ncyBMYW1iZGFcbiAqXG4gKiBIYW5kbGVzIGZsZWV0IGRlZmF1bHRzIHNldHRpbmdzIENSVUQgb3BlcmF0aW9ucy5cbiAqIEFkbWluLW9ubHkgZW5kcG9pbnRzIGFyZSBwcm90ZWN0ZWQgYnkgY2hlY2tpbmcgSldUIGNvZ25pdG86Z3JvdXBzIGNsYWltLlxuICpcbiAqIEZsZWV0IGRlZmF1bHRzIGFyZSBzYXZlZCB0bzpcbiAqIDEuIER5bmFtb0RCIChmb3IgZGFzaGJvYXJkIFVJKVxuICogMi4gTm90ZWh1YiBmbGVldCBlbnZpcm9ubWVudCB2YXJpYWJsZXMgKHNvIGRldmljZXMgcmVjZWl2ZSB0aGUgY29uZmlnKVxuICovXG5cbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7IER5bmFtb0RCRG9jdW1lbnRDbGllbnQsIEdldENvbW1hbmQsIFB1dENvbW1hbmQsIFF1ZXJ5Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBTZWNyZXRzTWFuYWdlckNsaWVudCwgR2V0U2VjcmV0VmFsdWVDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXNlY3JldHMtbWFuYWdlcic7XG5pbXBvcnQgdHlwZSB7IEFQSUdhdGV3YXlQcm94eUV2ZW50VjJXaXRoSldUQXV0aG9yaXplciwgQVBJR2F0ZXdheVByb3h5UmVzdWx0VjIgfSBmcm9tICdhd3MtbGFtYmRhJztcblxuY29uc3QgY2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShjbGllbnQpO1xuY29uc3Qgc2VjcmV0c0NsaWVudCA9IG5ldyBTZWNyZXRzTWFuYWdlckNsaWVudCh7fSk7XG5cbmNvbnN0IFNFVFRJTkdTX1RBQkxFID0gcHJvY2Vzcy5lbnYuU0VUVElOR1NfVEFCTEUgfHwgJ3NvbmdiaXJkLXNldHRpbmdzJztcbmNvbnN0IE5PVEVIVUJfUFJPSkVDVF9VSUQgPSBwcm9jZXNzLmVudi5OT1RFSFVCX1BST0pFQ1RfVUlEO1xuY29uc3QgTk9URUhVQl9TRUNSRVRfQVJOID0gcHJvY2Vzcy5lbnYuTk9URUhVQl9TRUNSRVRfQVJOO1xuXG4vLyBDYWNoZSB0aGUgTm90ZWh1YiB0b2tlblxubGV0IGNhY2hlZE5vdGVodWJUb2tlbjogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG5cbmFzeW5jIGZ1bmN0aW9uIGdldE5vdGVodWJUb2tlbigpOiBQcm9taXNlPHN0cmluZyB8IG51bGw+IHtcbiAgaWYgKCFOT1RFSFVCX1NFQ1JFVF9BUk4pIHtcbiAgICBjb25zb2xlLndhcm4oJ05PVEVIVUJfU0VDUkVUX0FSTiBub3QgY29uZmlndXJlZCcpO1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgaWYgKGNhY2hlZE5vdGVodWJUb2tlbikge1xuICAgIHJldHVybiBjYWNoZWROb3RlaHViVG9rZW47XG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0U2VjcmV0VmFsdWVDb21tYW5kKHsgU2VjcmV0SWQ6IE5PVEVIVUJfU0VDUkVUX0FSTiB9KTtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHNlY3JldHNDbGllbnQuc2VuZChjb21tYW5kKTtcblxuICAgIGlmICghcmVzcG9uc2UuU2VjcmV0U3RyaW5nKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdOb3RlaHViIEFQSSB0b2tlbiBub3QgZm91bmQgaW4gc2VjcmV0Jyk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCBzZWNyZXQgPSBKU09OLnBhcnNlKHJlc3BvbnNlLlNlY3JldFN0cmluZyk7XG4gICAgY2FjaGVkTm90ZWh1YlRva2VuID0gc2VjcmV0LnRva2VuO1xuICAgIHJldHVybiBjYWNoZWROb3RlaHViVG9rZW47XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgZmV0Y2hpbmcgTm90ZWh1YiB0b2tlbjonLCBlcnJvcik7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cblxuY29uc3QgaGVhZGVycyA9IHtcbiAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLEF1dGhvcml6YXRpb24nLFxuICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctTWV0aG9kcyc6ICdHRVQsUFVULE9QVElPTlMnLFxufTtcblxuaW50ZXJmYWNlIEZsZWV0RGVmYXVsdHMge1xuICBtb2RlPzogc3RyaW5nO1xuICBncHNfaW50ZXJ2YWxfbWluPzogbnVtYmVyO1xuICBzeW5jX2ludGVydmFsX21pbj86IG51bWJlcjtcbiAgaGVhcnRiZWF0X2hvdXJzPzogbnVtYmVyO1xuICB0ZW1wX2FsZXJ0X2hpZ2hfYz86IG51bWJlcjtcbiAgdGVtcF9hbGVydF9sb3dfYz86IG51bWJlcjtcbiAgaHVtaWRpdHlfYWxlcnRfaGlnaD86IG51bWJlcjtcbiAgaHVtaWRpdHlfYWxlcnRfbG93PzogbnVtYmVyO1xuICB2b2x0YWdlX2FsZXJ0X2xvdz86IG51bWJlcjtcbiAgbW90aW9uX3NlbnNpdGl2aXR5Pzogc3RyaW5nO1xuICBhdWRpb19lbmFibGVkPzogYm9vbGVhbjtcbiAgbGVkX2VuYWJsZWQ/OiBib29sZWFuO1xufVxuXG4vLyBWYWxpZGF0aW9uIHNjaGVtYSBmb3IgZmxlZXQgZGVmYXVsdHNcbmNvbnN0IGZsZWV0RGVmYXVsdHNTY2hlbWE6IFJlY29yZDxzdHJpbmcsIHsgdHlwZTogc3RyaW5nOyBtaW4/OiBudW1iZXI7IG1heD86IG51bWJlcjsgdmFsdWVzPzogc3RyaW5nW10gfT4gPSB7XG4gIG1vZGU6IHsgdHlwZTogJ3N0cmluZycsIHZhbHVlczogWydkZW1vJywgJ3RyYW5zaXQnLCAnc3RvcmFnZScsICdzbGVlcCddIH0sXG4gIGdwc19pbnRlcnZhbF9taW46IHsgdHlwZTogJ251bWJlcicsIG1pbjogMSwgbWF4OiAxNDQwIH0sXG4gIHN5bmNfaW50ZXJ2YWxfbWluOiB7IHR5cGU6ICdudW1iZXInLCBtaW46IDEsIG1heDogMTQ0MCB9LFxuICBoZWFydGJlYXRfaG91cnM6IHsgdHlwZTogJ251bWJlcicsIG1pbjogMSwgbWF4OiAxNjggfSxcbiAgdGVtcF9hbGVydF9oaWdoX2M6IHsgdHlwZTogJ251bWJlcicsIG1pbjogLTQwLCBtYXg6IDg1IH0sXG4gIHRlbXBfYWxlcnRfbG93X2M6IHsgdHlwZTogJ251bWJlcicsIG1pbjogLTQwLCBtYXg6IDg1IH0sXG4gIGh1bWlkaXR5X2FsZXJ0X2hpZ2g6IHsgdHlwZTogJ251bWJlcicsIG1pbjogMCwgbWF4OiAxMDAgfSxcbiAgaHVtaWRpdHlfYWxlcnRfbG93OiB7IHR5cGU6ICdudW1iZXInLCBtaW46IDAsIG1heDogMTAwIH0sXG4gIHZvbHRhZ2VfYWxlcnRfbG93OiB7IHR5cGU6ICdudW1iZXInLCBtaW46IDMuMCwgbWF4OiA0LjIgfSxcbiAgbW90aW9uX3NlbnNpdGl2aXR5OiB7IHR5cGU6ICdzdHJpbmcnLCB2YWx1ZXM6IFsnbG93JywgJ21lZGl1bScsICdoaWdoJ10gfSxcbiAgYXVkaW9fZW5hYmxlZDogeyB0eXBlOiAnYm9vbGVhbicgfSxcbiAgbGVkX2VuYWJsZWQ6IHsgdHlwZTogJ2Jvb2xlYW4nIH0sXG59O1xuXG5mdW5jdGlvbiBpc0FkbWluKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyV2l0aEpXVEF1dGhvcml6ZXIpOiBib29sZWFuIHtcbiAgdHJ5IHtcbiAgICBjb25zdCBjbGFpbXMgPSBldmVudC5yZXF1ZXN0Q29udGV4dD8uYXV0aG9yaXplcj8uand0Py5jbGFpbXM7XG4gICAgaWYgKCFjbGFpbXMpIHJldHVybiBmYWxzZTtcblxuICAgIC8vIGNvZ25pdG86Z3JvdXBzIGlzIGVpdGhlciBhIHN0cmluZyBvciBhcnJheSBkZXBlbmRpbmcgb24gbnVtYmVyIG9mIGdyb3Vwc1xuICAgIGNvbnN0IGdyb3VwcyA9IGNsYWltc1snY29nbml0bzpncm91cHMnXTtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShncm91cHMpKSB7XG4gICAgICByZXR1cm4gZ3JvdXBzLmluY2x1ZGVzKCdBZG1pbicpO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIGdyb3VwcyA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHJldHVybiBncm91cHMgPT09ICdBZG1pbicgfHwgZ3JvdXBzLmluY2x1ZGVzKCdBZG1pbicpO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH0gY2F0Y2gge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG4vKipcbiAqIFB1c2ggZmxlZXQgZGVmYXVsdHMgdG8gTm90ZWh1YiBhcyBmbGVldCBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbiAqIFRoaXMgbWFrZXMgdGhlIGNvbmZpZyBhdmFpbGFibGUgdG8gYWxsIGRldmljZXMgaW4gdGhlIGZsZWV0XG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHB1c2hUb05vdGVodWIoZmxlZXRVaWQ6IHN0cmluZywgY29uZmlnOiBGbGVldERlZmF1bHRzKTogUHJvbWlzZTx7IHN1Y2Nlc3M6IGJvb2xlYW47IGVycm9yPzogc3RyaW5nIH0+IHtcbiAgaWYgKCFOT1RFSFVCX1BST0pFQ1RfVUlEKSB7XG4gICAgY29uc29sZS53YXJuKCdOT1RFSFVCX1BST0pFQ1RfVUlEIG5vdCBjb25maWd1cmVkLCBza2lwcGluZyBOb3RlaHViIHB1c2gnKTtcbiAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICdOb3RlaHViIG5vdCBjb25maWd1cmVkJyB9O1xuICB9XG5cbiAgY29uc3QgdG9rZW4gPSBhd2FpdCBnZXROb3RlaHViVG9rZW4oKTtcbiAgaWYgKCF0b2tlbikge1xuICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogJ0NvdWxkIG5vdCBnZXQgTm90ZWh1YiB0b2tlbicgfTtcbiAgfVxuXG4gIC8vIENvbnZlcnQgY29uZmlnIHZhbHVlcyB0byBzdHJpbmdzIGZvciBOb3RlaHViIGVudmlyb25tZW50IHZhcmlhYmxlc1xuICBjb25zdCBlbnZWYXJzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XG4gIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGNvbmZpZykpIHtcbiAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gbnVsbCkge1xuICAgICAgZW52VmFyc1trZXldID0gU3RyaW5nKHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goXG4gICAgICBgaHR0cHM6Ly9hcGkubm90ZWZpbGUubmV0L3YxL3Byb2plY3RzLyR7Tk9URUhVQl9QUk9KRUNUX1VJRH0vZmxlZXRzLyR7ZmxlZXRVaWR9L2Vudmlyb25tZW50X3ZhcmlhYmxlc2AsXG4gICAgICB7XG4gICAgICAgIG1ldGhvZDogJ1BVVCcsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHt0b2tlbn1gLFxuICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgIH0sXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZW52aXJvbm1lbnRfdmFyaWFibGVzOiBlbnZWYXJzIH0pLFxuICAgICAgfVxuICAgICk7XG5cbiAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XG4gICAgICBjb25zdCBlcnJvclRleHQgPSBhd2FpdCByZXNwb25zZS50ZXh0KCk7XG4gICAgICBjb25zb2xlLmVycm9yKCdOb3RlaHViIEFQSSBlcnJvcjonLCByZXNwb25zZS5zdGF0dXMsIGVycm9yVGV4dCk7XG4gICAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6IGBOb3RlaHViIEFQSSBlcnJvcjogJHtyZXNwb25zZS5zdGF0dXN9YCB9O1xuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKGBTdWNjZXNzZnVsbHkgcHVzaGVkIGZsZWV0IGRlZmF1bHRzIHRvIE5vdGVodWIgZm9yIGZsZWV0ICR7ZmxlZXRVaWR9YCk7XG4gICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHB1c2hpbmcgdG8gTm90ZWh1YjonLCBlcnJvcik7XG4gICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBTdHJpbmcoZXJyb3IpIH07XG4gIH1cbn1cblxuZnVuY3Rpb24gdmFsaWRhdGVGbGVldERlZmF1bHRzKGNvbmZpZzogUmVjb3JkPHN0cmluZywgdW5rbm93bj4pOiB7IHZhbGlkOiBib29sZWFuOyBlcnJvcnM6IHN0cmluZ1tdIH0ge1xuICBjb25zdCBlcnJvcnM6IHN0cmluZ1tdID0gW107XG5cbiAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoY29uZmlnKSkge1xuICAgIGNvbnN0IHNjaGVtYSA9IGZsZWV0RGVmYXVsdHNTY2hlbWFba2V5XTtcbiAgICBpZiAoIXNjaGVtYSkge1xuICAgICAgZXJyb3JzLnB1c2goYFVua25vd24gc2V0dGluZzogJHtrZXl9YCk7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG5cbiAgICBpZiAoc2NoZW1hLnR5cGUgPT09ICdudW1iZXInKSB7XG4gICAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAnbnVtYmVyJykge1xuICAgICAgICBlcnJvcnMucHVzaChgJHtrZXl9IG11c3QgYmUgYSBudW1iZXJgKTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBpZiAoc2NoZW1hLm1pbiAhPT0gdW5kZWZpbmVkICYmIHZhbHVlIDwgc2NoZW1hLm1pbikge1xuICAgICAgICBlcnJvcnMucHVzaChgJHtrZXl9IG11c3QgYmUgYXQgbGVhc3QgJHtzY2hlbWEubWlufWApO1xuICAgICAgfVxuICAgICAgaWYgKHNjaGVtYS5tYXggIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSA+IHNjaGVtYS5tYXgpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goYCR7a2V5fSBtdXN0IGJlIGF0IG1vc3QgJHtzY2hlbWEubWF4fWApO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoc2NoZW1hLnR5cGUgPT09ICdzdHJpbmcnKSB7XG4gICAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAnc3RyaW5nJykge1xuICAgICAgICBlcnJvcnMucHVzaChgJHtrZXl9IG11c3QgYmUgYSBzdHJpbmdgKTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBpZiAoc2NoZW1hLnZhbHVlcyAmJiAhc2NoZW1hLnZhbHVlcy5pbmNsdWRlcyh2YWx1ZSkpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goYCR7a2V5fSBtdXN0IGJlIG9uZSBvZjogJHtzY2hlbWEudmFsdWVzLmpvaW4oJywgJyl9YCk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChzY2hlbWEudHlwZSA9PT0gJ2Jvb2xlYW4nKSB7XG4gICAgICBpZiAodHlwZW9mIHZhbHVlICE9PSAnYm9vbGVhbicpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goYCR7a2V5fSBtdXN0IGJlIGEgYm9vbGVhbmApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiB7IHZhbGlkOiBlcnJvcnMubGVuZ3RoID09PSAwLCBlcnJvcnMgfTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGhhbmRsZXIoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50VjJXaXRoSldUQXV0aG9yaXplcik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0VjI+IHtcbiAgY29uc29sZS5sb2coJ0V2ZW50OicsIEpTT04uc3RyaW5naWZ5KGV2ZW50LCBudWxsLCAyKSk7XG5cbiAgY29uc3QgbWV0aG9kID0gZXZlbnQucmVxdWVzdENvbnRleHQuaHR0cC5tZXRob2Q7XG4gIGNvbnN0IHBhdGggPSBldmVudC5yYXdQYXRoO1xuXG4gIC8vIEhhbmRsZSBPUFRJT05TIGZvciBDT1JTXG4gIGlmIChtZXRob2QgPT09ICdPUFRJT05TJykge1xuICAgIHJldHVybiB7IHN0YXR1c0NvZGU6IDIwMCwgaGVhZGVycywgYm9keTogJycgfTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgLy8gR0VUIC92MS9zZXR0aW5ncy9mbGVldC1kZWZhdWx0cyAtIExpc3QgYWxsIGZsZWV0IGRlZmF1bHRzIChhZG1pbiBvbmx5KVxuICAgIGlmIChtZXRob2QgPT09ICdHRVQnICYmIHBhdGggPT09ICcvdjEvc2V0dGluZ3MvZmxlZXQtZGVmYXVsdHMnKSB7XG4gICAgICBpZiAoIWlzQWRtaW4oZXZlbnQpKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgc3RhdHVzQ29kZTogNDAzLFxuICAgICAgICAgIGhlYWRlcnMsXG4gICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0FkbWluIGFjY2VzcyByZXF1aXJlZCcgfSksXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IFNFVFRJTkdTX1RBQkxFLFxuICAgICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnc2V0dGluZ190eXBlID0gOnR5cGUnLFxuICAgICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAgICAgJzp0eXBlJzogJ2ZsZWV0X2RlZmF1bHRzJyxcbiAgICAgICAgfSxcbiAgICAgIH0pKTtcblxuICAgICAgY29uc3QgZmxlZXREZWZhdWx0cyA9IChyZXN1bHQuSXRlbXMgfHwgW10pLm1hcCgoaXRlbTogUmVjb3JkPHN0cmluZywgdW5rbm93bj4pID0+ICh7XG4gICAgICAgIGZsZWV0X3VpZDogaXRlbS5zZXR0aW5nX2lkLFxuICAgICAgICAuLi4oaXRlbS5jb25maWcgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4gfHwge30pLFxuICAgICAgICB1cGRhdGVkX2F0OiBpdGVtLnVwZGF0ZWRfYXQsXG4gICAgICAgIHVwZGF0ZWRfYnk6IGl0ZW0udXBkYXRlZF9ieSxcbiAgICAgIH0pKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGZsZWV0X2RlZmF1bHRzOiBmbGVldERlZmF1bHRzIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBHRVQgL3YxL3NldHRpbmdzL2ZsZWV0LWRlZmF1bHRzL3tmbGVldH0gLSBHZXQgc3BlY2lmaWMgZmxlZXQgZGVmYXVsdHNcbiAgICBpZiAobWV0aG9kID09PSAnR0VUJyAmJiBwYXRoLnN0YXJ0c1dpdGgoJy92MS9zZXR0aW5ncy9mbGVldC1kZWZhdWx0cy8nKSkge1xuICAgICAgY29uc3QgZmxlZXRVaWQgPSBldmVudC5wYXRoUGFyYW1ldGVycz8uZmxlZXQ7XG4gICAgICBpZiAoIWZsZWV0VWlkKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgICAgIGhlYWRlcnMsXG4gICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0ZsZWV0IFVJRCByZXF1aXJlZCcgfSksXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBHZXRDb21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBTRVRUSU5HU19UQUJMRSxcbiAgICAgICAgS2V5OiB7XG4gICAgICAgICAgc2V0dGluZ190eXBlOiAnZmxlZXRfZGVmYXVsdHMnLFxuICAgICAgICAgIHNldHRpbmdfaWQ6IGZsZWV0VWlkLFxuICAgICAgICB9LFxuICAgICAgfSkpO1xuXG4gICAgICBpZiAoIXJlc3VsdC5JdGVtKSB7XG4gICAgICAgIC8vIFJldHVybiBlbXB0eSBkZWZhdWx0cyBpZiBub25lIHNldFxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgICAgICBoZWFkZXJzLFxuICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgIGZsZWV0X3VpZDogZmxlZXRVaWQsXG4gICAgICAgICAgICBjb25maWc6IHt9LFxuICAgICAgICAgICAgc2NoZW1hOiBmbGVldERlZmF1bHRzU2NoZW1hLFxuICAgICAgICAgIH0pLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICAgIGhlYWRlcnMsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBmbGVldF91aWQ6IGZsZWV0VWlkLFxuICAgICAgICAgIGNvbmZpZzogcmVzdWx0Lkl0ZW0uY29uZmlnIHx8IHt9LFxuICAgICAgICAgIHNjaGVtYTogZmxlZXREZWZhdWx0c1NjaGVtYSxcbiAgICAgICAgICB1cGRhdGVkX2F0OiByZXN1bHQuSXRlbS51cGRhdGVkX2F0LFxuICAgICAgICAgIHVwZGF0ZWRfYnk6IHJlc3VsdC5JdGVtLnVwZGF0ZWRfYnksXG4gICAgICAgIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBQVVQgL3YxL3NldHRpbmdzL2ZsZWV0LWRlZmF1bHRzL3tmbGVldH0gLSBVcGRhdGUgZmxlZXQgZGVmYXVsdHMgKGFkbWluIG9ubHkpXG4gICAgaWYgKG1ldGhvZCA9PT0gJ1BVVCcgJiYgcGF0aC5zdGFydHNXaXRoKCcvdjEvc2V0dGluZ3MvZmxlZXQtZGVmYXVsdHMvJykpIHtcbiAgICAgIGlmICghaXNBZG1pbihldmVudCkpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdGF0dXNDb2RlOiA0MDMsXG4gICAgICAgICAgaGVhZGVycyxcbiAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnQWRtaW4gYWNjZXNzIHJlcXVpcmVkJyB9KSxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZmxlZXRVaWQgPSBldmVudC5wYXRoUGFyYW1ldGVycz8uZmxlZXQ7XG4gICAgICBpZiAoIWZsZWV0VWlkKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgICAgIGhlYWRlcnMsXG4gICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0ZsZWV0IFVJRCByZXF1aXJlZCcgfSksXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGxldCBjb25maWc6IEZsZWV0RGVmYXVsdHM7XG4gICAgICB0cnkge1xuICAgICAgICBjb25maWcgPSBKU09OLnBhcnNlKGV2ZW50LmJvZHkgfHwgJ3t9Jyk7XG4gICAgICB9IGNhdGNoIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdGF0dXNDb2RlOiA0MDAsXG4gICAgICAgICAgaGVhZGVycyxcbiAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnSW52YWxpZCBKU09OIGJvZHknIH0pLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICAvLyBWYWxpZGF0ZSBjb25maWdcbiAgICAgIGNvbnN0IHZhbGlkYXRpb24gPSB2YWxpZGF0ZUZsZWV0RGVmYXVsdHMoY29uZmlnIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KTtcbiAgICAgIGlmICghdmFsaWRhdGlvbi52YWxpZCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgICAgICBoZWFkZXJzLFxuICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdWYWxpZGF0aW9uIGZhaWxlZCcsIGRldGFpbHM6IHZhbGlkYXRpb24uZXJyb3JzIH0pLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICAvLyBHZXQgdXNlciBpbmZvIGZyb20gSldUIGNsYWltc1xuICAgICAgY29uc3QgY2xhaW1zID0gZXZlbnQucmVxdWVzdENvbnRleHQ/LmF1dGhvcml6ZXI/Lmp3dD8uY2xhaW1zO1xuICAgICAgY29uc3QgdXNlckVtYWlsID0gY2xhaW1zPy5lbWFpbCB8fCBjbGFpbXM/LnN1YiB8fCAndW5rbm93bic7XG5cbiAgICAgIC8vIFN0b3JlIHNldHRpbmdzIGluIER5bmFtb0RCIChmb3IgZGFzaGJvYXJkIFVJKVxuICAgICAgYXdhaXQgZG9jQ2xpZW50LnNlbmQobmV3IFB1dENvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IFNFVFRJTkdTX1RBQkxFLFxuICAgICAgICBJdGVtOiB7XG4gICAgICAgICAgc2V0dGluZ190eXBlOiAnZmxlZXRfZGVmYXVsdHMnLFxuICAgICAgICAgIHNldHRpbmdfaWQ6IGZsZWV0VWlkLFxuICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICB1cGRhdGVkX2F0OiBEYXRlLm5vdygpLFxuICAgICAgICAgIHVwZGF0ZWRfYnk6IHVzZXJFbWFpbCxcbiAgICAgICAgfSxcbiAgICAgIH0pKTtcblxuICAgICAgLy8gUHVzaCB0byBOb3RlaHViIGFzIGZsZWV0IGVudmlyb25tZW50IHZhcmlhYmxlcyAoc28gZGV2aWNlcyByZWNlaXZlIHRoZSBjb25maWcpXG4gICAgICBjb25zdCBub3RlaHViUmVzdWx0ID0gYXdhaXQgcHVzaFRvTm90ZWh1YihmbGVldFVpZCwgY29uZmlnKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgZmxlZXRfdWlkOiBmbGVldFVpZCxcbiAgICAgICAgICBjb25maWcsXG4gICAgICAgICAgdXBkYXRlZF9hdDogRGF0ZS5ub3coKSxcbiAgICAgICAgICB1cGRhdGVkX2J5OiB1c2VyRW1haWwsXG4gICAgICAgICAgbm90ZWh1Yl9zeW5jOiBub3RlaHViUmVzdWx0LnN1Y2Nlc3MsXG4gICAgICAgICAgbm90ZWh1Yl9lcnJvcjogbm90ZWh1YlJlc3VsdC5lcnJvcixcbiAgICAgICAgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA0MDQsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ05vdCBmb3VuZCcgfSksXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyB9KSxcbiAgICB9O1xuICB9XG59XG4iXX0=