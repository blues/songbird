"use strict";
/**
 * API Settings Lambda
 *
 * Handles fleet defaults settings CRUD operations.
 * Admin-only endpoints are protected by checking JWT cognito:groups claim.
 *
 * Fleet defaults are saved to:
 * 1. DynamoDB (for dashboard UI)
 * 2. Notehub fleet environment variables (so devices receive the config)
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_secrets_manager_1 = require("@aws-sdk/client-secrets-manager");
const client = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(client);
const secretsClient = new client_secrets_manager_1.SecretsManagerClient({});
const SETTINGS_TABLE = process.env.SETTINGS_TABLE || 'songbird-settings';
const NOTEHUB_PROJECT_UID = process.env.NOTEHUB_PROJECT_UID;
const NOTEHUB_SECRET_ARN = process.env.NOTEHUB_SECRET_ARN;
// Cache the Notehub token
let cachedNotehubToken = null;
async function getNotehubToken() {
    if (!NOTEHUB_SECRET_ARN) {
        console.warn('NOTEHUB_SECRET_ARN not configured');
        return null;
    }
    if (cachedNotehubToken) {
        return cachedNotehubToken;
    }
    try {
        const command = new client_secrets_manager_1.GetSecretValueCommand({ SecretId: NOTEHUB_SECRET_ARN });
        const response = await secretsClient.send(command);
        if (!response.SecretString) {
            console.error('Notehub API token not found in secret');
            return null;
        }
        const secret = JSON.parse(response.SecretString);
        cachedNotehubToken = secret.token;
        return cachedNotehubToken;
    }
    catch (error) {
        console.error('Error fetching Notehub token:', error);
        return null;
    }
}
const headers = {
    'Content-Type': 'application/json',
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type,Authorization',
    'Access-Control-Allow-Methods': 'GET,PUT,OPTIONS',
};
// Validation schema for fleet defaults
const fleetDefaultsSchema = {
    mode: { type: 'string', values: ['demo', 'transit', 'storage', 'sleep'] },
    gps_interval_min: { type: 'number', min: 1, max: 1440 },
    sync_interval_min: { type: 'number', min: 1, max: 1440 },
    heartbeat_hours: { type: 'number', min: 1, max: 168 },
    temp_alert_high_c: { type: 'number', min: -40, max: 85 },
    temp_alert_low_c: { type: 'number', min: -40, max: 85 },
    humidity_alert_high: { type: 'number', min: 0, max: 100 },
    humidity_alert_low: { type: 'number', min: 0, max: 100 },
    voltage_alert_low: { type: 'number', min: 3.0, max: 4.2 },
    motion_sensitivity: { type: 'string', values: ['low', 'medium', 'high'] },
    audio_enabled: { type: 'boolean' },
    led_enabled: { type: 'boolean' },
};
function isAdmin(event) {
    try {
        const claims = event.requestContext?.authorizer?.jwt?.claims;
        if (!claims)
            return false;
        // cognito:groups is either a string or array depending on number of groups
        const groups = claims['cognito:groups'];
        if (Array.isArray(groups)) {
            return groups.includes('Admin');
        }
        if (typeof groups === 'string') {
            return groups === 'Admin' || groups.includes('Admin');
        }
        return false;
    }
    catch {
        return false;
    }
}
/**
 * Push fleet defaults to Notehub as fleet environment variables
 * This makes the config available to all devices in the fleet
 */
async function pushToNotehub(fleetUid, config) {
    if (!NOTEHUB_PROJECT_UID) {
        console.warn('NOTEHUB_PROJECT_UID not configured, skipping Notehub push');
        return { success: false, error: 'Notehub not configured' };
    }
    const token = await getNotehubToken();
    if (!token) {
        return { success: false, error: 'Could not get Notehub token' };
    }
    // Convert config values to strings for Notehub environment variables
    const envVars = {};
    for (const [key, value] of Object.entries(config)) {
        if (value !== undefined && value !== null) {
            envVars[key] = String(value);
        }
    }
    try {
        const response = await fetch(`https://api.notefile.net/v1/projects/${NOTEHUB_PROJECT_UID}/fleets/${fleetUid}/environment_variables`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ environment_variables: envVars }),
        });
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Notehub API error:', response.status, errorText);
            return { success: false, error: `Notehub API error: ${response.status}` };
        }
        console.log(`Successfully pushed fleet defaults to Notehub for fleet ${fleetUid}`);
        return { success: true };
    }
    catch (error) {
        console.error('Error pushing to Notehub:', error);
        return { success: false, error: String(error) };
    }
}
function validateFleetDefaults(config) {
    const errors = [];
    for (const [key, value] of Object.entries(config)) {
        const schema = fleetDefaultsSchema[key];
        if (!schema) {
            errors.push(`Unknown setting: ${key}`);
            continue;
        }
        if (schema.type === 'number') {
            if (typeof value !== 'number') {
                errors.push(`${key} must be a number`);
                continue;
            }
            if (schema.min !== undefined && value < schema.min) {
                errors.push(`${key} must be at least ${schema.min}`);
            }
            if (schema.max !== undefined && value > schema.max) {
                errors.push(`${key} must be at most ${schema.max}`);
            }
        }
        else if (schema.type === 'string') {
            if (typeof value !== 'string') {
                errors.push(`${key} must be a string`);
                continue;
            }
            if (schema.values && !schema.values.includes(value)) {
                errors.push(`${key} must be one of: ${schema.values.join(', ')}`);
            }
        }
        else if (schema.type === 'boolean') {
            if (typeof value !== 'boolean') {
                errors.push(`${key} must be a boolean`);
            }
        }
    }
    return { valid: errors.length === 0, errors };
}
async function handler(event) {
    console.log('Event:', JSON.stringify(event, null, 2));
    const method = event.requestContext.http.method;
    const path = event.rawPath;
    // Handle OPTIONS for CORS
    if (method === 'OPTIONS') {
        return { statusCode: 200, headers, body: '' };
    }
    try {
        // GET /v1/settings/fleet-defaults - List all fleet defaults (admin only)
        if (method === 'GET' && path === '/v1/settings/fleet-defaults') {
            if (!isAdmin(event)) {
                return {
                    statusCode: 403,
                    headers,
                    body: JSON.stringify({ error: 'Admin access required' }),
                };
            }
            const result = await docClient.send(new lib_dynamodb_1.QueryCommand({
                TableName: SETTINGS_TABLE,
                KeyConditionExpression: 'setting_type = :type',
                ExpressionAttributeValues: {
                    ':type': 'fleet_defaults',
                },
            }));
            const fleetDefaults = (result.Items || []).map(item => ({
                fleet_uid: item.setting_id,
                ...item.config,
                updated_at: item.updated_at,
                updated_by: item.updated_by,
            }));
            return {
                statusCode: 200,
                headers,
                body: JSON.stringify({ fleet_defaults: fleetDefaults }),
            };
        }
        // GET /v1/settings/fleet-defaults/{fleet} - Get specific fleet defaults
        if (method === 'GET' && path.startsWith('/v1/settings/fleet-defaults/')) {
            const fleetUid = event.pathParameters?.fleet;
            if (!fleetUid) {
                return {
                    statusCode: 400,
                    headers,
                    body: JSON.stringify({ error: 'Fleet UID required' }),
                };
            }
            const result = await docClient.send(new lib_dynamodb_1.GetCommand({
                TableName: SETTINGS_TABLE,
                Key: {
                    setting_type: 'fleet_defaults',
                    setting_id: fleetUid,
                },
            }));
            if (!result.Item) {
                // Return empty defaults if none set
                return {
                    statusCode: 200,
                    headers,
                    body: JSON.stringify({
                        fleet_uid: fleetUid,
                        config: {},
                        schema: fleetDefaultsSchema,
                    }),
                };
            }
            return {
                statusCode: 200,
                headers,
                body: JSON.stringify({
                    fleet_uid: fleetUid,
                    config: result.Item.config || {},
                    schema: fleetDefaultsSchema,
                    updated_at: result.Item.updated_at,
                    updated_by: result.Item.updated_by,
                }),
            };
        }
        // PUT /v1/settings/fleet-defaults/{fleet} - Update fleet defaults (admin only)
        if (method === 'PUT' && path.startsWith('/v1/settings/fleet-defaults/')) {
            if (!isAdmin(event)) {
                return {
                    statusCode: 403,
                    headers,
                    body: JSON.stringify({ error: 'Admin access required' }),
                };
            }
            const fleetUid = event.pathParameters?.fleet;
            if (!fleetUid) {
                return {
                    statusCode: 400,
                    headers,
                    body: JSON.stringify({ error: 'Fleet UID required' }),
                };
            }
            let config;
            try {
                config = JSON.parse(event.body || '{}');
            }
            catch {
                return {
                    statusCode: 400,
                    headers,
                    body: JSON.stringify({ error: 'Invalid JSON body' }),
                };
            }
            // Validate config
            const validation = validateFleetDefaults(config);
            if (!validation.valid) {
                return {
                    statusCode: 400,
                    headers,
                    body: JSON.stringify({ error: 'Validation failed', details: validation.errors }),
                };
            }
            // Get user info from JWT claims
            const claims = event.requestContext?.authorizer?.jwt?.claims;
            const userEmail = claims?.email || claims?.sub || 'unknown';
            // Store settings in DynamoDB (for dashboard UI)
            await docClient.send(new lib_dynamodb_1.PutCommand({
                TableName: SETTINGS_TABLE,
                Item: {
                    setting_type: 'fleet_defaults',
                    setting_id: fleetUid,
                    config,
                    updated_at: Date.now(),
                    updated_by: userEmail,
                },
            }));
            // Push to Notehub as fleet environment variables (so devices receive the config)
            const notehubResult = await pushToNotehub(fleetUid, config);
            return {
                statusCode: 200,
                headers,
                body: JSON.stringify({
                    fleet_uid: fleetUid,
                    config,
                    updated_at: Date.now(),
                    updated_by: userEmail,
                    notehub_sync: notehubResult.success,
                    notehub_error: notehubResult.error,
                }),
            };
        }
        return {
            statusCode: 404,
            headers,
            body: JSON.stringify({ error: 'Not found' }),
        };
    }
    catch (error) {
        console.error('Error:', error);
        return {
            statusCode: 500,
            headers,
            body: JSON.stringify({ error: 'Internal server error' }),
        };
    }
}
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvYXBpLXNldHRpbmdzL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7O0dBU0c7OztBQUVILDhEQUEwRDtBQUMxRCx3REFBcUc7QUFDckcsNEVBQThGO0FBRzlGLE1BQU0sTUFBTSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN0QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDdEQsTUFBTSxhQUFhLEdBQUcsSUFBSSw2Q0FBb0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUVuRCxNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSxtQkFBbUIsQ0FBQztBQUN6RSxNQUFNLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUM7QUFDNUQsTUFBTSxrQkFBa0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDO0FBRTFELDBCQUEwQjtBQUMxQixJQUFJLGtCQUFrQixHQUFrQixJQUFJLENBQUM7QUFFN0MsS0FBSyxVQUFVLGVBQWU7SUFDNUIsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFDeEIsT0FBTyxDQUFDLElBQUksQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDO1FBQ2xELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELElBQUksa0JBQWtCLEVBQUUsQ0FBQztRQUN2QixPQUFPLGtCQUFrQixDQUFDO0lBQzVCLENBQUM7SUFFRCxJQUFJLENBQUM7UUFDSCxNQUFNLE9BQU8sR0FBRyxJQUFJLDhDQUFxQixDQUFDLEVBQUUsUUFBUSxFQUFFLGtCQUFrQixFQUFFLENBQUMsQ0FBQztRQUM1RSxNQUFNLFFBQVEsR0FBRyxNQUFNLGFBQWEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFbkQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUMzQixPQUFPLENBQUMsS0FBSyxDQUFDLHVDQUF1QyxDQUFDLENBQUM7WUFDdkQsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBRUQsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDakQsa0JBQWtCLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQztRQUNsQyxPQUFPLGtCQUFrQixDQUFDO0lBQzVCLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQywrQkFBK0IsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN0RCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7QUFDSCxDQUFDO0FBRUQsTUFBTSxPQUFPLEdBQUc7SUFDZCxjQUFjLEVBQUUsa0JBQWtCO0lBQ2xDLDZCQUE2QixFQUFFLEdBQUc7SUFDbEMsOEJBQThCLEVBQUUsNEJBQTRCO0lBQzVELDhCQUE4QixFQUFFLGlCQUFpQjtDQUNsRCxDQUFDO0FBaUJGLHVDQUF1QztBQUN2QyxNQUFNLG1CQUFtQixHQUFvRjtJQUMzRyxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLE9BQU8sQ0FBQyxFQUFFO0lBQ3pFLGdCQUFnQixFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUU7SUFDdkQsaUJBQWlCLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRTtJQUN4RCxlQUFlLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRTtJQUNyRCxpQkFBaUIsRUFBRSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUU7SUFDeEQsZ0JBQWdCLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFO0lBQ3ZELG1CQUFtQixFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUU7SUFDekQsa0JBQWtCLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRTtJQUN4RCxpQkFBaUIsRUFBRSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFO0lBQ3pELGtCQUFrQixFQUFFLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxNQUFNLEVBQUUsQ0FBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLE1BQU0sQ0FBQyxFQUFFO0lBQ3pFLGFBQWEsRUFBRSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUU7SUFDbEMsV0FBVyxFQUFFLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRTtDQUNqQyxDQUFDO0FBRUYsU0FBUyxPQUFPLENBQUMsS0FBNkI7SUFDNUMsSUFBSSxDQUFDO1FBQ0gsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLGNBQWMsRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLE1BQU0sQ0FBQztRQUM3RCxJQUFJLENBQUMsTUFBTTtZQUFFLE9BQU8sS0FBSyxDQUFDO1FBRTFCLDJFQUEyRTtRQUMzRSxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUN4QyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztZQUMxQixPQUFPLE1BQU0sQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDbEMsQ0FBQztRQUNELElBQUksT0FBTyxNQUFNLEtBQUssUUFBUSxFQUFFLENBQUM7WUFDL0IsT0FBTyxNQUFNLEtBQUssT0FBTyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDeEQsQ0FBQztRQUNELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUFDLE1BQU0sQ0FBQztRQUNQLE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztBQUNILENBQUM7QUFFRDs7O0dBR0c7QUFDSCxLQUFLLFVBQVUsYUFBYSxDQUFDLFFBQWdCLEVBQUUsTUFBcUI7SUFDbEUsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDekIsT0FBTyxDQUFDLElBQUksQ0FBQywyREFBMkQsQ0FBQyxDQUFDO1FBQzFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSx3QkFBd0IsRUFBRSxDQUFDO0lBQzdELENBQUM7SUFFRCxNQUFNLEtBQUssR0FBRyxNQUFNLGVBQWUsRUFBRSxDQUFDO0lBQ3RDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNYLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSw2QkFBNkIsRUFBRSxDQUFDO0lBQ2xFLENBQUM7SUFFRCxxRUFBcUU7SUFDckUsTUFBTSxPQUFPLEdBQTJCLEVBQUUsQ0FBQztJQUMzQyxLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO1FBQ2xELElBQUksS0FBSyxLQUFLLFNBQVMsSUFBSSxLQUFLLEtBQUssSUFBSSxFQUFFLENBQUM7WUFDMUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMvQixDQUFDO0lBQ0gsQ0FBQztJQUVELElBQUksQ0FBQztRQUNILE1BQU0sUUFBUSxHQUFHLE1BQU0sS0FBSyxDQUMxQix3Q0FBd0MsbUJBQW1CLFdBQVcsUUFBUSx3QkFBd0IsRUFDdEc7WUFDRSxNQUFNLEVBQUUsS0FBSztZQUNiLE9BQU8sRUFBRTtnQkFDUCxlQUFlLEVBQUUsVUFBVSxLQUFLLEVBQUU7Z0JBQ2xDLGNBQWMsRUFBRSxrQkFBa0I7YUFDbkM7WUFDRCxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLHFCQUFxQixFQUFFLE9BQU8sRUFBRSxDQUFDO1NBQ3pELENBQ0YsQ0FBQztRQUVGLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDakIsTUFBTSxTQUFTLEdBQUcsTUFBTSxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDeEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsRUFBRSxRQUFRLENBQUMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQ2hFLE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxzQkFBc0IsUUFBUSxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUM7UUFDNUUsQ0FBQztRQUVELE9BQU8sQ0FBQyxHQUFHLENBQUMsMkRBQTJELFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDbkYsT0FBTyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQztJQUMzQixDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsMkJBQTJCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDbEQsT0FBTyxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO0lBQ2xELENBQUM7QUFDSCxDQUFDO0FBRUQsU0FBUyxxQkFBcUIsQ0FBQyxNQUErQjtJQUM1RCxNQUFNLE1BQU0sR0FBYSxFQUFFLENBQUM7SUFFNUIsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztRQUNsRCxNQUFNLE1BQU0sR0FBRyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN4QyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDWixNQUFNLENBQUMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ3ZDLFNBQVM7UUFDWCxDQUFDO1FBRUQsSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQzdCLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxFQUFFLENBQUM7Z0JBQzlCLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLG1CQUFtQixDQUFDLENBQUM7Z0JBQ3ZDLFNBQVM7WUFDWCxDQUFDO1lBQ0QsSUFBSSxNQUFNLENBQUMsR0FBRyxLQUFLLFNBQVMsSUFBSSxLQUFLLEdBQUcsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDO2dCQUNuRCxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxxQkFBcUIsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDdkQsQ0FBQztZQUNELElBQUksTUFBTSxDQUFDLEdBQUcsS0FBSyxTQUFTLElBQUksS0FBSyxHQUFHLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQztnQkFDbkQsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsb0JBQW9CLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ3RELENBQUM7UUFDSCxDQUFDO2FBQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQ3BDLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxFQUFFLENBQUM7Z0JBQzlCLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLG1CQUFtQixDQUFDLENBQUM7Z0JBQ3ZDLFNBQVM7WUFDWCxDQUFDO1lBQ0QsSUFBSSxNQUFNLENBQUMsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDcEQsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsb0JBQW9CLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUNwRSxDQUFDO1FBQ0gsQ0FBQzthQUFNLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxTQUFTLEVBQUUsQ0FBQztZQUNyQyxJQUFJLE9BQU8sS0FBSyxLQUFLLFNBQVMsRUFBRSxDQUFDO2dCQUMvQixNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxvQkFBb0IsQ0FBQyxDQUFDO1lBQzFDLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztJQUVELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUM7QUFDaEQsQ0FBQztBQUVNLEtBQUssVUFBVSxPQUFPLENBQUMsS0FBNkI7SUFDekQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFdEQsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ2hELE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUM7SUFFM0IsMEJBQTBCO0lBQzFCLElBQUksTUFBTSxLQUFLLFNBQVMsRUFBRSxDQUFDO1FBQ3pCLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUM7SUFDaEQsQ0FBQztJQUVELElBQUksQ0FBQztRQUNILHlFQUF5RTtRQUN6RSxJQUFJLE1BQU0sS0FBSyxLQUFLLElBQUksSUFBSSxLQUFLLDZCQUE2QixFQUFFLENBQUM7WUFDL0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUNwQixPQUFPO29CQUNMLFVBQVUsRUFBRSxHQUFHO29CQUNmLE9BQU87b0JBQ1AsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLEVBQUUsdUJBQXVCLEVBQUUsQ0FBQztpQkFDekQsQ0FBQztZQUNKLENBQUM7WUFFRCxNQUFNLE1BQU0sR0FBRyxNQUFNLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSwyQkFBWSxDQUFDO2dCQUNuRCxTQUFTLEVBQUUsY0FBYztnQkFDekIsc0JBQXNCLEVBQUUsc0JBQXNCO2dCQUM5Qyx5QkFBeUIsRUFBRTtvQkFDekIsT0FBTyxFQUFFLGdCQUFnQjtpQkFDMUI7YUFDRixDQUFDLENBQUMsQ0FBQztZQUVKLE1BQU0sYUFBYSxHQUFHLENBQUMsTUFBTSxDQUFDLEtBQUssSUFBSSxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUN0RCxTQUFTLEVBQUUsSUFBSSxDQUFDLFVBQVU7Z0JBQzFCLEdBQUcsSUFBSSxDQUFDLE1BQU07Z0JBQ2QsVUFBVSxFQUFFLElBQUksQ0FBQyxVQUFVO2dCQUMzQixVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVU7YUFDNUIsQ0FBQyxDQUFDLENBQUM7WUFFSixPQUFPO2dCQUNMLFVBQVUsRUFBRSxHQUFHO2dCQUNmLE9BQU87Z0JBQ1AsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxjQUFjLEVBQUUsYUFBYSxFQUFFLENBQUM7YUFDeEQsQ0FBQztRQUNKLENBQUM7UUFFRCx3RUFBd0U7UUFDeEUsSUFBSSxNQUFNLEtBQUssS0FBSyxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsOEJBQThCLENBQUMsRUFBRSxDQUFDO1lBQ3hFLE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxjQUFjLEVBQUUsS0FBSyxDQUFDO1lBQzdDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFDZCxPQUFPO29CQUNMLFVBQVUsRUFBRSxHQUFHO29CQUNmLE9BQU87b0JBQ1AsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLEVBQUUsb0JBQW9CLEVBQUUsQ0FBQztpQkFDdEQsQ0FBQztZQUNKLENBQUM7WUFFRCxNQUFNLE1BQU0sR0FBRyxNQUFNLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSx5QkFBVSxDQUFDO2dCQUNqRCxTQUFTLEVBQUUsY0FBYztnQkFDekIsR0FBRyxFQUFFO29CQUNILFlBQVksRUFBRSxnQkFBZ0I7b0JBQzlCLFVBQVUsRUFBRSxRQUFRO2lCQUNyQjthQUNGLENBQUMsQ0FBQyxDQUFDO1lBRUosSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDakIsb0NBQW9DO2dCQUNwQyxPQUFPO29CQUNMLFVBQVUsRUFBRSxHQUFHO29CQUNmLE9BQU87b0JBQ1AsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7d0JBQ25CLFNBQVMsRUFBRSxRQUFRO3dCQUNuQixNQUFNLEVBQUUsRUFBRTt3QkFDVixNQUFNLEVBQUUsbUJBQW1CO3FCQUM1QixDQUFDO2lCQUNILENBQUM7WUFDSixDQUFDO1lBRUQsT0FBTztnQkFDTCxVQUFVLEVBQUUsR0FBRztnQkFDZixPQUFPO2dCQUNQLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO29CQUNuQixTQUFTLEVBQUUsUUFBUTtvQkFDbkIsTUFBTSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxJQUFJLEVBQUU7b0JBQ2hDLE1BQU0sRUFBRSxtQkFBbUI7b0JBQzNCLFVBQVUsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVU7b0JBQ2xDLFVBQVUsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVU7aUJBQ25DLENBQUM7YUFDSCxDQUFDO1FBQ0osQ0FBQztRQUVELCtFQUErRTtRQUMvRSxJQUFJLE1BQU0sS0FBSyxLQUFLLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyw4QkFBOEIsQ0FBQyxFQUFFLENBQUM7WUFDeEUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUNwQixPQUFPO29CQUNMLFVBQVUsRUFBRSxHQUFHO29CQUNmLE9BQU87b0JBQ1AsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLEVBQUUsdUJBQXVCLEVBQUUsQ0FBQztpQkFDekQsQ0FBQztZQUNKLENBQUM7WUFFRCxNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsY0FBYyxFQUFFLEtBQUssQ0FBQztZQUM3QyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQ2QsT0FBTztvQkFDTCxVQUFVLEVBQUUsR0FBRztvQkFDZixPQUFPO29CQUNQLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsS0FBSyxFQUFFLG9CQUFvQixFQUFFLENBQUM7aUJBQ3RELENBQUM7WUFDSixDQUFDO1lBRUQsSUFBSSxNQUFxQixDQUFDO1lBQzFCLElBQUksQ0FBQztnQkFDSCxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxDQUFDO1lBQzFDLENBQUM7WUFBQyxNQUFNLENBQUM7Z0JBQ1AsT0FBTztvQkFDTCxVQUFVLEVBQUUsR0FBRztvQkFDZixPQUFPO29CQUNQLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsS0FBSyxFQUFFLG1CQUFtQixFQUFFLENBQUM7aUJBQ3JELENBQUM7WUFDSixDQUFDO1lBRUQsa0JBQWtCO1lBQ2xCLE1BQU0sVUFBVSxHQUFHLHFCQUFxQixDQUFDLE1BQWlDLENBQUMsQ0FBQztZQUM1RSxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUN0QixPQUFPO29CQUNMLFVBQVUsRUFBRSxHQUFHO29CQUNmLE9BQU87b0JBQ1AsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLEVBQUUsbUJBQW1CLEVBQUUsT0FBTyxFQUFFLFVBQVUsQ0FBQyxNQUFNLEVBQUUsQ0FBQztpQkFDakYsQ0FBQztZQUNKLENBQUM7WUFFRCxnQ0FBZ0M7WUFDaEMsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLGNBQWMsRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLE1BQU0sQ0FBQztZQUM3RCxNQUFNLFNBQVMsR0FBRyxNQUFNLEVBQUUsS0FBSyxJQUFJLE1BQU0sRUFBRSxHQUFHLElBQUksU0FBUyxDQUFDO1lBRTVELGdEQUFnRDtZQUNoRCxNQUFNLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSx5QkFBVSxDQUFDO2dCQUNsQyxTQUFTLEVBQUUsY0FBYztnQkFDekIsSUFBSSxFQUFFO29CQUNKLFlBQVksRUFBRSxnQkFBZ0I7b0JBQzlCLFVBQVUsRUFBRSxRQUFRO29CQUNwQixNQUFNO29CQUNOLFVBQVUsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFO29CQUN0QixVQUFVLEVBQUUsU0FBUztpQkFDdEI7YUFDRixDQUFDLENBQUMsQ0FBQztZQUVKLGlGQUFpRjtZQUNqRixNQUFNLGFBQWEsR0FBRyxNQUFNLGFBQWEsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFFNUQsT0FBTztnQkFDTCxVQUFVLEVBQUUsR0FBRztnQkFDZixPQUFPO2dCQUNQLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO29CQUNuQixTQUFTLEVBQUUsUUFBUTtvQkFDbkIsTUFBTTtvQkFDTixVQUFVLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTtvQkFDdEIsVUFBVSxFQUFFLFNBQVM7b0JBQ3JCLFlBQVksRUFBRSxhQUFhLENBQUMsT0FBTztvQkFDbkMsYUFBYSxFQUFFLGFBQWEsQ0FBQyxLQUFLO2lCQUNuQyxDQUFDO2FBQ0gsQ0FBQztRQUNKLENBQUM7UUFFRCxPQUFPO1lBQ0wsVUFBVSxFQUFFLEdBQUc7WUFDZixPQUFPO1lBQ1AsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLEVBQUUsV0FBVyxFQUFFLENBQUM7U0FDN0MsQ0FBQztJQUNKLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDL0IsT0FBTztZQUNMLFVBQVUsRUFBRSxHQUFHO1lBQ2YsT0FBTztZQUNQLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsS0FBSyxFQUFFLHVCQUF1QixFQUFFLENBQUM7U0FDekQsQ0FBQztJQUNKLENBQUM7QUFDSCxDQUFDO0FBL0tELDBCQStLQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQVBJIFNldHRpbmdzIExhbWJkYVxuICpcbiAqIEhhbmRsZXMgZmxlZXQgZGVmYXVsdHMgc2V0dGluZ3MgQ1JVRCBvcGVyYXRpb25zLlxuICogQWRtaW4tb25seSBlbmRwb2ludHMgYXJlIHByb3RlY3RlZCBieSBjaGVja2luZyBKV1QgY29nbml0bzpncm91cHMgY2xhaW0uXG4gKlxuICogRmxlZXQgZGVmYXVsdHMgYXJlIHNhdmVkIHRvOlxuICogMS4gRHluYW1vREIgKGZvciBkYXNoYm9hcmQgVUkpXG4gKiAyLiBOb3RlaHViIGZsZWV0IGVudmlyb25tZW50IHZhcmlhYmxlcyAoc28gZGV2aWNlcyByZWNlaXZlIHRoZSBjb25maWcpXG4gKi9cblxuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgR2V0Q29tbWFuZCwgUHV0Q29tbWFuZCwgUXVlcnlDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcbmltcG9ydCB7IFNlY3JldHNNYW5hZ2VyQ2xpZW50LCBHZXRTZWNyZXRWYWx1ZUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtc2VjcmV0cy1tYW5hZ2VyJztcbmltcG9ydCB0eXBlIHsgQVBJR2F0ZXdheVByb3h5RXZlbnRWMiwgQVBJR2F0ZXdheVByb3h5UmVzdWx0VjIgfSBmcm9tICdhd3MtbGFtYmRhJztcblxuY29uc3QgY2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShjbGllbnQpO1xuY29uc3Qgc2VjcmV0c0NsaWVudCA9IG5ldyBTZWNyZXRzTWFuYWdlckNsaWVudCh7fSk7XG5cbmNvbnN0IFNFVFRJTkdTX1RBQkxFID0gcHJvY2Vzcy5lbnYuU0VUVElOR1NfVEFCTEUgfHwgJ3NvbmdiaXJkLXNldHRpbmdzJztcbmNvbnN0IE5PVEVIVUJfUFJPSkVDVF9VSUQgPSBwcm9jZXNzLmVudi5OT1RFSFVCX1BST0pFQ1RfVUlEO1xuY29uc3QgTk9URUhVQl9TRUNSRVRfQVJOID0gcHJvY2Vzcy5lbnYuTk9URUhVQl9TRUNSRVRfQVJOO1xuXG4vLyBDYWNoZSB0aGUgTm90ZWh1YiB0b2tlblxubGV0IGNhY2hlZE5vdGVodWJUb2tlbjogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG5cbmFzeW5jIGZ1bmN0aW9uIGdldE5vdGVodWJUb2tlbigpOiBQcm9taXNlPHN0cmluZyB8IG51bGw+IHtcbiAgaWYgKCFOT1RFSFVCX1NFQ1JFVF9BUk4pIHtcbiAgICBjb25zb2xlLndhcm4oJ05PVEVIVUJfU0VDUkVUX0FSTiBub3QgY29uZmlndXJlZCcpO1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgaWYgKGNhY2hlZE5vdGVodWJUb2tlbikge1xuICAgIHJldHVybiBjYWNoZWROb3RlaHViVG9rZW47XG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0U2VjcmV0VmFsdWVDb21tYW5kKHsgU2VjcmV0SWQ6IE5PVEVIVUJfU0VDUkVUX0FSTiB9KTtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHNlY3JldHNDbGllbnQuc2VuZChjb21tYW5kKTtcblxuICAgIGlmICghcmVzcG9uc2UuU2VjcmV0U3RyaW5nKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdOb3RlaHViIEFQSSB0b2tlbiBub3QgZm91bmQgaW4gc2VjcmV0Jyk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCBzZWNyZXQgPSBKU09OLnBhcnNlKHJlc3BvbnNlLlNlY3JldFN0cmluZyk7XG4gICAgY2FjaGVkTm90ZWh1YlRva2VuID0gc2VjcmV0LnRva2VuO1xuICAgIHJldHVybiBjYWNoZWROb3RlaHViVG9rZW47XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3IgZmV0Y2hpbmcgTm90ZWh1YiB0b2tlbjonLCBlcnJvcik7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cblxuY29uc3QgaGVhZGVycyA9IHtcbiAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLEF1dGhvcml6YXRpb24nLFxuICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctTWV0aG9kcyc6ICdHRVQsUFVULE9QVElPTlMnLFxufTtcblxuaW50ZXJmYWNlIEZsZWV0RGVmYXVsdHMge1xuICBtb2RlPzogc3RyaW5nO1xuICBncHNfaW50ZXJ2YWxfbWluPzogbnVtYmVyO1xuICBzeW5jX2ludGVydmFsX21pbj86IG51bWJlcjtcbiAgaGVhcnRiZWF0X2hvdXJzPzogbnVtYmVyO1xuICB0ZW1wX2FsZXJ0X2hpZ2hfYz86IG51bWJlcjtcbiAgdGVtcF9hbGVydF9sb3dfYz86IG51bWJlcjtcbiAgaHVtaWRpdHlfYWxlcnRfaGlnaD86IG51bWJlcjtcbiAgaHVtaWRpdHlfYWxlcnRfbG93PzogbnVtYmVyO1xuICB2b2x0YWdlX2FsZXJ0X2xvdz86IG51bWJlcjtcbiAgbW90aW9uX3NlbnNpdGl2aXR5Pzogc3RyaW5nO1xuICBhdWRpb19lbmFibGVkPzogYm9vbGVhbjtcbiAgbGVkX2VuYWJsZWQ/OiBib29sZWFuO1xufVxuXG4vLyBWYWxpZGF0aW9uIHNjaGVtYSBmb3IgZmxlZXQgZGVmYXVsdHNcbmNvbnN0IGZsZWV0RGVmYXVsdHNTY2hlbWE6IFJlY29yZDxzdHJpbmcsIHsgdHlwZTogc3RyaW5nOyBtaW4/OiBudW1iZXI7IG1heD86IG51bWJlcjsgdmFsdWVzPzogc3RyaW5nW10gfT4gPSB7XG4gIG1vZGU6IHsgdHlwZTogJ3N0cmluZycsIHZhbHVlczogWydkZW1vJywgJ3RyYW5zaXQnLCAnc3RvcmFnZScsICdzbGVlcCddIH0sXG4gIGdwc19pbnRlcnZhbF9taW46IHsgdHlwZTogJ251bWJlcicsIG1pbjogMSwgbWF4OiAxNDQwIH0sXG4gIHN5bmNfaW50ZXJ2YWxfbWluOiB7IHR5cGU6ICdudW1iZXInLCBtaW46IDEsIG1heDogMTQ0MCB9LFxuICBoZWFydGJlYXRfaG91cnM6IHsgdHlwZTogJ251bWJlcicsIG1pbjogMSwgbWF4OiAxNjggfSxcbiAgdGVtcF9hbGVydF9oaWdoX2M6IHsgdHlwZTogJ251bWJlcicsIG1pbjogLTQwLCBtYXg6IDg1IH0sXG4gIHRlbXBfYWxlcnRfbG93X2M6IHsgdHlwZTogJ251bWJlcicsIG1pbjogLTQwLCBtYXg6IDg1IH0sXG4gIGh1bWlkaXR5X2FsZXJ0X2hpZ2g6IHsgdHlwZTogJ251bWJlcicsIG1pbjogMCwgbWF4OiAxMDAgfSxcbiAgaHVtaWRpdHlfYWxlcnRfbG93OiB7IHR5cGU6ICdudW1iZXInLCBtaW46IDAsIG1heDogMTAwIH0sXG4gIHZvbHRhZ2VfYWxlcnRfbG93OiB7IHR5cGU6ICdudW1iZXInLCBtaW46IDMuMCwgbWF4OiA0LjIgfSxcbiAgbW90aW9uX3NlbnNpdGl2aXR5OiB7IHR5cGU6ICdzdHJpbmcnLCB2YWx1ZXM6IFsnbG93JywgJ21lZGl1bScsICdoaWdoJ10gfSxcbiAgYXVkaW9fZW5hYmxlZDogeyB0eXBlOiAnYm9vbGVhbicgfSxcbiAgbGVkX2VuYWJsZWQ6IHsgdHlwZTogJ2Jvb2xlYW4nIH0sXG59O1xuXG5mdW5jdGlvbiBpc0FkbWluKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyKTogYm9vbGVhbiB7XG4gIHRyeSB7XG4gICAgY29uc3QgY2xhaW1zID0gZXZlbnQucmVxdWVzdENvbnRleHQ/LmF1dGhvcml6ZXI/Lmp3dD8uY2xhaW1zO1xuICAgIGlmICghY2xhaW1zKSByZXR1cm4gZmFsc2U7XG5cbiAgICAvLyBjb2duaXRvOmdyb3VwcyBpcyBlaXRoZXIgYSBzdHJpbmcgb3IgYXJyYXkgZGVwZW5kaW5nIG9uIG51bWJlciBvZiBncm91cHNcbiAgICBjb25zdCBncm91cHMgPSBjbGFpbXNbJ2NvZ25pdG86Z3JvdXBzJ107XG4gICAgaWYgKEFycmF5LmlzQXJyYXkoZ3JvdXBzKSkge1xuICAgICAgcmV0dXJuIGdyb3Vwcy5pbmNsdWRlcygnQWRtaW4nKTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBncm91cHMgPT09ICdzdHJpbmcnKSB7XG4gICAgICByZXR1cm4gZ3JvdXBzID09PSAnQWRtaW4nIHx8IGdyb3Vwcy5pbmNsdWRlcygnQWRtaW4nKTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9IGNhdGNoIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuLyoqXG4gKiBQdXNoIGZsZWV0IGRlZmF1bHRzIHRvIE5vdGVodWIgYXMgZmxlZXQgZW52aXJvbm1lbnQgdmFyaWFibGVzXG4gKiBUaGlzIG1ha2VzIHRoZSBjb25maWcgYXZhaWxhYmxlIHRvIGFsbCBkZXZpY2VzIGluIHRoZSBmbGVldFxuICovXG5hc3luYyBmdW5jdGlvbiBwdXNoVG9Ob3RlaHViKGZsZWV0VWlkOiBzdHJpbmcsIGNvbmZpZzogRmxlZXREZWZhdWx0cyk6IFByb21pc2U8eyBzdWNjZXNzOiBib29sZWFuOyBlcnJvcj86IHN0cmluZyB9PiB7XG4gIGlmICghTk9URUhVQl9QUk9KRUNUX1VJRCkge1xuICAgIGNvbnNvbGUud2FybignTk9URUhVQl9QUk9KRUNUX1VJRCBub3QgY29uZmlndXJlZCwgc2tpcHBpbmcgTm90ZWh1YiBwdXNoJyk7XG4gICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiAnTm90ZWh1YiBub3QgY29uZmlndXJlZCcgfTtcbiAgfVxuXG4gIGNvbnN0IHRva2VuID0gYXdhaXQgZ2V0Tm90ZWh1YlRva2VuKCk7XG4gIGlmICghdG9rZW4pIHtcbiAgICByZXR1cm4geyBzdWNjZXNzOiBmYWxzZSwgZXJyb3I6ICdDb3VsZCBub3QgZ2V0IE5vdGVodWIgdG9rZW4nIH07XG4gIH1cblxuICAvLyBDb252ZXJ0IGNvbmZpZyB2YWx1ZXMgdG8gc3RyaW5ncyBmb3IgTm90ZWh1YiBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbiAgY29uc3QgZW52VmFyczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhjb25maWcpKSB7XG4gICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgIT09IG51bGwpIHtcbiAgICAgIGVudlZhcnNba2V5XSA9IFN0cmluZyh2YWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgdHJ5IHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKFxuICAgICAgYGh0dHBzOi8vYXBpLm5vdGVmaWxlLm5ldC92MS9wcm9qZWN0cy8ke05PVEVIVUJfUFJPSkVDVF9VSUR9L2ZsZWV0cy8ke2ZsZWV0VWlkfS9lbnZpcm9ubWVudF92YXJpYWJsZXNgLFxuICAgICAge1xuICAgICAgICBtZXRob2Q6ICdQVVQnLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7dG9rZW59YCxcbiAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICB9LFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVudmlyb25tZW50X3ZhcmlhYmxlczogZW52VmFycyB9KSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgY29uc3QgZXJyb3JUZXh0ID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpO1xuICAgICAgY29uc29sZS5lcnJvcignTm90ZWh1YiBBUEkgZXJyb3I6JywgcmVzcG9uc2Uuc3RhdHVzLCBlcnJvclRleHQpO1xuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIGVycm9yOiBgTm90ZWh1YiBBUEkgZXJyb3I6ICR7cmVzcG9uc2Uuc3RhdHVzfWAgfTtcbiAgICB9XG5cbiAgICBjb25zb2xlLmxvZyhgU3VjY2Vzc2Z1bGx5IHB1c2hlZCBmbGVldCBkZWZhdWx0cyB0byBOb3RlaHViIGZvciBmbGVldCAke2ZsZWV0VWlkfWApO1xuICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBwdXNoaW5nIHRvIE5vdGVodWI6JywgZXJyb3IpO1xuICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBlcnJvcjogU3RyaW5nKGVycm9yKSB9O1xuICB9XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlRmxlZXREZWZhdWx0cyhjb25maWc6IFJlY29yZDxzdHJpbmcsIHVua25vd24+KTogeyB2YWxpZDogYm9vbGVhbjsgZXJyb3JzOiBzdHJpbmdbXSB9IHtcbiAgY29uc3QgZXJyb3JzOiBzdHJpbmdbXSA9IFtdO1xuXG4gIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGNvbmZpZykpIHtcbiAgICBjb25zdCBzY2hlbWEgPSBmbGVldERlZmF1bHRzU2NoZW1hW2tleV07XG4gICAgaWYgKCFzY2hlbWEpIHtcbiAgICAgIGVycm9ycy5wdXNoKGBVbmtub3duIHNldHRpbmc6ICR7a2V5fWApO1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgaWYgKHNjaGVtYS50eXBlID09PSAnbnVtYmVyJykge1xuICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ251bWJlcicpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goYCR7a2V5fSBtdXN0IGJlIGEgbnVtYmVyYCk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgaWYgKHNjaGVtYS5taW4gIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSA8IHNjaGVtYS5taW4pIHtcbiAgICAgICAgZXJyb3JzLnB1c2goYCR7a2V5fSBtdXN0IGJlIGF0IGxlYXN0ICR7c2NoZW1hLm1pbn1gKTtcbiAgICAgIH1cbiAgICAgIGlmIChzY2hlbWEubWF4ICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgPiBzY2hlbWEubWF4KSB7XG4gICAgICAgIGVycm9ycy5wdXNoKGAke2tleX0gbXVzdCBiZSBhdCBtb3N0ICR7c2NoZW1hLm1heH1gKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHNjaGVtYS50eXBlID09PSAnc3RyaW5nJykge1xuICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goYCR7a2V5fSBtdXN0IGJlIGEgc3RyaW5nYCk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgaWYgKHNjaGVtYS52YWx1ZXMgJiYgIXNjaGVtYS52YWx1ZXMuaW5jbHVkZXModmFsdWUpKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKGAke2tleX0gbXVzdCBiZSBvbmUgb2Y6ICR7c2NoZW1hLnZhbHVlcy5qb2luKCcsICcpfWApO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoc2NoZW1hLnR5cGUgPT09ICdib29sZWFuJykge1xuICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ2Jvb2xlYW4nKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKGAke2tleX0gbXVzdCBiZSBhIGJvb2xlYW5gKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4geyB2YWxpZDogZXJyb3JzLmxlbmd0aCA9PT0gMCwgZXJyb3JzIH07XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYW5kbGVyKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHRWMj4ge1xuICBjb25zb2xlLmxvZygnRXZlbnQ6JywgSlNPTi5zdHJpbmdpZnkoZXZlbnQsIG51bGwsIDIpKTtcblxuICBjb25zdCBtZXRob2QgPSBldmVudC5yZXF1ZXN0Q29udGV4dC5odHRwLm1ldGhvZDtcbiAgY29uc3QgcGF0aCA9IGV2ZW50LnJhd1BhdGg7XG5cbiAgLy8gSGFuZGxlIE9QVElPTlMgZm9yIENPUlNcbiAgaWYgKG1ldGhvZCA9PT0gJ09QVElPTlMnKSB7XG4gICAgcmV0dXJuIHsgc3RhdHVzQ29kZTogMjAwLCBoZWFkZXJzLCBib2R5OiAnJyB9O1xuICB9XG5cbiAgdHJ5IHtcbiAgICAvLyBHRVQgL3YxL3NldHRpbmdzL2ZsZWV0LWRlZmF1bHRzIC0gTGlzdCBhbGwgZmxlZXQgZGVmYXVsdHMgKGFkbWluIG9ubHkpXG4gICAgaWYgKG1ldGhvZCA9PT0gJ0dFVCcgJiYgcGF0aCA9PT0gJy92MS9zZXR0aW5ncy9mbGVldC1kZWZhdWx0cycpIHtcbiAgICAgIGlmICghaXNBZG1pbihldmVudCkpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdGF0dXNDb2RlOiA0MDMsXG4gICAgICAgICAgaGVhZGVycyxcbiAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnQWRtaW4gYWNjZXNzIHJlcXVpcmVkJyB9KSxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQobmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICAgIFRhYmxlTmFtZTogU0VUVElOR1NfVEFCTEUsXG4gICAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdzZXR0aW5nX3R5cGUgPSA6dHlwZScsXG4gICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgICAnOnR5cGUnOiAnZmxlZXRfZGVmYXVsdHMnLFxuICAgICAgICB9LFxuICAgICAgfSkpO1xuXG4gICAgICBjb25zdCBmbGVldERlZmF1bHRzID0gKHJlc3VsdC5JdGVtcyB8fCBbXSkubWFwKGl0ZW0gPT4gKHtcbiAgICAgICAgZmxlZXRfdWlkOiBpdGVtLnNldHRpbmdfaWQsXG4gICAgICAgIC4uLml0ZW0uY29uZmlnLFxuICAgICAgICB1cGRhdGVkX2F0OiBpdGVtLnVwZGF0ZWRfYXQsXG4gICAgICAgIHVwZGF0ZWRfYnk6IGl0ZW0udXBkYXRlZF9ieSxcbiAgICAgIH0pKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGZsZWV0X2RlZmF1bHRzOiBmbGVldERlZmF1bHRzIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBHRVQgL3YxL3NldHRpbmdzL2ZsZWV0LWRlZmF1bHRzL3tmbGVldH0gLSBHZXQgc3BlY2lmaWMgZmxlZXQgZGVmYXVsdHNcbiAgICBpZiAobWV0aG9kID09PSAnR0VUJyAmJiBwYXRoLnN0YXJ0c1dpdGgoJy92MS9zZXR0aW5ncy9mbGVldC1kZWZhdWx0cy8nKSkge1xuICAgICAgY29uc3QgZmxlZXRVaWQgPSBldmVudC5wYXRoUGFyYW1ldGVycz8uZmxlZXQ7XG4gICAgICBpZiAoIWZsZWV0VWlkKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgICAgIGhlYWRlcnMsXG4gICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0ZsZWV0IFVJRCByZXF1aXJlZCcgfSksXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKG5ldyBHZXRDb21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBTRVRUSU5HU19UQUJMRSxcbiAgICAgICAgS2V5OiB7XG4gICAgICAgICAgc2V0dGluZ190eXBlOiAnZmxlZXRfZGVmYXVsdHMnLFxuICAgICAgICAgIHNldHRpbmdfaWQ6IGZsZWV0VWlkLFxuICAgICAgICB9LFxuICAgICAgfSkpO1xuXG4gICAgICBpZiAoIXJlc3VsdC5JdGVtKSB7XG4gICAgICAgIC8vIFJldHVybiBlbXB0eSBkZWZhdWx0cyBpZiBub25lIHNldFxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgICAgICBoZWFkZXJzLFxuICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgIGZsZWV0X3VpZDogZmxlZXRVaWQsXG4gICAgICAgICAgICBjb25maWc6IHt9LFxuICAgICAgICAgICAgc2NoZW1hOiBmbGVldERlZmF1bHRzU2NoZW1hLFxuICAgICAgICAgIH0pLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICAgIGhlYWRlcnMsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBmbGVldF91aWQ6IGZsZWV0VWlkLFxuICAgICAgICAgIGNvbmZpZzogcmVzdWx0Lkl0ZW0uY29uZmlnIHx8IHt9LFxuICAgICAgICAgIHNjaGVtYTogZmxlZXREZWZhdWx0c1NjaGVtYSxcbiAgICAgICAgICB1cGRhdGVkX2F0OiByZXN1bHQuSXRlbS51cGRhdGVkX2F0LFxuICAgICAgICAgIHVwZGF0ZWRfYnk6IHJlc3VsdC5JdGVtLnVwZGF0ZWRfYnksXG4gICAgICAgIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBQVVQgL3YxL3NldHRpbmdzL2ZsZWV0LWRlZmF1bHRzL3tmbGVldH0gLSBVcGRhdGUgZmxlZXQgZGVmYXVsdHMgKGFkbWluIG9ubHkpXG4gICAgaWYgKG1ldGhvZCA9PT0gJ1BVVCcgJiYgcGF0aC5zdGFydHNXaXRoKCcvdjEvc2V0dGluZ3MvZmxlZXQtZGVmYXVsdHMvJykpIHtcbiAgICAgIGlmICghaXNBZG1pbihldmVudCkpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdGF0dXNDb2RlOiA0MDMsXG4gICAgICAgICAgaGVhZGVycyxcbiAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnQWRtaW4gYWNjZXNzIHJlcXVpcmVkJyB9KSxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZmxlZXRVaWQgPSBldmVudC5wYXRoUGFyYW1ldGVycz8uZmxlZXQ7XG4gICAgICBpZiAoIWZsZWV0VWlkKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgICAgIGhlYWRlcnMsXG4gICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0ZsZWV0IFVJRCByZXF1aXJlZCcgfSksXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGxldCBjb25maWc6IEZsZWV0RGVmYXVsdHM7XG4gICAgICB0cnkge1xuICAgICAgICBjb25maWcgPSBKU09OLnBhcnNlKGV2ZW50LmJvZHkgfHwgJ3t9Jyk7XG4gICAgICB9IGNhdGNoIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdGF0dXNDb2RlOiA0MDAsXG4gICAgICAgICAgaGVhZGVycyxcbiAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnSW52YWxpZCBKU09OIGJvZHknIH0pLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICAvLyBWYWxpZGF0ZSBjb25maWdcbiAgICAgIGNvbnN0IHZhbGlkYXRpb24gPSB2YWxpZGF0ZUZsZWV0RGVmYXVsdHMoY29uZmlnIGFzIFJlY29yZDxzdHJpbmcsIHVua25vd24+KTtcbiAgICAgIGlmICghdmFsaWRhdGlvbi52YWxpZCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgICAgICBoZWFkZXJzLFxuICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdWYWxpZGF0aW9uIGZhaWxlZCcsIGRldGFpbHM6IHZhbGlkYXRpb24uZXJyb3JzIH0pLFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICAvLyBHZXQgdXNlciBpbmZvIGZyb20gSldUIGNsYWltc1xuICAgICAgY29uc3QgY2xhaW1zID0gZXZlbnQucmVxdWVzdENvbnRleHQ/LmF1dGhvcml6ZXI/Lmp3dD8uY2xhaW1zO1xuICAgICAgY29uc3QgdXNlckVtYWlsID0gY2xhaW1zPy5lbWFpbCB8fCBjbGFpbXM/LnN1YiB8fCAndW5rbm93bic7XG5cbiAgICAgIC8vIFN0b3JlIHNldHRpbmdzIGluIER5bmFtb0RCIChmb3IgZGFzaGJvYXJkIFVJKVxuICAgICAgYXdhaXQgZG9jQ2xpZW50LnNlbmQobmV3IFB1dENvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IFNFVFRJTkdTX1RBQkxFLFxuICAgICAgICBJdGVtOiB7XG4gICAgICAgICAgc2V0dGluZ190eXBlOiAnZmxlZXRfZGVmYXVsdHMnLFxuICAgICAgICAgIHNldHRpbmdfaWQ6IGZsZWV0VWlkLFxuICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICB1cGRhdGVkX2F0OiBEYXRlLm5vdygpLFxuICAgICAgICAgIHVwZGF0ZWRfYnk6IHVzZXJFbWFpbCxcbiAgICAgICAgfSxcbiAgICAgIH0pKTtcblxuICAgICAgLy8gUHVzaCB0byBOb3RlaHViIGFzIGZsZWV0IGVudmlyb25tZW50IHZhcmlhYmxlcyAoc28gZGV2aWNlcyByZWNlaXZlIHRoZSBjb25maWcpXG4gICAgICBjb25zdCBub3RlaHViUmVzdWx0ID0gYXdhaXQgcHVzaFRvTm90ZWh1YihmbGVldFVpZCwgY29uZmlnKTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgICBoZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgZmxlZXRfdWlkOiBmbGVldFVpZCxcbiAgICAgICAgICBjb25maWcsXG4gICAgICAgICAgdXBkYXRlZF9hdDogRGF0ZS5ub3coKSxcbiAgICAgICAgICB1cGRhdGVkX2J5OiB1c2VyRW1haWwsXG4gICAgICAgICAgbm90ZWh1Yl9zeW5jOiBub3RlaHViUmVzdWx0LnN1Y2Nlc3MsXG4gICAgICAgICAgbm90ZWh1Yl9lcnJvcjogbm90ZWh1YlJlc3VsdC5lcnJvcixcbiAgICAgICAgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA0MDQsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ05vdCBmb3VuZCcgfSksXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyB9KSxcbiAgICB9O1xuICB9XG59XG4iXX0=