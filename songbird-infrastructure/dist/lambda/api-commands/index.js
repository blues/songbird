"use strict";
/**
 * Commands API Lambda
 *
 * Sends commands to devices via Notehub API:
 * - GET /v1/commands - Get all commands across devices
 * - DELETE /v1/commands/{command_id} - Delete a command
 * - POST /devices/{serial_number}/commands - Send command to device (routes to current Notecard)
 * - GET /devices/{serial_number}/commands - Get command history for a device (merged from all Notecards)
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_secrets_manager_1 = require("@aws-sdk/client-secrets-manager");
const crypto_1 = require("crypto");
const device_lookup_1 = require("../shared/device-lookup");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient);
const secretsClient = new client_secrets_manager_1.SecretsManagerClient({});
const COMMANDS_TABLE = process.env.COMMANDS_TABLE;
const NOTEHUB_PROJECT_UID = process.env.NOTEHUB_PROJECT_UID;
const NOTEHUB_SECRET_ARN = process.env.NOTEHUB_SECRET_ARN;
// Cache the token to avoid fetching on every request
let cachedToken = null;
async function getNotehubToken() {
    if (cachedToken) {
        return cachedToken;
    }
    const command = new client_secrets_manager_1.GetSecretValueCommand({ SecretId: NOTEHUB_SECRET_ARN });
    const response = await secretsClient.send(command);
    if (!response.SecretString) {
        throw new Error('Notehub API token not found in secret');
    }
    const secret = JSON.parse(response.SecretString);
    cachedToken = secret.token;
    if (!cachedToken) {
        throw new Error('Token field not found in secret');
    }
    return cachedToken;
}
// Supported commands
const VALID_COMMANDS = ['ping', 'locate', 'play_melody', 'test_audio', 'set_volume'];
const handler = async (event) => {
    console.log('Request:', JSON.stringify(event));
    const corsHeaders = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type,Authorization',
        'Access-Control-Allow-Methods': 'GET,POST,DELETE,OPTIONS',
    };
    try {
        // HTTP API v2 uses requestContext.http.method, REST API v1 uses httpMethod
        const method = event.requestContext?.http?.method || event.httpMethod;
        const path = event.requestContext?.http?.path || event.path;
        if (method === 'OPTIONS') {
            return { statusCode: 200, headers: corsHeaders, body: '' };
        }
        // Handle /v1/commands endpoint (all commands across devices)
        if (path === '/v1/commands' && method === 'GET') {
            const deviceUid = event.queryStringParameters?.device_uid;
            return await getAllCommands(deviceUid, corsHeaders);
        }
        // Handle DELETE /v1/commands/{command_id}
        const commandId = event.pathParameters?.command_id;
        if (commandId && method === 'DELETE') {
            const deviceUid = event.queryStringParameters?.device_uid;
            if (!deviceUid) {
                return {
                    statusCode: 400,
                    headers: corsHeaders,
                    body: JSON.stringify({ error: 'device_uid query parameter required' }),
                };
            }
            return await deleteCommand(deviceUid, commandId, corsHeaders);
        }
        // Handle device-specific commands endpoints
        const serialNumber = event.pathParameters?.serial_number;
        if (!serialNumber) {
            return {
                statusCode: 400,
                headers: corsHeaders,
                body: JSON.stringify({ error: 'serial_number required' }),
            };
        }
        // Resolve serial_number to device info
        const resolved = await (0, device_lookup_1.resolveDevice)(serialNumber);
        if (!resolved) {
            return {
                statusCode: 404,
                headers: corsHeaders,
                body: JSON.stringify({ error: 'Device not found' }),
            };
        }
        if (method === 'POST') {
            // Send command to the CURRENT device_uid (the active Notecard)
            return await sendCommand(resolved.device_uid, resolved.serial_number, event.body, corsHeaders);
        }
        if (method === 'GET') {
            // Get command history from ALL device_uids (merged across Notecard swaps)
            return await getCommandHistory(resolved.serial_number, resolved.all_device_uids, corsHeaders);
        }
        return {
            statusCode: 405,
            headers: corsHeaders,
            body: JSON.stringify({ error: 'Method not allowed' }),
        };
    }
    catch (error) {
        console.error('Error:', error);
        return {
            statusCode: 500,
            headers: corsHeaders,
            body: JSON.stringify({ error: 'Internal server error' }),
        };
    }
};
exports.handler = handler;
async function sendCommand(deviceUid, serialNumber, body, headers) {
    if (!body) {
        return {
            statusCode: 400,
            headers,
            body: JSON.stringify({ error: 'Request body required' }),
        };
    }
    const request = JSON.parse(body);
    const { cmd, params } = request;
    // Validate command
    if (!cmd || !VALID_COMMANDS.includes(cmd)) {
        return {
            statusCode: 400,
            headers,
            body: JSON.stringify({
                error: 'Invalid command',
                valid_commands: VALID_COMMANDS,
            }),
        };
    }
    // Generate command ID
    const commandId = `cmd_${(0, crypto_1.randomUUID)().replace(/-/g, '').substring(0, 12)}`;
    const now = Date.now();
    // Build command note body
    const noteBody = {
        cmd,
        params: params || {},
        command_id: commandId,
        sent_at: now,
    };
    // Send to Notehub API (using the current device_uid for the active Notecard)
    try {
        const notehubToken = await getNotehubToken();
        const notehubResponse = await fetch(`https://api.notefile.net/v1/projects/${NOTEHUB_PROJECT_UID}/devices/${deviceUid}/notes/command.qi`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${notehubToken}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ body: noteBody }),
        });
        if (!notehubResponse.ok) {
            const errorText = await notehubResponse.text();
            console.error('Notehub API error:', errorText);
            return {
                statusCode: 502,
                headers,
                body: JSON.stringify({
                    error: 'Failed to send command to Notehub',
                    details: errorText,
                }),
            };
        }
        // Store command in history (include serial_number for reference)
        await storeCommand(deviceUid, serialNumber, commandId, cmd, params, now);
        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({
                command_id: commandId,
                serial_number: serialNumber,
                device_uid: deviceUid,
                cmd,
                params: params || {},
                status: 'queued',
                queued_at: new Date(now).toISOString(),
            }),
        };
    }
    catch (error) {
        console.error('Error sending command to Notehub:', error);
        return {
            statusCode: 502,
            headers,
            body: JSON.stringify({
                error: 'Failed to communicate with Notehub',
            }),
        };
    }
}
async function storeCommand(deviceUid, serialNumber, commandId, cmd, params, timestamp) {
    const command = new lib_dynamodb_1.PutCommand({
        TableName: COMMANDS_TABLE,
        Item: {
            device_uid: deviceUid,
            serial_number: serialNumber,
            command_id: commandId,
            cmd,
            params: params || {},
            status: 'queued',
            created_at: timestamp,
            updated_at: timestamp,
            ttl: Math.floor(timestamp / 1000) + 30 * 24 * 60 * 60, // 30 days TTL
        },
    });
    await docClient.send(command);
}
async function getCommandHistory(serialNumber, deviceUids, headers) {
    // Query all device_uids in parallel to get merged command history
    const queryPromises = deviceUids.map(async (deviceUid) => {
        const command = new lib_dynamodb_1.QueryCommand({
            TableName: COMMANDS_TABLE,
            IndexName: 'device-created-index',
            KeyConditionExpression: 'device_uid = :device_uid',
            ExpressionAttributeValues: {
                ':device_uid': deviceUid,
            },
            ScanIndexForward: false,
            Limit: 50,
        });
        const result = await docClient.send(command);
        return result.Items || [];
    });
    const allResults = await Promise.all(queryPromises);
    // Merge and sort by created_at (most recent first)
    const mergedCommands = allResults
        .flat()
        .sort((a, b) => b.created_at - a.created_at)
        .slice(0, 50); // Limit to 50 total
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
            serial_number: serialNumber,
            commands: mergedCommands,
        }),
    };
}
async function getAllCommands(deviceUid, headers) {
    // If device_uid is provided, use the existing query
    if (deviceUid) {
        const command = new lib_dynamodb_1.QueryCommand({
            TableName: COMMANDS_TABLE,
            IndexName: 'device-created-index',
            KeyConditionExpression: 'device_uid = :device_uid',
            ExpressionAttributeValues: {
                ':device_uid': deviceUid,
            },
            ScanIndexForward: false,
            Limit: 100,
        });
        const result = await docClient.send(command);
        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({
                commands: result.Items || [],
                total: result.Items?.length || 0,
            }),
        };
    }
    // Otherwise, scan for all commands (limited to 100 most recent)
    const command = new lib_dynamodb_1.ScanCommand({
        TableName: COMMANDS_TABLE,
        Limit: 200, // Fetch more to allow sorting
    });
    const result = await docClient.send(command);
    // Sort by created_at descending and take the first 100
    const sortedCommands = (result.Items || [])
        .sort((a, b) => (b.created_at || 0) - (a.created_at || 0))
        .slice(0, 100);
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
            commands: sortedCommands,
            total: sortedCommands.length,
        }),
    };
}
async function deleteCommand(deviceUid, commandId, headers) {
    // First verify the command exists
    const getCmd = new lib_dynamodb_1.GetCommand({
        TableName: COMMANDS_TABLE,
        Key: {
            device_uid: deviceUid,
            command_id: commandId,
        },
    });
    const existing = await docClient.send(getCmd);
    if (!existing.Item) {
        return {
            statusCode: 404,
            headers,
            body: JSON.stringify({ error: 'Command not found' }),
        };
    }
    // Delete the command
    const deleteCmd = new lib_dynamodb_1.DeleteCommand({
        TableName: COMMANDS_TABLE,
        Key: {
            device_uid: deviceUid,
            command_id: commandId,
        },
    });
    await docClient.send(deleteCmd);
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
            message: 'Command deleted',
            command_id: commandId,
        }),
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvYXBpLWNvbW1hbmRzL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7R0FRRzs7O0FBRUgsOERBQTBEO0FBQzFELHdEQU8rQjtBQUMvQiw0RUFBOEY7QUFFOUYsbUNBQW9DO0FBQ3BDLDJEQUF3RDtBQUV4RCxNQUFNLFNBQVMsR0FBRyxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDekMsTUFBTSxTQUFTLEdBQUcscUNBQXNCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ3pELE1BQU0sYUFBYSxHQUFHLElBQUksNkNBQW9CLENBQUMsRUFBRSxDQUFDLENBQUM7QUFFbkQsTUFBTSxjQUFjLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFlLENBQUM7QUFDbkQsTUFBTSxtQkFBbUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFvQixDQUFDO0FBQzdELE1BQU0sa0JBQWtCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBbUIsQ0FBQztBQUUzRCxxREFBcUQ7QUFDckQsSUFBSSxXQUFXLEdBQWtCLElBQUksQ0FBQztBQUV0QyxLQUFLLFVBQVUsZUFBZTtJQUM1QixJQUFJLFdBQVcsRUFBRSxDQUFDO1FBQ2hCLE9BQU8sV0FBVyxDQUFDO0lBQ3JCLENBQUM7SUFFRCxNQUFNLE9BQU8sR0FBRyxJQUFJLDhDQUFxQixDQUFDLEVBQUUsUUFBUSxFQUFFLGtCQUFrQixFQUFFLENBQUMsQ0FBQztJQUM1RSxNQUFNLFFBQVEsR0FBRyxNQUFNLGFBQWEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFbkQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUMzQixNQUFNLElBQUksS0FBSyxDQUFDLHVDQUF1QyxDQUFDLENBQUM7SUFDM0QsQ0FBQztJQUVELE1BQU0sTUFBTSxH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LE1BQU07U0FDN0IsQ0FBQztLQUNILENBQUM7QUFDSixDQUFDO0FBRUQsS0FBSyxVQUFVLGFBQWEsQ0FDMUIsU0FBaUIsRUFDakIsU0FBaUIsRUFDakIsT0FBK0I7SUFFL0Isa0NBQWtDO0lBQ2xDLE1BQU0sTUFBTSxHQUFHLElBQUkseUJBQVUsQ0FBQztRQUM1QixTQUFTLEVBQUUsY0FBYztRQUN6QixHQUFHLEVBQUU7WUFDSCxVQUFVLEVBQUUsU0FBUztZQUNyQixVQUFVLEVBQUUsU0FBUztTQUN0QjtLQUNGLENBQUMsQ0FBQztJQUVILE1BQU0sUUFBUSxHQUFHLE1BQU0sU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM5QyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ25CLE9BQU87WUFDTCxVQUFVLEVBQUUsR0FBRztZQUNmLE9BQU87WUFDUCxJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLEtBQUssRUFBRSxtQkFBbUIsRUFBRSxDQUFDO1NBQ3JELENBQUM7SUFDSixDQUFDO0lBRUQscUJBQXFCO0lBQ3JCLE1BQU0sU0FBUyxHQUFHLElBQUksNEJBQWEsQ0FBQztRQUNsQyxTQUFTLEVBQUUsY0FBYztRQUN6QixHQUFHLEVBQUU7WUFDSCxVQUFVLEVBQUUsU0FBUztZQUNyQixVQUFVLEVBQUUsU0FBUztTQUN0QjtLQUNGLENBQUMsQ0FBQztJQUVILE1BQU0sU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUVoQyxPQUFPO1FBQ0wsVUFBVSxFQUFFLEdBQUc7UUFDZixPQUFPO1FBQ1AsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7WUFDbkIsT0FBTyxFQUFFLGlCQUFpQjtZQUMxQixVQUFVLEVBQUUsU0FBUztTQUN0QixDQUFDO0tBQ0gsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvbW1hbmRzIEFQSSBMYW1iZGFcbiAqXG4gKiBTZW5kcyBjb21tYW5kcyB0byBkZXZpY2VzIHZpYSBOb3RlaHViIEFQSTpcbiAqIC0gR0VUIC92MS9jb21tYW5kcyAtIEdldCBhbGwgY29tbWFuZHMgYWNyb3NzIGRldmljZXNcbiAqIC0gREVMRVRFIC92MS9jb21tYW5kcy97Y29tbWFuZF9pZH0gLSBEZWxldGUgYSBjb21tYW5kXG4gKiAtIFBPU1QgL2RldmljZXMve3NlcmlhbF9udW1iZXJ9L2NvbW1hbmRzIC0gU2VuZCBjb21tYW5kIHRvIGRldmljZSAocm91dGVzIHRvIGN1cnJlbnQgTm90ZWNhcmQpXG4gKiAtIEdFVCAvZGV2aWNlcy97c2VyaWFsX251bWJlcn0vY29tbWFuZHMgLSBHZXQgY29tbWFuZCBoaXN0b3J5IGZvciBhIGRldmljZSAobWVyZ2VkIGZyb20gYWxsIE5vdGVjYXJkcylcbiAqL1xuXG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQge1xuICBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LFxuICBQdXRDb21tYW5kLFxuICBRdWVyeUNvbW1hbmQsXG4gIFNjYW5Db21tYW5kLFxuICBEZWxldGVDb21tYW5kLFxuICBHZXRDb21tYW5kLFxufSBmcm9tICdAYXdzLXNkay9saWItZHluYW1vZGInO1xuaW1wb3J0IHsgU2VjcmV0c01hbmFnZXJDbGllbnQsIEdldFNlY3JldFZhbHVlQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zZWNyZXRzLW1hbmFnZXInO1xuaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgcmFuZG9tVVVJRCB9IGZyb20gJ2NyeXB0byc7XG5pbXBvcnQgeyByZXNvbHZlRGV2aWNlIH0gZnJvbSAnLi4vc2hhcmVkL2RldmljZS1sb29rdXAnO1xuXG5jb25zdCBkZGJDbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGRkYkNsaWVudCk7XG5jb25zdCBzZWNyZXRzQ2xpZW50ID0gbmV3IFNlY3JldHNNYW5hZ2VyQ2xpZW50KHt9KTtcblxuY29uc3QgQ09NTUFORFNfVEFCTEUgPSBwcm9jZXNzLmVudi5DT01NQU5EU19UQUJMRSE7XG5jb25zdCBOT1RFSFVCX1BST0pFQ1RfVUlEID0gcHJvY2Vzcy5lbnYuTk9URUhVQl9QUk9KRUNUX1VJRCE7XG5jb25zdCBOT1RFSFVCX1NFQ1JFVF9BUk4gPSBwcm9jZXNzLmVudi5OT1RFSFVCX1NFQ1JFVF9BUk4hO1xuXG4vLyBDYWNoZSB0aGUgdG9rZW4gdG8gYXZvaWQgZmV0Y2hpbmcgb24gZXZlcnkgcmVxdWVzdFxubGV0IGNhY2hlZFRva2VuOiBzdHJpbmcgfCBudWxsID0gbnVsbDtcblxuYXN5bmMgZnVuY3Rpb24gZ2V0Tm90ZWh1YlRva2VuKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gIGlmIChjYWNoZWRUb2tlbikge1xuICAgIHJldHVybiBjYWNoZWRUb2tlbjtcbiAgfVxuXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0U2VjcmV0VmFsdWVDb21tYW5kKHsgU2VjcmV0SWQ6IE5PVEVIVUJfU0VDUkVUX0FSTiB9KTtcbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBzZWNyZXRzQ2xpZW50LnNlbmQoY29tbWFuZCk7XG5cbiAgaWYgKCFyZXNwb25zZS5TZWNyZXRTdHJpbmcpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vdGVodWIgQVBJIHRva2VuIG5vdCBmb3VuZCBpbiBzZWNyZXQnKTtcbiAgfVxuXG4gIGNvbnN0IHNlY3JldCA9IEpTT04ucGFyc2UocmVzcG9uc2UuU2VjcmV0U3RyaW5nKTtcbiAgY2FjaGVkVG9rZW4gPSBzZWNyZXQudG9rZW47XG5cbiAgaWYgKCFjYWNoZWRUb2tlbikge1xuICAgIHRocm93IG5ldyBFcnJvcignVG9rZW4gZmllbGQgbm90IGZvdW5kIGluIHNlY3JldCcpO1xuICB9XG5cbiAgcmV0dXJuIGNhY2hlZFRva2VuO1xufVxuXG4vLyBTdXBwb3J0ZWQgY29tbWFuZHNcbmNvbnN0IFZBTElEX0NPTU1BTkRTID0gWydwaW5nJywgJ2xvY2F0ZScsICdwbGF5X21lbG9keScsICd0ZXN0X2F1ZGlvJywgJ3NldF92b2x1bWUnXTtcblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50KTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+ID0+IHtcbiAgY29uc29sZS5sb2coJ1JlcXVlc3Q6JywgSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTtcblxuICBjb25zdCBjb3JzSGVhZGVycyA9IHtcbiAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJzogJyonLFxuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJzogJ0NvbnRlbnQtVHlwZSxBdXRob3JpemF0aW9uJyxcbiAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctTWV0aG9kcyc6ICdHRVQsUE9TVCxERUxFVEUsT1BUSU9OUycsXG4gIH07XG5cbiAgdHJ5IHtcbiAgICAvLyBIVFRQIEFQSSB2MiB1c2VzIHJlcXVlc3RDb250ZXh0Lmh0dHAubWV0aG9kLCBSRVNUIEFQSSB2MSB1c2VzIGh0dHBNZXRob2RcbiAgICBjb25zdCBtZXRob2QgPSAoZXZlbnQucmVxdWVzdENvbnRleHQgYXMgYW55KT8uaHR0cD8ubWV0aG9kIHx8IGV2ZW50Lmh0dHBNZXRob2Q7XG4gICAgY29uc3QgcGF0aCA9IChldmVudC5yZXF1ZXN0Q29udGV4dCBhcyBhbnkpPy5odHRwPy5wYXRoIHx8IGV2ZW50LnBhdGg7XG5cbiAgICBpZiAobWV0aG9kID09PSAnT1BUSU9OUycpIHtcbiAgICAgIHJldHVybiB7IHN0YXR1c0NvZGU6IDIwMCwgaGVhZGVyczogY29yc0hlYWRlcnMsIGJvZHk6ICcnIH07XG4gICAgfVxuXG4gICAgLy8gSGFuZGxlIC92MS9jb21tYW5kcyBlbmRwb2ludCAoYWxsIGNvbW1hbmRzIGFjcm9zcyBkZXZpY2VzKVxuICAgIGlmIChwYXRoID09PSAnL3YxL2NvbW1hbmRzJyAmJiBtZXRob2QgPT09ICdHRVQnKSB7XG4gICAgICBjb25zdCBkZXZpY2VVaWQgPSBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnM/LmRldmljZV91aWQ7XG4gICAgICByZXR1cm4gYXdhaXQgZ2V0QWxsQ29tbWFuZHMoZGV2aWNlVWlkLCBjb3JzSGVhZGVycyk7XG4gICAgfVxuXG4gICAgLy8gSGFuZGxlIERFTEVURSAvdjEvY29tbWFuZHMve2NvbW1hbmRfaWR9XG4gICAgY29uc3QgY29tbWFuZElkID0gZXZlbnQucGF0aFBhcmFtZXRlcnM/LmNvbW1hbmRfaWQ7XG4gICAgaWYgKGNvbW1hbmRJZCAmJiBtZXRob2QgPT09ICdERUxFVEUnKSB7XG4gICAgICBjb25zdCBkZXZpY2VVaWQgPSBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnM/LmRldmljZV91aWQ7XG4gICAgICBpZiAoIWRldmljZVVpZCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgICAgICBoZWFkZXJzOiBjb3JzSGVhZGVycyxcbiAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnZGV2aWNlX3VpZCBxdWVyeSBwYXJhbWV0ZXIgcmVxdWlyZWQnIH0pLFxuICAgICAgICB9O1xuICAgICAgfVxuICAgICAgcmV0dXJuIGF3YWl0IGRlbGV0ZUNvbW1hbmQoZGV2aWNlVWlkLCBjb21tYW5kSWQsIGNvcnNIZWFkZXJzKTtcbiAgICB9XG5cbiAgICAvLyBIYW5kbGUgZGV2aWNlLXNwZWNpZmljIGNvbW1hbmRzIGVuZHBvaW50c1xuICAgIGNvbnN0IHNlcmlhbE51bWJlciA9IGV2ZW50LnBhdGhQYXJhbWV0ZXJzPy5zZXJpYWxfbnVtYmVyO1xuICAgIGlmICghc2VyaWFsTnVtYmVyKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXNDb2RlOiA0MDAsXG4gICAgICAgIGhlYWRlcnM6IGNvcnNIZWFkZXJzLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnc2VyaWFsX251bWJlciByZXF1aXJlZCcgfSksXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIFJlc29sdmUgc2VyaWFsX251bWJlciB0byBkZXZpY2UgaW5mb1xuICAgIGNvbnN0IHJlc29sdmVkID0gYXdhaXQgcmVzb2x2ZURldmljZShzZXJpYWxOdW1iZXIpO1xuICAgIGlmICghcmVzb2x2ZWQpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDQwNCxcbiAgICAgICAgaGVhZGVyczogY29yc0hlYWRlcnMsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdEZXZpY2Ugbm90IGZvdW5kJyB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgaWYgKG1ldGhvZCA9PT0gJ1BPU1QnKSB7XG4gICAgICAvLyBTZW5kIGNvbW1hbmQgdG8gdGhlIENVUlJFTlQgZGV2aWNlX3VpZCAodGhlIGFjdGl2ZSBOb3RlY2FyZClcbiAgICAgIHJldHVybiBhd2FpdCBzZW5kQ29tbWFuZChyZXNvbHZlZC5kZXZpY2VfdWlkLCByZXNvbHZlZC5zZXJpYWxfbnVtYmVyLCBldmVudC5ib2R5LCBjb3JzSGVhZGVycyk7XG4gICAgfVxuXG4gICAgaWYgKG1ldGhvZCA9PT0gJ0dFVCcpIHtcbiAgICAgIC8vIEdldCBjb21tYW5kIGhpc3RvcnkgZnJvbSBBTEwgZGV2aWNlX3VpZHMgKG1lcmdlZCBhY3Jvc3MgTm90ZWNhcmQgc3dhcHMpXG4gICAgICByZXR1cm4gYXdhaXQgZ2V0Q29tbWFuZEhpc3RvcnkocmVzb2x2ZWQuc2VyaWFsX251bWJlciwgcmVzb2x2ZWQuYWxsX2RldmljZV91aWRzLCBjb3JzSGVhZGVycyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDQwNSxcbiAgICAgIGhlYWRlcnM6IGNvcnNIZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ01ldGhvZCBub3QgYWxsb3dlZCcgfSksXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICAgIGhlYWRlcnM6IGNvcnNIZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicgfSksXG4gICAgfTtcbiAgfVxufTtcblxuYXN5bmMgZnVuY3Rpb24gc2VuZENvbW1hbmQoXG4gIGRldmljZVVpZDogc3RyaW5nLFxuICBzZXJpYWxOdW1iZXI6IHN0cmluZyxcbiAgYm9keTogc3RyaW5nIHwgbnVsbCxcbiAgaGVhZGVyczogUmVjb3JkPHN0cmluZywgc3RyaW5nPlxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+IHtcbiAgaWYgKCFib2R5KSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnUmVxdWVzdCBib2R5IHJlcXVpcmVkJyB9KSxcbiAgICB9O1xuICB9XG5cbiAgY29uc3QgcmVxdWVzdCA9IEpTT04ucGFyc2UoYm9keSk7XG4gIGNvbnN0IHsgY21kLCBwYXJhbXMgfSA9IHJlcXVlc3Q7XG5cbiAgLy8gVmFsaWRhdGUgY29tbWFuZFxuICBpZiAoIWNtZCB8fCAhVkFMSURfQ09NTUFORFMuaW5jbHVkZXMoY21kKSkge1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA0MDAsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBlcnJvcjogJ0ludmFsaWQgY29tbWFuZCcsXG4gICAgICAgIHZhbGlkX2NvbW1hbmRzOiBWQUxJRF9DT01NQU5EUyxcbiAgICAgIH0pLFxuICAgIH07XG4gIH1cblxuICAvLyBHZW5lcmF0ZSBjb21tYW5kIElEXG4gIGNvbnN0IGNvbW1hbmRJZCA9IGBjbWRfJHtyYW5kb21VVUlEKCkucmVwbGFjZSgvLS9nLCAnJykuc3Vic3RyaW5nKDAsIDEyKX1gO1xuICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuXG4gIC8vIEJ1aWxkIGNvbW1hbmQgbm90ZSBib2R5XG4gIGNvbnN0IG5vdGVCb2R5ID0ge1xuICAgIGNtZCxcbiAgICBwYXJhbXM6IHBhcmFtcyB8fCB7fSxcbiAgICBjb21tYW5kX2lkOiBjb21tYW5kSWQsXG4gICAgc2VudF9hdDogbm93LFxuICB9O1xuXG4gIC8vIFNlbmQgdG8gTm90ZWh1YiBBUEkgKHVzaW5nIHRoZSBjdXJyZW50IGRldmljZV91aWQgZm9yIHRoZSBhY3RpdmUgTm90ZWNhcmQpXG4gIHRyeSB7XG4gICAgY29uc3Qgbm90ZWh1YlRva2VuID0gYXdhaXQgZ2V0Tm90ZWh1YlRva2VuKCk7XG4gICAgY29uc3Qgbm90ZWh1YlJlc3BvbnNlID0gYXdhaXQgZmV0Y2goXG4gICAgICBgaHR0cHM6Ly9hcGkubm90ZWZpbGUubmV0L3YxL3Byb2plY3RzLyR7Tk9URUhVQl9QUk9KRUNUX1VJRH0vZGV2aWNlcy8ke2RldmljZVVpZH0vbm90ZXMvY29tbWFuZC5xaWAsXG4gICAgICB7XG4gICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgJ0F1dGhvcml6YXRpb24nOiBgQmVhcmVyICR7bm90ZWh1YlRva2VufWAsXG4gICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgfSxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBib2R5OiBub3RlQm9keSB9KSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgaWYgKCFub3RlaHViUmVzcG9uc2Uub2spIHtcbiAgICAgIGNvbnN0IGVycm9yVGV4dCA9IGF3YWl0IG5vdGVodWJSZXNwb25zZS50ZXh0KCk7XG4gICAgICBjb25zb2xlLmVycm9yKCdOb3RlaHViIEFQSSBlcnJvcjonLCBlcnJvclRleHQpO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXNDb2RlOiA1MDIsXG4gICAgICAgIGhlYWRlcnMsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBlcnJvcjogJ0ZhaWxlZCB0byBzZW5kIGNvbW1hbmQgdG8gTm90ZWh1YicsXG4gICAgICAgICAgZGV0YWlsczogZXJyb3JUZXh0LFxuICAgICAgICB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gU3RvcmUgY29tbWFuZCBpbiBoaXN0b3J5IChpbmNsdWRlIHNlcmlhbF9udW1iZXIgZm9yIHJlZmVyZW5jZSlcbiAgICBhd2FpdCBzdG9yZUNvbW1hbmQoZGV2aWNlVWlkLCBzZXJpYWxOdW1iZXIsIGNvbW1hbmRJZCwgY21kLCBwYXJhbXMsIG5vdyk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgaGVhZGVycyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgY29tbWFuZF9pZDogY29tbWFuZElkLFxuICAgICAgICBzZXJpYWxfbnVtYmVyOiBzZXJpYWxOdW1iZXIsXG4gICAgICAgIGRldmljZV91aWQ6IGRldmljZVVpZCxcbiAgICAgICAgY21kLFxuICAgICAgICBwYXJhbXM6IHBhcmFtcyB8fCB7fSxcbiAgICAgICAgc3RhdHVzOiAncXVldWVkJyxcbiAgICAgICAgcXVldWVkX2F0OiBuZXcgRGF0ZShub3cpLnRvSVNPU3RyaW5nKCksXG4gICAgICB9KSxcbiAgICB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHNlbmRpbmcgY29tbWFuZCB0byBOb3RlaHViOicsIGVycm9yKTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA1MDIsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBlcnJvcjogJ0ZhaWxlZCB0byBjb21tdW5pY2F0ZSB3aXRoIE5vdGVodWInLFxuICAgICAgfSksXG4gICAgfTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBzdG9yZUNvbW1hbmQoXG4gIGRldmljZVVpZDogc3RyaW5nLFxuICBzZXJpYWxOdW1iZXI6IHN0cmluZyxcbiAgY29tbWFuZElkOiBzdHJpbmcsXG4gIGNtZDogc3RyaW5nLFxuICBwYXJhbXM6IGFueSxcbiAgdGltZXN0YW1wOiBudW1iZXJcbik6IFByb21pc2U8dm9pZD4ge1xuICBjb25zdCBjb21tYW5kID0gbmV3IFB1dENvbW1hbmQoe1xuICAgIFRhYmxlTmFtZTogQ09NTUFORFNfVEFCTEUsXG4gICAgSXRlbToge1xuICAgICAgZGV2aWNlX3VpZDogZGV2aWNlVWlkLFxuICAgICAgc2VyaWFsX251bWJlcjogc2VyaWFsTnVtYmVyLFxuICAgICAgY29tbWFuZF9pZDogY29tbWFuZElkLFxuICAgICAgY21kLFxuICAgICAgcGFyYW1zOiBwYXJhbXMgfHwge30sXG4gICAgICBzdGF0dXM6ICdxdWV1ZWQnLFxuICAgICAgY3JlYXRlZF9hdDogdGltZXN0YW1wLFxuICAgICAgdXBkYXRlZF9hdDogdGltZXN0YW1wLFxuICAgICAgdHRsOiBNYXRoLmZsb29yKHRpbWVzdGFtcCAvIDEwMDApICsgMzAgKiAyNCAqIDYwICogNjAsIC8vIDMwIGRheXMgVFRMXG4gICAgfSxcbiAgfSk7XG5cbiAgYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldENvbW1hbmRIaXN0b3J5KFxuICBzZXJpYWxOdW1iZXI6IHN0cmluZyxcbiAgZGV2aWNlVWlkczogc3RyaW5nW10sXG4gIGhlYWRlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XG4gIC8vIFF1ZXJ5IGFsbCBkZXZpY2VfdWlkcyBpbiBwYXJhbGxlbCB0byBnZXQgbWVyZ2VkIGNvbW1hbmQgaGlzdG9yeVxuICBjb25zdCBxdWVyeVByb21pc2VzID0gZGV2aWNlVWlkcy5tYXAoYXN5bmMgKGRldmljZVVpZCkgPT4ge1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogQ09NTUFORFNfVEFCTEUsXG4gICAgICBJbmRleE5hbWU6ICdkZXZpY2UtY3JlYXRlZC1pbmRleCcsXG4gICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnZGV2aWNlX3VpZCA9IDpkZXZpY2VfdWlkJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgJzpkZXZpY2VfdWlkJzogZGV2aWNlVWlkLFxuICAgICAgfSxcbiAgICAgIFNjYW5JbmRleEZvcndhcmQ6IGZhbHNlLFxuICAgICAgTGltaXQ6IDUwLFxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gICAgcmV0dXJuIHJlc3VsdC5JdGVtcyB8fCBbXTtcbiAgfSk7XG5cbiAgY29uc3QgYWxsUmVzdWx0cyA9IGF3YWl0IFByb21pc2UuYWxsKHF1ZXJ5UHJvbWlzZXMpO1xuXG4gIC8vIE1lcmdlIGFuZCBzb3J0IGJ5IGNyZWF0ZWRfYXQgKG1vc3QgcmVjZW50IGZpcnN0KVxuICBjb25zdCBtZXJnZWRDb21tYW5kcyA9IGFsbFJlc3VsdHNcbiAgICAuZmxhdCgpXG4gICAgLnNvcnQoKGEsIGIpID0+IGIuY3JlYXRlZF9hdCAtIGEuY3JlYXRlZF9hdClcbiAgICAuc2xpY2UoMCwgNTApOyAvLyBMaW1pdCB0byA1MCB0b3RhbFxuXG4gIHJldHVybiB7XG4gICAgc3RhdHVzQ29kZTogMjAwLFxuICAgIGhlYWRlcnMsXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgc2VyaWFsX251bWJlcjogc2VyaWFsTnVtYmVyLFxuICAgICAgY29tbWFuZHM6IG1lcmdlZENvbW1hbmRzLFxuICAgIH0pLFxuICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRBbGxDb21tYW5kcyhcbiAgZGV2aWNlVWlkOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gIGhlYWRlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XG4gIC8vIElmIGRldmljZV91aWQgaXMgcHJvdmlkZWQsIHVzZSB0aGUgZXhpc3RpbmcgcXVlcnlcbiAgaWYgKGRldmljZVVpZCkge1xuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgUXVlcnlDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogQ09NTUFORFNfVEFCTEUsXG4gICAgICBJbmRleE5hbWU6ICdkZXZpY2UtY3JlYXRlZC1pbmRleCcsXG4gICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnZGV2aWNlX3VpZCA9IDpkZXZpY2VfdWlkJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgJzpkZXZpY2VfdWlkJzogZGV2aWNlVWlkLFxuICAgICAgfSxcbiAgICAgIFNjYW5JbmRleEZvcndhcmQ6IGZhbHNlLFxuICAgICAgTGltaXQ6IDEwMCxcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGNvbW1hbmRzOiByZXN1bHQuSXRlbXMgfHwgW10sXG4gICAgICAgIHRvdGFsOiByZXN1bHQuSXRlbXM/Lmxlbmd0aCB8fCAwLFxuICAgICAgfSksXG4gICAgfTtcbiAgfVxuXG4gIC8vIE90aGVyd2lzZSwgc2NhbiBmb3IgYWxsIGNvbW1hbmRzIChsaW1pdGVkIHRvIDEwMCBtb3N0IHJlY2VudClcbiAgY29uc3QgY29tbWFuZCA9IG5ldyBTY2FuQ29tbWFuZCh7XG4gICAgVGFibGVOYW1lOiBDT01NQU5EU19UQUJMRSxcbiAgICBMaW1pdDogMjAwLCAvLyBGZXRjaCBtb3JlIHRvIGFsbG93IHNvcnRpbmdcbiAgfSk7XG5cbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG5cbiAgLy8gU29ydCBieSBjcmVhdGVkX2F0IGRlc2NlbmRpbmcgYW5kIHRha2UgdGhlIGZpcnN0IDEwMFxuICBjb25zdCBzb3J0ZWRDb21tYW5kcyA9IChyZXN1bHQuSXRlbXMgfHwgW10pXG4gICAgLnNvcnQoKGE6IFJlY29yZDxzdHJpbmcsIHVua25vd24+LCBiOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPikgPT5cbiAgICAgICgoYi5jcmVhdGVkX2F0IGFzIG51bWJlcikgfHwgMCkgLSAoKGEuY3JlYXRlZF9hdCBhcyBudW1iZXIpIHx8IDApKVxuICAgIC5zbGljZSgwLCAxMDApO1xuXG4gIHJldHVybiB7XG4gICAgc3RhdHVzQ29kZTogMjAwLFxuICAgIGhlYWRlcnMsXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgY29tbWFuZHM6IHNvcnRlZENvbW1hbmRzLFxuICAgICAgdG90YWw6IHNvcnRlZENvbW1hbmRzLmxlbmd0aCxcbiAgICB9KSxcbiAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZGVsZXRlQ29tbWFuZChcbiAgZGV2aWNlVWlkOiBzdHJpbmcsXG4gIGNvbW1hbmRJZDogc3RyaW5nLFxuICBoZWFkZXJzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+XG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4ge1xuICAvLyBGaXJzdCB2ZXJpZnkgdGhlIGNvbW1hbmQgZXhpc3RzXG4gIGNvbnN0IGdldENtZCA9IG5ldyBHZXRDb21tYW5kKHtcbiAgICBUYWJsZU5hbWU6IENPTU1BTkRTX1RBQkxFLFxuICAgIEtleToge1xuICAgICAgZGV2aWNlX3VpZDogZGV2aWNlVWlkLFxuICAgICAgY29tbWFuZF9pZDogY29tbWFuZElkLFxuICAgIH0sXG4gIH0pO1xuXG4gIGNvbnN0IGV4aXN0aW5nID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoZ2V0Q21kKTtcbiAgaWYgKCFleGlzdGluZy5JdGVtKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDQwNCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnQ29tbWFuZCBub3QgZm91bmQnIH0pLFxuICAgIH07XG4gIH1cblxuICAvLyBEZWxldGUgdGhlIGNvbW1hbmRcbiAgY29uc3QgZGVsZXRlQ21kID0gbmV3IERlbGV0ZUNvbW1hbmQoe1xuICAgIFRhYmxlTmFtZTogQ09NTUFORFNfVEFCTEUsXG4gICAgS2V5OiB7XG4gICAgICBkZXZpY2VfdWlkOiBkZXZpY2VVaWQsXG4gICAgICBjb21tYW5kX2lkOiBjb21tYW5kSWQsXG4gICAgfSxcbiAgfSk7XG5cbiAgYXdhaXQgZG9jQ2xpZW50LnNlbmQoZGVsZXRlQ21kKTtcblxuICByZXR1cm4ge1xuICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICBoZWFkZXJzLFxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIG1lc3NhZ2U6ICdDb21tYW5kIGRlbGV0ZWQnLFxuICAgICAgY29tbWFuZF9pZDogY29tbWFuZElkLFxuICAgIH0pLFxuICB9O1xufVxuIl19