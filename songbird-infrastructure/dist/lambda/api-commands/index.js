"use strict";
/**
 * Commands API Lambda
 *
 * Sends commands to devices via Notehub API:
 * - GET /v1/commands - Get all commands across devices
 * - DELETE /v1/commands/{command_id} - Delete a command
 * - POST /devices/{device_uid}/commands - Send command to device
 * - GET /devices/{device_uid}/commands - Get command history for a device
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const client_secrets_manager_1 = require("@aws-sdk/client-secrets-manager");
const crypto_1 = require("crypto");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient);
const secretsClient = new client_secrets_manager_1.SecretsManagerClient({});
const COMMANDS_TABLE = process.env.COMMANDS_TABLE;
const NOTEHUB_PROJECT_UID = process.env.NOTEHUB_PROJECT_UID;
const NOTEHUB_SECRET_ARN = process.env.NOTEHUB_SECRET_ARN;
// Cache the token to avoid fetching on every request
let cachedToken = null;
async function getNotehubToken() {
    if (cachedToken) {
        return cachedToken;
    }
    const command = new client_secrets_manager_1.GetSecretValueCommand({ SecretId: NOTEHUB_SECRET_ARN });
    const response = await secretsClient.send(command);
    if (!response.SecretString) {
        throw new Error('Notehub API token not found in secret');
    }
    const secret = JSON.parse(response.SecretString);
    cachedToken = secret.token;
    if (!cachedToken) {
        throw new Error('Token field not found in secret');
    }
    return cachedToken;
}
// Supported commands
const VALID_COMMANDS = ['ping', 'locate', 'play_melody', 'test_audio', 'set_volume'];
const handler = async (event) => {
    console.log('Request:', JSON.stringify(event));
    const corsHeaders = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type,Authorization',
        'Access-Control-Allow-Methods': 'GET,POST,DELETE,OPTIONS',
    };
    try {
        // HTTP API v2 uses requestContext.http.method, REST API v1 uses httpMethod
        const method = event.requestContext?.http?.method || event.httpMethod;
        const path = event.requestContext?.http?.path || event.path;
        if (method === 'OPTIONS') {
            return { statusCode: 200, headers: corsHeaders, body: '' };
        }
        // Handle /v1/commands endpoint (all commands across devices)
        if (path === '/v1/commands' && method === 'GET') {
            const deviceUid = event.queryStringParameters?.device_uid;
            return await getAllCommands(deviceUid, corsHeaders);
        }
        // Handle DELETE /v1/commands/{command_id}
        const commandId = event.pathParameters?.command_id;
        if (commandId && method === 'DELETE') {
            const deviceUid = event.queryStringParameters?.device_uid;
            if (!deviceUid) {
                return {
                    statusCode: 400,
                    headers: corsHeaders,
                    body: JSON.stringify({ error: 'device_uid query parameter required' }),
                };
            }
            return await deleteCommand(deviceUid, commandId, corsHeaders);
        }
        // Handle device-specific commands endpoints
        const deviceUid = event.pathParameters?.device_uid;
        if (!deviceUid) {
            return {
                statusCode: 400,
                headers: corsHeaders,
                body: JSON.stringify({ error: 'device_uid required' }),
            };
        }
        if (method === 'POST') {
            return await sendCommand(deviceUid, event.body, corsHeaders);
        }
        if (method === 'GET') {
            return await getCommandHistory(deviceUid, corsHeaders);
        }
        return {
            statusCode: 405,
            headers: corsHeaders,
            body: JSON.stringify({ error: 'Method not allowed' }),
        };
    }
    catch (error) {
        console.error('Error:', error);
        return {
            statusCode: 500,
            headers: corsHeaders,
            body: JSON.stringify({ error: 'Internal server error' }),
        };
    }
};
exports.handler = handler;
async function sendCommand(deviceUid, body, headers) {
    if (!body) {
        return {
            statusCode: 400,
            headers,
            body: JSON.stringify({ error: 'Request body required' }),
        };
    }
    const request = JSON.parse(body);
    const { cmd, params } = request;
    // Validate command
    if (!cmd || !VALID_COMMANDS.includes(cmd)) {
        return {
            statusCode: 400,
            headers,
            body: JSON.stringify({
                error: 'Invalid command',
                valid_commands: VALID_COMMANDS,
            }),
        };
    }
    // Generate command ID
    const commandId = `cmd_${(0, crypto_1.randomUUID)().replace(/-/g, '').substring(0, 12)}`;
    const now = Date.now();
    // Build command note body
    const noteBody = {
        cmd,
        params: params || {},
        command_id: commandId,
        sent_at: now,
    };
    // Send to Notehub API
    try {
        const notehubToken = await getNotehubToken();
        const notehubResponse = await fetch(`https://api.notefile.net/v1/projects/${NOTEHUB_PROJECT_UID}/devices/${deviceUid}/notes/command.qi`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${notehubToken}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ body: noteBody }),
        });
        if (!notehubResponse.ok) {
            const errorText = await notehubResponse.text();
            console.error('Notehub API error:', errorText);
            return {
                statusCode: 502,
                headers,
                body: JSON.stringify({
                    error: 'Failed to send command to Notehub',
                    details: errorText,
                }),
            };
        }
        // Store command in history
        await storeCommand(deviceUid, commandId, cmd, params, now);
        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({
                command_id: commandId,
                device_uid: deviceUid,
                cmd,
                params: params || {},
                status: 'queued',
                queued_at: new Date(now).toISOString(),
            }),
        };
    }
    catch (error) {
        console.error('Error sending command to Notehub:', error);
        return {
            statusCode: 502,
            headers,
            body: JSON.stringify({
                error: 'Failed to communicate with Notehub',
            }),
        };
    }
}
async function storeCommand(deviceUid, commandId, cmd, params, timestamp) {
    const command = new lib_dynamodb_1.PutCommand({
        TableName: COMMANDS_TABLE,
        Item: {
            device_uid: deviceUid,
            command_id: commandId,
            cmd,
            params: params || {},
            status: 'queued',
            created_at: timestamp,
            updated_at: timestamp,
            ttl: Math.floor(timestamp / 1000) + 30 * 24 * 60 * 60, // 30 days TTL
        },
    });
    await docClient.send(command);
}
async function getCommandHistory(deviceUid, headers) {
    const command = new lib_dynamodb_1.QueryCommand({
        TableName: COMMANDS_TABLE,
        IndexName: 'device-created-index',
        KeyConditionExpression: 'device_uid = :device_uid',
        ExpressionAttributeValues: {
            ':device_uid': deviceUid,
        },
        ScanIndexForward: false, // Most recent first (by created_at)
        Limit: 50,
    });
    const result = await docClient.send(command);
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
            device_uid: deviceUid,
            commands: result.Items || [],
        }),
    };
}
async function getAllCommands(deviceUid, headers) {
    // If device_uid is provided, use the existing query
    if (deviceUid) {
        const command = new lib_dynamodb_1.QueryCommand({
            TableName: COMMANDS_TABLE,
            IndexName: 'device-created-index',
            KeyConditionExpression: 'device_uid = :device_uid',
            ExpressionAttributeValues: {
                ':device_uid': deviceUid,
            },
            ScanIndexForward: false,
            Limit: 100,
        });
        const result = await docClient.send(command);
        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({
                commands: result.Items || [],
                total: result.Items?.length || 0,
            }),
        };
    }
    // Otherwise, scan for all commands (limited to 100 most recent)
    const command = new lib_dynamodb_1.ScanCommand({
        TableName: COMMANDS_TABLE,
        Limit: 200, // Fetch more to allow sorting
    });
    const result = await docClient.send(command);
    // Sort by created_at descending and take the first 100
    const sortedCommands = (result.Items || [])
        .sort((a, b) => (b.created_at || 0) - (a.created_at || 0))
        .slice(0, 100);
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
            commands: sortedCommands,
            total: sortedCommands.length,
        }),
    };
}
async function deleteCommand(deviceUid, commandId, headers) {
    // First verify the command exists
    const getCmd = new lib_dynamodb_1.GetCommand({
        TableName: COMMANDS_TABLE,
        Key: {
            device_uid: deviceUid,
            command_id: commandId,
        },
    });
    const existing = await docClient.send(getCmd);
    if (!existing.Item) {
        return {
            statusCode: 404,
            headers,
            body: JSON.stringify({ error: 'Command not found' }),
        };
    }
    // Delete the command
    const deleteCmd = new lib_dynamodb_1.DeleteCommand({
        TableName: COMMANDS_TABLE,
        Key: {
            device_uid: deviceUid,
            command_id: commandId,
        },
    });
    await docClient.send(deleteCmd);
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
            message: 'Command deleted',
            command_id: commandId,
        }),
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvYXBpLWNvbW1hbmRzL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7R0FRRzs7O0FBRUgsOERBQTBEO0FBQzFELHdEQU8rQjtBQUMvQiw0RUFBOEY7QUFFOUYsbUNBQW9DO0FBRXBDLE1BQU0sU0FBUyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN6QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDekQsTUFBTSxhQUFhLEdBQUcsSUFBSSw2Q0FBb0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUVuRCxNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWUsQ0FBQztBQUNuRCxNQUFNLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW9CLENBQUM7QUFDN0QsTUFBTSxrQkFBa0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFtQixDQUFDO0FBRTNELHFEQUFxRDtBQUNyRCxJQUFJLFdBQVcsR0FBa0IsSUFBSSxDQUFDO0FBRXRDLEtBQUssVUFBVSxlQUFlO0lBQzVCLElBQUksV0FBVyxFQUFFLENBQUM7UUFDaEIsT0FBTyxXQUFXLENBQUM7SUFDckIsQ0FBQztJQUVELE1BQU0sT0FBTyxHQUFHLElBQUksOENBQXFCLENBQUMsRUFBRSxRQUFRLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQyxDQUFDO0lBQzVFLE1BQU0sUUFBUSxHQUFHLE1BQU0sYUFBYSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUVuRCxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQzNCLE1BQU0sSUFBSSxLQUFLLENBQUMsdUNBQXVDLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBRUQsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFD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SCxDQUFDO0FBQ0osQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29tbWFuZHMgQVBJIExhbWJkYVxuICpcbiAqIFNlbmRzIGNvbW1hbmRzIHRvIGRldmljZXMgdmlhIE5vdGVodWIgQVBJOlxuICogLSBHRVQgL3YxL2NvbW1hbmRzIC0gR2V0IGFsbCBjb21tYW5kcyBhY3Jvc3MgZGV2aWNlc1xuICogLSBERUxFVEUgL3YxL2NvbW1hbmRzL3tjb21tYW5kX2lkfSAtIERlbGV0ZSBhIGNvbW1hbmRcbiAqIC0gUE9TVCAvZGV2aWNlcy97ZGV2aWNlX3VpZH0vY29tbWFuZHMgLSBTZW5kIGNvbW1hbmQgdG8gZGV2aWNlXG4gKiAtIEdFVCAvZGV2aWNlcy97ZGV2aWNlX3VpZH0vY29tbWFuZHMgLSBHZXQgY29tbWFuZCBoaXN0b3J5IGZvciBhIGRldmljZVxuICovXG5cbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7XG4gIER5bmFtb0RCRG9jdW1lbnRDbGllbnQsXG4gIFB1dENvbW1hbmQsXG4gIFF1ZXJ5Q29tbWFuZCxcbiAgU2NhbkNvbW1hbmQsXG4gIERlbGV0ZUNvbW1hbmQsXG4gIEdldENvbW1hbmQsXG59IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBTZWNyZXRzTWFuYWdlckNsaWVudCwgR2V0U2VjcmV0VmFsdWVDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXNlY3JldHMtbWFuYWdlcic7XG5pbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudCwgQVBJR2F0ZXdheVByb3h5UmVzdWx0IH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyByYW5kb21VVUlEIH0gZnJvbSAnY3J5cHRvJztcblxuY29uc3QgZGRiQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkZGJDbGllbnQpO1xuY29uc3Qgc2VjcmV0c0NsaWVudCA9IG5ldyBTZWNyZXRzTWFuYWdlckNsaWVudCh7fSk7XG5cbmNvbnN0IENPTU1BTkRTX1RBQkxFID0gcHJvY2Vzcy5lbnYuQ09NTUFORFNfVEFCTEUhO1xuY29uc3QgTk9URUhVQl9QUk9KRUNUX1VJRCA9IHByb2Nlc3MuZW52Lk5PVEVIVUJfUFJPSkVDVF9VSUQhO1xuY29uc3QgTk9URUhVQl9TRUNSRVRfQVJOID0gcHJvY2Vzcy5lbnYuTk9URUhVQl9TRUNSRVRfQVJOITtcblxuLy8gQ2FjaGUgdGhlIHRva2VuIHRvIGF2b2lkIGZldGNoaW5nIG9uIGV2ZXJ5IHJlcXVlc3RcbmxldCBjYWNoZWRUb2tlbjogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG5cbmFzeW5jIGZ1bmN0aW9uIGdldE5vdGVodWJUb2tlbigpOiBQcm9taXNlPHN0cmluZz4ge1xuICBpZiAoY2FjaGVkVG9rZW4pIHtcbiAgICByZXR1cm4gY2FjaGVkVG9rZW47XG4gIH1cblxuICBjb25zdCBjb21tYW5kID0gbmV3IEdldFNlY3JldFZhbHVlQ29tbWFuZCh7IFNlY3JldElkOiBOT1RFSFVCX1NFQ1JFVF9BUk4gfSk7XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgc2VjcmV0c0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuXG4gIGlmICghcmVzcG9uc2UuU2VjcmV0U3RyaW5nKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdOb3RlaHViIEFQSSB0b2tlbiBub3QgZm91bmQgaW4gc2VjcmV0Jyk7XG4gIH1cblxuICBjb25zdCBzZWNyZXQgPSBKU09OLnBhcnNlKHJlc3BvbnNlLlNlY3JldFN0cmluZyk7XG4gIGNhY2hlZFRva2VuID0gc2VjcmV0LnRva2VuO1xuXG4gIGlmICghY2FjaGVkVG9rZW4pIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1Rva2VuIGZpZWxkIG5vdCBmb3VuZCBpbiBzZWNyZXQnKTtcbiAgfVxuXG4gIHJldHVybiBjYWNoZWRUb2tlbjtcbn1cblxuLy8gU3VwcG9ydGVkIGNvbW1hbmRzXG5jb25zdCBWQUxJRF9DT01NQU5EUyA9IFsncGluZycsICdsb2NhdGUnLCAncGxheV9tZWxvZHknLCAndGVzdF9hdWRpbycsICdzZXRfdm9sdW1lJ107XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCk6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiA9PiB7XG4gIGNvbnNvbGUubG9nKCdSZXF1ZXN0OicsIEpTT04uc3RyaW5naWZ5KGV2ZW50KSk7XG5cbiAgY29uc3QgY29yc0hlYWRlcnMgPSB7XG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVycyc6ICdDb250ZW50LVR5cGUsQXV0aG9yaXphdGlvbicsXG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU1ldGhvZHMnOiAnR0VULFBPU1QsREVMRVRFLE9QVElPTlMnLFxuICB9O1xuXG4gIHRyeSB7XG4gICAgLy8gSFRUUCBBUEkgdjIgdXNlcyByZXF1ZXN0Q29udGV4dC5odHRwLm1ldGhvZCwgUkVTVCBBUEkgdjEgdXNlcyBodHRwTWV0aG9kXG4gICAgY29uc3QgbWV0aG9kID0gKGV2ZW50LnJlcXVlc3RDb250ZXh0IGFzIGFueSk/Lmh0dHA/Lm1ldGhvZCB8fCBldmVudC5odHRwTWV0aG9kO1xuICAgIGNvbnN0IHBhdGggPSAoZXZlbnQucmVxdWVzdENvbnRleHQgYXMgYW55KT8uaHR0cD8ucGF0aCB8fCBldmVudC5wYXRoO1xuXG4gICAgaWYgKG1ldGhvZCA9PT0gJ09QVElPTlMnKSB7XG4gICAgICByZXR1cm4geyBzdGF0dXNDb2RlOiAyMDAsIGhlYWRlcnM6IGNvcnNIZWFkZXJzLCBib2R5OiAnJyB9O1xuICAgIH1cblxuICAgIC8vIEhhbmRsZSAvdjEvY29tbWFuZHMgZW5kcG9pbnQgKGFsbCBjb21tYW5kcyBhY3Jvc3MgZGV2aWNlcylcbiAgICBpZiAocGF0aCA9PT0gJy92MS9jb21tYW5kcycgJiYgbWV0aG9kID09PSAnR0VUJykge1xuICAgICAgY29uc3QgZGV2aWNlVWlkID0gZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzPy5kZXZpY2VfdWlkO1xuICAgICAgcmV0dXJuIGF3YWl0IGdldEFsbENvbW1hbmRzKGRldmljZVVpZCwgY29yc0hlYWRlcnMpO1xuICAgIH1cblxuICAgIC8vIEhhbmRsZSBERUxFVEUgL3YxL2NvbW1hbmRzL3tjb21tYW5kX2lkfVxuICAgIGNvbnN0IGNvbW1hbmRJZCA9IGV2ZW50LnBhdGhQYXJhbWV0ZXJzPy5jb21tYW5kX2lkO1xuICAgIGlmIChjb21tYW5kSWQgJiYgbWV0aG9kID09PSAnREVMRVRFJykge1xuICAgICAgY29uc3QgZGV2aWNlVWlkID0gZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzPy5kZXZpY2VfdWlkO1xuICAgICAgaWYgKCFkZXZpY2VVaWQpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdGF0dXNDb2RlOiA0MDAsXG4gICAgICAgICAgaGVhZGVyczogY29yc0hlYWRlcnMsXG4gICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ2RldmljZV91aWQgcXVlcnkgcGFyYW1ldGVyIHJlcXVpcmVkJyB9KSxcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBhd2FpdCBkZWxldGVDb21tYW5kKGRldmljZVVpZCwgY29tbWFuZElkLCBjb3JzSGVhZGVycyk7XG4gICAgfVxuXG4gICAgLy8gSGFuZGxlIGRldmljZS1zcGVjaWZpYyBjb21tYW5kcyBlbmRwb2ludHNcbiAgICBjb25zdCBkZXZpY2VVaWQgPSBldmVudC5wYXRoUGFyYW1ldGVycz8uZGV2aWNlX3VpZDtcbiAgICBpZiAoIWRldmljZVVpZCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgICBoZWFkZXJzOiBjb3JzSGVhZGVycyxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ2RldmljZV91aWQgcmVxdWlyZWQnIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAobWV0aG9kID09PSAnUE9TVCcpIHtcbiAgICAgIHJldHVybiBhd2FpdCBzZW5kQ29tbWFuZChkZXZpY2VVaWQsIGV2ZW50LmJvZHksIGNvcnNIZWFkZXJzKTtcbiAgICB9XG5cbiAgICBpZiAobWV0aG9kID09PSAnR0VUJykge1xuICAgICAgcmV0dXJuIGF3YWl0IGdldENvbW1hbmRIaXN0b3J5KGRldmljZVVpZCwgY29yc0hlYWRlcnMpO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA0MDUsXG4gICAgICBoZWFkZXJzOiBjb3JzSGVhZGVycyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdNZXRob2Qgbm90IGFsbG93ZWQnIH0pLFxuICAgIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3I6JywgZXJyb3IpO1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA1MDAsXG4gICAgICBoZWFkZXJzOiBjb3JzSGVhZGVycyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InIH0pLFxuICAgIH07XG4gIH1cbn07XG5cbmFzeW5jIGZ1bmN0aW9uIHNlbmRDb21tYW5kKFxuICBkZXZpY2VVaWQ6IHN0cmluZyxcbiAgYm9keTogc3RyaW5nIHwgbnVsbCxcbiAgaGVhZGVyczogUmVjb3JkPHN0cmluZywgc3RyaW5nPlxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+IHtcbiAgaWYgKCFib2R5KSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnUmVxdWVzdCBib2R5IHJlcXVpcmVkJyB9KSxcbiAgICB9O1xuICB9XG5cbiAgY29uc3QgcmVxdWVzdCA9IEpTT04ucGFyc2UoYm9keSk7XG4gIGNvbnN0IHsgY21kLCBwYXJhbXMgfSA9IHJlcXVlc3Q7XG5cbiAgLy8gVmFsaWRhdGUgY29tbWFuZFxuICBpZiAoIWNtZCB8fCAhVkFMSURfQ09NTUFORFMuaW5jbHVkZXMoY21kKSkge1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA0MDAsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBlcnJvcjogJ0ludmFsaWQgY29tbWFuZCcsXG4gICAgICAgIHZhbGlkX2NvbW1hbmRzOiBWQUxJRF9DT01NQU5EUyxcbiAgICAgIH0pLFxuICAgIH07XG4gIH1cblxuICAvLyBHZW5lcmF0ZSBjb21tYW5kIElEXG4gIGNvbnN0IGNvbW1hbmRJZCA9IGBjbWRfJHtyYW5kb21VVUlEKCkucmVwbGFjZSgvLS9nLCAnJykuc3Vic3RyaW5nKDAsIDEyKX1gO1xuICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuXG4gIC8vIEJ1aWxkIGNvbW1hbmQgbm90ZSBib2R5XG4gIGNvbnN0IG5vdGVCb2R5ID0ge1xuICAgIGNtZCxcbiAgICBwYXJhbXM6IHBhcmFtcyB8fCB7fSxcbiAgICBjb21tYW5kX2lkOiBjb21tYW5kSWQsXG4gICAgc2VudF9hdDogbm93LFxuICB9O1xuXG4gIC8vIFNlbmQgdG8gTm90ZWh1YiBBUElcbiAgdHJ5IHtcbiAgICBjb25zdCBub3RlaHViVG9rZW4gPSBhd2FpdCBnZXROb3RlaHViVG9rZW4oKTtcbiAgICBjb25zdCBub3RlaHViUmVzcG9uc2UgPSBhd2FpdCBmZXRjaChcbiAgICAgIGBodHRwczovL2FwaS5ub3RlZmlsZS5uZXQvdjEvcHJvamVjdHMvJHtOT1RFSFVCX1BST0pFQ1RfVUlEfS9kZXZpY2VzLyR7ZGV2aWNlVWlkfS9ub3Rlcy9jb21tYW5kLnFpYCxcbiAgICAgIHtcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnQXV0aG9yaXphdGlvbic6IGBCZWFyZXIgJHtub3RlaHViVG9rZW59YCxcbiAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICB9LFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGJvZHk6IG5vdGVCb2R5IH0pLFxuICAgICAgfVxuICAgICk7XG5cbiAgICBpZiAoIW5vdGVodWJSZXNwb25zZS5vaykge1xuICAgICAgY29uc3QgZXJyb3JUZXh0ID0gYXdhaXQgbm90ZWh1YlJlc3BvbnNlLnRleHQoKTtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ05vdGVodWIgQVBJIGVycm9yOicsIGVycm9yVGV4dCk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDUwMixcbiAgICAgICAgaGVhZGVycyxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIGVycm9yOiAnRmFpbGVkIHRvIHNlbmQgY29tbWFuZCB0byBOb3RlaHViJyxcbiAgICAgICAgICBkZXRhaWxzOiBlcnJvclRleHQsXG4gICAgICAgIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBTdG9yZSBjb21tYW5kIGluIGhpc3RvcnlcbiAgICBhd2FpdCBzdG9yZUNvbW1hbmQoZGV2aWNlVWlkLCBjb21tYW5kSWQsIGNtZCwgcGFyYW1zLCBub3cpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGNvbW1hbmRfaWQ6IGNvbW1hbmRJZCxcbiAgICAgICAgZGV2aWNlX3VpZDogZGV2aWNlVWlkLFxuICAgICAgICBjbWQsXG4gICAgICAgIHBhcmFtczogcGFyYW1zIHx8IHt9LFxuICAgICAgICBzdGF0dXM6ICdxdWV1ZWQnLFxuICAgICAgICBxdWV1ZWRfYXQ6IG5ldyBEYXRlKG5vdykudG9JU09TdHJpbmcoKSxcbiAgICAgIH0pLFxuICAgIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3Igc2VuZGluZyBjb21tYW5kIHRvIE5vdGVodWI6JywgZXJyb3IpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDUwMixcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGVycm9yOiAnRmFpbGVkIHRvIGNvbW11bmljYXRlIHdpdGggTm90ZWh1YicsXG4gICAgICB9KSxcbiAgICB9O1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHN0b3JlQ29tbWFuZChcbiAgZGV2aWNlVWlkOiBzdHJpbmcsXG4gIGNvbW1hbmRJZDogc3RyaW5nLFxuICBjbWQ6IHN0cmluZyxcbiAgcGFyYW1zOiBhbnksXG4gIHRpbWVzdGFtcDogbnVtYmVyXG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgY29uc3QgY29tbWFuZCA9IG5ldyBQdXRDb21tYW5kKHtcbiAgICBUYWJsZU5hbWU6IENPTU1BTkRTX1RBQkxFLFxuICAgIEl0ZW06IHtcbiAgICAgIGRldmljZV91aWQ6IGRldmljZVVpZCxcbiAgICAgIGNvbW1hbmRfaWQ6IGNvbW1hbmRJZCxcbiAgICAgIGNtZCxcbiAgICAgIHBhcmFtczogcGFyYW1zIHx8IHt9LFxuICAgICAgc3RhdHVzOiAncXVldWVkJyxcbiAgICAgIGNyZWF0ZWRfYXQ6IHRpbWVzdGFtcCxcbiAgICAgIHVwZGF0ZWRfYXQ6IHRpbWVzdGFtcCxcbiAgICAgIHR0bDogTWF0aC5mbG9vcih0aW1lc3RhbXAgLyAxMDAwKSArIDMwICogMjQgKiA2MCAqIDYwLCAvLyAzMCBkYXlzIFRUTFxuICAgIH0sXG4gIH0pO1xuXG4gIGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRDb21tYW5kSGlzdG9yeShcbiAgZGV2aWNlVWlkOiBzdHJpbmcsXG4gIGhlYWRlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgUXVlcnlDb21tYW5kKHtcbiAgICBUYWJsZU5hbWU6IENPTU1BTkRTX1RBQkxFLFxuICAgIEluZGV4TmFtZTogJ2RldmljZS1jcmVhdGVkLWluZGV4JyxcbiAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnZGV2aWNlX3VpZCA9IDpkZXZpY2VfdWlkJyxcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAnOmRldmljZV91aWQnOiBkZXZpY2VVaWQsXG4gICAgfSxcbiAgICBTY2FuSW5kZXhGb3J3YXJkOiBmYWxzZSwgLy8gTW9zdCByZWNlbnQgZmlyc3QgKGJ5IGNyZWF0ZWRfYXQpXG4gICAgTGltaXQ6IDUwLFxuICB9KTtcblxuICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcblxuICByZXR1cm4ge1xuICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICBoZWFkZXJzLFxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIGRldmljZV91aWQ6IGRldmljZVVpZCxcbiAgICAgIGNvbW1hbmRzOiByZXN1bHQuSXRlbXMgfHwgW10sXG4gICAgfSksXG4gIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEFsbENvbW1hbmRzKFxuICBkZXZpY2VVaWQ6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgaGVhZGVyczogUmVjb3JkPHN0cmluZywgc3RyaW5nPlxuKTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+IHtcbiAgLy8gSWYgZGV2aWNlX3VpZCBpcyBwcm92aWRlZCwgdXNlIHRoZSBleGlzdGluZyBxdWVyeVxuICBpZiAoZGV2aWNlVWlkKSB7XG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBDT01NQU5EU19UQUJMRSxcbiAgICAgIEluZGV4TmFtZTogJ2RldmljZS1jcmVhdGVkLWluZGV4JyxcbiAgICAgIEtleUNvbmRpdGlvbkV4cHJlc3Npb246ICdkZXZpY2VfdWlkID0gOmRldmljZV91aWQnLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAnOmRldmljZV91aWQnOiBkZXZpY2VVaWQsXG4gICAgICB9LFxuICAgICAgU2NhbkluZGV4Rm9yd2FyZDogZmFsc2UsXG4gICAgICBMaW1pdDogMTAwLFxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgaGVhZGVycyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgY29tbWFuZHM6IHJlc3VsdC5JdGVtcyB8fCBbXSxcbiAgICAgICAgdG90YWw6IHJlc3VsdC5JdGVtcz8ubGVuZ3RoIHx8IDAsXG4gICAgICB9KSxcbiAgICB9O1xuICB9XG5cbiAgLy8gT3RoZXJ3aXNlLCBzY2FuIGZvciBhbGwgY29tbWFuZHMgKGxpbWl0ZWQgdG8gMTAwIG1vc3QgcmVjZW50KVxuICBjb25zdCBjb21tYW5kID0gbmV3IFNjYW5Db21tYW5kKHtcbiAgICBUYWJsZU5hbWU6IENPTU1BTkRTX1RBQkxFLFxuICAgIExpbWl0OiAyMDAsIC8vIEZldGNoIG1vcmUgdG8gYWxsb3cgc29ydGluZ1xuICB9KTtcblxuICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcblxuICAvLyBTb3J0IGJ5IGNyZWF0ZWRfYXQgZGVzY2VuZGluZyBhbmQgdGFrZSB0aGUgZmlyc3QgMTAwXG4gIGNvbnN0IHNvcnRlZENvbW1hbmRzID0gKHJlc3VsdC5JdGVtcyB8fCBbXSlcbiAgICAuc29ydCgoYTogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sIGI6IFJlY29yZDxzdHJpbmcsIHVua25vd24+KSA9PlxuICAgICAgKChiLmNyZWF0ZWRfYXQgYXMgbnVtYmVyKSB8fCAwKSAtICgoYS5jcmVhdGVkX2F0IGFzIG51bWJlcikgfHwgMCkpXG4gICAgLnNsaWNlKDAsIDEwMCk7XG5cbiAgcmV0dXJuIHtcbiAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgaGVhZGVycyxcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICBjb21tYW5kczogc29ydGVkQ29tbWFuZHMsXG4gICAgICB0b3RhbDogc29ydGVkQ29tbWFuZHMubGVuZ3RoLFxuICAgIH0pLFxuICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBkZWxldGVDb21tYW5kKFxuICBkZXZpY2VVaWQ6IHN0cmluZyxcbiAgY29tbWFuZElkOiBzdHJpbmcsXG4gIGhlYWRlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XG4gIC8vIEZpcnN0IHZlcmlmeSB0aGUgY29tbWFuZCBleGlzdHNcbiAgY29uc3QgZ2V0Q21kID0gbmV3IEdldENvbW1hbmQoe1xuICAgIFRhYmxlTmFtZTogQ09NTUFORFNfVEFCTEUsXG4gICAgS2V5OiB7XG4gICAgICBkZXZpY2VfdWlkOiBkZXZpY2VVaWQsXG4gICAgICBjb21tYW5kX2lkOiBjb21tYW5kSWQsXG4gICAgfSxcbiAgfSk7XG5cbiAgY29uc3QgZXhpc3RpbmcgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChnZXRDbWQpO1xuICBpZiAoIWV4aXN0aW5nLkl0ZW0pIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNDA0LFxuICAgICAgaGVhZGVycyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdDb21tYW5kIG5vdCBmb3VuZCcgfSksXG4gICAgfTtcbiAgfVxuXG4gIC8vIERlbGV0ZSB0aGUgY29tbWFuZFxuICBjb25zdCBkZWxldGVDbWQgPSBuZXcgRGVsZXRlQ29tbWFuZCh7XG4gICAgVGFibGVOYW1lOiBDT01NQU5EU19UQUJMRSxcbiAgICBLZXk6IHtcbiAgICAgIGRldmljZV91aWQ6IGRldmljZVVpZCxcbiAgICAgIGNvbW1hbmRfaWQ6IGNvbW1hbmRJZCxcbiAgICB9LFxuICB9KTtcblxuICBhd2FpdCBkb2NDbGllbnQuc2VuZChkZWxldGVDbWQpO1xuXG4gIHJldHVybiB7XG4gICAgc3RhdHVzQ29kZTogMjAwLFxuICAgIGhlYWRlcnMsXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgbWVzc2FnZTogJ0NvbW1hbmQgZGVsZXRlZCcsXG4gICAgICBjb21tYW5kX2lkOiBjb21tYW5kSWQsXG4gICAgfSksXG4gIH07XG59XG4iXX0=