"use strict";
/**
 * Commands API Lambda
 *
 * Sends commands to devices via Notehub API:
 * - POST /devices/{device_uid}/commands - Send command to device
 * - GET /devices/{device_uid}/commands - Get command history
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const crypto_1 = require("crypto");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient);
const COMMANDS_TABLE = process.env.COMMANDS_TABLE;
const NOTEHUB_PROJECT_UID = process.env.NOTEHUB_PROJECT_UID;
const NOTEHUB_API_TOKEN = process.env.NOTEHUB_API_TOKEN;
// Supported commands
const VALID_COMMANDS = ['ping', 'locate', 'play_melody', 'test_audio', 'set_volume'];
const handler = async (event) => {
    console.log('Request:', JSON.stringify(event));
    const corsHeaders = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type,Authorization',
        'Access-Control-Allow-Methods': 'GET,POST,OPTIONS',
    };
    try {
        if (event.httpMethod === 'OPTIONS') {
            return { statusCode: 200, headers: corsHeaders, body: '' };
        }
        const deviceUid = event.pathParameters?.device_uid;
        if (!deviceUid) {
            return {
                statusCode: 400,
                headers: corsHeaders,
                body: JSON.stringify({ error: 'device_uid required' }),
            };
        }
        if (event.httpMethod === 'POST') {
            return await sendCommand(deviceUid, event.body, corsHeaders);
        }
        if (event.httpMethod === 'GET') {
            return await getCommandHistory(deviceUid, corsHeaders);
        }
        return {
            statusCode: 405,
            headers: corsHeaders,
            body: JSON.stringify({ error: 'Method not allowed' }),
        };
    }
    catch (error) {
        console.error('Error:', error);
        return {
            statusCode: 500,
            headers: corsHeaders,
            body: JSON.stringify({ error: 'Internal server error' }),
        };
    }
};
exports.handler = handler;
async function sendCommand(deviceUid, body, headers) {
    if (!body) {
        return {
            statusCode: 400,
            headers,
            body: JSON.stringify({ error: 'Request body required' }),
        };
    }
    const request = JSON.parse(body);
    const { cmd, params } = request;
    // Validate command
    if (!cmd || !VALID_COMMANDS.includes(cmd)) {
        return {
            statusCode: 400,
            headers,
            body: JSON.stringify({
                error: 'Invalid command',
                valid_commands: VALID_COMMANDS,
            }),
        };
    }
    // Generate command ID
    const commandId = `cmd_${(0, crypto_1.randomUUID)().replace(/-/g, '').substring(0, 12)}`;
    const now = Date.now();
    // Build command note body
    const noteBody = {
        cmd,
        params: params || {},
        command_id: commandId,
        sent_at: now,
    };
    // Send to Notehub API
    try {
        const notehubResponse = await fetch(`https://api.notefile.net/v1/projects/${NOTEHUB_PROJECT_UID}/devices/${deviceUid}/notes/command.qi`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${NOTEHUB_API_TOKEN}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ body: noteBody }),
        });
        if (!notehubResponse.ok) {
            const errorText = await notehubResponse.text();
            console.error('Notehub API error:', errorText);
            return {
                statusCode: 502,
                headers,
                body: JSON.stringify({
                    error: 'Failed to send command to Notehub',
                    details: errorText,
                }),
            };
        }
        // Store command in history
        await storeCommand(deviceUid, commandId, cmd, params, now);
        return {
            statusCode: 200,
            headers,
            body: JSON.stringify({
                command_id: commandId,
                device_uid: deviceUid,
                cmd,
                params: params || {},
                status: 'queued',
                queued_at: new Date(now).toISOString(),
            }),
        };
    }
    catch (error) {
        console.error('Error sending command to Notehub:', error);
        return {
            statusCode: 502,
            headers,
            body: JSON.stringify({
                error: 'Failed to communicate with Notehub',
            }),
        };
    }
}
async function storeCommand(deviceUid, commandId, cmd, params, timestamp) {
    const command = new lib_dynamodb_1.PutCommand({
        TableName: COMMANDS_TABLE,
        Item: {
            device_uid: deviceUid,
            command_id: commandId,
            cmd,
            params: params || {},
            status: 'queued',
            created_at: timestamp,
            updated_at: timestamp,
            ttl: Math.floor(timestamp / 1000) + 30 * 24 * 60 * 60, // 30 days TTL
        },
    });
    await docClient.send(command);
}
async function getCommandHistory(deviceUid, headers) {
    const command = new lib_dynamodb_1.QueryCommand({
        TableName: COMMANDS_TABLE,
        KeyConditionExpression: 'device_uid = :device_uid',
        ExpressionAttributeValues: {
            ':device_uid': deviceUid,
        },
        ScanIndexForward: false, // Most recent first
        Limit: 50,
    });
    const result = await docClient.send(command);
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
            device_uid: deviceUid,
            commands: result.Items || [],
        }),
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvYXBpLWNvbW1hbmRzL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7O0dBTUc7OztBQUVILDhEQUEwRDtBQUMxRCx3REFJK0I7QUFFL0IsbUNBQW9DO0FBRXBDLE1BQU0sU0FBUyxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN6QyxNQUFNLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7QUFFekQsTUFBTSxjQUFjLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFlLENBQUM7QUFDbkQsTUFBTSxtQkFBbUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFvQixDQUFDO0FBQzdELE1BQU0saUJBQWlCLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBa0IsQ0FBQztBQUV6RCxxQkFBcUI7QUFDckIsTUFBTSxjQUFjLEdBQUcsQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLGFBQWEsRUFBRSxZQUFZLEVBQUUsWUFBWSxDQUFDLENBQUM7QUFFOUUsTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUFFLEtBQTJCLEVBQWtDLEVBQUU7SUFDM0YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBRS9DLE1BQU0sV0FBVyxHQUFHO1FBQ2xCLDZCQUE2QixFQUFFLEdBQUc7UUFDbEMsOEJBQThCLEVBQUUsNEJBQTRCO1FBQzVELDhCQUE4QixFQUFFLGtCQUFrQjtLQUNuRCxDQUFDO0lBRUYsSUFBSSxDQUFDO1FBQ0gsSUFBSSxLQUFLLENBQUMsVUFBVSxLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQ25DLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLEVB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LEVBQUU7S0FDVixDQUFDLENBQUM7SUFFSCxNQUFNLE1BQU0sR0FBRyxNQUFNLFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFFN0MsT0FBTztRQUNMLFVBQVUsRUFBRSxHQUFHO1FBQ2YsT0FBTztRQUNQLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDO1lBQ25CLFVBQVUsRUFBRSxTQUFTO1lBQ3JCLFFBQVEsRUFBRSxNQUFNLENBQUMsS0FBSyxJQUFJLEVBQUU7U0FDN0IsQ0FBQztLQUNILENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb21tYW5kcyBBUEkgTGFtYmRhXG4gKlxuICogU2VuZHMgY29tbWFuZHMgdG8gZGV2aWNlcyB2aWEgTm90ZWh1YiBBUEk6XG4gKiAtIFBPU1QgL2RldmljZXMve2RldmljZV91aWR9L2NvbW1hbmRzIC0gU2VuZCBjb21tYW5kIHRvIGRldmljZVxuICogLSBHRVQgL2RldmljZXMve2RldmljZV91aWR9L2NvbW1hbmRzIC0gR2V0IGNvbW1hbmQgaGlzdG9yeVxuICovXG5cbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7XG4gIER5bmFtb0RCRG9jdW1lbnRDbGllbnQsXG4gIFB1dENvbW1hbmQsXG4gIFF1ZXJ5Q29tbWFuZCxcbn0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcbmltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBBUElHYXRld2F5UHJveHlSZXN1bHQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IHJhbmRvbVVVSUQgfSBmcm9tICdjcnlwdG8nO1xuXG5jb25zdCBkZGJDbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe30pO1xuY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGRkYkNsaWVudCk7XG5cbmNvbnN0IENPTU1BTkRTX1RBQkxFID0gcHJvY2Vzcy5lbnYuQ09NTUFORFNfVEFCTEUhO1xuY29uc3QgTk9URUhVQl9QUk9KRUNUX1VJRCA9IHByb2Nlc3MuZW52Lk5PVEVIVUJfUFJPSkVDVF9VSUQhO1xuY29uc3QgTk9URUhVQl9BUElfVE9LRU4gPSBwcm9jZXNzLmVudi5OT1RFSFVCX0FQSV9UT0tFTiE7XG5cbi8vIFN1cHBvcnRlZCBjb21tYW5kc1xuY29uc3QgVkFMSURfQ09NTUFORFMgPSBbJ3BpbmcnLCAnbG9jYXRlJywgJ3BsYXlfbWVsb2R5JywgJ3Rlc3RfYXVkaW8nLCAnc2V0X3ZvbHVtZSddO1xuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQpOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4gPT4ge1xuICBjb25zb2xlLmxvZygnUmVxdWVzdDonLCBKU09OLnN0cmluZ2lmeShldmVudCkpO1xuXG4gIGNvbnN0IGNvcnNIZWFkZXJzID0ge1xuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKicsXG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLEF1dGhvcml6YXRpb24nLFxuICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzJzogJ0dFVCxQT1NULE9QVElPTlMnLFxuICB9O1xuXG4gIHRyeSB7XG4gICAgaWYgKGV2ZW50Lmh0dHBNZXRob2QgPT09ICdPUFRJT05TJykge1xuICAgICAgcmV0dXJuIHsgc3RhdHVzQ29kZTogMjAwLCBoZWFkZXJzOiBjb3JzSGVhZGVycywgYm9keTogJycgfTtcbiAgICB9XG5cbiAgICBjb25zdCBkZXZpY2VVaWQgPSBldmVudC5wYXRoUGFyYW1ldGVycz8uZGV2aWNlX3VpZDtcbiAgICBpZiAoIWRldmljZVVpZCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgICBoZWFkZXJzOiBjb3JzSGVhZGVycyxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ2RldmljZV91aWQgcmVxdWlyZWQnIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoZXZlbnQuaHR0cE1ldGhvZCA9PT0gJ1BPU1QnKSB7XG4gICAgICByZXR1cm4gYXdhaXQgc2VuZENvbW1hbmQoZGV2aWNlVWlkLCBldmVudC5ib2R5LCBjb3JzSGVhZGVycyk7XG4gICAgfVxuXG4gICAgaWYgKGV2ZW50Lmh0dHBNZXRob2QgPT09ICdHRVQnKSB7XG4gICAgICByZXR1cm4gYXdhaXQgZ2V0Q29tbWFuZEhpc3RvcnkoZGV2aWNlVWlkLCBjb3JzSGVhZGVycyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDQwNSxcbiAgICAgIGhlYWRlcnM6IGNvcnNIZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ01ldGhvZCBub3QgYWxsb3dlZCcgfSksXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvcjonLCBlcnJvcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICAgIGhlYWRlcnM6IGNvcnNIZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicgfSksXG4gICAgfTtcbiAgfVxufTtcblxuYXN5bmMgZnVuY3Rpb24gc2VuZENvbW1hbmQoXG4gIGRldmljZVVpZDogc3RyaW5nLFxuICBib2R5OiBzdHJpbmcgfCBudWxsLFxuICBoZWFkZXJzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+XG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4ge1xuICBpZiAoIWJvZHkpIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgaGVhZGVycyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdSZXF1ZXN0IGJvZHkgcmVxdWlyZWQnIH0pLFxuICAgIH07XG4gIH1cblxuICBjb25zdCByZXF1ZXN0ID0gSlNPTi5wYXJzZShib2R5KTtcbiAgY29uc3QgeyBjbWQsIHBhcmFtcyB9ID0gcmVxdWVzdDtcblxuICAvLyBWYWxpZGF0ZSBjb21tYW5kXG4gIGlmICghY21kIHx8ICFWQUxJRF9DT01NQU5EUy5pbmNsdWRlcyhjbWQpKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIGVycm9yOiAnSW52YWxpZCBjb21tYW5kJyxcbiAgICAgICAgdmFsaWRfY29tbWFuZHM6IFZBTElEX0NPTU1BTkRTLFxuICAgICAgfSksXG4gICAgfTtcbiAgfVxuXG4gIC8vIEdlbmVyYXRlIGNvbW1hbmQgSURcbiAgY29uc3QgY29tbWFuZElkID0gYGNtZF8ke3JhbmRvbVVVSUQoKS5yZXBsYWNlKC8tL2csICcnKS5zdWJzdHJpbmcoMCwgMTIpfWA7XG4gIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG5cbiAgLy8gQnVpbGQgY29tbWFuZCBub3RlIGJvZHlcbiAgY29uc3Qgbm90ZUJvZHkgPSB7XG4gICAgY21kLFxuICAgIHBhcmFtczogcGFyYW1zIHx8IHt9LFxuICAgIGNvbW1hbmRfaWQ6IGNvbW1hbmRJZCxcbiAgICBzZW50X2F0OiBub3csXG4gIH07XG5cbiAgLy8gU2VuZCB0byBOb3RlaHViIEFQSVxuICB0cnkge1xuICAgIGNvbnN0IG5vdGVodWJSZXNwb25zZSA9IGF3YWl0IGZldGNoKFxuICAgICAgYGh0dHBzOi8vYXBpLm5vdGVmaWxlLm5ldC92MS9wcm9qZWN0cy8ke05PVEVIVUJfUFJPSkVDVF9VSUR9L2RldmljZXMvJHtkZXZpY2VVaWR9L25vdGVzL2NvbW1hbmQucWlgLFxuICAgICAge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke05PVEVIVUJfQVBJX1RPS0VOfWAsXG4gICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgfSxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBib2R5OiBub3RlQm9keSB9KSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgaWYgKCFub3RlaHViUmVzcG9uc2Uub2spIHtcbiAgICAgIGNvbnN0IGVycm9yVGV4dCA9IGF3YWl0IG5vdGVodWJSZXNwb25zZS50ZXh0KCk7XG4gICAgICBjb25zb2xlLmVycm9yKCdOb3RlaHViIEFQSSBlcnJvcjonLCBlcnJvclRleHQpO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXNDb2RlOiA1MDIsXG4gICAgICAgIGhlYWRlcnMsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBlcnJvcjogJ0ZhaWxlZCB0byBzZW5kIGNvbW1hbmQgdG8gTm90ZWh1YicsXG4gICAgICAgICAgZGV0YWlsczogZXJyb3JUZXh0LFxuICAgICAgICB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gU3RvcmUgY29tbWFuZCBpbiBoaXN0b3J5XG4gICAgYXdhaXQgc3RvcmVDb21tYW5kKGRldmljZVVpZCwgY29tbWFuZElkLCBjbWQsIHBhcmFtcywgbm93KTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBjb21tYW5kX2lkOiBjb21tYW5kSWQsXG4gICAgICAgIGRldmljZV91aWQ6IGRldmljZVVpZCxcbiAgICAgICAgY21kLFxuICAgICAgICBwYXJhbXM6IHBhcmFtcyB8fCB7fSxcbiAgICAgICAgc3RhdHVzOiAncXVldWVkJyxcbiAgICAgICAgcXVldWVkX2F0OiBuZXcgRGF0ZShub3cpLnRvSVNPU3RyaW5nKCksXG4gICAgICB9KSxcbiAgICB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHNlbmRpbmcgY29tbWFuZCB0byBOb3RlaHViOicsIGVycm9yKTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA1MDIsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBlcnJvcjogJ0ZhaWxlZCB0byBjb21tdW5pY2F0ZSB3aXRoIE5vdGVodWInLFxuICAgICAgfSksXG4gICAgfTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBzdG9yZUNvbW1hbmQoXG4gIGRldmljZVVpZDogc3RyaW5nLFxuICBjb21tYW5kSWQ6IHN0cmluZyxcbiAgY21kOiBzdHJpbmcsXG4gIHBhcmFtczogYW55LFxuICB0aW1lc3RhbXA6IG51bWJlclxuKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgUHV0Q29tbWFuZCh7XG4gICAgVGFibGVOYW1lOiBDT01NQU5EU19UQUJMRSxcbiAgICBJdGVtOiB7XG4gICAgICBkZXZpY2VfdWlkOiBkZXZpY2VVaWQsXG4gICAgICBjb21tYW5kX2lkOiBjb21tYW5kSWQsXG4gICAgICBjbWQsXG4gICAgICBwYXJhbXM6IHBhcmFtcyB8fCB7fSxcbiAgICAgIHN0YXR1czogJ3F1ZXVlZCcsXG4gICAgICBjcmVhdGVkX2F0OiB0aW1lc3RhbXAsXG4gICAgICB1cGRhdGVkX2F0OiB0aW1lc3RhbXAsXG4gICAgICB0dGw6IE1hdGguZmxvb3IodGltZXN0YW1wIC8gMTAwMCkgKyAzMCAqIDI0ICogNjAgKiA2MCwgLy8gMzAgZGF5cyBUVExcbiAgICB9LFxuICB9KTtcblxuICBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0Q29tbWFuZEhpc3RvcnkoXG4gIGRldmljZVVpZDogc3RyaW5nLFxuICBoZWFkZXJzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+XG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4ge1xuICBjb25zdCBjb21tYW5kID0gbmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgVGFibGVOYW1lOiBDT01NQU5EU19UQUJMRSxcbiAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnZGV2aWNlX3VpZCA9IDpkZXZpY2VfdWlkJyxcbiAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7XG4gICAgICAnOmRldmljZV91aWQnOiBkZXZpY2VVaWQsXG4gICAgfSxcbiAgICBTY2FuSW5kZXhGb3J3YXJkOiBmYWxzZSwgLy8gTW9zdCByZWNlbnQgZmlyc3RcbiAgICBMaW1pdDogNTAsXG4gIH0pO1xuXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuXG4gIHJldHVybiB7XG4gICAgc3RhdHVzQ29kZTogMjAwLFxuICAgIGhlYWRlcnMsXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgZGV2aWNlX3VpZDogZGV2aWNlVWlkLFxuICAgICAgY29tbWFuZHM6IHJlc3VsdC5JdGVtcyB8fCBbXSxcbiAgICB9KSxcbiAgfTtcbn1cbiJdfQ==