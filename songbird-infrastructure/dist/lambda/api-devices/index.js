"use strict";
/**
 * Devices API Lambda
 *
 * Handles device CRUD operations:
 * - GET /devices - List all devices
 * - GET /devices/{device_uid} - Get device details
 * - PATCH /devices/{device_uid} - Update device metadata
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const ddbClient = new client_dynamodb_1.DynamoDBClient({});
const docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(ddbClient);
const DEVICES_TABLE = process.env.DEVICES_TABLE;
const handler = async (event) => {
    console.log('Request:', JSON.stringify(event));
    const corsHeaders = {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': 'Content-Type,Authorization',
        'Access-Control-Allow-Methods': 'GET,PATCH,OPTIONS',
    };
    try {
        // HTTP API v2 uses requestContext.http.method, REST API v1 uses httpMethod
        const method = event.requestContext?.http?.method || event.httpMethod;
        const deviceUid = event.pathParameters?.device_uid;
        if (method === 'OPTIONS') {
            return { statusCode: 200, headers: corsHeaders, body: '' };
        }
        if (method === 'GET' && !deviceUid) {
            // List devices
            return await listDevices(event, corsHeaders);
        }
        if (method === 'GET' && deviceUid) {
            // Get single device
            return await getDevice(deviceUid, corsHeaders);
        }
        if (method === 'PATCH' && deviceUid) {
            // Update device
            return await updateDevice(deviceUid, event.body, corsHeaders);
        }
        return {
            statusCode: 405,
            headers: corsHeaders,
            body: JSON.stringify({ error: 'Method not allowed' }),
        };
    }
    catch (error) {
        console.error('Error:', error);
        return {
            statusCode: 500,
            headers: corsHeaders,
            body: JSON.stringify({ error: 'Internal server error' }),
        };
    }
};
exports.handler = handler;
async function listDevices(event, headers) {
    const queryParams = event.queryStringParameters || {};
    const fleet = queryParams.fleet;
    const status = queryParams.status;
    const limit = parseInt(queryParams.limit || '100');
    let items = [];
    if (fleet) {
        // Query by fleet using GSI
        const command = new lib_dynamodb_1.QueryCommand({
            TableName: DEVICES_TABLE,
            IndexName: 'fleet-index',
            KeyConditionExpression: '#fleet = :fleet',
            ExpressionAttributeNames: { '#fleet': 'fleet' },
            ExpressionAttributeValues: { ':fleet': fleet },
            Limit: limit,
            ScanIndexForward: false, // Most recent first
        });
        const result = await docClient.send(command);
        items = result.Items || [];
    }
    else if (status) {
        // Query by status using GSI
        const command = new lib_dynamodb_1.QueryCommand({
            TableName: DEVICES_TABLE,
            IndexName: 'status-index',
            KeyConditionExpression: '#status = :status',
            ExpressionAttributeNames: { '#status': 'status' },
            ExpressionAttributeValues: { ':status': status },
            Limit: limit,
            ScanIndexForward: false,
        });
        const result = await docClient.send(command);
        items = result.Items || [];
    }
    else {
        // Scan all devices (for small fleets)
        const command = new lib_dynamodb_1.ScanCommand({
            TableName: DEVICES_TABLE,
            Limit: limit,
        });
        const result = await docClient.send(command);
        items = result.Items || [];
    }
    // Transform and calculate fleet stats
    const transformedDevices = items.map(transformDevice);
    const stats = calculateStats(items);
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify({
            devices: transformedDevices,
            count: transformedDevices.length,
            stats,
        }),
    };
}
async function getDevice(deviceUid, headers) {
    const command = new lib_dynamodb_1.GetCommand({
        TableName: DEVICES_TABLE,
        Key: { device_uid: deviceUid },
    });
    const result = await docClient.send(command);
    if (!result.Item) {
        return {
            statusCode: 404,
            headers,
            body: JSON.stringify({ error: 'Device not found' }),
        };
    }
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify(transformDevice(result.Item)),
    };
}
async function updateDevice(deviceUid, body, headers) {
    if (!body) {
        return {
            statusCode: 400,
            headers,
            body: JSON.stringify({ error: 'Request body required' }),
        };
    }
    const updates = JSON.parse(body);
    // Only allow certain fields to be updated
    const allowedFields = ['serial_number', 'assigned_to', 'fleet', 'notes'];
    const updateExpressions = [];
    const expressionAttributeNames = {};
    const expressionAttributeValues = {};
    for (const [key, value] of Object.entries(updates)) {
        if (allowedFields.includes(key)) {
            const attrName = `#${key}`;
            const attrValue = `:${key}`;
            updateExpressions.push(`${attrName} = ${attrValue}`);
            expressionAttributeNames[attrName] = key;
            expressionAttributeValues[attrValue] = value;
        }
    }
    if (updateExpressions.length === 0) {
        return {
            statusCode: 400,
            headers,
            body: JSON.stringify({ error: 'No valid fields to update' }),
        };
    }
    // Always update updated_at
    updateExpressions.push('#updated_at = :updated_at');
    expressionAttributeNames['#updated_at'] = 'updated_at';
    expressionAttributeValues[':updated_at'] = Date.now();
    const command = new lib_dynamodb_1.UpdateCommand({
        TableName: DEVICES_TABLE,
        Key: { device_uid: deviceUid },
        UpdateExpression: 'SET ' + updateExpressions.join(', '),
        ExpressionAttributeNames: expressionAttributeNames,
        ExpressionAttributeValues: expressionAttributeValues,
        ReturnValues: 'ALL_NEW',
    });
    const result = await docClient.send(command);
    return {
        statusCode: 200,
        headers,
        body: JSON.stringify(result.Attributes),
    };
}
/**
 * Transform DynamoDB device record to frontend format
 * Flattens nested objects like last_location and last_telemetry
 */
function transformDevice(item) {
    const device = {
        device_uid: item.device_uid,
        serial_number: item.serial_number,
        name: item.name,
        fleet: item.fleet,
        status: item.status,
        // Convert millisecond timestamp to ISO string for frontend
        last_seen: item.last_seen ? new Date(item.last_seen).toISOString() : undefined,
        mode: item.current_mode,
        transit_locked: item.transit_locked || false,
        created_at: item.created_at ? new Date(item.created_at).toISOString() : undefined,
        updated_at: item.updated_at ? new Date(item.updated_at).toISOString() : undefined,
        assigned_to: item.assigned_to,
        assigned_to_name: item.assigned_to_name,
    };
    // Flatten last_location
    if (item.last_location) {
        device.latitude = item.last_location.lat;
        device.longitude = item.last_location.lon;
        // Convert Unix timestamp (seconds) to ISO string for frontend
        if (item.last_location.time) {
            // Notehub timestamps are in seconds, convert to milliseconds for Date
            const timeMs = item.last_location.time * 1000;
            device.location_time = new Date(timeMs).toISOString();
        }
        device.location_source = item.last_location.source;
        device.location_name = item.last_location.name;
    }
    // Flatten last_telemetry
    if (item.last_telemetry) {
        device.temperature = item.last_telemetry.temp;
        device.humidity = item.last_telemetry.humidity;
        device.pressure = item.last_telemetry.pressure;
        device.voltage = item.last_telemetry.voltage;
        device.motion = item.last_telemetry.motion;
    }
    // Flatten last_power (Mojo data)
    if (item.last_power) {
        device.mojo_voltage = item.last_power.voltage;
        device.mojo_temperature = item.last_power.temperature;
        device.milliamp_hours = item.last_power.milliamp_hours;
    }
    // Firmware versions (from _session.qo events)
    if (item.firmware_version) {
        device.firmware_version = item.firmware_version;
    }
    if (item.notecard_version) {
        device.notecard_version = item.notecard_version;
    }
    if (item.notecard_sku) {
        device.notecard_sku = item.notecard_sku;
    }
    return device;
}
function calculateStats(devices) {
    const stats = {
        total: devices.length,
        online: 0,
        offline: 0,
        alert: 0,
        low_battery: 0,
        fleets: {},
    };
    const now = Date.now();
    const offlineThreshold = 15 * 60 * 1000; // 15 minutes
    for (const device of devices) {
        // Status counts
        if (device.status === 'alert') {
            stats.alert++;
        }
        else if (device.last_seen && now - device.last_seen < offlineThreshold) {
            stats.online++;
        }
        else {
            stats.offline++;
        }
        // Low battery check
        if (device.last_telemetry?.voltage && device.last_telemetry.voltage < 3.4) {
            stats.low_battery++;
        }
        // Fleet counts
        const fleet = device.fleet || 'default';
        stats.fleets[fleet] = (stats.fleets[fleet] || 0) + 1;
    }
    return stats;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvYXBpLWRldmljZXMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7O0dBT0c7OztBQUVILDhEQUEwRDtBQUMxRCx3REFNK0I7QUFHL0IsTUFBTSxTQUFTLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3pDLE1BQU0sU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUV6RCxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWMsQ0FBQztBQUUxQyxNQUFNLE9BQU8sR0FBRyxLQUFLLEVBQUUsS0FBMkIsRUFBa0MsRUFBRTtJQUMzRixPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFFL0MsTUFBTSxXQUFXLEdBQUc7UUFDbEIsNkJBQTZCLEVBQUUsR0FBRztRQUNsQyw4QkFBOEIsRUFBRSw0QkFBNEI7UUFDNUQsOEJBQThCLEVBQUUsbUJBQW1CO0tBQ3BELENBQUM7SUFFRixJQUFJLENBQUM7UUFDSCwyRUFBMkU7UUFDM0UsTUFBTSxNQUFNLEdBQUksS0FBSyxDQUFDLGNBQXNCLEVBQUUsSUFBSSxFQUFFLE1BQU0sSUFBSSxLQUFLLENBQUMsVUFBVSxDQUFDO1FBQy9FLE1BQU0sU0FBUyxHQUFHLEtBQUssQ0FBQyxjQUFjLEVBQUUsVUFBVSxDQUFDO1FBRW5ELElBQUksTUFBTSxLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQ3pCLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxDQUFDO1FBQzdELENBQUM7UUFFRCxJQUFJLE1BQU0sS0FBSyxLQUFLLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUNuQyxl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QixJQUFJLE1BQU0sQ0FBQyxjQUFjLEVBQUUsT0FBTyxJQUFJLE1BQU0sQ0FBQyxjQUFjLENBQUMsT0FBTyxHQUFHLEdBQUcsRUFBRSxDQUFDO1lBQzFFLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUN0QixDQUFDO1FBRUQsZUFBZTtRQUNmLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxLQUFLLElBQUksU0FBUyxDQUFDO1FBQ3hDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN2RCxDQUFDO0lBRUQsT0FBTyxLQUFLLENBQUM7QUFDZixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBEZXZpY2VzIEFQSSBMYW1iZGFcbiAqXG4gKiBIYW5kbGVzIGRldmljZSBDUlVEIG9wZXJhdGlvbnM6XG4gKiAtIEdFVCAvZGV2aWNlcyAtIExpc3QgYWxsIGRldmljZXNcbiAqIC0gR0VUIC9kZXZpY2VzL3tkZXZpY2VfdWlkfSAtIEdldCBkZXZpY2UgZGV0YWlsc1xuICogLSBQQVRDSCAvZGV2aWNlcy97ZGV2aWNlX3VpZH0gLSBVcGRhdGUgZGV2aWNlIG1ldGFkYXRhXG4gKi9cblxuaW1wb3J0IHsgRHluYW1vREJDbGllbnQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHtcbiAgRHluYW1vREJEb2N1bWVudENsaWVudCxcbiAgU2NhbkNvbW1hbmQsXG4gIFF1ZXJ5Q29tbWFuZCxcbiAgR2V0Q29tbWFuZCxcbiAgVXBkYXRlQ29tbWFuZCxcbn0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcbmltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBBUElHYXRld2F5UHJveHlSZXN1bHQgfSBmcm9tICdhd3MtbGFtYmRhJztcblxuY29uc3QgZGRiQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbmNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkZGJDbGllbnQpO1xuXG5jb25zdCBERVZJQ0VTX1RBQkxFID0gcHJvY2Vzcy5lbnYuREVWSUNFU19UQUJMRSE7XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCk6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiA9PiB7XG4gIGNvbnNvbGUubG9nKCdSZXF1ZXN0OicsIEpTT04uc3RyaW5naWZ5KGV2ZW50KSk7XG5cbiAgY29uc3QgY29yc0hlYWRlcnMgPSB7XG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgICAnQWNjZXNzLUNvbnRyb2wtQWxsb3ctSGVhZGVycyc6ICdDb250ZW50LVR5cGUsQXV0aG9yaXphdGlvbicsXG4gICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU1ldGhvZHMnOiAnR0VULFBBVENILE9QVElPTlMnLFxuICB9O1xuXG4gIHRyeSB7XG4gICAgLy8gSFRUUCBBUEkgdjIgdXNlcyByZXF1ZXN0Q29udGV4dC5odHRwLm1ldGhvZCwgUkVTVCBBUEkgdjEgdXNlcyBodHRwTWV0aG9kXG4gICAgY29uc3QgbWV0aG9kID0gKGV2ZW50LnJlcXVlc3RDb250ZXh0IGFzIGFueSk/Lmh0dHA/Lm1ldGhvZCB8fCBldmVudC5odHRwTWV0aG9kO1xuICAgIGNvbnN0IGRldmljZVVpZCA9IGV2ZW50LnBhdGhQYXJhbWV0ZXJzPy5kZXZpY2VfdWlkO1xuXG4gICAgaWYgKG1ldGhvZCA9PT0gJ09QVElPTlMnKSB7XG4gICAgICByZXR1cm4geyBzdGF0dXNDb2RlOiAyMDAsIGhlYWRlcnM6IGNvcnNIZWFkZXJzLCBib2R5OiAnJyB9O1xuICAgIH1cblxuICAgIGlmIChtZXRob2QgPT09ICdHRVQnICYmICFkZXZpY2VVaWQpIHtcbiAgICAgIC8vIExpc3QgZGV2aWNlc1xuICAgICAgcmV0dXJuIGF3YWl0IGxpc3REZXZpY2VzKGV2ZW50LCBjb3JzSGVhZGVycyk7XG4gICAgfVxuXG4gICAgaWYgKG1ldGhvZCA9PT0gJ0dFVCcgJiYgZGV2aWNlVWlkKSB7XG4gICAgICAvLyBHZXQgc2luZ2xlIGRldmljZVxuICAgICAgcmV0dXJuIGF3YWl0IGdldERldmljZShkZXZpY2VVaWQsIGNvcnNIZWFkZXJzKTtcbiAgICB9XG5cbiAgICBpZiAobWV0aG9kID09PSAnUEFUQ0gnICYmIGRldmljZVVpZCkge1xuICAgICAgLy8gVXBkYXRlIGRldmljZVxuICAgICAgcmV0dXJuIGF3YWl0IHVwZGF0ZURldmljZShkZXZpY2VVaWQsIGV2ZW50LmJvZHksIGNvcnNIZWFkZXJzKTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNDA1LFxuICAgICAgaGVhZGVyczogY29yc0hlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnTWV0aG9kIG5vdCBhbGxvd2VkJyB9KSxcbiAgICB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yOicsIGVycm9yKTtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNTAwLFxuICAgICAgaGVhZGVyczogY29yc0hlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnSW50ZXJuYWwgc2VydmVyIGVycm9yJyB9KSxcbiAgICB9O1xuICB9XG59O1xuXG5hc3luYyBmdW5jdGlvbiBsaXN0RGV2aWNlcyhcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50LFxuICBoZWFkZXJzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+XG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4ge1xuICBjb25zdCBxdWVyeVBhcmFtcyA9IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycyB8fCB7fTtcbiAgY29uc3QgZmxlZXQgPSBxdWVyeVBhcmFtcy5mbGVldDtcbiAgY29uc3Qgc3RhdHVzID0gcXVlcnlQYXJhbXMuc3RhdHVzO1xuICBjb25zdCBsaW1pdCA9IHBhcnNlSW50KHF1ZXJ5UGFyYW1zLmxpbWl0IHx8ICcxMDAnKTtcblxuICBsZXQgaXRlbXM6IGFueVtdID0gW107XG5cbiAgaWYgKGZsZWV0KSB7XG4gICAgLy8gUXVlcnkgYnkgZmxlZXQgdXNpbmcgR1NJXG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiBERVZJQ0VTX1RBQkxFLFxuICAgICAgSW5kZXhOYW1lOiAnZmxlZXQtaW5kZXgnLFxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJyNmbGVldCA9IDpmbGVldCcsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IHsgJyNmbGVldCc6ICdmbGVldCcgfSxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHsgJzpmbGVldCc6IGZsZWV0IH0sXG4gICAgICBMaW1pdDogbGltaXQsXG4gICAgICBTY2FuSW5kZXhGb3J3YXJkOiBmYWxzZSwgLy8gTW9zdCByZWNlbnQgZmlyc3RcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIGl0ZW1zID0gcmVzdWx0Lkl0ZW1zIHx8IFtdO1xuICB9IGVsc2UgaWYgKHN0YXR1cykge1xuICAgIC8vIFF1ZXJ5IGJ5IHN0YXR1cyB1c2luZyBHU0lcbiAgICBjb25zdCBjb21tYW5kID0gbmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IERFVklDRVNfVEFCTEUsXG4gICAgICBJbmRleE5hbWU6ICdzdGF0dXMtaW5kZXgnLFxuICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJyNzdGF0dXMgPSA6c3RhdHVzJyxcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogeyAnI3N0YXR1cyc6ICdzdGF0dXMnIH0sXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiB7ICc6c3RhdHVzJzogc3RhdHVzIH0sXG4gICAgICBMaW1pdDogbGltaXQsXG4gICAgICBTY2FuSW5kZXhGb3J3YXJkOiBmYWxzZSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKGNvbW1hbmQpO1xuICAgIGl0ZW1zID0gcmVzdWx0Lkl0ZW1zIHx8IFtdO1xuICB9IGVsc2Uge1xuICAgIC8vIFNjYW4gYWxsIGRldmljZXMgKGZvciBzbWFsbCBmbGVldHMpXG4gICAgY29uc3QgY29tbWFuZCA9IG5ldyBTY2FuQ29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IERFVklDRVNfVEFCTEUsXG4gICAgICBMaW1pdDogbGltaXQsXG4gICAgfSk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkb2NDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICBpdGVtcyA9IHJlc3VsdC5JdGVtcyB8fCBbXTtcbiAgfVxuXG4gIC8vIFRyYW5zZm9ybSBhbmQgY2FsY3VsYXRlIGZsZWV0IHN0YXRzXG4gIGNvbnN0IHRyYW5zZm9ybWVkRGV2aWNlcyA9IGl0ZW1zLm1hcCh0cmFuc2Zvcm1EZXZpY2UpO1xuICBjb25zdCBzdGF0cyA9IGNhbGN1bGF0ZVN0YXRzKGl0ZW1zKTtcblxuICByZXR1cm4ge1xuICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICBoZWFkZXJzLFxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgIGRldmljZXM6IHRyYW5zZm9ybWVkRGV2aWNlcyxcbiAgICAgIGNvdW50OiB0cmFuc2Zvcm1lZERldmljZXMubGVuZ3RoLFxuICAgICAgc3RhdHMsXG4gICAgfSksXG4gIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldERldmljZShcbiAgZGV2aWNlVWlkOiBzdHJpbmcsXG4gIGhlYWRlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgR2V0Q29tbWFuZCh7XG4gICAgVGFibGVOYW1lOiBERVZJQ0VTX1RBQkxFLFxuICAgIEtleTogeyBkZXZpY2VfdWlkOiBkZXZpY2VVaWQgfSxcbiAgfSk7XG5cbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG5cbiAgaWYgKCFyZXN1bHQuSXRlbSkge1xuICAgIHJldHVybiB7XG4gICAgICBzdGF0dXNDb2RlOiA0MDQsXG4gICAgICBoZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0RldmljZSBub3QgZm91bmQnIH0pLFxuICAgIH07XG4gIH1cblxuICByZXR1cm4ge1xuICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICBoZWFkZXJzLFxuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHRyYW5zZm9ybURldmljZShyZXN1bHQuSXRlbSkpLFxuICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiB1cGRhdGVEZXZpY2UoXG4gIGRldmljZVVpZDogc3RyaW5nLFxuICBib2R5OiBzdHJpbmcgfCBudWxsLFxuICBoZWFkZXJzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+XG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4ge1xuICBpZiAoIWJvZHkpIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgaGVhZGVycyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdSZXF1ZXN0IGJvZHkgcmVxdWlyZWQnIH0pLFxuICAgIH07XG4gIH1cblxuICBjb25zdCB1cGRhdGVzID0gSlNPTi5wYXJzZShib2R5KTtcblxuICAvLyBPbmx5IGFsbG93IGNlcnRhaW4gZmllbGRzIHRvIGJlIHVwZGF0ZWRcbiAgY29uc3QgYWxsb3dlZEZpZWxkcyA9IFsnc2VyaWFsX251bWJlcicsICdhc3NpZ25lZF90bycsICdmbGVldCcsICdub3RlcyddO1xuICBjb25zdCB1cGRhdGVFeHByZXNzaW9uczogc3RyaW5nW10gPSBbXTtcbiAgY29uc3QgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge307XG4gIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcblxuICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyh1cGRhdGVzKSkge1xuICAgIGlmIChhbGxvd2VkRmllbGRzLmluY2x1ZGVzKGtleSkpIHtcbiAgICAgIGNvbnN0IGF0dHJOYW1lID0gYCMke2tleX1gO1xuICAgICAgY29uc3QgYXR0clZhbHVlID0gYDoke2tleX1gO1xuICAgICAgdXBkYXRlRXhwcmVzc2lvbnMucHVzaChgJHthdHRyTmFtZX0gPSAke2F0dHJWYWx1ZX1gKTtcbiAgICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1thdHRyTmFtZV0gPSBrZXk7XG4gICAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzW2F0dHJWYWx1ZV0gPSB2YWx1ZTtcbiAgICB9XG4gIH1cblxuICBpZiAodXBkYXRlRXhwcmVzc2lvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGVycm9yOiAnTm8gdmFsaWQgZmllbGRzIHRvIHVwZGF0ZScgfSksXG4gICAgfTtcbiAgfVxuXG4gIC8vIEFsd2F5cyB1cGRhdGUgdXBkYXRlZF9hdFxuICB1cGRhdGVFeHByZXNzaW9ucy5wdXNoKCcjdXBkYXRlZF9hdCA9IDp1cGRhdGVkX2F0Jyk7XG4gIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1snI3VwZGF0ZWRfYXQnXSA9ICd1cGRhdGVkX2F0JztcbiAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnVwZGF0ZWRfYXQnXSA9IERhdGUubm93KCk7XG5cbiAgY29uc3QgY29tbWFuZCA9IG5ldyBVcGRhdGVDb21tYW5kKHtcbiAgICBUYWJsZU5hbWU6IERFVklDRVNfVEFCTEUsXG4gICAgS2V5OiB7IGRldmljZV91aWQ6IGRldmljZVVpZCB9LFxuICAgIFVwZGF0ZUV4cHJlc3Npb246ICdTRVQgJyArIHVwZGF0ZUV4cHJlc3Npb25zLmpvaW4oJywgJyksXG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiBleHByZXNzaW9uQXR0cmlidXRlTmFtZXMsXG4gICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcbiAgICBSZXR1cm5WYWx1ZXM6ICdBTExfTkVXJyxcbiAgfSk7XG5cbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZG9jQ2xpZW50LnNlbmQoY29tbWFuZCk7XG5cbiAgcmV0dXJuIHtcbiAgICBzdGF0dXNDb2RlOiAyMDAsXG4gICAgaGVhZGVycyxcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeShyZXN1bHQuQXR0cmlidXRlcyksXG4gIH07XG59XG5cbi8qKlxuICogVHJhbnNmb3JtIER5bmFtb0RCIGRldmljZSByZWNvcmQgdG8gZnJvbnRlbmQgZm9ybWF0XG4gKiBGbGF0dGVucyBuZXN0ZWQgb2JqZWN0cyBsaWtlIGxhc3RfbG9jYXRpb24gYW5kIGxhc3RfdGVsZW1ldHJ5XG4gKi9cbmZ1bmN0aW9uIHRyYW5zZm9ybURldmljZShpdGVtOiBhbnkpOiBhbnkge1xuICBjb25zdCBkZXZpY2U6IGFueSA9IHtcbiAgICBkZXZpY2VfdWlkOiBpdGVtLmRldmljZV91aWQsXG4gICAgc2VyaWFsX251bWJlcjogaXRlbS5zZXJpYWxfbnVtYmVyLFxuICAgIG5hbWU6IGl0ZW0ubmFtZSxcbiAgICBmbGVldDogaXRlbS5mbGVldCxcbiAgICBzdGF0dXM6IGl0ZW0uc3RhdHVzLFxuICAgIC8vIENvbnZlcnQgbWlsbGlzZWNvbmQgdGltZXN0YW1wIHRvIElTTyBzdHJpbmcgZm9yIGZyb250ZW5kXG4gICAgbGFzdF9zZWVuOiBpdGVtLmxhc3Rfc2VlbiA/IG5ldyBEYXRlKGl0ZW0ubGFzdF9zZWVuKS50b0lTT1N0cmluZygpIDogdW5kZWZpbmVkLFxuICAgIG1vZGU6IGl0ZW0uY3VycmVudF9tb2RlLFxuICAgIHRyYW5zaXRfbG9ja2VkOiBpdGVtLnRyYW5zaXRfbG9ja2VkIHx8IGZhbHNlLFxuICAgIGNyZWF0ZWRfYXQ6IGl0ZW0uY3JlYXRlZF9hdCA/IG5ldyBEYXRlKGl0ZW0uY3JlYXRlZF9hdCkudG9JU09TdHJpbmcoKSA6IHVuZGVmaW5lZCxcbiAgICB1cGRhdGVkX2F0OiBpdGVtLnVwZGF0ZWRfYXQgPyBuZXcgRGF0ZShpdGVtLnVwZGF0ZWRfYXQpLnRvSVNPU3RyaW5nKCkgOiB1bmRlZmluZWQsXG4gICAgYXNzaWduZWRfdG86IGl0ZW0uYXNzaWduZWRfdG8sXG4gICAgYXNzaWduZWRfdG9fbmFtZTogaXRlbS5hc3NpZ25lZF90b19uYW1lLFxuICB9O1xuXG4gIC8vIEZsYXR0ZW4gbGFzdF9sb2NhdGlvblxuICBpZiAoaXRlbS5sYXN0X2xvY2F0aW9uKSB7XG4gICAgZGV2aWNlLmxhdGl0dWRlID0gaXRlbS5sYXN0X2xvY2F0aW9uLmxhdDtcbiAgICBkZXZpY2UubG9uZ2l0dWRlID0gaXRlbS5sYXN0X2xvY2F0aW9uLmxvbjtcbiAgICAvLyBDb252ZXJ0IFVuaXggdGltZXN0YW1wIChzZWNvbmRzKSB0byBJU08gc3RyaW5nIGZvciBmcm9udGVuZFxuICAgIGlmIChpdGVtLmxhc3RfbG9jYXRpb24udGltZSkge1xuICAgICAgLy8gTm90ZWh1YiB0aW1lc3RhbXBzIGFyZSBpbiBzZWNvbmRzLCBjb252ZXJ0IHRvIG1pbGxpc2Vjb25kcyBmb3IgRGF0ZVxuICAgICAgY29uc3QgdGltZU1zID0gaXRlbS5sYXN0X2xvY2F0aW9uLnRpbWUgKiAxMDAwO1xuICAgICAgZGV2aWNlLmxvY2F0aW9uX3RpbWUgPSBuZXcgRGF0ZSh0aW1lTXMpLnRvSVNPU3RyaW5nKCk7XG4gICAgfVxuICAgIGRldmljZS5sb2NhdGlvbl9zb3VyY2UgPSBpdGVtLmxhc3RfbG9jYXRpb24uc291cmNlO1xuICAgIGRldmljZS5sb2NhdGlvbl9uYW1lID0gaXRlbS5sYXN0X2xvY2F0aW9uLm5hbWU7XG4gIH1cblxuICAvLyBGbGF0dGVuIGxhc3RfdGVsZW1ldHJ5XG4gIGlmIChpdGVtLmxhc3RfdGVsZW1ldHJ5KSB7XG4gICAgZGV2aWNlLnRlbXBlcmF0dXJlID0gaXRlbS5sYXN0X3RlbGVtZXRyeS50ZW1wO1xuICAgIGRldmljZS5odW1pZGl0eSA9IGl0ZW0ubGFzdF90ZWxlbWV0cnkuaHVtaWRpdHk7XG4gICAgZGV2aWNlLnByZXNzdXJlID0gaXRlbS5sYXN0X3RlbGVtZXRyeS5wcmVzc3VyZTtcbiAgICBkZXZpY2Uudm9sdGFnZSA9IGl0ZW0ubGFzdF90ZWxlbWV0cnkudm9sdGFnZTtcbiAgICBkZXZpY2UubW90aW9uID0gaXRlbS5sYXN0X3RlbGVtZXRyeS5tb3Rpb247XG4gIH1cblxuICAvLyBGbGF0dGVuIGxhc3RfcG93ZXIgKE1vam8gZGF0YSlcbiAgaWYgKGl0ZW0ubGFzdF9wb3dlcikge1xuICAgIGRldmljZS5tb2pvX3ZvbHRhZ2UgPSBpdGVtLmxhc3RfcG93ZXIudm9sdGFnZTtcbiAgICBkZXZpY2UubW9qb190ZW1wZXJhdHVyZSA9IGl0ZW0ubGFzdF9wb3dlci50ZW1wZXJhdHVyZTtcbiAgICBkZXZpY2UubWlsbGlhbXBfaG91cnMgPSBpdGVtLmxhc3RfcG93ZXIubWlsbGlhbXBfaG91cnM7XG4gIH1cblxuICAvLyBGaXJtd2FyZSB2ZXJzaW9ucyAoZnJvbSBfc2Vzc2lvbi5xbyBldmVudHMpXG4gIGlmIChpdGVtLmZpcm13YXJlX3ZlcnNpb24pIHtcbiAgICBkZXZpY2UuZmlybXdhcmVfdmVyc2lvbiA9IGl0ZW0uZmlybXdhcmVfdmVyc2lvbjtcbiAgfVxuICBpZiAoaXRlbS5ub3RlY2FyZF92ZXJzaW9uKSB7XG4gICAgZGV2aWNlLm5vdGVjYXJkX3ZlcnNpb24gPSBpdGVtLm5vdGVjYXJkX3ZlcnNpb247XG4gIH1cbiAgaWYgKGl0ZW0ubm90ZWNhcmRfc2t1KSB7XG4gICAgZGV2aWNlLm5vdGVjYXJkX3NrdSA9IGl0ZW0ubm90ZWNhcmRfc2t1O1xuICB9XG5cbiAgcmV0dXJuIGRldmljZTtcbn1cblxuZnVuY3Rpb24gY2FsY3VsYXRlU3RhdHMoZGV2aWNlczogYW55W10pOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHtcbiAgY29uc3Qgc3RhdHMgPSB7XG4gICAgdG90YWw6IGRldmljZXMubGVuZ3RoLFxuICAgIG9ubGluZTogMCxcbiAgICBvZmZsaW5lOiAwLFxuICAgIGFsZXJ0OiAwLFxuICAgIGxvd19iYXR0ZXJ5OiAwLFxuICAgIGZsZWV0czoge30gYXMgUmVjb3JkPHN0cmluZywgbnVtYmVyPixcbiAgfTtcblxuICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICBjb25zdCBvZmZsaW5lVGhyZXNob2xkID0gMTUgKiA2MCAqIDEwMDA7IC8vIDE1IG1pbnV0ZXNcblxuICBmb3IgKGNvbnN0IGRldmljZSBvZiBkZXZpY2VzKSB7XG4gICAgLy8gU3RhdHVzIGNvdW50c1xuICAgIGlmIChkZXZpY2Uuc3RhdHVzID09PSAnYWxlcnQnKSB7XG4gICAgICBzdGF0cy5hbGVydCsrO1xuICAgIH0gZWxzZSBpZiAoZGV2aWNlLmxhc3Rfc2VlbiAmJiBub3cgLSBkZXZpY2UubGFzdF9zZWVuIDwgb2ZmbGluZVRocmVzaG9sZCkge1xuICAgICAgc3RhdHMub25saW5lKys7XG4gICAgfSBlbHNlIHtcbiAgICAgIHN0YXRzLm9mZmxpbmUrKztcbiAgICB9XG5cbiAgICAvLyBMb3cgYmF0dGVyeSBjaGVja1xuICAgIGlmIChkZXZpY2UubGFzdF90ZWxlbWV0cnk/LnZvbHRhZ2UgJiYgZGV2aWNlLmxhc3RfdGVsZW1ldHJ5LnZvbHRhZ2UgPCAzLjQpIHtcbiAgICAgIHN0YXRzLmxvd19iYXR0ZXJ5Kys7XG4gICAgfVxuXG4gICAgLy8gRmxlZXQgY291bnRzXG4gICAgY29uc3QgZmxlZXQgPSBkZXZpY2UuZmxlZXQgfHwgJ2RlZmF1bHQnO1xuICAgIHN0YXRzLmZsZWV0c1tmbGVldF0gPSAoc3RhdHMuZmxlZXRzW2ZsZWV0XSB8fCAwKSArIDE7XG4gIH1cblxuICByZXR1cm4gc3RhdHM7XG59XG4iXX0=